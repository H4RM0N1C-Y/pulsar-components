<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Pulsar Journal v8</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#050507;--surface:#0a0a0e;--surface2:#0f0f14;--surface3:#16161d;--surface4:#1e1e27;
--border:#1a1a25;--border2:#252533;
--text:#f0f0f4;--text2:#b0b0c0;--text3:#707088;--text4:#4a4a5c;
--accent:#a78bfa;--accent2:#c4b5fd;--accent-soft:rgba(167,139,250,0.12);--accent-glow:rgba(167,139,250,0.25);
--success:#6ee7b7;--warning:#fcd34d;--danger:#fca5a5;
--ease:cubic-bezier(0.22,1,0.36,1);
--font:'Outfit',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
}
html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-user-select:none;user-select:none}
body{font-family:var(--font);background:var(--bg);color:var(--text)}
::selection{background:var(--accent-soft)}

.canvas{position:fixed;inset:0;overflow:hidden;cursor:grab}
.canvas.panning{cursor:grabbing}
.canvas.panning *{pointer-events:none!important}
.canvas-world{position:absolute;transform-origin:0 0;will-change:transform;transition:transform 0.1s var(--ease)}
.canvas-bg{position:fixed;inset:-50%;width:200%;height:200%;background-image:radial-gradient(circle,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:28px 28px;pointer-events:none;transition:transform 0.1s var(--ease)}

.hdr{position:fixed;top:0;left:0;right:0;height:56px;background:rgba(5,5,7,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;z-index:100;gap:12px}
.logo{font-size:1.1rem;font-weight:700;color:var(--accent);display:flex;align-items:center;gap:8px}
.logo svg{width:22px;height:22px}
.day-nav{display:flex;align-items:center;gap:8px;margin-left:8px}
.day-arr{width:34px;height:34px;border:1px solid var(--border);background:var(--surface2);border-radius:8px;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all 0.15s}
.day-arr:hover{background:var(--surface3);color:var(--text);border-color:var(--border2)}
.day-arr:active{transform:scale(0.95)}
.day-arr.disabled{opacity:0.2;cursor:not-allowed;pointer-events:none}
.day-info{display:flex;flex-direction:column;gap:1px;min-width:180px}
.day-title{font-size:0.95rem;font-weight:600;color:var(--text)}
.day-date{font-size:0.7rem;color:var(--text3)}
.stats{display:flex;gap:14px;font-size:0.75rem;color:var(--text3);margin-left:auto}
.stats strong{color:var(--text);font-weight:600}
.streak{display:flex;align-items:center;gap:5px}
.streak-dot{width:5px;height:5px;border-radius:50%;background:var(--surface4)}
.streak-dot.on{background:var(--success)}
.streak-dot.today{background:var(--accent);box-shadow:0 0 6px var(--accent-glow)}
.streak-num{color:var(--success);font-weight:600;margin-left:2px}
.zoom{font-size:0.7rem;color:var(--text4);font-family:var(--mono);min-width:45px;text-align:right}
.actions{display:flex;gap:6px}

.btn{height:34px;min-width:34px;padding:0 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text3);font-size:0.75rem;font-weight:500;cursor:pointer;transition:all 0.15s;font-family:var(--font);display:flex;align-items:center;justify-content:center;gap:6px}
.btn:hover{background:var(--surface3);color:var(--text);border-color:var(--border2)}
.btn:active{transform:scale(0.97)}
.btn-icon{padding:0;width:34px}
.btn.on{background:var(--accent-soft);color:var(--accent2);border-color:var(--accent)}

.drag-handle{position:fixed;bottom:20px;left:20px;width:130px;height:130px;background:var(--surface);border:2px dashed var(--border2);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;cursor:grab;transition:all 0.15s;z-index:100;user-select:none}
.drag-handle:hover{background:var(--surface2);border-color:var(--accent);transform:scale(1.02)}
.drag-handle:active{cursor:grabbing;transform:scale(0.98)}
.drag-handle-icon{font-size:2.2rem;opacity:0.5}
.drag-handle-text{font-size:0.75rem;color:var(--text3);font-weight:500;text-align:center;line-height:1.3}
.drag-handle.dragging{opacity:0.25}
.drag-preview{position:absolute;width:340px;height:140px;background:var(--surface);border:2px dashed var(--accent);border-radius:12px;opacity:0.6;pointer-events:none;display:none;z-index:1000;box-shadow:0 8px 32px rgba(167,139,250,0.25)}

.entry{position:absolute;width:340px;background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:default;transition:box-shadow 0.15s}
.entry:hover{border-color:var(--border2);box-shadow:0 8px 32px rgba(0,0,0,0.3)}
.entry.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-soft)}
.entry.dragging{opacity:0.9;z-index:500;cursor:grabbing;box-shadow:0 12px 48px rgba(0,0,0,0.5)}
.entry.editing{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-soft),0 8px 32px rgba(0,0,0,0.3)}
.entry.thread-highlight{border-color:var(--warning);box-shadow:0 0 0 2px rgba(252,213,77,0.2)}
.entry.new{animation:pop 0.2s cubic-bezier(0.16,1,0.3,1)}
@keyframes pop{from{opacity:0;transform:scale(0.94)}to{opacity:1;transform:scale(1)}}

.entry-hdr{display:flex;align-items:center;gap:8px;padding:11px 14px;border-bottom:1px solid var(--border);cursor:grab;background:var(--surface2);transition:background 0.1s}
.entry-hdr:hover{background:var(--surface3)}
.entry-hdr:active{cursor:grabbing}
.entry-grip{color:var(--text4);font-size:0.7rem;letter-spacing:2px}
.entry-time{font-size:0.65rem;color:var(--text4);font-family:var(--mono)}
.entry-acts{margin-left:auto;display:flex;gap:3px}
.entry-act{width:26px;height:26px;border:none;background:transparent;color:var(--text4);border-radius:6px;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.entry-act:hover{background:var(--surface4);color:var(--text2)}
.entry-act.del:hover{background:rgba(252,165,165,0.15);color:var(--danger)}
.entry-act.thread:hover{background:rgba(252,213,77,0.15);color:var(--warning)}

.entry-body{padding:14px;min-height:70px;max-height:260px;overflow-y:auto;-webkit-user-select:text;user-select:text}
.entry-body::-webkit-scrollbar{width:5px}
.entry-body::-webkit-scrollbar-track{background:transparent}
.entry-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.entry-text{font-size:0.88rem;color:var(--text);line-height:1.7;outline:none;white-space:pre-wrap;word-break:break-word;cursor:text}
.entry-text[contenteditable="true"]{border:1px dashed var(--accent);border-radius:8px;padding:8px;margin:-8px;background:var(--surface2)}
.entry-text:empty::before{content:attr(data-ph);color:var(--text4)}

.entry-foot{padding:11px 14px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:6px;align-items:center;min-height:44px}
.mood{display:flex;align-items:center;gap:5px;font-size:0.68rem;color:var(--text3)}
.mood-dot{width:9px;height:9px;border-radius:50%}
.tags{display:flex;flex-wrap:wrap;gap:5px;flex:1}
.tag{font-size:0.62rem;padding:4px 10px;background:var(--surface3);border-radius:9px;color:var(--text3);border:1px solid transparent;cursor:pointer;transition:all 0.15s}
.tag:hover{border-color:var(--border2);background:var(--surface4)}
.links{display:flex;flex-wrap:wrap;gap:5px;width:100%}
.link{font-size:0.62rem;padding:4px 10px;background:rgba(110,231,183,0.12);border:1px solid rgba(110,231,183,0.2);border-radius:9px;color:var(--success);cursor:pointer;display:flex;align-items:center;gap:4px;transition:all 0.15s;position:relative}
.link:hover{border-color:var(--success);background:rgba(110,231,183,0.2)}
.link button{background:none;border:none;color:currentColor;cursor:pointer;padding:0;font-size:0.85rem;line-height:1}

.link-preview{position:absolute;bottom:100%;left:0;margin-bottom:8px;width:280px;background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:12px;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:600;box-shadow:0 8px 24px rgba(0,0,0,0.4)}
.link:hover .link-preview{opacity:1}
.link-preview-date{font-size:0.65rem;color:var(--text4);margin-bottom:6px}
.link-preview-text{font-size:0.75rem;color:var(--text2);line-height:1.5;max-height:80px;overflow:hidden;text-overflow:ellipsis}

.edit-bar{display:flex;gap:6px;padding:11px 14px;border-top:1px solid var(--border);background:var(--surface2)}
.edit-bar button{padding:6px 13px;border-radius:7px;border:1px solid var(--border);background:var(--surface3);color:var(--text3);font-size:0.72rem;font-weight:500;cursor:pointer;font-family:var(--font);transition:all 0.15s}
.edit-bar button:hover{background:var(--surface4);color:var(--text)}
.edit-bar .save{background:var(--accent);color:#111;border-color:var(--accent)}
.edit-bar .save:hover{background:var(--accent2)}

.connections{position:absolute;inset:0;pointer-events:none;overflow:visible;z-index:-1}
.conn{fill:none;stroke-width:2.5;stroke-linecap:round;opacity:0.35}
.conn.thread{stroke:var(--warning);opacity:0.5;stroke-width:3;stroke-dasharray:6,3}
.conn-marker{fill:var(--accent);opacity:0.5}

.thread-panel{position:fixed;right:20px;top:76px;width:320px;max-height:calc(100vh - 96px);background:var(--surface);border:1px solid var(--border);border-radius:12px;z-index:150;display:none;flex-direction:column;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.thread-panel.on{display:flex}
.thread-hdr{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.thread-title{font-size:0.85rem;font-weight:600;color:var(--text)}
.thread-close{width:28px;height:28px;border:none;background:transparent;color:var(--text4);border-radius:6px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.thread-close:hover{background:var(--surface3);color:var(--text)}
.thread-body{flex:1;overflow-y:auto;padding:12px}
.thread-body::-webkit-scrollbar{width:5px}
.thread-body::-webkit-scrollbar-track{background:transparent}
.thread-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.thread-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;cursor:pointer;transition:all 0.15s}
.thread-item:hover{background:var(--surface3);border-color:var(--border2)}
.thread-item:last-child{margin-bottom:0}
.thread-item-date{font-size:0.65rem;color:var(--text4);margin-bottom:6px;font-family:var(--mono)}
.thread-item-text{font-size:0.75rem;color:var(--text);line-height:1.6;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.thread-item-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
.thread-item-tag{font-size:0.6rem;padding:3px 8px;background:var(--surface3);border-radius:6px;color:var(--text3)}

.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0);display:flex;align-items:center;justify-content:center;z-index:200;pointer-events:none;transition:background 0.2s}
.modal-bg.on{background:rgba(0,0,0,0.8);pointer-events:auto}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:100%;max-width:500px;transform:translateY(30px) scale(0.95);opacity:0;transition:all 0.25s cubic-bezier(0.16,1,0.3,1)}
.modal-bg.on .modal{transform:translateY(0) scale(1);opacity:1}
.modal-hdr{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-hdr h3{font-size:1rem;font-weight:600}
.modal-close{width:32px;height:32px;border:none;background:var(--surface3);color:var(--text3);border-radius:8px;cursor:pointer;font-size:1.15rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.modal-close:hover{background:rgba(252,165,165,0.15);color:var(--danger)}
.modal-body{padding:20px}
.form-group{margin-bottom:16px}
.form-label{font-size:0.72rem;font-weight:600;color:var(--text2);margin-bottom:7px;display:block;text-transform:uppercase;letter-spacing:0.4px}
.mood-sel{display:flex;gap:9px}
.mood-opt{width:44px;height:44px;border:2px solid var(--border);border-radius:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.mood-opt:hover{border-color:var(--border2);transform:translateY(-2px)}
.mood-opt.selected{border-color:var(--accent);background:var(--accent-soft);box-shadow:0 0 0 3px var(--accent-soft)}
.mood-opt-dot{width:18px;height:18px;border-radius:50%}
.tag-input{display:flex;gap:7px;flex-wrap:wrap;padding:11px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;min-height:44px;transition:border 0.15s}
.tag-input:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}
.tag-item{display:flex;align-items:center;gap:5px;padding:5px 10px;background:var(--surface3);border-radius:7px;font-size:0.72rem;color:var(--text2)}
.tag-item button{background:none;border:none;color:var(--text4);cursor:pointer;font-size:0.95rem;padding:0;width:17px;height:17px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all 0.15s}
.tag-item button:hover{background:var(--surface4);color:var(--text)}
.tag-input input{flex:1;min-width:90px;background:none;border:none;color:var(--text);font-size:0.78rem;font-family:var(--font);outline:none}
.link-input{display:flex;gap:7px;flex-wrap:wrap;padding:11px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;min-height:44px;transition:border 0.15s}
.link-input:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}
.link-item{display:flex;align-items:center;gap:5px;padding:5px 10px;background:rgba(110,231,183,0.12);border:1px solid rgba(110,231,183,0.2);border-radius:7px;font-size:0.72rem;color:var(--success)}
.link-item button{background:none;border:none;color:currentColor;cursor:pointer;font-size:0.95rem;padding:0;width:17px;height:17px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all 0.15s}
.link-item button:hover{background:rgba(110,231,183,0.2)}
.link-input input{flex:1;min-width:90px;background:none;border:none;color:var(--text);font-size:0.78rem;font-family:var(--font);outline:none}
.modal-hint{font-size:0.68rem;color:var(--text4);margin-top:8px;line-height:1.55}
.modal-foot{padding:15px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}

.toast{position:fixed;top:75px;left:50%;transform:translateX(-50%) translateY(-20px);background:var(--surface);border:1px solid var(--border2);padding:14px 20px;border-radius:10px;font-size:0.82rem;opacity:0;transition:all 0.25s;z-index:300;pointer-events:none;max-width:450px;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
.toast.welcome{padding:18px 22px;background:var(--surface2);border-color:var(--accent);max-width:550px}
.toast-head{display:flex;align-items:center;gap:9px;margin-bottom:10px}
.toast-icon{font-size:1.2rem}
.toast-title{font-size:0.9rem;font-weight:600;color:var(--text)}
.toast-msg{color:var(--text2);line-height:1.6;font-size:0.8rem}
.toast-acts{margin-top:12px;display:flex;gap:8px;justify-content:flex-end}
.toast-btn{padding:7px 14px;background:var(--surface3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.72rem;cursor:pointer;font-family:var(--font);font-weight:500;transition:all 0.15s}
.toast-btn:hover{background:var(--surface4);color:var(--text)}
.toast-btn.primary{background:var(--accent);color:#111;border-color:var(--accent)}
.toast-btn.primary:hover{background:var(--accent2)}
</style>
</head>
<body>
<div class="canvas" id="canvas">
  <div class="canvas-bg" id="canvasBg"></div>
  <div class="canvas-world" id="world">
    <svg class="connections" id="connections">
      <defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" class="conn-marker"><path d="M0,0 L0,6 L9,3 z"/></marker></defs>
    </svg>
    <div id="entries"></div>
  </div>
  <div class="drag-preview" id="dragPreview"></div>
</div>

<header class="hdr">
  <div class="logo">
    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
    Journal
  </div>
  <div class="day-nav">
    <button class="day-arr" id="prevDay">‚Äπ</button>
    <div class="day-info">
      <div class="day-title" id="dayTitle">Today</div>
      <div class="day-date" id="dayDate"></div>
    </div>
    <button class="day-arr" id="nextDay">‚Ä∫</button>
  </div>
  <div class="stats">
    <span><strong id="entryCount">0</strong> entries</span>
    <span><strong id="wordCount">0</strong> words</span>
    <div class="streak" id="streak"></div>
    <span class="zoom" id="zoomInd">100%</span>
  </div>
  <div class="actions">
    <button class="btn btn-icon" id="connBtn" title="Connections (C)">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
    </button>
    <button class="btn" id="arrangeBtn">Arrange</button>
  </div>
</header>

<div class="drag-handle" id="dragHandle">
  <div class="drag-handle-icon">‚úö</div>
  <div class="drag-handle-text">Drag to create</div>
</div>

<div class="thread-panel" id="threadPanel">
  <div class="thread-hdr">
    <div class="thread-title">Related Entries</div>
    <button class="thread-close" id="threadClose">√ó</button>
  </div>
  <div class="thread-body" id="threadBody"></div>
</div>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div class="modal-hdr">
      <h3>Edit Details</h3>
      <button class="modal-close" id="modalClose">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Mood</label>
        <div class="mood-sel" id="moodSel">
          <div class="mood-opt" data-mood="great"><div class="mood-opt-dot" style="background:#6ee7b7"></div></div>
          <div class="mood-opt" data-mood="good"><div class="mood-opt-dot" style="background:#a78bfa"></div></div>
          <div class="mood-opt" data-mood="okay"><div class="mood-opt-dot" style="background:#fcd34d"></div></div>
          <div class="mood-opt" data-mood="low"><div class="mood-opt-dot" style="background:#fca5a5"></div></div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Tags</label>
        <div class="tag-input" id="tagInput">
          <input type="text" id="tagField" placeholder="Add tag...">
        </div>
        <div class="modal-hint">Press Enter to add tags</div>
      </div>
      <div class="form-group">
        <label class="form-label">Links</label>
        <div class="link-input" id="linkInput">
          <input type="text" id="linkField" placeholder="Entry ID">
        </div>
        <div class="modal-hint">Link to other entries</div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="cancelBtn">Cancel</button>
      <button class="btn btn-pri" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="toast-head">
    <span class="toast-icon"></span>
    <span class="toast-title" id="toastTitle"></span>
  </div>
  <div class="toast-msg" id="toastMsg"></div>
  <div class="toast-acts" id="toastActs"></div>
</div>

<script>
const MOODS={great:'#6ee7b7',good:'#a78bfa',okay:'#fcd34d',low:'#fca5a5'};
const MOOD_LABELS={great:'Great',good:'Good',okay:'Okay',low:'Low'};
const VERSION='v8';

let entries={},currentDay=null,selectedId=null,showConn=true;
let isPanning=false,isDragging=false,panStart={x:0,y:0},panOrigin={x:0,y:0};
let dayPans={},dayZooms={};
let editingId=null,tempTags=[],tempLinks=[];
let hasSeenWelcome=false;
let threadEntryId=null;

const $=id=>document.getElementById(id);
const fmt=d=>d.toISOString().split('T')[0];
const today=()=>fmt(new Date());

function getTodayDevice(){const d=new Date();d.setHours(0,0,0,0);return d}
function isPastOrToday(dateStr){return new Date(dateStr)<=getTodayDevice()}

function load(){
  try{
    const d=JSON.parse(localStorage.getItem('pj_v8')||'{}');
    entries=d.entries||{};
    dayPans=d.dayPans||{};
    dayZooms=d.dayZooms||{};
    showConn=d.showConn!==undefined?d.showConn:true;
    currentDay=d.currentDay||today();
    hasSeenWelcome=d.hasSeenWelcome||false;
    if(!isPastOrToday(currentDay))currentDay=today();
  }catch{entries={};dayPans={};dayZooms={}}
}

function save(){
  localStorage.setItem('pj_v8',JSON.stringify({
    entries,dayPans,dayZooms,showConn,currentDay,hasSeenWelcome,version:VERSION
  }));
}

function toast(msg,icon='',title='',duration=1500){
  const t=$('toast');
  $('toastTitle').textContent=title||'';
  $('toastMsg').textContent=msg;
  t.querySelector('.toast-icon').textContent=icon;
  $('toastActs').innerHTML='';
  t.classList.remove('welcome');
  t.classList.add('on');
  if(duration>0)setTimeout(()=>t.classList.remove('on'),duration);
}

function showWelcome(){
  const t=$('toast');
  t.classList.add('welcome','on');
  $('toastTitle').textContent='Welcome';
  $('toastMsg').innerHTML='Drag the <strong>+ box</strong> to create entries. Scroll to zoom. Click + drag to pan. Use ‚Üê ‚Üí to switch days. Click üßµ to see entry threads.';
  t.querySelector('.toast-icon').textContent='üëã';
  $('toastActs').innerHTML='<button class="toast-btn primary" id="gotItBtn">Got it</button>';
  $('gotItBtn').onclick=()=>{
    hasSeenWelcome=true;
    save();
    t.classList.remove('on');
  };
}

function getPan(){return dayPans[currentDay]||{x:0,y:0}}
function setPan(x,y){dayPans[currentDay]={x,y};save()}
function getZoom(){return dayZooms[currentDay]||1}
function setZoom(z){dayZooms[currentDay]=Math.max(0.25,Math.min(2,z));save()}

function getDayEntries(day){return entries[day]||[]}
function setDayEntries(day,arr){entries[day]=arr;save()}

function getAllEntries(){
  const all=[];
  Object.keys(entries).forEach(day=>{
    entries[day].forEach(e=>all.push({...e,day}));
  });
  return all;
}

function findEntryById(id){
  for(let day in entries){
    const e=entries[day].find(x=>x.id===id);
    if(e)return{...e,day};
  }
  return null;
}

function getThreadEntries(id){
  const entry=findEntryById(id);
  if(!entry)return[];
  
  const thread=[];
  const visited=new Set();
  const queue=[id];
  
  while(queue.length>0){
    const currentId=queue.shift();
    if(visited.has(currentId))continue;
    visited.add(currentId);
    
    const e=findEntryById(currentId);
    if(e)thread.push(e);
    
    if(e&&e.links){
      e.links.forEach(lid=>{
        if(!visited.has(lid))queue.push(lid);
      });
    }
    
    getAllEntries().forEach(other=>{
      if(other.links&&other.links.includes(currentId)&&!visited.has(other.id)){
        queue.push(other.id);
      }
    });
  }
  
  return thread.sort((a,b)=>new Date(a.time)-new Date(b.time));
}

function showThread(id){
  threadEntryId=id;
  const thread=getThreadEntries(id);
  
  if(thread.length<=1){
    toast('No connected entries found','‚ÑπÔ∏è','',1500);
    return;
  }
  
  let html='';
  thread.forEach(e=>{
    const d=new Date(e.time);
    const dateStr=d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    const tags=e.tags.map(t=>`<span class="thread-item-tag">#${t}</span>`).join('');
    html+=`<div class="thread-item" data-id="${e.id}" data-day="${e.day}">
      <div class="thread-item-date">${dateStr}</div>
      <div class="thread-item-text">${esc(e.body)}</div>
      ${tags?`<div class="thread-item-tags">${tags}</div>`:''}
    </div>`;
  });
  
  $('threadBody').innerHTML=html;
  $('threadPanel').classList.add('on');
  
  document.querySelectorAll('.thread-item').forEach(item=>{
    item.onclick=()=>{
      const day=item.dataset.day;
      const id=item.dataset.id;
      if(day!==currentDay){
        switchDay(day);
      }
      selectEntry(id);
      jumpToEntry(id);
      $('threadPanel').classList.remove('on');
    };
  });
  
  highlightThread(thread.map(e=>e.id));
}

function highlightThread(ids){
  document.querySelectorAll('.entry').forEach(el=>{
    if(ids.includes(el.dataset.id)){
      el.classList.add('thread-highlight');
    }
  });
  setTimeout(()=>{
    document.querySelectorAll('.entry').forEach(el=>el.classList.remove('thread-highlight'));
  },3000);
}

function jumpToEntry(id){
  const list=getDayEntries(currentDay);
  const e=list.find(x=>x.id===id);
  if(e){
    const pan=getPan();
    const zoom=getZoom();
    const vw=window.innerWidth,vh=window.innerHeight;
    setPan(-e.x*zoom+vw/2-170*zoom,-e.y*zoom+vh/2-80*zoom);
    applyTransform();
  }
}

function createEntry(body,mood,tags,links,x,y){
  const e={
    id:'e'+Date.now(),
    body:body.trim()||'',
    mood,
    tags:[...tags],
    links:[...links],
    x:Math.round(x),
    y:Math.round(y),
    time:new Date().toISOString()
  };
  const list=getDayEntries(currentDay);
  list.push(e);
  setDayEntries(currentDay,list);
  render();
  selectEntry(e.id);
  startInlineEdit(e.id);
  return e.id;
}

function deleteEntry(id){
  let list=getDayEntries(currentDay);
  list=list.filter(e=>e.id!==id);
  setDayEntries(currentDay,list);
  if(selectedId===id)selectedId=null;
  render();
}

function selectEntry(id){
  selectedId=id;
  document.querySelectorAll('.entry').forEach(el=>
    el.classList.toggle('selected',el.dataset.id===id)
  );
}

function startInlineEdit(id){
  editingId=id;
  const list=getDayEntries(currentDay);
  const e=list.find(x=>x.id===id);
  if(!e)return;
  
  render();
  
  const entryEl=document.querySelector(`.entry[data-id="${id}"]`);
  const textEl=entryEl.querySelector('.entry-text');
  textEl.contentEditable='true';
  textEl.focus();
  
  if(!e.body){
    const range=document.createRange();
    const sel=window.getSelection();
    range.selectNodeContents(textEl);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);
  }
}

function stopInlineEdit(id,shouldSave){
  const list=getDayEntries(currentDay);
  const e=list.find(x=>x.id===id);
  if(!e)return;
  
  const entryEl=document.querySelector(`.entry[data-id="${id}"]`);
  if(!entryEl)return;
  
  const textEl=entryEl.querySelector('.entry-text');
  if(shouldSave){
    e.body=textEl.innerText.trim();
    if(!e.body){
      deleteEntry(id);
      return;
    }
    setDayEntries(currentDay,list);
    toast('Saved','‚úì','',1500);
  }
  
  editingId=null;
  render();
}

function cancelEntry(id){
  const list=getDayEntries(currentDay);
  const e=list.find(x=>x.id===id);
  if(!e)return;
  
  if(!e.body.trim()){
    deleteEntry(id);
  }else{
    editingId=null;
    render();
  }
}

function openDetailsModal(id){
  const list=getDayEntries(currentDay);
  const e=list.find(x=>x.id===id);
  if(!e)return;
  
  editingId=id;
  tempTags=[...e.tags];
  tempLinks=[...(e.links||[])];
  
  document.querySelectorAll('.mood-opt').forEach(el=>{
    el.classList.toggle('selected',el.dataset.mood===e.mood);
  });
  updateTagDisplay();
  updateLinkDisplay();
  $('modalBg').classList.add('on');
}

function findConnections(){
  if(!showConn)return[];
  const list=getDayEntries(currentDay),conns=[];
  for(let i=0;i<list.length;i++){
    for(let j=i+1;j<list.length;j++){
      const a=list[i],b=list[j];
      if(a.tags.some(t=>b.tags.includes(t)))conns.push({from:a.id,to:b.id,type:'tag'});
    }
  }
  list.forEach(e=>{
    if(e.links){
      e.links.forEach(targetId=>{
        const target=list.find(x=>x.id===targetId);
        if(target)conns.push({from:e.id,to:targetId,type:'link'});
        else{
          const targetEntry=findEntryById(targetId);
          if(targetEntry)conns.push({from:e.id,to:targetId,type:'thread'});
        }
      });
    }
  });
  return conns;
}

function changeDay(offset){
  const d=new Date(currentDay);
  d.setDate(d.getDate()+offset);
  const newDay=fmt(d);
  if(isPastOrToday(newDay)){
    switchDay(newDay);
  }
}

function switchDay(day){
  if(!isPastOrToday(day))return;
  currentDay=day;
  selectedId=null;
  editingId=null;
  save();
  updateHeader();
  render();
  applyTransform();
}

function updateHeader(){
  const d=new Date(currentDay);
  const isToday=currentDay===today();
  const dayName=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][d.getDay()];
  $('dayTitle').textContent=isToday?'Today':dayName;
  $('dayDate').textContent=d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  
  const list=getDayEntries(currentDay);
  $('entryCount').textContent=list.length;
  const words=list.reduce((sum,e)=>sum+e.body.split(/\s+/).filter(w=>w).length,0);
  $('wordCount').textContent=words;
  
  renderStreak();
  
  const zoom=getZoom();
  $('zoomInd').textContent=Math.round(zoom*100)+'%';
  
  $('prevDay').classList.remove('disabled');
  const tomorrow=new Date(currentDay);
  tomorrow.setDate(tomorrow.getDate()+1);
  $('nextDay').classList.toggle('disabled',!isPastOrToday(fmt(tomorrow)));
}

function renderStreak(){
  let html='',streak=0;
  const td=today();
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const ds=fmt(d);
    const has=entries[ds]&&entries[ds].length>0;
    if(has)streak++;
    html+=`<span class="streak-dot${has?' on':''}${ds===td?' today':''}"></span>`;
  }
  html+=`<span class="streak-num">${streak}</span>`;
  $('streak').innerHTML=html;
}

function render(){
  const list=getDayEntries(currentDay);
  updateHeader();
  $('connBtn').classList.toggle('on',showConn);
  
  const container=$('entries');
  let html='';
  list.forEach(e=>{
    const mc=MOODS[e.mood]||'';
    const ml=MOOD_LABELS[e.mood]||'';
    const time=new Date(e.time).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const tags=e.tags.map(t=>`<span class="tag">#${esc(t)}</span>`).join('');
    
    const links=(e.links||[]).map(lid=>{
      const target=findEntryById(lid);
      const preview=target?`<div class="link-preview">
        <div class="link-preview-date">${new Date(target.time).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>
        <div class="link-preview-text">${esc(target.body)}</div>
      </div>`:'';
      return`<span class="link" data-target="${lid}">${preview}‚Üí ${lid.slice(0,8)}<button data-unlink="${e.id},${lid}">√ó</button></span>`;
    }).join('');
    
    const isEditing=editingId===e.id;
    const hasThread=(e.links||[]).length>0;
    
    html+=`<div class="entry${selectedId===e.id?' selected':''}${isEditing?' editing':''}" data-id="${e.id}" style="left:${e.x}px;top:${e.y}px">
      <div class="entry-hdr">
        <span class="entry-grip">‚ãÆ‚ãÆ</span>
        <span class="entry-time">${time}</span>
        <div class="entry-acts">
          ${hasThread?`<button class="entry-act thread" data-thread="${e.id}" title="View thread">üßµ</button>`:''}
          <button class="entry-act" data-copy="${e.id}" title="Copy ID">üîó</button>
          <button class="entry-act edit" data-id="${e.id}" title="Edit">‚öô</button>
          <button class="entry-act del" data-id="${e.id}" title="Delete">√ó</button>
        </div>
      </div>
      <div class="entry-body">
        <div class="entry-text" data-id="${e.id}" data-ph="Start typing...">${esc(e.body)}</div>
      </div>
      <div class="entry-foot">
        ${mc?`<div class="mood"><span class="mood-dot" style="background:${mc}"></span>${ml}</div>`:''}
        <div class="tags">${tags}</div>
        ${links?`<div class="links">${links}</div>`:''}
      </div>
      ${isEditing?`<div class="edit-bar">
        <button class="save" data-save="${e.id}">Done</button>
        <button data-cancel="${e.id}">Cancel</button>
      </div>`:''}
    </div>`;
  });
  container.innerHTML=html;
  renderConnections();
  bindEntries();
}

function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}

function renderConnections(){
  const conns=findConnections();
  const list=getDayEntries(currentDay);
  let svg='<defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" class="conn-marker"><path d="M0,0 L0,6 L9,3 z"/></marker></defs>';
  conns.forEach(c=>{
    const a=list.find(e=>e.id===c.from),b=list.find(e=>e.id===c.to);
    if(!a||!b)return;
    const x1=a.x+170,y1=a.y+70,x2=b.x+170,y2=b.y+70;
    const color=c.type==='link'?MOODS.great:c.type==='thread'?MOODS.warning:MOODS.good;
    const marker=c.type==='link'||c.type==='thread'?' marker-end="url(#arrow)"':'';
    const className=c.type==='thread'?'conn thread':'conn';
    if(c.type==='link'||c.type==='thread'){
      svg+=`<path class="${className}" stroke="${color}" d="M${x1},${y1} L${x2},${y2}"${marker}/>`;
    }else{
      const mx=(x1+x2)/2,my=Math.min(y1,y2)-50;
      svg+=`<path class="${className}" stroke="${color}" d="M${x1},${y1} Q${mx},${my} ${x2},${y2}"/>`;
    }
  });
  $('connections').innerHTML=svg;
}

function bindEntries(){
  document.querySelectorAll('.entry').forEach(el=>{
    const id=el.dataset.id;
    const hdr=el.querySelector('.entry-hdr');
    const textEl=el.querySelector('.entry-text');
    
    el.onmousedown=e=>{
      if(e.target.closest('.entry-act')||e.target.closest('.edit-bar'))return;
      selectEntry(id);
    };
    
    let sx,sy,ox,oy;
    hdr.onmousedown=e=>{
      if(e.target.closest('.entry-act'))return;
      e.stopPropagation();
      selectEntry(id);
      const list=getDayEntries(currentDay);
      const en=list.find(x=>x.id===id);
      sx=e.clientX;sy=e.clientY;ox=en.x;oy=en.y;
      el.classList.add('dragging');
      const move=e=>{
        const zoom=getZoom();
        en.x=ox+(e.clientX-sx)/zoom;
        en.y=oy+(e.clientY-sy)/zoom;
        el.style.left=en.x+'px';
        el.style.top=en.y+'px';
        renderConnections();
      };
      const up=()=>{
        el.classList.remove('dragging');
        save();
        document.removeEventListener('mousemove',move);
        document.removeEventListener('mouseup',up);
      };
      document.addEventListener('mousemove',move);
      document.addEventListener('mouseup',up);
    };
    
    if(textEl.contentEditable==='true'){
      textEl.onkeydown=e=>{
        if(e.key==='Escape'){
          e.preventDefault();
          stopInlineEdit(id,true);
        }
      };
    }
  });

  document.querySelectorAll('[data-thread]').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      showThread(btn.dataset.thread);
    };
  });

  document.querySelectorAll('.entry-act.edit').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      openDetailsModal(btn.dataset.id);
    };
  });

  document.querySelectorAll('.entry-act.del').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      if(confirm('Delete this entry?'))deleteEntry(btn.dataset.id);
    };
  });

  document.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      const id=btn.dataset.copy;
      navigator.clipboard.writeText(id).then(()=>toast('ID copied','üìã','',1500));
    };
  });

  document.querySelectorAll('[data-save]').forEach(btn=>{
    btn.onclick=()=>stopInlineEdit(btn.dataset.save,true);
  });

  document.querySelectorAll('[data-cancel]').forEach(btn=>{
    btn.onclick=()=>cancelEntry(btn.dataset.cancel);
  });

  document.querySelectorAll('[data-unlink]').forEach(btn=>{
    btn.onclick=e=>{
      e.stopPropagation();
      const [from,to]=btn.dataset.unlink.split(',');
      const list=getDayEntries(currentDay);
      const entry=list.find(x=>x.id===from);
      if(entry&&entry.links){
        entry.links=entry.links.filter(l=>l!==to);
        setDayEntries(currentDay,list);
        render();
      }
    };
  });

  document.querySelectorAll('.link').forEach(badge=>{
    const target=badge.dataset.target;
    badge.onclick=e=>{
      if(e.target.tagName==='BUTTON')return;
      const targetEntry=findEntryById(target);
      if(targetEntry){
        if(targetEntry.day!==currentDay){
          switchDay(targetEntry.day);
        }
        selectEntry(target);
        jumpToEntry(target);
      }
    };
  });
}

function applyTransform(){
  const pan=getPan();
  const zoom=getZoom();
  $('world').style.transform=`translate(${pan.x}px,${pan.y}px) scale(${zoom})`;
  const bgZoom=zoom*28;
  $('canvasBg').style.backgroundSize=`${bgZoom}px ${bgZoom}px`;
  $('canvasBg').style.transform=`translate(${pan.x%(bgZoom)}px,${pan.y%(bgZoom)}px)`;
}

const canvas=$('canvas');
canvas.onmousedown=e=>{
  if(e.target.closest('.entry')||e.target.closest('.drag-handle')||e.target.closest('.hdr')||e.target.closest('.thread-panel'))return;
  isPanning=true;
  panStart={x:e.clientX,y:e.clientY};
  const pan=getPan();
  panOrigin={x:pan.x,y:pan.y};
  canvas.classList.add('panning');
  selectEntry(null);
};

document.onmousemove=e=>{
  if(isDragging){
    const pan=getPan();
    const zoom=getZoom();
    const preview=$('dragPreview');
    preview.style.left=((e.clientX-pan.x)/zoom-170)+'px';
    preview.style.top=((e.clientY-pan.y)/zoom-70)+'px';
  }else if(isPanning){
    const nx=panOrigin.x+(e.clientX-panStart.x);
    const ny=panOrigin.y+(e.clientY-panStart.y);
    setPan(nx,ny);
    applyTransform();
  }
};

document.onmouseup=e=>{
  if(isDragging){
    isDragging=false;
    $('dragHandle').classList.remove('dragging');
    const preview=$('dragPreview');
    preview.style.display='none';
    const pan=getPan();
    const zoom=getZoom();
    const x=(e.clientX-pan.x)/zoom-170;
    const y=(e.clientY-pan.y)/zoom-70;
    createEntry('',null,[],[],x,y);
  }else if(isPanning){
    isPanning=false;
    canvas.classList.remove('panning');
  }
};

canvas.onwheel=e=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const mouseX=e.clientX-rect.left;
  const mouseY=e.clientY-rect.top;
  
  const pan=getPan();
  const oldZoom=getZoom();
  const delta=e.deltaY>0?-0.1:0.1;
  const newZoom=Math.max(0.25,Math.min(2,oldZoom+delta));
  
  const worldX=(mouseX-pan.x)/oldZoom;
  const worldY=(mouseY-pan.y)/oldZoom;
  
  const newPanX=mouseX-worldX*newZoom;
  const newPanY=mouseY-worldY*newZoom;
  
  setZoom(newZoom);
  setPan(newPanX,newPanY);
  applyTransform();
  updateHeader();
};

const dragHandle=$('dragHandle');
dragHandle.onmousedown=e=>{
  isDragging=true;
  dragHandle.classList.add('dragging');
  const preview=$('dragPreview');
  preview.style.display='block';
  const pan=getPan();
  const zoom=getZoom();
  preview.style.left=((e.clientX-pan.x)/zoom-170)+'px';
  preview.style.top=((e.clientY-pan.y)/zoom-70)+'px';
};

function toggleConn(){
  showConn=!showConn;
  save();render();
}

function autoArrange(){
  const list=getDayEntries(currentDay);
  if(list.length===0)return;
  const cols=Math.ceil(Math.sqrt(list.length));
  const pan=getPan();
  const zoom=getZoom();
  const startX=(-pan.x+100)/zoom,startY=(-pan.y+100)/zoom;
  list.forEach((e,i)=>{
    e.x=startX+(i%cols)*380;
    e.y=startY+Math.floor(i/cols)*220;
  });
  setDayEntries(currentDay,list);
  render();
  toast('Arranged','‚úì','',1500);
}

function closeModal(){$('modalBg').classList.remove('on')}

function updateTagDisplay(){
  const container=$('tagInput');
  let html='';
  tempTags.forEach((t,i)=>{
    html+=`<span class="tag-item">#${esc(t)}<button data-idx="${i}">√ó</button></span>`;
  });
  html+=`<input type="text" id="tagField" placeholder="Add tag...">`;
  container.innerHTML=html;
  
  const field=$('tagField');
  if(field){
    field.onkeydown=e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        const val=field.value.trim().toLowerCase();
        if(val&&!tempTags.includes(val)){
          tempTags.push(val);
          updateTagDisplay();
        }
        field.value='';
      }
    };
  }
  
  container.querySelectorAll('.tag-item button').forEach(btn=>{
    btn.onclick=()=>{
      tempTags.splice(parseInt(btn.dataset.idx),1);
      updateTagDisplay();
    };
  });
}

function updateLinkDisplay(){
  const container=$('linkInput');
  let html='';
  tempLinks.forEach((l,i)=>{
    html+=`<span class="link-item">${l.slice(0,12)}<button data-idx="${i}">√ó</button></span>`;
  });
  html+=`<input type="text" id="linkField" placeholder="Entry ID">`;
  container.innerHTML=html;
  
  const field=$('linkField');
  if(field){
    field.onkeydown=e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        const val=field.value.trim();
        if(val&&!tempLinks.includes(val)){
          const allEntries=getAllEntries();
          if(allEntries.some(e=>e.id===val)){
            tempLinks.push(val);
            updateLinkDisplay();
            field.value='';
          }
        }
      }
    };
  }
  
  container.querySelectorAll('.link-item button').forEach(btn=>{
    btn.onclick=()=>{
      tempLinks.splice(parseInt(btn.dataset.idx),1);
      updateLinkDisplay();
    };
  });
}

$('modalClose').onclick=closeModal;
$('cancelBtn').onclick=closeModal;
$('modalBg').onclick=e=>{if(e.target===$('modalBg'))closeModal()};
$('threadClose').onclick=()=>$('threadPanel').classList.remove('on');

$('saveBtn').onclick=()=>{
  if(!editingId)return;
  const mood=document.querySelector('.mood-opt.selected')?.dataset.mood||null;
  const list=getDayEntries(currentDay);
  const e=list.find(x=>x.id===editingId);
  if(e){
    e.mood=mood;
    e.tags=[...tempTags];
    e.links=[...tempLinks];
    setDayEntries(currentDay,list);
    render();
    toast('Updated','‚úì','',1500);
  }
  closeModal();
};

document.querySelectorAll('.mood-opt').forEach(opt=>{
  opt.onclick=()=>{
    document.querySelectorAll('.mood-opt').forEach(el=>el.classList.remove('selected'));
    opt.classList.add('selected');
  };
});

$('connBtn').onclick=toggleConn;
$('arrangeBtn').onclick=autoArrange;
$('prevDay').onclick=()=>changeDay(-1);
$('nextDay').onclick=()=>changeDay(1);

document.onkeydown=e=>{
  if(e.target.tagName==='TEXTAREA'||e.target.tagName==='INPUT'||e.target.contentEditable==='true')return;
  if(e.key==='c'||e.key==='C')toggleConn();
  if(e.key==='ArrowLeft')changeDay(-1);
  if(e.key==='ArrowRight')changeDay(1);
  if(e.key==='Escape'){
    selectEntry(null);
    closeModal();
    $('threadPanel').classList.remove('on');
    if(editingId)stopInlineEdit(editingId,true);
  }
  if((e.key==='Delete'||e.key==='Backspace')&&selectedId&&!editingId){
    e.preventDefault();
    if(confirm('Delete this entry?'))deleteEntry(selectedId);
  }
};

function seedMockData(){
  if(Object.keys(entries).length>0)return;
  
  const baseTime=Date.now();
  const stockId='e'+(baseTime-20*864e5);
  const stockUpdate1='e'+(baseTime-16*864e5);
  const stockUpdate2='e'+(baseTime-10*864e5);
  const stockPayoff='e'+(baseTime-3*864e5);
  
  const projectStart='e'+(baseTime-19*864e5);
  const projectMilestone='e'+(baseTime-15*864e5);
  const projectBlocker='e'+(baseTime-12*864e5);
  const projectLaunch='e'+(baseTime-5*864e5);
  
  const mockData={
    [-20]:[
      {id:stockId,body:'Looking at $NVDA - AI chip demand is insane. Stock at $880, considering entry. Their H100 GPUs are sold out for months. Datacenters expanding rapidly. Risk: high valuation, competition from AMD.',tags:['stocks','investing','tech'],mood:'good',x:100,y:100,links:[]},
      {id:projectStart,body:'Kicking off the new dashboard redesign project. Goals: improve loading speed by 50%, modernize UI, add dark mode. Team excited. Timeline: 3 weeks.',tags:['work','project','frontend'],mood:'great',x:500,y:100,links:[]}
    ],
    [-19]:[
      {id:'e'+(baseTime-19*864e5+1e5),body:'Morning run felt amazing. 5 miles in 42 minutes - new PR. The endorphins are real. Need to keep this consistent.',tags:['health','personal'],mood:'great',x:200,y:300,links:[]},
      {id:'e'+(baseTime-19*864e5+2e5),body:'Read about the attention mechanism in transformers. The way query, key, value matrices work together is elegant. This is why LLMs can understand context so well.',tags:['learning','ai','tech'],mood:'good',x:600,y:300,links:[]}
    ],
    [-18]:[
      {id:'e'+(baseTime-18*864e5),body:'Team standup - discussed API rate limiting issues. Need to implement exponential backoff. John suggested Redis for caching. Good call.',tags:['work','technical'],mood:'okay',x:150,y:500,links:[]},
      {id:'e'+(baseTime-18*864e5+1e5),body:'Dinner with Emma. Talked about career paths and life goals. She\'s thinking about switching to product management. Interesting perspective on tech leadership.',tags:['personal','social'],mood:'good',x:550,y:500,links:[]}
    ],
    [-17]:[
      {id:'e'+(baseTime-17*864e5),body:'Watched conference talk on distributed systems. CAP theorem makes sense theoretically but the real-world tradeoffs are nuanced. Eventual consistency is harder than it sounds.',tags:['learning','systems','tech'],mood:'good',x:300,y:700,links:[]},
      {id:'e'+(baseTime-17*864e5+1e5),body:'Meditation session - 20 minutes. Mind was racing about work deadlines. Slowly getting better at returning to breath. Progress is gradual.',tags:['personal','wellness'],mood:'okay',x:700,y:700,links:[]}
    ],
    [-16]:[
      {id:stockUpdate1,body:'$NVDA up 8% today to $950! Microsoft and Google announcing massive AI infrastructure spend. Demand looks sustainable. Holding for now. Target: $1100.',tags:['stocks','investing'],mood:'great',x:100,y:900,links:[stockId]},
      {id:'e'+(baseTime-16*864e5+1e5),body:'Code review feedback: my async error handling needs work. Valid criticism. Going to refactor the promise chains into async/await for clarity.',tags:['work','coding','learning'],mood:'okay',x:500,y:900,links:[]}
    ],
    [-15]:[
      {id:projectMilestone,body:'Dashboard project update: New component library integrated! Dark mode toggle working beautifully. Performance testing shows 35% faster load times. On track for deadline.',tags:['work','project','achievement'],mood:'great',x:900,y:100,links:[projectStart]},
      {id:'e'+(baseTime-15*864e5+1e5),body:'Read "Atomic Habits" chapter on habit stacking. The concept of linking new habits to existing routines makes sense. Going to try: after morning coffee ‚Üí 10 min journaling.',tags:['learning','productivity','personal'],mood:'good',x:200,y:300,links:[]}
    ],
    [-14]:[
      {id:'e'+(baseTime-14*864e5),body:'Debugging session from hell. Race condition in the websocket handler caused intermittent failures. Took 4 hours to reproduce. Fixed with mutex lock.',tags:['work','debugging'],mood:'low',x:600,y:300,links:[]},
      {id:'e'+(baseTime-14*864e5+1e5),body:'Evening walk in the park. Clear sunset. Sometimes stepping away from the computer is when the best solutions come to mind.',tags:['personal','reflection'],mood:'good',x:150,y:500,links:[]}
    ],
    [-13]:[
      {id:'e'+(baseTime-13*864e5),body:'Team retrospective - discussed what went well and what didn\'t. Communication gaps identified. Going to try daily async updates on Slack. Culture is improving.',tags:['work','team','process'],mood:'good',x:550,y:500,links:[]},
      {id:'e'+(baseTime-13*864e5+1e5),body:'Started learning Rust. The borrow checker is brutal but I can see why it prevents memory bugs. Fighting the compiler but learning a lot.',tags:['learning','programming'],mood:'okay',x:300,y:700,links:[]}
    ],
    [-12]:[
      {id:projectBlocker,body:'Dashboard project BLOCKER: Safari rendering bug with CSS grid. Only shows up on iOS 16+. Spent all day trying different fixes. Frustrating. May need polyfill.',tags:['work','project','bug'],mood:'low',x:700,y:700,links:[projectStart,projectMilestone]},
      {id:'e'+(baseTime-12*864e5+1e5),body:'Workout: strength training. Deadlifts felt strong - hit 225lbs for 5 reps. Form is improving. Consistency paying off.',tags:['health','fitness'],mood:'great',x:100,y:900,links:[]}
    ],
    [-11]:[
      {id:'e'+(baseTime-11*864e5),body:'Morning pages - just writing stream of consciousness. Feeling anxious about the project deadline. Need to trust the process and the team.',tags:['personal','reflection'],mood:'okay',x:500,y:900,links:[]},
      {id:'e'+(baseTime-11*864e5+1e5),body:'Coffee with Marcus. He shared his experience transitioning from IC to manager. Key insight: it\'s about multiplying impact through others, not doing more yourself.',tags:['career','learning','social'],mood:'good',x:900,y:100,links:[]}
    ],
    [-10]:[
      {id:stockUpdate2,body:'$NVDA correction - down to $920. Market rotation into value stocks. Not worried, fundamentals haven\'t changed. AI spending cycle just starting. Diamond hands.',tags:['stocks','investing'],mood:'okay',x:200,y:300,links:[stockId,stockUpdate1]},
      {id:'e'+(baseTime-10*864e5+1e5),body:'Fixed the Safari bug! Turns out it was a flexbox compatibility issue, not grid. Used a different layout approach. Dashboard looks perfect across all browsers now.',tags:['work','project','technical'],mood:'great',x:600,y:300,links:[projectBlocker]}
    ],
    [-9]:[
      {id:'e'+(baseTime-9*864e5),body:'Read paper on attention mechanisms in vision transformers. The self-attention layer is doing similar things as CNNs but with global receptive fields. Fascinating.',tags:['learning','ai','research'],mood:'good',x:150,y:500,links:[]},
      {id:'e'+(baseTime-9*864e5+1e5),body:'Grocery shopping and meal prep for the week. Made chicken stir-fry and overnight oats. Small wins that make weekdays easier.',tags:['personal','health'],mood:'okay',x:550,y:500,links:[]}
    ],
    [-8]:[
      {id:'e'+(baseTime-8*864e5),body:'Late night coding session. Sometimes the focus is just better after everyone else is asleep. Finished the authentication refactor. Clean code feels good.',tags:['work','coding','focus'],mood:'good',x:300,y:700,links:[]},
      {id:'e'+(baseTime-8*864e5+1e5),body:'Watched documentary on the 2008 financial crisis. The level of systemic risk was insane. Makes me think differently about current market dynamics.',tags:['learning','finance','investing'],mood:'okay',x:700,y:700,links:[]}
    ],
    [-7]:[
      {id:'e'+(baseTime-7*864e5),body:'Stand-up meeting: Discussed handoff process for the dashboard. Documentation needs to be better. Creating comprehensive README with screenshots.',tags:['work','project','documentation'],mood:'good',x:100,y:900,links:[projectStart]},
      {id:'e'+(baseTime-7*864e5+1e5),body:'Phone call with Mom. She\'s doing well. Reminded me to slow down and not get too caught up in work. Good perspective check.',tags:['personal','family'],mood:'good',x:500,y:900,links:[]}
    ],
    [-6]:[
      {id:'e'+(baseTime-6*864e5),body:'Meditation getting easier. 25 minutes today and actually felt present. The resistance is lessening. Building the habit slowly.',tags:['personal','wellness','mindfulness'],mood:'great',x:900,y:100,links:[]},
      {id:'e'+(baseTime-6*864e5+1e5),body:'Code review for Sarah\'s PR. Really solid work on the state management refactor. Left detailed feedback. Mentoring junior devs is rewarding.',tags:['work','mentoring','team'],mood:'good',x:200,y:300,links:[]}
    ],
    [-5]:[
      {id:projectLaunch,body:'DASHBOARD LAUNCHED! Users love the new dark mode and speed improvements. 67% faster load time achieved. CEO sent a thank you email. Team celebration tomorrow. This is what we worked for.',tags:['work','project','achievement','milestone'],mood:'great',x:600,y:300,links:[projectStart,projectMilestone,projectBlocker]},
      {id:'e'+(baseTime-5*864e5+1e5),body:'Celebrated launch with the team. Pizza and beer. These are the moments that make the hard work worth it. Great team chemistry.',tags:['work','team','social','celebration'],mood:'great',x:150,y:500,links:[projectLaunch]}
    ],
    [-4]:[
      {id:'e'+(baseTime-4*864e5),body:'Post-launch monitoring. A few edge case bugs reported but nothing major. Users giving positive feedback on HN. Feels good to ship something people actually use.',tags:['work','project','feedback'],mood:'good',x:550,y:500,links:[projectLaunch]},
      {id:'e'+(baseTime-4*864e5+1e5),body:'Long walk to clear my head after intense sprint. Realized I need better work-life balance. Going to set boundaries on evening work.',tags:['personal','reflection','health'],mood:'okay',x:300,y:700,links:[]}
    ],
    [-3]:[
      {id:stockPayoff,body:'$NVDA earnings beat! Stock surging to $1,150. Up 31% on my position. This is why you do the research and hold through volatility. Taking partial profits, letting the rest ride.',tags:['stocks','investing','achievement'],mood:'great',x:700,y:700,links:[stockId,stockUpdate1,stockUpdate2]},
      {id:'e'+(baseTime-3*864e5+1e5),body:'Weekend project: building a CLI tool to automate my deployment workflow. Rust is starting to click. The compiler errors are actually helpful.',tags:['personal','coding','learning'],mood:'good',x:100,y:900,links:[]}
    ],
    [-2]:[
      {id:'e'+(baseTime-2*864e5),body:'Quarterly review prep. Need to document the dashboard project impact, the infrastructure improvements, and the mentoring work. Building a strong case for promotion.',tags:['career','work','planning'],mood:'good',x:500,y:900,links:[projectLaunch]},
      {id:'e'+(baseTime-2*864e5+1e5),body:'Gym session: new PR on squat - 275lbs. Form felt solid. Progressive overload is working. Consistency beats intensity.',tags:['health','fitness','achievement'],mood:'great',x:900,y:100,links:[]}
    ],
    [-1]:[
      {id:'e'+(baseTime-1*864e5),body:'Reading "Designing Data-Intensive Applications" - chapter on replication. The tradeoffs between consistency and availability make so much more sense now.',tags:['learning','systems','tech'],mood:'good',x:200,y:300,links:[]},
      {id:'e'+(baseTime-1*864e5+1e5),body:'Sunday meal prep and reflection. This week was intense but productive. Launch went well, stock investment paying off, fitness improving. Momentum is building.',tags:['personal','reflection','planning'],mood:'great',x:600,y:300,links:[projectLaunch,stockPayoff]}
    ],
    [0]:[
      {id:'e'+baseTime,body:'New week, new goals. Going to focus on: 1) Knowledge sharing from dashboard project, 2) Exploring new AI research, 3) Maintaining the fitness and meditation streak.',tags:['planning','personal','work'],mood:'good',x:150,y:500,links:[]},
      {id:'e'+(baseTime+1e5),body:'Interesting conversation with the team about technical debt. We need to allocate 20% of sprint capacity to refactoring. Prevention is cheaper than cure.',tags:['work','technical','team'],mood:'good',x:550,y:500,links:[]},
      {id:'e'+(baseTime+2e5),body:'Lunch with colleague about career growth. His advice: focus on projects with high visibility and clear business impact. Make your wins known.',tags:['career','learning','social'],mood:'good',x:300,y:700,links:[]}
    ]
  };
  
  Object.keys(mockData).forEach(dayOffset=>{
    const d=new Date();
    d.setDate(d.getDate()+parseInt(dayOffset));
    const day=fmt(d);
    const dayEntries=mockData[dayOffset];
    
    dayEntries.forEach(mock=>{
      const time=new Date(d);
      time.setHours(9+Math.floor(Math.random()*12),Math.floor(Math.random()*60),0,0);
      
      const e={
        id:mock.id,
        body:mock.body,
        mood:mock.mood,
        tags:mock.tags,
        links:mock.links||[],
        x:mock.x,
        y:mock.y,
        time:time.toISOString()
      };
      
      if(!entries[day])entries[day]=[];
      entries[day].push(e);
    });
  });
  
  save();
}

load();
seedMockData();
if(!currentDay)currentDay=today();
updateHeader();
render();
applyTransform();

if(!hasSeenWelcome){
  setTimeout(showWelcome,600);
}
</script>
</body>
</html>