<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pulsar ‚Äî Journal</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-base: oklch(0.13 0.015 280);
      --bg-raised: oklch(0.16 0.015 280);
      --bg-surface: oklch(0.19 0.015 280);
      --bg-overlay: oklch(0.22 0.015 280);
      --bg-hover: oklch(0.24 0.015 280);
      --bg-active: oklch(0.27 0.015 280);
      --text-primary: oklch(0.95 0.005 280);
      --text-secondary: oklch(0.68 0.01 280);
      --text-tertiary: oklch(0.50 0.01 280);
      --text-muted: oklch(0.38 0.01 280);
      --accent-blue: oklch(0.65 0.16 255);
      --accent-purple: oklch(0.60 0.18 290);
      --accent-gradient: linear-gradient(135deg, oklch(0.60 0.18 290), oklch(0.65 0.16 255));
      --color-success: oklch(0.65 0.17 155);
      --color-warning: oklch(0.72 0.16 70);
      --color-error: oklch(0.60 0.20 25);
      --mood-great: oklch(0.70 0.17 155);
      --mood-good: oklch(0.68 0.14 175);
      --mood-okay: oklch(0.70 0.13 85);
      --mood-low: oklch(0.65 0.14 50);
      --mood-bad: oklch(0.58 0.18 25);
      --border-subtle: oklch(0.25 0.01 280);
      --border-default: oklch(0.30 0.01 280);
      --border-strong: oklch(0.35 0.01 280);
      --shadow-sm: 0 1px 2px oklch(0 0 0 / 0.3);
      --shadow-md: 0 4px 12px oklch(0 0 0 / 0.4);
      --shadow-lg: 0 8px 28px oklch(0 0 0 / 0.5);
      --shadow-glow-purple: 0 0 20px oklch(0.60 0.18 290 / 0.15);
      --font-display: 'Space Grotesk', system-ui, sans-serif;
      --font-body: 'Inter', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --sp-1: 4px; --sp-2: 8px; --sp-3: 12px; --sp-4: 16px;
      --sp-5: 20px; --sp-6: 24px; --sp-8: 32px; --sp-10: 40px;
      --sp-12: 48px; --sp-16: 64px;
      --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px;
      --radius-xl: 16px; --radius-2xl: 20px;
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --duration-fast: 150ms; --duration-normal: 250ms; --duration-slow: 400ms;
    }

    html, body {
      width: 100%; height: 100%; background: var(--bg-base);
      color: var(--text-primary); font-family: var(--font-body);
      font-size: 14px; line-height: 1.5; overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }

    .journal-app { display: flex; flex-direction: column; height: 100vh; max-width: 1280px; margin: 0 auto; }

    /* ============ TOP BAR ============ */
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 var(--sp-8); border-bottom: 1px solid var(--border-subtle);
      background: oklch(0.13 0.015 280 / 0.85); backdrop-filter: blur(20px);
      position: sticky; top: 0; z-index: 100; height: 56px; flex-shrink: 0;
    }
    .topbar-left { display: flex; align-items: center; gap: var(--sp-5); }
    .brand { display: flex; align-items: center; gap: var(--sp-3); }
    .brand-icon {
      width: 28px; height: 28px; background: var(--accent-gradient);
      border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow-glow-purple);
    }
    .brand-icon svg { width: 16px; height: 16px; }
    .brand-name { font-family: var(--font-display); font-size: 16px; font-weight: 700; letter-spacing: -0.03em; }
    .topbar-divider { width: 1px; height: 20px; background: var(--border-subtle); }
    .topbar-page { font-family: var(--font-display); font-size: 14px; font-weight: 600; color: var(--text-secondary); }

    .topbar-right { display: flex; align-items: center; gap: var(--sp-3); }
    .search-pill {
      display: flex; align-items: center; gap: var(--sp-2);
      padding: var(--sp-2) var(--sp-4); background: var(--bg-surface);
      border: 1px solid var(--border-subtle); border-radius: 100px;
      width: 260px; transition: all var(--duration-fast) var(--ease-out);
    }
    .search-pill:focus-within { border-color: var(--accent-purple); background: var(--bg-overlay); width: 320px; }
    .search-pill svg { width: 14px; height: 14px; color: var(--text-tertiary); flex-shrink: 0; }
    .search-pill input { background: none; border: none; outline: none; color: var(--text-primary); font-family: var(--font-body); font-size: 13px; width: 100%; }
    .search-pill input::placeholder { color: var(--text-muted); }
    .search-pill kbd { font-family: var(--font-mono); font-size: 10px; padding: 1px 5px; background: var(--bg-active); border-radius: 3px; color: var(--text-muted); }

    .icon-btn {
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      border: none; background: transparent; color: var(--text-tertiary);
      border-radius: var(--radius-md); cursor: pointer; transition: all var(--duration-fast) var(--ease-out);
    }
    .icon-btn:hover { background: var(--bg-surface); color: var(--text-primary); }
    .icon-btn svg { width: 16px; height: 16px; }

    /* ============ PAGES ============ */
    .page { display: none; flex: 1; overflow-y: auto; }
    .page.active { display: flex; flex-direction: column; }

    /* ============ DASHBOARD ============ */
    .dashboard { padding: var(--sp-6) var(--sp-8); display: flex; flex-direction: column; gap: var(--sp-6); }

    /* ---- TOP ROW: Add + Stats ---- */
    .top-row {
      display: flex; align-items: stretch; gap: var(--sp-5);
    }

    /* Add Button */
    .add-block {
      width: 80px; height: 80px; flex-shrink: 0;
      background: var(--bg-raised); border: 2px dashed var(--border-default);
      border-radius: var(--radius-xl); display: flex;
      align-items: center; justify-content: center;
      cursor: pointer; transition: all var(--duration-normal) var(--ease-out);
      position: relative; overflow: hidden;
    }
    .add-block::before {
      content: ''; position: absolute; inset: 0;
      background: radial-gradient(circle at center, oklch(0.60 0.18 290 / 0.08) 0%, transparent 70%);
      opacity: 0; transition: opacity var(--duration-normal) var(--ease-out);
    }
    .add-block:hover {
      border-color: var(--accent-purple); border-style: solid;
      background: oklch(0.18 0.02 280); transform: translateY(-1px);
      box-shadow: var(--shadow-glow-purple);
    }
    .add-block:hover::before { opacity: 1; }
    .add-block:active { transform: translateY(0); }

    .add-plus {
      width: 40px; height: 40px; border-radius: 50%;
      background: oklch(0.60 0.18 290 / 0.10);
      border: 1.5px solid oklch(0.60 0.18 290 / 0.25);
      display: flex; align-items: center; justify-content: center;
      transition: all var(--duration-normal) var(--ease-spring);
      z-index: 1;
    }
    .add-block:hover .add-plus {
      transform: scale(1.1);
      background: oklch(0.60 0.18 290 / 0.16);
      border-color: oklch(0.60 0.18 290 / 0.45);
      box-shadow: 0 0 16px oklch(0.60 0.18 290 / 0.2);
    }
    .add-plus svg { width: 20px; height: 20px; stroke: var(--accent-purple); stroke-width: 2; }

    /* Stats Row */
    .stats-row {
      flex: 1; display: flex; align-items: stretch; gap: var(--sp-3);
      background: var(--bg-raised); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl); padding: var(--sp-4) var(--sp-5);
    }

    .stat-item {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 2px;
    }
    .stat-item + .stat-item { border-left: 1px solid var(--border-subtle); }
    .stat-val {
      font-family: var(--font-display); font-size: 22px; font-weight: 700;
      letter-spacing: -0.03em; background: var(--accent-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      line-height: 1.2;
    }
    .stat-lbl { font-size: 10px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }

    .stat-divider { width: 1px; background: var(--border-subtle); margin: var(--sp-1) 0; }

    .week-tracker {
      flex: 0 0 auto; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: var(--sp-1);
      padding-left: var(--sp-4); border-left: 1px solid var(--border-subtle);
      min-width: 100px;
    }
    .week-label { font-size: 10px; color: var(--text-muted); font-family: var(--font-mono); }
    .week-dots { display: flex; gap: 4px; }
    .week-dot {
      width: 10px; height: 10px; border-radius: 3px;
      background: var(--bg-surface); transition: all var(--duration-fast) var(--ease-out);
    }
    .week-dot.active { background: var(--accent-purple); box-shadow: 0 0 6px oklch(0.60 0.18 290 / 0.3); }
    .week-dot.today { border: 1px solid var(--accent-blue); }

    /* ---- MAIN AREA: Entries + Sidebar ---- */
    .main-area {
      display: grid; grid-template-columns: 1fr 300px; gap: var(--sp-6);
      flex: 1;
    }

    /* Entries */
    .entries-section { display: flex; flex-direction: column; gap: var(--sp-4); }

    .entries-header {
      display: flex; align-items: center; justify-content: space-between;
    }
    .entries-title {
      font-family: var(--font-display); font-size: 15px; font-weight: 600;
      color: var(--text-secondary); display: flex; align-items: center; gap: var(--sp-2);
    }
    .entries-title svg { width: 15px; height: 15px; color: var(--accent-purple); }

    .entries-tabs {
      display: flex; gap: 2px; padding: 3px;
      background: var(--bg-surface); border-radius: var(--radius-md);
    }
    .etab {
      padding: var(--sp-1) var(--sp-3); background: transparent; border: none;
      border-radius: var(--radius-sm); color: var(--text-tertiary);
      font-family: var(--font-display); font-size: 12px; font-weight: 500;
      cursor: pointer; transition: all var(--duration-fast) var(--ease-out);
    }
    .etab.active { background: var(--bg-overlay); color: var(--text-primary); }
    .etab:hover:not(.active) { color: var(--text-secondary); }

    .entries-list { display: flex; flex-direction: column; gap: var(--sp-3); }

    .entry-card {
      padding: var(--sp-5); background: var(--bg-raised);
      border: 1px solid var(--border-subtle); border-radius: var(--radius-lg);
      cursor: pointer; transition: all var(--duration-normal) var(--ease-out);
    }
    .entry-card:hover {
      border-color: var(--border-default); background: var(--bg-surface);
      transform: translateY(-1px); box-shadow: var(--shadow-sm);
    }
    .ec-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--sp-2); }
    .ec-meta { display: flex; align-items: center; gap: var(--sp-3); }
    .ec-mood { font-size: 16px; }
    .ec-date { font-family: var(--font-mono); font-size: 11px; color: var(--text-tertiary); }
    .ec-actions { display: flex; gap: var(--sp-1); opacity: 0; transition: opacity var(--duration-fast); }
    .entry-card:hover .ec-actions { opacity: 1; }
    .ec-action {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      background: transparent; border: none; color: var(--text-tertiary);
      border-radius: var(--radius-sm); cursor: pointer; transition: all var(--duration-fast);
    }
    .ec-action:hover { background: var(--bg-active); color: var(--text-primary); }
    .ec-action.del:hover { color: var(--color-error); }
    .ec-action svg { width: 13px; height: 13px; }
    .ec-title { font-family: var(--font-display); font-size: 15px; font-weight: 600; letter-spacing: -0.01em; margin-bottom: 2px; }
    .ec-preview { font-size: 13px; color: var(--text-secondary); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .ec-tags { display: flex; gap: var(--sp-1); margin-top: var(--sp-2); flex-wrap: wrap; }
    .ec-tag { padding: 2px 8px; font-size: 10px; font-weight: 500; color: var(--text-tertiary); background: var(--bg-active); border-radius: 100px; }

    /* Sidebar */
    .sidebar { display: flex; flex-direction: column; gap: var(--sp-5); }

    .side-block {
      background: var(--bg-raised); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-xl); overflow: hidden;
    }
    .sb-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--sp-4) var(--sp-5); border-bottom: 1px solid var(--border-subtle);
    }
    .sb-title {
      font-family: var(--font-display); font-size: 13px; font-weight: 600;
      display: flex; align-items: center; gap: var(--sp-2); color: var(--text-secondary);
    }
    .sb-title svg { width: 14px; height: 14px; color: var(--accent-purple); }
    .sb-body { padding: var(--sp-4) var(--sp-5); }

    /* Mood Chart */
    .mood-chart { display: flex; align-items: flex-end; gap: var(--sp-2); height: 72px; }
    .mb-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .mb-bar { width: 100%; border-radius: 3px 3px 0 0; min-height: 3px; transition: height var(--duration-slow) var(--ease-spring); }
    .mb-bar:hover { opacity: 0.8; }
    .mb-lbl { font-family: var(--font-mono); font-size: 9px; color: var(--text-muted); }
    .mood-legend { display: flex; gap: var(--sp-3); margin-top: var(--sp-3); padding-top: var(--sp-3); border-top: 1px solid var(--border-subtle); flex-wrap: wrap; }
    .ml-item { display: flex; align-items: center; gap: 3px; font-size: 10px; color: var(--text-tertiary); }
    .ml-dot { width: 6px; height: 6px; border-radius: 50%; }

    /* Tags */
    .tags-cloud { display: flex; flex-wrap: wrap; gap: var(--sp-2); }
    .cloud-tag {
      padding: 3px var(--sp-3); background: var(--bg-surface);
      border: 1px solid var(--border-subtle); border-radius: 100px;
      font-size: 11px; color: var(--text-secondary); cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }
    .cloud-tag:hover { border-color: var(--accent-purple); color: var(--accent-purple); background: oklch(0.60 0.18 290 / 0.08); }
    .cloud-tag .tc { font-family: var(--font-mono); font-size: 9px; color: var(--text-muted); margin-left: 3px; }

    /* Related Entries */
    .related-entry {
      display: flex; align-items: center; gap: var(--sp-3);
      padding: var(--sp-3); border-radius: var(--radius-md);
      cursor: pointer; transition: all var(--duration-fast) var(--ease-out);
    }
    .related-entry:hover { background: var(--bg-surface); }
    .related-entry + .related-entry { margin-top: var(--sp-2); }
    .re-mood { font-size: 14px; }
    .re-info { flex: 1; min-width: 0; }
    .re-title { font-family: var(--font-display); font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .re-date { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); }
    .re-match {
      font-size: 9px; font-weight: 600; padding: 2px 6px;
      border-radius: 100px; background: oklch(0.60 0.18 290 / 0.10);
      color: var(--accent-purple); flex-shrink: 0;
    }

    /* ============ ENTRY DETAIL PAGE ============ */
    .detail-page { animation: pageFadeIn var(--duration-slow) var(--ease-out); }

    .detail-bar {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--sp-4) var(--sp-8); border-bottom: 1px solid var(--border-subtle);
      position: sticky; top: 56px; z-index: 50;
      background: oklch(0.13 0.015 280 / 0.9); backdrop-filter: blur(16px);
    }
    .back-btn {
      display: flex; align-items: center; gap: var(--sp-2);
      padding: var(--sp-2) var(--sp-3); background: var(--bg-surface);
      border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
      color: var(--text-secondary); font-family: var(--font-display);
      font-size: 13px; font-weight: 500; cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }
    .back-btn:hover { background: var(--bg-overlay); color: var(--text-primary); border-color: var(--border-default); }
    .back-btn svg { width: 15px; height: 15px; }

    .detail-actions { display: flex; gap: var(--sp-2); }
    .da-btn {
      display: flex; align-items: center; gap: var(--sp-2);
      padding: var(--sp-2) var(--sp-4); background: var(--bg-surface);
      border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
      color: var(--text-secondary); font-size: 13px; font-weight: 500;
      font-family: var(--font-display); cursor: pointer;
      transition: all var(--duration-fast) var(--ease-out);
    }
    .da-btn:hover { background: var(--bg-overlay); color: var(--text-primary); border-color: var(--border-default); }
    .da-btn.del:hover { color: var(--color-error); border-color: oklch(0.60 0.20 25 / 0.4); }
    .da-btn svg { width: 14px; height: 14px; }

    .detail-grid {
      display: grid; grid-template-columns: 1fr 280px;
      max-width: 1080px; margin: 0 auto; padding: var(--sp-10) var(--sp-8) var(--sp-16);
      gap: var(--sp-10);
    }

    .detail-main {}
    .d-meta { display: flex; align-items: center; gap: var(--sp-4); margin-bottom: var(--sp-6); }
    .d-mood {
      font-size: 32px; width: 52px; height: 52px;
      background: var(--bg-surface); border-radius: var(--radius-lg);
      display: flex; align-items: center; justify-content: center;
      border: 1px solid var(--border-subtle);
    }
    .d-meta-text { display: flex; flex-direction: column; gap: 2px; }
    .d-date { font-family: var(--font-display); font-size: 14px; font-weight: 500; color: var(--text-secondary); }
    .d-words { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); }
    .d-title { font-family: var(--font-display); font-size: 32px; font-weight: 700; letter-spacing: -0.03em; line-height: 1.2; margin-bottom: var(--sp-6); }
    .d-body { font-size: 15px; line-height: 1.85; color: var(--text-secondary); white-space: pre-wrap; }
    .d-tags { display: flex; gap: var(--sp-2); margin-top: var(--sp-8); padding-top: var(--sp-5); border-top: 1px solid var(--border-subtle); flex-wrap: wrap; }
    .d-tag { padding: 3px var(--sp-3); background: oklch(0.60 0.18 290 / 0.10); color: var(--accent-purple); border-radius: 100px; font-size: 12px; font-weight: 500; }

    .detail-sidebar { display: flex; flex-direction: column; gap: var(--sp-5); }

    /* ============ COMPOSER MODAL ============ */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: oklch(0 0 0 / 0.6); backdrop-filter: blur(8px);
      z-index: 1000; justify-content: center; align-items: center;
      padding: var(--sp-8);
    }
    .modal-overlay.open { display: flex; animation: fadeIn var(--duration-normal) var(--ease-out); }
    .modal {
      background: var(--bg-raised); border: 1px solid var(--border-default);
      border-radius: var(--radius-2xl); width: 100%; max-width: 680px;
      max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-lg);
      animation: modalSlide var(--duration-slow) var(--ease-spring);
    }
    .m-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--sp-4) var(--sp-6); border-bottom: 1px solid var(--border-subtle);
      position: sticky; top: 0; background: var(--bg-raised); z-index: 1;
    }
    .m-header-left { display: flex; align-items: center; gap: var(--sp-4); }
    .m-body { padding: var(--sp-6) var(--sp-8) var(--sp-8); }

    .c-date { font-family: var(--font-mono); font-size: 12px; color: var(--text-tertiary); padding: var(--sp-1) var(--sp-3); background: var(--bg-surface); border-radius: var(--radius-sm); }
    .mood-sel { display: flex; align-items: center; gap: var(--sp-2); }
    .mood-sel label { font-size: 12px; color: var(--text-tertiary); }
    .mood-btn {
      width: 30px; height: 30px; border: 2px solid transparent; border-radius: 50%;
      cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center;
      background: var(--bg-surface); transition: all var(--duration-fast) var(--ease-spring);
    }
    .mood-btn:hover { transform: scale(1.2); }
    .mood-btn.active { border-color: var(--accent-purple); background: var(--bg-overlay); transform: scale(1.15); }

    .c-title {
      width: 100%; background: none; border: none; outline: none;
      font-family: var(--font-display); font-size: 26px; font-weight: 700;
      color: var(--text-primary); letter-spacing: -0.03em; margin-bottom: var(--sp-3);
    }
    .c-title::placeholder { color: var(--text-muted); }
    .c-body {
      width: 100%; min-height: 180px; background: none; border: none; outline: none;
      color: var(--text-primary); font-family: var(--font-body); font-size: 15px;
      line-height: 1.8; resize: vertical;
    }
    .c-body::placeholder { color: var(--text-muted); }

    .c-footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--sp-4) var(--sp-6); border-top: 1px solid var(--border-subtle);
    }
    .c-footer-left { display: flex; align-items: center; gap: var(--sp-3); }
    .tag-wrap { display: flex; align-items: center; gap: var(--sp-2); flex-wrap: wrap; }
    .tag-chip {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 2px 10px; background: oklch(0.60 0.18 290 / 0.12);
      color: var(--accent-purple); border-radius: 100px; font-size: 12px; font-weight: 500;
    }
    .tag-chip .rx { cursor: pointer; opacity: 0.6; font-size: 13px; }
    .tag-chip .rx:hover { opacity: 1; }
    .tag-in {
      background: none; border: none; outline: none; color: var(--text-primary);
      font-family: var(--font-body); font-size: 12px; width: 72px;
    }
    .tag-in::placeholder { color: var(--text-muted); }
    .wc { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); }
    .save-btn {
      padding: var(--sp-2) var(--sp-5); background: var(--accent-gradient);
      color: white; border: none; border-radius: var(--radius-md);
      font-family: var(--font-display); font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all var(--duration-fast) var(--ease-out);
    }
    .save-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-glow-purple); }
    .save-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    /* ============ EMPTY ============ */
    .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--sp-16) var(--sp-8); text-align: center; }
    .empty-icon { width: 56px; height: 56px; background: var(--bg-surface); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; margin-bottom: var(--sp-4); }
    .empty-icon svg { width: 24px; height: 24px; color: var(--text-muted); }
    .empty h3 { font-family: var(--font-display); font-size: 16px; font-weight: 600; margin-bottom: var(--sp-1); }
    .empty p { font-size: 13px; color: var(--text-tertiary); max-width: 260px; }

    /* ============ TOAST ============ */
    .toast-box { position: fixed; bottom: var(--sp-6); right: var(--sp-6); z-index: 2000; display: flex; flex-direction: column; gap: var(--sp-2); }
    .toast { padding: var(--sp-3) var(--sp-5); background: var(--bg-overlay); border: 1px solid var(--border-default); border-radius: var(--radius-lg); font-size: 13px; color: var(--text-primary); box-shadow: var(--shadow-lg); animation: toastIn var(--duration-normal) var(--ease-spring); display: flex; align-items: center; gap: var(--sp-2); }
    .toast.out { animation: toastOut var(--duration-fast) var(--ease-out) forwards; }

    /* ============ ANIMATIONS ============ */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modalSlide { from { opacity: 0; transform: translateY(16px) scale(0.97); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(20px); } }
    @keyframes entryIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pageFadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 900px) {
      .main-area { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .detail-grid { grid-template-columns: 1fr; }
      .detail-sidebar { display: none; }
    }
    @media (max-width: 640px) {
      .dashboard { padding: var(--sp-4); }
      .top-row { flex-wrap: wrap; }
      .search-pill { width: 180px; }
      .topbar { padding: 0 var(--sp-4); }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
    }
  </style>
</head>
<body>
  <div class="journal-app">
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand">
          <div class="brand-icon"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></div>
          <span class="brand-name">Pulsar</span>
        </div>
        <div class="topbar-divider"></div>
        <span class="topbar-page" id="topbarPage">Journal</span>
      </div>
      <div class="topbar-right">
        <div class="search-pill">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input type="text" placeholder="Search entries..." id="searchInput">
          <kbd>‚åòK</kbd>
        </div>
      </div>
    </header>

    <!-- DASHBOARD PAGE -->
    <div class="page dashboard active" id="dashPage">
      <!-- Top Row: Add + Stats -->
      <div class="top-row">
        <div class="add-block" onclick="openComposer()">
          <div class="add-plus">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
          </div>
        </div>
        <div class="stats-row">
          <div class="stat-item"><div class="stat-val" id="sTotal">0</div><div class="stat-lbl">Entries</div></div>
          <div class="stat-item"><div class="stat-val" id="sStreak">0</div><div class="stat-lbl">Streak</div></div>
          <div class="stat-item"><div class="stat-val" id="sWords">0</div><div class="stat-lbl">Words</div></div>
          <div class="stat-item"><div class="stat-val" id="sAvg">0</div><div class="stat-lbl">Avg</div></div>
          <div class="week-tracker">
            <div class="week-dots" id="weekDots"></div>
            <span class="week-label" id="weekLabel">0/7</span>
          </div>
        </div>
      </div>

      <!-- Main: Entries + Sidebar -->
      <div class="main-area">
        <div class="entries-section">
          <div class="entries-header">
            <h2 class="entries-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
              Past Entries
            </h2>
            <div class="entries-tabs">
              <button class="etab active" data-f="all">All</button>
              <button class="etab" data-f="week">Week</button>
              <button class="etab" data-f="month">Month</button>
            </div>
          </div>
          <div class="entries-list" id="entriesList"></div>
        </div>

        <div class="sidebar">
          <!-- Mood -->
          <div class="side-block">
            <div class="sb-header">
              <h3 class="sb-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg> Mood</h3>
              <span style="font-size:10px;color:var(--text-muted);">7d</span>
            </div>
            <div class="sb-body">
              <div class="mood-chart" id="moodChart"></div>
              <div class="mood-legend">
                <div class="ml-item"><div class="ml-dot" style="background:var(--mood-great)"></div>Great</div>
                <div class="ml-item"><div class="ml-dot" style="background:var(--mood-good)"></div>Good</div>
                <div class="ml-item"><div class="ml-dot" style="background:var(--mood-okay)"></div>Okay</div>
                <div class="ml-item"><div class="ml-dot" style="background:var(--mood-low)"></div>Low</div>
                <div class="ml-item"><div class="ml-dot" style="background:var(--mood-bad)"></div>Bad</div>
              </div>
            </div>
          </div>
          <!-- Tags -->
          <div class="side-block">
            <div class="sb-header"><h3 class="sb-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/></svg> Tags</h3></div>
            <div class="sb-body"><div class="tags-cloud" id="tagsCloud"></div></div>
          </div>
          <!-- Related -->
          <div class="side-block">
            <div class="sb-header"><h3 class="sb-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Related</h3></div>
            <div class="sb-body" id="relatedList"><span style="font-size:12px;color:var(--text-muted);">Select an entry to see related</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- DETAIL PAGE -->
    <div class="page detail-page" id="detailPage">
      <div class="detail-bar">
        <button class="back-btn" onclick="goBack()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          Back
        </button>
        <div class="detail-actions">
          <button class="da-btn" onclick="editDetail()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg> Edit</button>
          <button class="da-btn del" onclick="deleteDetail()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg> Delete</button>
        </div>
      </div>
      <div class="detail-grid">
        <div class="detail-main">
          <div class="d-meta">
            <div class="d-mood" id="dMood"></div>
            <div class="d-meta-text">
              <span class="d-date" id="dDate"></span>
              <span class="d-words" id="dWords"></span>
            </div>
          </div>
          <h1 class="d-title" id="dTitle"></h1>
          <div class="d-body" id="dBody"></div>
          <div class="d-tags" id="dTags"></div>
        </div>
        <div class="detail-sidebar" id="detailSidebar"></div>
      </div>
    </div>
  </div>

  <!-- COMPOSER MODAL -->
  <div class="modal-overlay" id="composerModal">
    <div class="modal">
      <div class="m-header">
        <div class="m-header-left">
          <span class="c-date" id="cDate"></span>
          <div class="mood-sel">
            <label>Mood</label>
            <button class="mood-btn" data-mood="great">üòä</button>
            <button class="mood-btn" data-mood="good">üôÇ</button>
            <button class="mood-btn" data-mood="okay">üòê</button>
            <button class="mood-btn" data-mood="low">üòî</button>
            <button class="mood-btn" data-mood="bad">üò¢</button>
          </div>
        </div>
        <button class="icon-btn" onclick="closeComposer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="m-body">
        <input type="text" class="c-title" id="cTitle" placeholder="Entry title...">
        <textarea class="c-body" id="cBody" placeholder="Write freely ‚Äî this is your space."></textarea>
      </div>
      <div class="c-footer">
        <div class="c-footer-left">
          <div class="tag-wrap" id="tagWrap"><input type="text" class="tag-in" id="tagIn" placeholder="+ tag" maxlength="20"></div>
        </div>
        <div style="display:flex;align-items:center;gap:var(--sp-4);">
          <span class="wc" id="wc">0 words</span>
          <button class="save-btn" id="saveBtn" onclick="saveEntry()" disabled>Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-box" id="toastBox"></div>

  <script>
    const SK = 'pulsar_journal_entries';
    const M = { great:'üòä', good:'üôÇ', okay:'üòê', low:'üòî', bad:'üò¢' };
    const MV = { great:5, good:4, okay:3, low:2, bad:1 };
    const MC = { great:'var(--mood-great)', good:'var(--mood-good)', okay:'var(--mood-okay)', low:'var(--mood-low)', bad:'var(--mood-bad)' };

    let entries = JSON.parse(localStorage.getItem(SK) || '[]');
    let selMood = null, cTags = [], filter = 'all', sq = '', detailId = null, editId = null;

    function init() {
      renderAll();
      setupListeners();
      if (!entries.length) seed();
    }

    function seed() {
      const n = Date.now(), d = 864e5;
      entries = [
        { id: gid(), title: 'Project Kickoff Reflections', body: 'Today was the first day working on the new Pulsar module. The architecture feels solid ‚Äî modular components with clear separation of concerns.\n\nThe team is aligned on the design system, which makes things much smoother.', mood: 'great', tags: ['pulsar','work','architecture'], createdAt: n-d*6, wordCount: 38 },
        { id: gid(), title: 'Deep Work Session', body: 'Had an uninterrupted 3-hour focus block this afternoon. Managed to implement the entire entry card component system with hover states and responsive breakpoints.\n\nCSS Grid with named areas was the key insight.', mood: 'great', tags: ['coding','focus','css'], createdAt: n-d*5, wordCount: 34 },
        { id: gid(), title: 'Hitting a Wall', body: 'Struggled with the animation timing today. The spring easing curve feels jarring when multiple elements animate simultaneously.\n\nTaking a step back to think about it fresh tomorrow.', mood: 'low', tags: ['animations','challenges'], createdAt: n-d*4, wordCount: 30 },
        { id: gid(), title: 'Breakthrough on Motion Design', body: 'Found the solution ‚Äî CSS animation-delay with a calculated offset creates natural staggering. Combined with a longer container fade, everything flows.\n\nSleeping on problems pays off.', mood: 'great', tags: ['animations','breakthrough','design'], createdAt: n-d*3, wordCount: 30 },
        { id: gid(), title: 'Midweek Check-in', body: 'Energy levels are moderate today. Got through the code review backlog and fixed edge cases in tag filtering.\n\nNot every day needs to be a breakthrough. Consistent progress matters.', mood: 'okay', tags: ['reflection','work'], createdAt: n-d*2, wordCount: 30 },
        { id: gid(), title: 'Design System Polish', body: 'Spent the day refining color tokens and ensuring WCAG contrast compliance. The oklch color space is a game-changer for accessible palettes.\n\nAlso added prefers-reduced-motion support.', mood: 'good', tags: ['design-system','accessibility','colors'], createdAt: n-d, wordCount: 30 },
      ];
      save(); renderAll();
    }

    // Helpers
    function gid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
    function save() { localStorage.setItem(SK, JSON.stringify(entries)); }
    function cw(t) { return t.trim() ? t.trim().split(/\s+/).length : 0; }
    function fDate(ts) { return new Date(ts).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'}); }
    function fTime(ts) { return new Date(ts).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'}); }
    function rel(ts) {
      const m=Math.floor((Date.now()-ts)/6e4);
      if(m<1)return'Just now'; if(m<60)return m+'m ago';
      const h=Math.floor(m/60); if(h<24)return h+'h ago';
      const dd=Math.floor(h/24); if(dd<7)return dd+'d ago';
      return new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    }
    function sameD(a,b){const x=new Date(a),y=new Date(b);return x.getFullYear()===y.getFullYear()&&x.getMonth()===y.getMonth()&&x.getDate()===y.getDate();}
    function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
    function renderAll(){renderEntries();renderStats();renderWeek();renderMood();renderTags();}

    // Pages
    function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');}
    function goBack(){showPage('dashPage');document.getElementById('topbarPage').textContent='Journal';detailId=null;}

    // Stats
    function renderStats(){
      document.getElementById('sTotal').textContent=entries.length;
      const tw=entries.reduce((s,e)=>s+(e.wordCount||cw(e.body)),0);
      document.getElementById('sWords').textContent=tw>999?(tw/1000).toFixed(1)+'k':tw;
      document.getElementById('sAvg').textContent=entries.length?Math.round(tw/entries.length):0;
      let streak=0;const td=new Date();td.setHours(0,0,0,0);let cd=new Date(td);
      if(!entries.some(e=>sameD(e.createdAt,cd.getTime())))cd.setDate(cd.getDate()-1);
      while(entries.some(e=>sameD(e.createdAt,cd.getTime()))){streak++;cd.setDate(cd.getDate()-1);}
      document.getElementById('sStreak').textContent=streak;
    }

    function renderWeek(){
      const el=document.getElementById('weekDots'),td=new Date();td.setHours(0,0,0,0);
      const dow=td.getDay(),sow=new Date(td);sow.setDate(td.getDate()-dow);
      let ac=0,h='';
      for(let i=0;i<7;i++){
        const dd=new Date(sow);dd.setDate(sow.getDate()+i);
        const has=entries.some(e=>sameD(e.createdAt,dd.getTime()));
        if(has)ac++;
        h+=`<div class="week-dot ${has?'active':''} ${sameD(dd.getTime(),td.getTime())?'today':''}"></div>`;
      }
      el.innerHTML=h;document.getElementById('weekLabel').textContent=ac+'/7';
    }

    function renderMood(){
      const ch=document.getElementById('moodChart'),td=new Date();td.setHours(0,0,0,0);
      const lb=['S','M','T','W','T','F','S'];let h='';
      for(let i=6;i>=0;i--){
        const dd=new Date(td);dd.setDate(td.getDate()-i);
        const de=entries.filter(e=>sameD(e.createdAt,dd.getTime())),di=dd.getDay();
        if(!de.length){h+=`<div class="mb-wrap"><div class="mb-bar" style="height:3px;background:var(--bg-overlay)"></div><span class="mb-lbl">${lb[di]}</span></div>`;}
        else{
          const avg=de.reduce((s,e)=>s+(MV[e.mood]||3),0)/de.length;
          const ht=Math.max(8,(avg/5)*64);
          const mk=avg>=4.5?'great':avg>=3.5?'good':avg>=2.5?'okay':avg>=1.5?'low':'bad';
          h+=`<div class="mb-wrap"><div class="mb-bar" style="height:${ht}px;background:${MC[mk]}" title="${M[mk]} ${avg.toFixed(1)}"></div><span class="mb-lbl">${lb[di]}</span></div>`;
        }
      }
      ch.innerHTML=h;
    }

    function renderTags(){
      const cl=document.getElementById('tagsCloud'),tm={};
      entries.forEach(e=>e.tags.forEach(t=>{tm[t]=(tm[t]||0)+1;}));
      const sorted=Object.entries(tm).sort((a,b)=>b[1]-a[1]);
      if(!sorted.length){cl.innerHTML='<span style="font-size:11px;color:var(--text-muted)">Tags appear here</span>';return;}
      cl.innerHTML=sorted.map(([t,c])=>`<button class="cloud-tag" onclick="filterTag('${esc(t)}')">${esc(t)}<span class="tc">${c}</span></button>`).join('');
    }

    function filterTag(t){document.getElementById('searchInput').value=t;sq=t;renderEntries();}

    // Related entries (by shared tags or similar mood)
    function getRelated(entry){
      return entries.filter(e=>e.id!==entry.id).map(e=>{
        const sharedTags=e.tags.filter(t=>entry.tags.includes(t));
        const sameMood=e.mood===entry.mood?1:0;
        const score=sharedTags.length*2+sameMood;
        return{...e,score,sharedTags};
      }).filter(e=>e.score>0).sort((a,b)=>b.score-a.score).slice(0,4);
    }

    function renderRelated(entry){
      const el=document.getElementById('relatedList');
      const related=getRelated(entry);
      if(!related.length){el.innerHTML='<span style="font-size:11px;color:var(--text-muted)">No related entries found</span>';return;}
      el.innerHTML=related.map(r=>`
        <div class="related-entry" onclick="openEntry('${r.id}')">
          <span class="re-mood">${M[r.mood]||'üòê'}</span>
          <div class="re-info"><div class="re-title">${esc(r.title)}</div><div class="re-date">${rel(r.createdAt)}</div></div>
          <span class="re-match">${r.sharedTags.length?r.sharedTags[0]:r.mood}</span>
        </div>`).join('');
    }

    function renderDetailSidebar(entry){
      const sb=document.getElementById('detailSidebar');
      const related=getRelated(entry);
      sb.innerHTML=`
        <div class="side-block">
          <div class="sb-header"><h3 class="sb-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg> Related Entries</h3></div>
          <div class="sb-body">${related.length?related.map(r=>`
            <div class="related-entry" onclick="openEntry('${r.id}')">
              <span class="re-mood">${M[r.mood]||'üòê'}</span>
              <div class="re-info"><div class="re-title">${esc(r.title)}</div><div class="re-date">${rel(r.createdAt)}</div></div>
              <span class="re-match">${r.sharedTags.length?r.sharedTags[0]:r.mood}</span>
            </div>`).join(''):'<span style="font-size:11px;color:var(--text-muted)">No related entries</span>'}</div>
        </div>
        ${entry.tags.length?`<div class="side-block">
          <div class="sb-header"><h3 class="sb-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/></svg> Tags</h3></div>
          <div class="sb-body"><div class="tags-cloud">${entry.tags.map(t=>`<span class="d-tag">${esc(t)}</span>`).join('')}</div></div>
        </div>`:''}`;
    }

    // Entries
    function getFiltered(){
      let f=[...entries];const n=Date.now();
      if(filter==='week')f=f.filter(e=>e.createdAt>=n-7*864e5);
      else if(filter==='month')f=f.filter(e=>e.createdAt>=n-30*864e5);
      if(sq){const q=sq.toLowerCase();f=f.filter(e=>e.title.toLowerCase().includes(q)||e.body.toLowerCase().includes(q)||e.tags.some(t=>t.includes(q)));}
      return f.sort((a,b)=>b.createdAt-a.createdAt);
    }

    function renderEntries(){
      const el=document.getElementById('entriesList'),fl=getFiltered();
      if(!fl.length){
        el.innerHTML=`<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></div><h3>${sq?'No matches':'No entries yet'}</h3><p>${sq?'Try different keywords':'Hit the plus to start writing.'}</p></div>`;return;
      }
      el.innerHTML=fl.map((e,i)=>`
        <article class="entry-card" onclick="openEntry('${e.id}')" style="animation:entryIn var(--duration-normal) var(--ease-out) ${i*35}ms both">
          <div class="ec-top">
            <div class="ec-meta"><span class="ec-mood">${M[e.mood]||'üòê'}</span><span class="ec-date">${rel(e.createdAt)}</span></div>
            <div class="ec-actions">
              <button class="ec-action" onclick="event.stopPropagation();editFromList('${e.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>
              <button class="ec-action del" onclick="event.stopPropagation();delEntry('${e.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
            </div>
          </div>
          <h3 class="ec-title">${esc(e.title)}</h3>
          <p class="ec-preview">${esc(e.body)}</p>
          ${e.tags.length?`<div class="ec-tags">${e.tags.map(t=>`<span class="ec-tag">${esc(t)}</span>`).join('')}</div>`:''}
        </article>`).join('');

      // Update related sidebar on dashboard with most recent entry
      if(fl.length) renderRelated(fl[0]);
    }

    // Open entry ‚Üí full page
    function openEntry(id){
      const e=entries.find(x=>x.id===id);if(!e)return;
      detailId=id;
      document.getElementById('dMood').textContent=M[e.mood]||'üòê';
      document.getElementById('dDate').textContent=fDate(e.createdAt)+' ¬∑ '+fTime(e.createdAt);
      document.getElementById('dWords').textContent=(e.wordCount||cw(e.body))+' words';
      document.getElementById('dTitle').textContent=e.title;
      document.getElementById('dBody').textContent=e.body;
      document.getElementById('dTags').innerHTML=e.tags.map(t=>`<span class="d-tag">${esc(t)}</span>`).join('');
      document.getElementById('topbarPage').textContent=e.title;
      renderDetailSidebar(e);
      showPage('detailPage');
      document.getElementById('detailPage').scrollTop=0;
    }

    function editDetail(){
      if(!detailId)return;
      const e=entries.find(x=>x.id===detailId);if(!e)return;
      loadIntoComposer(e); openComposer();
    }
    function deleteDetail(){
      if(!detailId)return;
      entries=entries.filter(e=>e.id!==detailId);
      save();goBack();renderAll();toast('Entry deleted');
    }

    function editFromList(id){
      const e=entries.find(x=>x.id===id);if(!e)return;
      loadIntoComposer(e); openComposer();
    }
    function delEntry(id){entries=entries.filter(e=>e.id!==id);save();renderAll();toast('Entry deleted');}

    function loadIntoComposer(e){
      editId=e.id;
      document.getElementById('cTitle').value=e.title;
      document.getElementById('cBody').value=e.body;
      cTags=[...e.tags];renderCTags();
      document.querySelectorAll('.mood-btn').forEach(b=>b.classList.toggle('active',b.dataset.mood===e.mood));
      selMood=e.mood;updWC();updSave();
      document.getElementById('saveBtn').textContent='Update';
    }

    // Composer
    function openComposer(){
      document.getElementById('cDate').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
      document.getElementById('composerModal').classList.add('open');
      document.body.style.overflow='hidden';
      setTimeout(()=>document.getElementById('cTitle').focus(),100);
    }
    function closeComposer(){
      document.getElementById('composerModal').classList.remove('open');
      document.body.style.overflow='';
    }
    function updSave(){
      const t=document.getElementById('cTitle').value.trim(),b=document.getElementById('cBody').value.trim();
      document.getElementById('saveBtn').disabled=!(t||b);
    }
    function updWC(){
      const c=cw(document.getElementById('cBody').value);
      document.getElementById('wc').textContent=c+' word'+(c!==1?'s':'');
    }

    function saveEntry(){
      const title=document.getElementById('cTitle').value.trim();
      const body=document.getElementById('cBody').value.trim();
      if(!title&&!body)return;
      if(editId){
        const idx=entries.findIndex(e=>e.id===editId);
        if(idx>-1){
          entries[idx].title=title||'Untitled';entries[idx].body=body;
          entries[idx].mood=selMood||entries[idx].mood;
          entries[idx].tags=[...cTags];entries[idx].wordCount=cw(body);
          toast('Updated');
          if(detailId===editId)openEntry(editId);
        }
        editId=null;document.getElementById('saveBtn').textContent='Save';
      } else {
        entries.unshift({id:gid(),title:title||'Untitled',body,mood:selMood||'okay',tags:[...cTags],createdAt:Date.now(),wordCount:cw(body)});
        toast('Saved');
      }
      save();clearComposer();closeComposer();renderAll();
    }

    function clearComposer(){
      document.getElementById('cTitle').value='';document.getElementById('cBody').value='';
      document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('active'));
      selMood=null;cTags=[];renderCTags();updWC();updSave();
    }

    // Tags
    document.querySelectorAll('.mood-btn').forEach(b=>{
      b.addEventListener('click',()=>{
        document.querySelectorAll('.mood-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');selMood=b.dataset.mood;updSave();
      });
    });

    function setupTagIn(){
      const inp=document.getElementById('tagIn');
      inp.addEventListener('keydown',e=>{
        if((e.key==='Enter'||e.key===',')&&inp.value.trim()){
          e.preventDefault();const t=inp.value.trim().toLowerCase().replace(/,/g,'');
          if(t&&!cTags.includes(t)&&cTags.length<5){cTags.push(t);renderCTags();}inp.value='';
        }
        if(e.key==='Backspace'&&!inp.value&&cTags.length){cTags.pop();renderCTags();}
      });
    }
    function renderCTags(){
      const w=document.getElementById('tagWrap'),inp=document.getElementById('tagIn');
      w.querySelectorAll('.tag-chip').forEach(c=>c.remove());
      cTags.forEach((t,i)=>{const c=document.createElement('span');c.className='tag-chip';c.innerHTML=`${t}<span class="rx" onclick="rmTag(${i})">√ó</span>`;w.insertBefore(c,inp);});
    }
    function rmTag(i){cTags.splice(i,1);renderCTags();}

    // Listeners
    function setupListeners(){
      const si=document.getElementById('searchInput');let db;
      si.addEventListener('input',()=>{clearTimeout(db);db=setTimeout(()=>{sq=si.value.trim();renderEntries();},200);});
      document.querySelectorAll('.etab').forEach(t=>{
        t.addEventListener('click',()=>{
          document.querySelectorAll('.etab').forEach(x=>x.classList.remove('active'));
          t.classList.add('active');filter=t.dataset.f;renderEntries();
        });
      });
      document.getElementById('cTitle').addEventListener('input',updSave);
      document.getElementById('cBody').addEventListener('input',()=>{updWC();updSave();});
      setupTagIn();
      document.getElementById('composerModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeComposer();});
      document.addEventListener('keydown',e=>{
        if(e.key==='Escape'){
          if(document.getElementById('composerModal').classList.contains('open'))closeComposer();
          else if(document.getElementById('detailPage').classList.contains('active'))goBack();
        }
        if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();si.focus();if(!document.getElementById('dashPage').classList.contains('active'))goBack();}
        if((e.metaKey||e.ctrlKey)&&e.key==='j'){e.preventDefault();openComposer();}
      });
    }

    function toast(msg){
      const c=document.getElementById('toastBox'),t=document.createElement('div');t.className='toast';
      t.innerHTML=`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>${msg}`;
      c.appendChild(t);setTimeout(()=>{t.classList.add('out');setTimeout(()=>t.remove(),200);},2500);
    }

    init();
  </script>
</body>
</html>