<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pulsar Journal</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#f6f4f8;--bg2:#eeeaf3;--bg3:#e4dfeb;--surface:#fffeff;--surface2:#faf8fc;
--ink:#1c1a21;--ink2:#44404d;--ink3:#736e7e;--ink4:#a39dae;--ink5:#c8c3d0;
--accent:#7c4dca;--accent2:#9366de;--accent-soft:rgba(124,77,202,.09);--accent-glow:rgba(124,77,202,.18);
--insight:#2e7d8c;--insight2:#3a9aab;--insight-soft:rgba(46,125,140,.1);--insight-bg:rgba(46,125,140,.08);
--pin:#8c6a2e;--pin-soft:rgba(140,106,46,.08);
--success:#4a8c5e;--danger:#b83a3a;
--border:rgba(0,0,0,.06);--border2:rgba(0,0,0,.1);
--font-display:'Palatino Linotype','Book Antiqua','Palatino',serif;
--font-body:-apple-system,'Segoe UI','Helvetica Neue',sans-serif;
--font-mono:'SF Mono','Cascadia Code','Consolas',monospace;
--r:8px;--r-sm:4px;--r-lg:14px;
--sh-sm:0 1px 2px rgba(0,0,0,.04);--sh:0 2px 8px rgba(0,0,0,.06);--sh-lg:0 8px 30px rgba(0,0,0,.1);
--ease:cubic-bezier(.4,0,.2,1);--ease-out:cubic-bezier(0,0,.2,1);--ease-spring:cubic-bezier(.34,1.56,.64,1);
--dur:180ms;--dur-md:280ms;--sbw:300px;
}
[data-theme="dark"]{
--bg:#17151c;--bg2:#1f1d25;--bg3:#2a2733;--surface:#232130;--surface2:#1c1a24;
--ink:#e4e0ec;--ink2:#b5b0c2;--ink3:#837e92;--ink4:#5a5568;--ink5:#3a3646;
--accent:#a07de8;--accent2:#b494f0;--accent-soft:rgba(160,125,232,.13);--accent-glow:rgba(160,125,232,.22);
--insight:#4ab0c4;--insight2:#5ec4d8;--insight-soft:rgba(74,176,196,.14);--insight-bg:rgba(74,176,196,.1);
--pin:#c4a04a;--pin-soft:rgba(196,160,74,.1);
--border:rgba(255,255,255,.06);--border2:rgba(255,255,255,.1);
}
html{font-size:16px;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
body{font-family:var(--font-body);background:var(--bg);color:var(--ink);line-height:1.6;min-height:100vh;overflow:hidden}
body::before{content:'';position:fixed;inset:0;opacity:.018;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");pointer-events:none;z-index:9999}
[data-theme="dark"] body::before{opacity:.03}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit}
input,textarea{font-family:inherit;border:none;outline:none;background:none;color:inherit}
textarea{resize:none}
::selection{background:var(--accent-soft);color:var(--accent)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--ink5);border-radius:3px}

.app{display:flex;height:100vh;overflow:hidden;position:relative}

/* ══ SIDEBAR ══ */
.sidebar{width:var(--sbw);min-width:var(--sbw);background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:20;transition:transform var(--dur-md) var(--ease)}
.sb-hd{padding:16px 18px 0}
.sb-brand{display:flex;align-items:center;gap:9px;margin-bottom:14px}
.sb-mk{width:30px;height:30px;border-radius:var(--r);background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.9rem;font-family:var(--font-display);box-shadow:0 2px 10px var(--accent-glow)}
.sb-name{font-family:var(--font-display);font-size:1.05rem;color:var(--ink);letter-spacing:-.02em}
.sb-name small{font-size:.52rem;color:var(--ink4);text-transform:uppercase;letter-spacing:.12em;display:block;margin-top:-1px;font-family:var(--font-body)}
.sb-btns{display:flex;gap:2px;margin-left:auto}
/* Search */
.sb-srch{position:relative;margin:0 0 10px}
.sb-srch input{width:100%;padding:7px 12px 7px 30px;background:var(--bg);border:1px solid var(--border);border-radius:var(--r);font-size:.78rem;color:var(--ink);transition:all var(--dur)}
.sb-srch input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}
.sb-srch input::placeholder{color:var(--ink4)}
.sb-srch svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);width:13px;height:13px;color:var(--ink4);pointer-events:none}
.sb-srch .clr{position:absolute;right:7px;top:50%;transform:translateY(-50%);width:16px;height:16px;display:none;align-items:center;justify-content:center;color:var(--ink4);border-radius:50%;font-size:.65rem}
.sb-srch.has .clr{display:flex}
/* View Toggle */
.vt{display:flex;background:var(--bg);border-radius:var(--r);padding:3px;margin-bottom:10px;position:relative}
.vt button{flex:1;padding:5px 0;font-size:.73rem;font-weight:500;border-radius:6px;color:var(--ink3);transition:color var(--dur);position:relative;z-index:1}
.vt button.on{color:var(--ink)}
.vt .vts{position:absolute;top:3px;height:calc(100% - 6px);border-radius:6px;background:var(--surface);box-shadow:var(--sh-sm);transition:all var(--dur-md) var(--ease-spring);z-index:0}
/* Filters */
.sb-flt{padding:0 0 8px;display:flex;flex-wrap:wrap;gap:4px}
.fc{font-size:.66rem;padding:2px 8px;border-radius:12px;background:var(--bg);color:var(--ink4);transition:all var(--dur);border:1px solid transparent}
.fc:hover{color:var(--ink3);border-color:var(--border2)}
.fc.on{background:var(--accent-soft);color:var(--accent);border-color:var(--accent-glow)}
.fc.if.on{background:var(--insight-soft);color:var(--insight)}
/* Timeline */
.tl{flex:1;overflow-y:auto;padding:2px 10px 80px}
.tl-g{margin-bottom:1px}
.tl-d{font-size:.6rem;font-weight:600;color:var(--ink4);text-transform:uppercase;letter-spacing:.1em;padding:12px 6px 4px;position:sticky;top:0;background:var(--bg2);z-index:2;display:flex;align-items:center;gap:6px}
.tl-d::after{content:'';flex:1;height:1px;background:var(--border)}
.tl-d .tl-rel{font-weight:400;color:var(--ink4);text-transform:none;letter-spacing:0;font-size:.58rem;opacity:.75}
.ti{padding:8px 10px;border-radius:var(--r);cursor:pointer;transition:all var(--dur);border:1px solid transparent;margin-bottom:1px;position:relative;opacity:0;animation:tlIn .3s var(--ease-out) forwards}
@keyframes tlIn{to{opacity:1}}
.ti:hover{background:var(--bg3);border-color:var(--border)}
.ti.sel{background:var(--surface);border-color:var(--border2);box-shadow:var(--sh-sm)}
.ti.wk{padding-left:12px}
.ti.wk::before{content:'';position:absolute;left:3px;top:10px;bottom:10px;width:2px;border-radius:1px;background:var(--accent)}
.ti .tt{font-size:.78rem;font-weight:500;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ti .tp{font-size:.68rem;color:var(--ink4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.ti .tm{display:flex;align-items:center;gap:4px;margin-top:2px}
.ti-tg{font-size:.56rem;padding:1px 5px;border-radius:8px;background:var(--bg3);color:var(--ink4)}
.ti-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.ti-dot.ins{background:var(--insight)}
.ti-dot.pin{background:var(--pin)}
.ti-ic{font-size:.55rem;color:var(--insight);background:var(--insight-soft);padding:0 4px;border-radius:6px;line-height:1.5}
/* Consistency */
.sb-ft{padding:12px 18px;border-top:1px solid var(--border)}
.ct{font-size:.7rem;color:var(--ink3);margin-bottom:5px}.ct b{color:var(--ink2)}
.cb{display:flex;gap:3px}
.cd{display:flex;flex-direction:column;align-items:center;gap:2px;flex:1}
.cd .dd{width:100%;height:5px;border-radius:2px;background:var(--bg);transition:all var(--dur-md)}
.cd .dd.f{background:var(--accent)}
.cd .dd.t{box-shadow:inset 0 0 0 1.5px var(--accent)}
.cd .dd.t.f{background:var(--accent);box-shadow:none}
.cd .dl{font-size:.5rem;color:var(--ink4);text-transform:uppercase}

/* ══ MAIN ══ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.mh{padding:8px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--surface2);flex-shrink:0}
.bn{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;background:var(--accent);color:#fff;border-radius:var(--r);font-size:.76rem;font-weight:500;transition:all var(--dur);box-shadow:0 1px 4px var(--accent-glow)}
.bn:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 3px 10px var(--accent-glow)}
.bn:active{transform:translateY(0)}
.bn svg{width:13px;height:13px}
.hd{font-family:var(--font-display);font-size:.88rem;color:var(--ink3);margin-left:2px}
.save-st{font-size:.62rem;color:var(--ink4);margin-left:4px;opacity:0;transition:opacity .3s}
.save-st.vis{opacity:1}
.hr{margin-left:auto;display:flex;gap:2px}
.ib{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:var(--r);transition:all var(--dur);color:var(--ink4)}
.ib:hover{background:var(--bg2);color:var(--ink2)}
.ib.on{color:var(--accent);background:var(--accent-soft)}
.ib svg{width:15px;height:15px}
.mb{display:none}

/* ══ EDITOR ══ */
.ew{flex:1;overflow-y:auto;display:flex;justify-content:center}
.ed{width:100%;max-width:720px;padding:32px 32px 140px;animation:ef .3s var(--ease-out)}
@keyframes ef{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
/* Focus Mode */
.app.focus .sidebar{transform:translateX(calc(var(--sbw) * -1));position:absolute;left:0;top:0;height:100%}
.app.focus .ed{max-width:640px}
.app.focus .mh{border-color:transparent}
/* Empty */
.es{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px;animation:ef .5s var(--ease-out)}
.es-i{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--accent-soft),var(--insight-soft));display:flex;align-items:center;justify-content:center;margin-bottom:18px;color:var(--accent)}
.es h2{font-family:var(--font-display);font-size:1.45rem;color:var(--ink2);font-weight:400;margin-bottom:5px;letter-spacing:-.02em}
.es p{font-size:.86rem;color:var(--ink3);max-width:340px;line-height:1.55;margin-bottom:22px}
.es-a{display:flex;gap:8px}
.es-b{padding:8px 18px;border-radius:var(--r);font-size:.8rem;font-weight:500;transition:all var(--dur)}
.es-b.p{background:var(--accent);color:#fff;box-shadow:0 1px 4px var(--accent-glow)}.es-b.p:hover{background:var(--accent2)}
.es-b.s{background:var(--bg2);color:var(--ink2)}.es-b.s:hover{background:var(--bg3)}
.es-k{font-size:.7rem;color:var(--ink4);margin-top:18px}.es-k kbd{background:var(--bg2);padding:1px 5px;border-radius:3px;font-size:.66rem;font-family:var(--font-mono);border:1px solid var(--border)}
/* Type bar */
.eb{display:flex;align-items:center;gap:7px;margin-bottom:10px}
.et{font-size:.6rem;text-transform:uppercase;letter-spacing:.1em;padding:2px 9px;border-radius:10px;font-weight:600}
.et.dy{background:var(--bg2);color:var(--ink3)}.et.wk{background:var(--accent-soft);color:var(--accent)}
.edt{font-size:.7rem;color:var(--ink4);font-family:var(--font-mono);cursor:pointer;border-bottom:1px dashed var(--border);padding-bottom:1px}
.edt:hover{color:var(--accent);border-color:var(--accent)}
.eb .sp{flex:1}
.eb .ib{width:28px;height:28px}
/* Nav arrows */
.enav{display:flex;gap:1px;margin-right:4px}
.enav .ib{width:26px;height:26px;border-radius:6px}
/* Title */
.etl{font-family:var(--font-display);font-size:1.6rem;line-height:1.3;width:100%;padding:0;color:var(--ink);font-weight:400;letter-spacing:-.015em;margin-bottom:1px}
.etl::placeholder{color:var(--ink5)}
/* Mood */
.mb-r{display:flex;align-items:center;gap:14px;margin:4px 0 12px;opacity:.6;transition:opacity var(--dur)}
.mb-r:hover,.mb-r:focus-within{opacity:1}
.mg{display:flex;align-items:center;gap:2px}
.ml{font-size:.6rem;color:var(--ink4);text-transform:uppercase;letter-spacing:.08em;margin-right:2px}
.mmb{width:26px;height:22px;border-radius:11px;font-size:.62rem;color:var(--ink4);transition:all var(--dur);border:1px solid var(--border);display:flex;align-items:center;justify-content:center}
.mmb:hover{border-color:var(--border2);color:var(--ink2)}
.mmb.on{border-color:var(--accent);color:var(--accent);background:var(--accent-soft)}
/* Prompts */
.pw{margin-bottom:12px;overflow:hidden;transition:all var(--dur-md)}
.pw.gone{max-height:0;opacity:0;margin:0}
.pc{font-size:.72rem;padding:5px 13px;border-radius:18px;background:var(--bg2);color:var(--ink3);transition:all var(--dur);border:1px solid var(--border);cursor:pointer;display:inline-block;margin:0 5px 5px 0}
.pc:hover{background:var(--bg3);color:var(--ink2);border-color:var(--border2)}
/* Body */
.ebd{width:100%;min-height:300px;font-size:1.04rem;line-height:1.8;color:var(--ink);padding:0;font-family:var(--font-display);letter-spacing:.005em}
.ebd::placeholder{color:var(--ink5)}
/* Word info */
.wi{display:flex;gap:10px;margin-top:6px;font-size:.65rem;color:var(--ink4)}.wi span{display:flex;align-items:center;gap:3px}
/* Tags */
.tgs{margin-top:18px;padding-top:12px;border-top:1px solid var(--border)}
.tgr{display:flex;flex-wrap:wrap;gap:4px;align-items:center}
.tg{font-size:.66rem;padding:2px 9px;border-radius:12px;background:var(--bg2);color:var(--ink3);display:inline-flex;align-items:center;gap:3px}
.tg button{font-size:.72rem;color:var(--ink4);line-height:1;display:flex}.tg button:hover{color:var(--danger)}
.tga{font-size:.68rem;padding:2px 9px;border:1px dashed var(--border);border-radius:12px;width:85px;color:var(--ink3)}
.tga::placeholder{color:var(--ink5)}.tga:focus{border-color:var(--accent);border-style:solid}
/* Linked */
.lks{margin-top:22px;padding-top:14px;border-top:1px solid var(--border)}
.lkl{font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;color:var(--ink4);margin-bottom:6px}
.lki{padding:7px 10px;background:var(--bg2);border-radius:var(--r);margin-bottom:3px;font-size:.8rem;cursor:pointer;color:var(--ink3);transition:all var(--dur);display:flex;align-items:center;gap:7px}
.lki:hover{background:var(--bg3);color:var(--ink)}.lki b{color:var(--ink2);font-weight:500}
/* Week Summary */
.ws{margin-top:20px;padding:14px;background:var(--bg2);border-radius:var(--r-lg);display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.wss{text-align:center}
.wss .wv{font-family:var(--font-display);font-size:1.3rem;color:var(--ink);font-weight:400}
.wss .wl{font-size:.58rem;text-transform:uppercase;letter-spacing:.08em;color:var(--ink4)}
/* Mood mini-chart */
.mood-chart{display:flex;align-items:end;gap:2px;height:24px;justify-content:center;margin-top:4px}
.mood-bar{width:6px;border-radius:2px 2px 0 0;transition:height .3s}

/* Date Picker (inline) */
.dp-wrap{position:relative;display:inline-block}
.dp-inp{position:absolute;top:100%;left:0;margin-top:4px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);padding:8px;box-shadow:var(--sh-lg);z-index:50;display:none}
.dp-inp.vis{display:block}
.dp-inp input[type="date"]{font-family:var(--font-mono);font-size:.8rem;padding:6px 10px;border:1px solid var(--border);border-radius:var(--r-sm);background:var(--bg);color:var(--ink);width:170px}

/* ══ PANELS ══ */
.ip{position:fixed;right:0;top:0;width:310px;height:100vh;background:var(--surface);border-left:1px solid var(--border);transform:translateX(100%);transition:transform var(--dur-md) var(--ease);z-index:30;display:flex;flex-direction:column;box-shadow:-4px 0 20px rgba(0,0,0,.04)}
.ip.open{transform:translateX(0)}
.ip-h{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.ip-h h3{font-family:var(--font-display);font-size:.92rem;color:var(--ink);font-weight:400}
.ip-b{flex:1;overflow-y:auto;padding:10px 14px}
.ip-s{font-size:.6rem;text-transform:uppercase;letter-spacing:.08em;color:var(--ink4);margin:10px 0 5px;padding:0 4px}
.ip-i{padding:9px 10px;border-radius:var(--r);margin-bottom:5px;cursor:pointer;transition:all var(--dur)}
.ip-i.insight{background:var(--insight-soft);border-left:2px solid var(--insight)}.ip-i.insight:hover{background:var(--insight-bg)}
.ip-i.pn{background:var(--pin-soft);border-left:2px solid var(--pin)}.ip-i.pn:hover{opacity:.85}
.ip-t{font-size:.78rem;color:var(--ink);line-height:1.4}
.ip-d{font-size:.6rem;color:var(--ink4);margin-top:2px;display:flex;justify-content:space-between;align-items:center}
.ip-rm{color:var(--ink4);font-size:.62rem;opacity:0;transition:opacity var(--dur);cursor:pointer}.ip-i:hover .ip-rm{opacity:1}
.ip-e{padding:28px 14px;text-align:center;color:var(--ink4);font-size:.8rem;line-height:1.5}

/* ══ OVERLAYS ══ */
.stb{position:fixed;background:var(--ink);color:#fff;border-radius:var(--r);padding:3px;display:flex;gap:2px;z-index:100;box-shadow:var(--sh-lg);opacity:0;pointer-events:none;transition:opacity .12s;transform:translateX(-50%)}
.stb.vis{opacity:1;pointer-events:auto}
.stb button{padding:4px 11px;font-size:.7rem;border-radius:var(--r-sm);color:rgba(255,255,255,.85);white-space:nowrap;transition:all var(--dur)}
.stb button:hover{background:rgba(255,255,255,.15);color:#fff}
/* Command */
.co{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:200;display:flex;align-items:flex-start;justify-content:center;padding-top:18vh;opacity:0;pointer-events:none;transition:opacity .15s;backdrop-filter:blur(2px)}
.co.vis{opacity:1;pointer-events:auto}
.cb{width:460px;max-width:90vw;background:var(--surface);border-radius:var(--r-lg);box-shadow:var(--sh-lg);overflow:hidden;transform:translateY(-8px) scale(.98);transition:transform .2s var(--ease-spring)}
.co.vis .cb{transform:none}
.ci{width:100%;padding:14px 18px;font-size:.95rem;border-bottom:1px solid var(--border)}.ci::placeholder{color:var(--ink4)}
.cl{max-height:260px;overflow-y:auto;padding:4px}
.cm{padding:9px 14px;border-radius:var(--r);cursor:pointer;font-size:.82rem;color:var(--ink2);display:flex;align-items:center;gap:9px;transition:background var(--dur)}
.cm:hover,.cm.sl{background:var(--bg2);color:var(--ink)}
.cm .ck{font-size:.62rem;color:var(--ink4);font-family:var(--font-mono);margin-left:auto;background:var(--bg3);padding:1px 5px;border-radius:3px}
/* Dialog */
.do{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:250;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s;backdrop-filter:blur(2px)}
.do.vis{opacity:1;pointer-events:auto}
.dg{background:var(--surface);border-radius:var(--r-lg);padding:24px;max-width:340px;width:90vw;box-shadow:var(--sh-lg)}
.dg h3{font-family:var(--font-display);font-size:1.05rem;margin-bottom:5px}
.dg p{font-size:.84rem;color:var(--ink2);margin-bottom:20px;line-height:1.5}
.db{display:flex;gap:7px;justify-content:flex-end}
.db button{padding:7px 16px;font-size:.8rem;border-radius:var(--r);font-weight:500;transition:all var(--dur)}
.bc{background:var(--bg2);color:var(--ink2)}.bc:hover{background:var(--bg3)}
.bd{background:var(--danger);color:#fff}.bd:hover{opacity:.9}
/* Toast */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--ink);color:var(--bg);padding:8px 18px;border-radius:var(--r);font-size:.8rem;box-shadow:var(--sh-lg);opacity:0;pointer-events:none;transition:all var(--dur-md) var(--ease);z-index:300}
.toast.vis{opacity:1;transform:translateX(-50%) translateY(0)}

@media(max-width:800px){
.sidebar{position:fixed;left:0;top:0;height:100%;z-index:50;transform:translateX(-100%);box-shadow:var(--sh-lg)}
.sidebar.open{transform:translateX(0)}
.mb{display:flex}
.ed{padding:20px 14px 120px}
.mh{padding:8px 14px}
.sbo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.2);z-index:40}.sbo.vis{display:block}
}
</style>
</head>
<body>
<div class="app" id="app">
<div class="sbo" id="sbo" onclick="closeSb()"></div>
<aside class="sidebar" id="sidebar">
<div class="sb-hd">
 <div class="sb-brand">
  <div class="sb-mk">P</div>
  <div class="sb-name">Journal<small>Pulsar</small></div>
  <div class="sb-btns">
   <button class="ib" onclick="toggleTheme()" title="Theme" id="thBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
  </div>
 </div>
 <div class="sb-srch" id="sBox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search entries…" id="sInp" oninput="onSrch(this.value)"><button class="clr" onclick="clrSrch()">×</button></div>
 <div class="vt" id="vt"><button class="on" data-v="daily">Daily</button><button data-v="weekly">Weekly</button><button data-v="all">All</button><div class="vts" id="vts"></div></div>
 <div class="sb-flt" id="flt"></div>
</div>
<div class="tl" id="tl"></div>
<div class="sb-ft" id="sft"></div>
</aside>

<div class="main">
<header class="mh">
 <button class="ib mb" onclick="openSb()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg></button>
 <button class="bn" onclick="newE()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New</button>
 <span class="hd" id="hd"></span>
 <span class="save-st" id="saveSt">Saved</span>
 <div class="hr">
  <button class="ib" id="focBtn" onclick="toggleFocus()" title="Focus mode"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg></button>
  <button class="ib" id="insBtn" onclick="toggleIns()" title="Insights & Pins"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.674M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg></button>
  <button class="ib" onclick="openCmd()" title="Commands ⌘K"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 3a3 3 0 00-3 3v12a3 3 0 003 3 3 3 0 003-3 3 3 0 00-3-3H6a3 3 0 00-3 3 3 3 0 003 3 3 3 0 003-3V6a3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3h12a3 3 0 003-3 3 3 0 00-3-3z"/></svg></button>
 </div>
</header>
<div class="ew" id="ew"></div>
</div>

<div class="ip" id="ip"><div class="ip-h"><h3>Insights & Pins</h3><button class="ib" onclick="toggleIns()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class="ip-b" id="ipb"></div></div>
<div class="stb" id="stb"><button onclick="doIns()">✦ Insight</button><button onclick="doPin()">★ Pin</button></div>
<div class="co" id="co" onclick="closeCmd()"><div class="cb" onclick="event.stopPropagation()"><input class="ci" id="cInp" placeholder="Type a command… /journal" oninput="fCmd(this.value)" onkeydown="cKey(event)"><div class="cl" id="cLst"></div></div></div>
<div class="do" id="dov"><div class="dg"><h3 id="dTi">Delete Entry</h3><p id="dMs">This can't be undone.</p><div class="db"><button class="bc" onclick="cDlg()">Cancel</button><button class="bd" id="dCf">Delete</button></div></div></div>
<div class="toast" id="tst"></div>
</div>

<script>
const S={entries:[],aid:null,view:'daily',search:'',ftag:null,fins:false,insO:false,theme:localStorage.getItem('pj_th')||'light',delT:null,cmdO:false,cmdI:0,focus:false};
const DB={K:'pulsar_journal_v3',load(){try{const d=JSON.parse(localStorage.getItem(this.K));if(d?.entries)S.entries=d.entries}catch(e){}},save(){localStorage.setItem(this.K,JSON.stringify({entries:S.entries}))}};

const T={
  str(d=new Date()){return d.toISOString().split('T')[0]},
  today(){return this.str()},
  fmt(s){return new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})},
  full(s){return new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})},
  wkLbl(s){const d=new Date(s+'T12:00:00'),st=new Date(d);st.setDate(d.getDate()-d.getDay());const en=new Date(st);en.setDate(st.getDate()+6);const f=x=>x.toLocaleDateString('en-US',{month:'short',day:'numeric'});return`Week of ${f(st)} – ${f(en)}`},
  wkStart(s){const d=new Date(s+'T12:00:00');d.setDate(d.getDate()-d.getDay());return this.str(d)},
  daysOfWk(){const t=new Date(),s=new Date(t);s.setDate(t.getDate()-t.getDay());return Array.from({length:7},(_,i)=>{const d=new Date(s);d.setDate(s.getDate()+i);return this.str(d)})},
  dayN(s){return['S','M','T','W','T','F','S'][new Date(s+'T12:00:00').getDay()]},
  rel(s){const t=this.today(),d=new Date(t+'T12:00:00'),e=new Date(s+'T12:00:00'),diff=Math.round((d-e)/864e5);if(diff===0)return'Today';if(diff===1)return'Yesterday';if(diff<7)return diff+' days ago';return''}
};

function mkE(type='daily'){const n=new Date();return{id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),type,date:T.str(n),created:n.toISOString(),updated:n.toISOString(),title:'',body:'',tags:[],mood:null,energy:null,insights:[],pinned:false,pinnedTexts:[]}}

const $=id=>document.getElementById(id),esc=s=>s?s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';
const wc=s=>s.trim()?s.trim().split(/\s+/).length:0;
const rt=w=>Math.max(1,Math.ceil(w/200));
const pc=s=>s.trim()?s.trim().split(/\n+/).filter(Boolean).length:0;
const act=()=>S.entries.find(e=>e.id===S.aid);
const allT=()=>[...new Set(S.entries.flatMap(e=>e.tags))].sort();
const allI=()=>S.entries.flatMap(e=>e.insights.map(i=>({...i,eid:e.id,date:e.date}))).sort((a,b)=>b.date.localeCompare(a.date));
const allP=()=>{const p=[];S.entries.forEach(e=>{if(e.pinned)p.push({t:'entry',eid:e.id,text:e.title||e.body.slice(0,80)||'Untitled',date:e.date});e.pinnedTexts.forEach(x=>p.push({t:'text',eid:e.id,text:x.text,date:e.date}))});return p};

function filt(){
  let es=[...S.entries];
  if(S.view==='daily')es=es.filter(e=>e.type==='daily');
  else if(S.view==='weekly')es=es.filter(e=>e.type==='weekly');
  if(S.ftag)es=es.filter(e=>e.tags.includes(S.ftag));
  if(S.fins)es=es.filter(e=>e.insights.length>0);
  if(S.search){const q=S.search.toLowerCase();es=es.filter(e=>(e.title+' '+e.body+' '+e.tags.join(' ')).toLowerCase().includes(q))}
  return es.sort((a,b)=>b.date.localeCompare(a.date)||b.created.localeCompare(a.created));
}

function newE(type){const t=type||(S.view==='weekly'?'weekly':'daily');const e=mkE(t);S.entries.unshift(e);S.aid=e.id;persist();closeSb()}
function selE(id){S.aid=id;render();closeSb();setTimeout(()=>{const el=document.querySelector('.tl .ti.sel');if(el)el.scrollIntoView({block:'nearest',behavior:'smooth'})},50)}
function persist(){DB.save();render()}
function toast(m){const t=$('tst');t.textContent=m;t.classList.add('vis');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('vis'),2200)}
function showSaved(){const s=$('saveSt');s.textContent='Saved';s.classList.add('vis');clearTimeout(s._t);s._t=setTimeout(()=>s.classList.remove('vis'),1500)}

// Theme
function applyTh(){document.documentElement.setAttribute('data-theme',S.theme);$('thBtn').innerHTML=S.theme==='dark'?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'}
function toggleTheme(){S.theme=S.theme==='dark'?'light':'dark';localStorage.setItem('pj_th',S.theme);applyTh()}

// Search
function onSrch(v){S.search=v;$('sBox').classList.toggle('has',!!v);renderTL();renderFlt()}
function clrSrch(){$('sInp').value='';onSrch('')}

// Focus
function toggleFocus(){S.focus=!S.focus;$('app').classList.toggle('focus',S.focus);$('focBtn').classList.toggle('on',S.focus)}

// View
function initVT(){const w=$('vt'),bs=w.querySelectorAll('button[data-v]'),sl=$('vts');function u(){bs.forEach(b=>b.classList.toggle('on',b.dataset.v===S.view));const a=w.querySelector('button.on');if(a){sl.style.left=a.offsetLeft+'px';sl.style.width=a.offsetWidth+'px'}}bs.forEach(b=>b.addEventListener('click',()=>{S.view=b.dataset.v;u();renderTL();renderFlt()}));u();requestAnimationFrame(u)}

// ═══ RENDER ═══
function renderTL(){
  const el=$('tl'),es=filt();
  if(!es.length){el.innerHTML=`<div style="padding:28px 10px;text-align:center;color:var(--ink4);font-size:.8rem;line-height:1.5">${S.search?'No matches.':'No entries yet.'}</div>`;return}
  let h='',lg='';
  es.forEach((e,i)=>{
    const g=e.type==='weekly'?T.wkLbl(e.date):T.fmt(e.date);
    if(g!==lg){if(lg)h+='</div>';const rel=e.type!=='weekly'?T.rel(e.date):'';h+=`<div class="tl-g"><div class="tl-d">${g}${rel?` <span class="tl-rel">${rel}</span>`:''}</div>`;lg=g}
    const sel=e.id===S.aid?' sel':'',wk=e.type==='weekly'?' wk':'';
    const title=esc(e.title||(e.type==='weekly'?'Weekly Reflection':'Untitled'));
    const prev=e.body?esc(e.body.replace(/\n/g,' ').slice(0,50)):'';
    let meta='';e.tags.slice(0,2).forEach(t=>{meta+=`<span class="ti-tg">${esc(t)}</span>`});
    if(e.insights.length)meta+=`<span class="ti-ic">${e.insights.length}</span>`;
    if(e.pinned)meta+=`<span class="ti-dot pin"></span>`;
    h+=`<div class="ti${sel}${wk}" onclick="selE('${e.id}')" style="animation-delay:${Math.min(i*20,180)}ms"><div class="tt">${title}</div>${prev?`<div class="tp">${prev}</div>`:''}${meta?`<div class="tm">${meta}</div>`:''}</div>`;
  });
  if(lg)h+='</div>';el.innerHTML=h;
}

function renderFlt(){
  const el=$('flt'),tags=allT();
  let h=`<button class="fc if${S.fins?' on':''}" onclick="S.fins=!S.fins;renderTL();renderFlt()">✦ Insights</button>`;
  tags.forEach(t=>{h+=`<button class="fc${S.ftag===t?' on':''}" onclick="S.ftag=S.ftag==='${esc(t)}'?null:'${esc(t)}';renderTL();renderFlt()">${esc(t)}</button>`});
  el.innerHTML=h;
}

let _laid=null,_bel=null;
function renderEd(){
  const el=$('ew'),e=act();
  if(e&&e.id===_laid&&_bel){updMeta(e);return}
  _laid=e?e.id:null;
  if(!e){el.innerHTML=`<div class="es"><div class="es-i"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="26" height="26"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></div><h2>Your thinking surface</h2><p>Anchor your thoughts to today, or write a weekly retrospective. Build meaning over time.</p><div class="es-a"><button class="es-b p" onclick="newE('daily')">Today's Entry</button><button class="es-b s" onclick="newE('weekly')">Weekly Reflection</button></div><div class="es-k"><kbd>⌘</kbd><kbd>J</kbd> Quick entry · <kbd>⌘</kbd><kbd>K</kbd> Commands</div></div>`;_bel=null;return}
  const isW=e.type==='weekly',dl=isW?T.wkLbl(e.date):T.full(e.date);
  // Prompts pool
  const pool=isW?["What patterns emerged?","Key wins this week","What to carry forward","What to leave behind","What would I tell my past self?","Where did I grow?","What drained me most?"]:["What mattered today?","What slowed me down?","One thing to keep doing","What surprised me?","What am I avoiding?","Who helped me today?","What would make tomorrow great?"];
  const prompts=shuffle(pool).slice(0,4);
  const sp=!e.body;
  let tgsH=e.tags.map((t,i)=>`<span class="tg">${esc(t)}<button onclick="rmTg(${i})">×</button></span>`).join('');
  // Linked + weekly summary
  let lnk='';
  if(isW){
    const ws=T.wkStart(e.date),ld=S.entries.filter(x=>x.type==='daily'&&T.wkStart(x.date)===ws);
    if(ld.length){lnk+=`<div class="lks"><div class="lkl">This week's entries</div>${ld.map(x=>`<div class="lki" onclick="selE('${x.id}')"><b>${T.fmt(x.date)}</b> ${esc(x.title||x.body.slice(0,40)||'Untitled')}</div>`).join('')}</div>`}
    const tw=ld.reduce((s,x)=>s+wc(x.body),0),ic=ld.reduce((s,x)=>s+x.insights.length,0);
    const moods=ld.filter(x=>x.mood).map(x=>x.mood);
    const ma=moods.length?moods.reduce((s,m)=>s+(m==='high'?3:m==='neutral'?2:1),0)/moods.length:0;
    const ml=ma>=2.5?'↑':ma>=1.5?'·':'↓';
    // Mini mood chart
    let mc='';if(ld.length>1){mc=`<div class="mood-chart">${ld.map(x=>{const v=x.mood==='high'?20:x.mood==='low'?6:12;const c=x.mood==='high'?'var(--success)':x.mood==='low'?'var(--danger)':'var(--ink4)';return`<div class="mood-bar" style="height:${v}px;background:${c}"></div>`}).join('')}</div>`}
    lnk+=`<div class="ws"><div class="wss"><div class="wv">${ld.length}</div><div class="wl">Entries</div></div><div class="wss"><div class="wv">${tw.toLocaleString()}</div><div class="wl">Words</div></div><div class="wss"><div class="wv">${ic}</div><div class="wl">Insights</div></div><div class="wss"><div class="wv">${ml}</div><div class="wl">Mood</div>${mc}</div></div>`;
  }
  const w=wc(e.body),r=rt(w),p=pc(e.body);
  // Entry navigation
  const es=filt(),idx=es.findIndex(x=>x.id===e.id);
  const hasPrev=idx>0,hasNext=idx<es.length-1;

  el.innerHTML=`<div class="ed"><div class="eb">
    <span class="et ${isW?'wk':'dy'}">${isW?'Weekly':'Daily'}</span>
    <div class="dp-wrap"><span class="edt" onclick="toggleDP()">${dl}</span><div class="dp-inp" id="dpInp"><input type="date" value="${e.date}" onchange="chgDate(this.value)"></div></div>
    <span class="sp"></span>
    <div class="enav">
      <button class="ib${hasPrev?'':'" disabled'}" onclick="navE(-1)" title="Previous"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
      <button class="ib${hasNext?'':'" disabled'}" onclick="navE(1)" title="Next"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
    </div>
    <button class="ib${e.pinned?' on':''}" onclick="togglePin()" title="Pin"><svg viewBox="0 0 24 24" fill="${e.pinned?'currentColor':'none'}" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg></button>
    <button class="ib" onclick="dupE()" title="Duplicate"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
    <button class="ib" onclick="expE()" title="Export"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
    <button class="ib" onclick="delE('${e.id}')" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
  </div>
  <input class="etl" type="text" placeholder="${isW?'Weekly reflection…':'Title (optional)…'}" value="${esc(e.title)}" oninput="uFld('title',this.value)" id="eTi">
  <div class="mb-r">
    <div class="mg"><span class="ml">Mood</span>${['low','neutral','high'].map(m=>`<button class="mmb${e.mood===m?' on':''}" onclick="sM('${m}')">${m==='low'?'↓':m==='high'?'↑':'·'}</button>`).join('')}</div>
    <div class="mg"><span class="ml">Energy</span>${['low','neutral','high'].map(m=>`<button class="mmb${e.energy===m?' on':''}" onclick="sEn('${m}')">${m==='low'?'↓':m==='high'?'↑':'·'}</button>`).join('')}</div>
  </div>
  <div class="pw${sp?'':' gone'}" id="pw">${prompts.map(x=>`<button class="pc" onclick="usePr('${esc(x)}')">${x}</button>`).join('')}</div>
  <textarea class="ebd" id="eBd" placeholder="Start writing…" oninput="uBod(this)" onmouseup="chkSel(event)">${esc(e.body)}</textarea>
  <div class="wi" id="wi"><span>${w} words</span><span>${p} ¶</span><span>${r} min</span></div>
  <div class="tgs"><div class="tgr">${tgsH}<input class="tga" type="text" placeholder="+ tag" onkeydown="addTg(event,this)"></div></div>
  ${lnk}</div>`;

  _bel=$('eBd');if(_bel){aH(_bel);_bel.addEventListener('input',()=>aH(_bel))}
  if(!e.title&&!e.body)setTimeout(()=>$('eTi')?.focus(),50);
}
function updMeta(e){const w=wc(e.body),r=rt(w),p=pc(e.body);const wi=$('wi');if(wi)wi.innerHTML=`<span>${w} words</span><span>${p} ¶</span><span>${r} min</span>`}
function aH(ta){ta.style.height='auto';ta.style.height=Math.max(300,ta.scrollHeight)+'px'}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}

// Editor actions
let _st=null;
function uFld(f,v){const e=act();if(!e)return;e[f]=v;e.updated=new Date().toISOString();clearTimeout(_st);$('saveSt').textContent='Saving…';$('saveSt').classList.add('vis');_st=setTimeout(()=>{DB.save();renderTL();showSaved()},400)}
function uBod(ta){const e=act();if(!e)return;e.body=ta.value;e.updated=new Date().toISOString();const pw=$('pw');if(pw)pw.classList.toggle('gone',!!ta.value);updMeta(e);clearTimeout(_st);$('saveSt').textContent='Saving…';$('saveSt').classList.add('vis');_st=setTimeout(()=>{DB.save();renderTL();showSaved()},400)}
function sM(m){const e=act();if(!e)return;e.mood=e.mood===m?null:m;persist()}
function sEn(m){const e=act();if(!e)return;e.energy=e.energy===m?null:m;persist()}
function togglePin(){const e=act();if(!e)return;e.pinned=!e.pinned;toast(e.pinned?'Pinned':'Unpinned');persist()}
function addTg(ev,inp){if(ev.key!=='Enter'||!inp.value.trim())return;const e=act();if(!e)return;const t=inp.value.trim().toLowerCase().replace(/[^a-z0-9\-_]/g,'');if(t&&!e.tags.includes(t)){e.tags.push(t);inp.value='';persist()}}
function rmTg(i){const e=act();if(!e)return;e.tags.splice(i,1);persist()}
function usePr(p){const ta=$('eBd');if(!ta)return;ta.value=p+'\n';ta.focus();ta.setSelectionRange(ta.value.length,ta.value.length);uBod(ta)}

// Date picker
function toggleDP(){const d=$('dpInp');d.classList.toggle('vis')}
function chgDate(v){const e=act();if(!e)return;e.date=v;$('dpInp').classList.remove('vis');toast('Date updated');persist()}

// Entry nav
function navE(dir){const es=filt(),idx=es.findIndex(x=>x.id===S.aid);const ni=idx+dir;if(ni>=0&&ni<es.length)selE(es[ni].id)}

// Duplicate
function dupE(){const e=act();if(!e)return;const d=mkE(e.type);d.title=e.title?(e.title+' (copy)'):e.title;d.body=e.body;d.tags=[...e.tags];S.entries.unshift(d);S.aid=d.id;toast('Duplicated');persist()}

// Export
function expE(){const e=act();if(!e)return;const md=`# ${e.title||'Untitled'}\n\n**Date:** ${e.date}\n**Type:** ${e.type}\n${e.mood?'**Mood:** '+e.mood+'\n':''}${e.energy?'**Energy:** '+e.energy+'\n':''}${e.tags.length?'**Tags:** '+e.tags.join(', ')+'\n':''}\n---\n\n${e.body}\n${e.insights.length?'\n---\n\n## Insights\n\n'+e.insights.map(i=>'> '+i.text).join('\n\n')+'\n':''}`;
  const blob=new Blob([md],{type:'text/markdown'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`journal-${e.date}-${e.id.slice(0,4)}.md`;a.click();URL.revokeObjectURL(a.href);toast('Exported as Markdown')}

// Delete
function delE(id){S.delT=id;$('dov').classList.add('vis');$('dCf').onclick=()=>{S.entries=S.entries.filter(e=>e.id!==S.delT);if(S.aid===S.delT){S.aid=null;_laid=null}cDlg();toast('Deleted');persist()}}
function cDlg(){S.delT=null;$('dov').classList.remove('vis')}

// Selection toolbar
let _sel=null;
function chkSel(ev){const ta=$('eBd');if(!ta)return;const s=ta.selectionStart,e=ta.selectionEnd,tb=$('stb');if(s===e){tb.classList.remove('vis');_sel=null;return}_sel={s,e,text:ta.value.substring(s,e)};tb.style.left=ev.clientX+'px';tb.style.top=(ev.clientY-40)+'px';tb.classList.add('vis')}
function doIns(){if(!_sel)return;const e=act();if(!e)return;e.insights.push({text:_sel.text,start:_sel.s,end:_sel.e});$('stb').classList.remove('vis');_sel=null;toast('Insight saved');persist()}
function doPin(){if(!_sel)return;const e=act();if(!e)return;e.pinnedTexts.push({text:_sel.text});$('stb').classList.remove('vis');_sel=null;toast('Pinned');persist()}

// Insights panel
function toggleIns(){S.insO=!S.insO;$('ip').classList.toggle('open',S.insO);$('insBtn').classList.toggle('on',S.insO);if(S.insO)renderIns()}
function renderIns(){
  const el=$('ipb'),pins=allP(),ins=allI();let h='';
  if(pins.length){h+=`<div class="ip-s">Pinned (${pins.length})</div>`;pins.forEach(p=>{h+=`<div class="ip-i pn" onclick="selE('${p.eid}')"><div class="ip-t">${esc(p.text)}</div><div class="ip-d">${T.fmt(p.date)}<span class="ip-rm" onclick="event.stopPropagation();rmP('${p.eid}','${p.t}')">×</span></div></div>`})}
  if(ins.length){h+=`<div class="ip-s">Insights (${ins.length})</div>`;ins.forEach(i=>{h+=`<div class="ip-i insight" onclick="selE('${i.eid}')"><div class="ip-t">${esc(i.text)}</div><div class="ip-d">${T.fmt(i.date)}<span class="ip-rm" onclick="event.stopPropagation();rmI('${i.eid}','${esc(i.text).replace(/'/g,"\\'")}')">×</span></div></div>`})}
  if(!pins.length&&!ins.length)h=`<div class="ip-e">Select text in an entry to mark insights or pin fragments.</div>`;
  el.innerHTML=h;
}
function rmP(eid,t){const e=S.entries.find(x=>x.id===eid);if(!e)return;if(t==='entry')e.pinned=false;else if(e.pinnedTexts.length)e.pinnedTexts.shift();toast('Removed');persist();if(S.insO)renderIns()}
function rmI(eid,txt){const e=S.entries.find(x=>x.id===eid);if(!e)return;const i=e.insights.findIndex(x=>x.text===txt);if(i>-1)e.insights.splice(i,1);toast('Removed');persist();if(S.insO)renderIns()}

// Consistency
function renderCon(){
  const el=$('sft'),days=T.daysOfWk(),today=T.today();
  const wr=new Set(S.entries.filter(e=>e.type==='daily').map(e=>e.date));
  const cnt=days.filter(d=>wr.has(d)&&d<=today).length;
  el.innerHTML=`<div class="ct">You wrote <b>${cnt} day${cnt!==1?'s':''}</b> this week</div><div class="cb">${days.map(d=>{const f=wr.has(d)?'f':'',t=d===today?'t':'';return`<div class="cd"><div class="dd ${f} ${t}"></div><div class="dl">${T.dayN(d)}</div></div>`}).join('')}</div>`;
}

// Command Palette
const CMDS=[
  {l:'New daily entry',k:'⌘J',fn:()=>newE('daily')},
  {l:'New weekly reflection',k:'⌘⇧J',fn:()=>newE('weekly')},
  {l:'Toggle focus mode',k:'⌘.',fn:toggleFocus},
  {l:'Toggle theme',k:'',fn:toggleTheme},
  {l:'Export current entry',k:'',fn:expE},
  {l:'Open insights panel',k:'',fn:()=>{if(!S.insO)toggleIns()}},
  {l:'Search entries',k:'⌘F',fn:()=>{closeSb();setTimeout(()=>{if(S.focus)toggleFocus();$('sInp').focus()},100)}},
  {l:'Duplicate entry',k:'',fn:dupE},
];
function openCmd(){S.cmdO=true;S.cmdI=0;$('co').classList.add('vis');$('cInp').value='';fCmd('');setTimeout(()=>$('cInp').focus(),50)}
function closeCmd(){S.cmdO=false;$('co').classList.remove('vis')}
function fCmd(v){const q=v.toLowerCase().replace(/^\//,''),el=$('cLst');const m=CMDS.filter(c=>c.l.toLowerCase().includes(q));S.cmdI=0;el.innerHTML=m.map((c,i)=>`<div class="cm${i===0?' sl':''}" onclick="rCmd(${CMDS.indexOf(c)})" onmouseenter="S.cmdI=${i};uCS()"><span>${c.l}</span>${c.k?`<span class="ck">${c.k}</span>`:''}</div>`).join('')}
function uCS(){$('cLst').querySelectorAll('.cm').forEach((x,i)=>x.classList.toggle('sl',i===S.cmdI))}
function cKey(ev){const it=$('cLst').querySelectorAll('.cm');if(ev.key==='ArrowDown'){ev.preventDefault();S.cmdI=Math.min(S.cmdI+1,it.length-1);uCS()}else if(ev.key==='ArrowUp'){ev.preventDefault();S.cmdI=Math.max(S.cmdI-1,0);uCS()}else if(ev.key==='Enter'){ev.preventDefault();it[S.cmdI]?.click()}else if(ev.key==='Escape')closeCmd()}
function rCmd(i){CMDS[i].fn();closeCmd()}

// Sidebar mobile
function openSb(){$('sidebar').classList.add('open');$('sbo').classList.add('vis')}
function closeSb(){$('sidebar').classList.remove('open');$('sbo').classList.remove('vis')}

// Keyboard
document.addEventListener('keydown',ev=>{
  if(ev.key==='Escape'){$('stb').classList.remove('vis');$('dpInp')?.classList.remove('vis');if(S.cmdO)closeCmd();else if(S.insO)toggleIns();else if(S.focus)toggleFocus();return}
  if((ev.metaKey||ev.ctrlKey)&&ev.key==='j'&&!ev.shiftKey){ev.preventDefault();newE('daily');return}
  if((ev.metaKey||ev.ctrlKey)&&ev.key==='j'&&ev.shiftKey){ev.preventDefault();newE('weekly');return}
  if((ev.metaKey||ev.ctrlKey)&&ev.key==='k'){ev.preventDefault();S.cmdO?closeCmd():openCmd();return}
  if((ev.metaKey||ev.ctrlKey)&&ev.key==='.'){ev.preventDefault();toggleFocus();return}
  if((ev.key==='ArrowUp'||ev.key==='ArrowDown')&&!ev.target.closest('.ed')&&!ev.target.closest('.cb')&&!S.cmdO){const es=filt();if(!es.length)return;const idx=es.findIndex(e=>e.id===S.aid);const n=ev.key==='ArrowDown'?Math.min(idx+1,es.length-1):Math.max(idx-1,0);if(es[n])selE(es[n].id);ev.preventDefault()}
});
document.addEventListener('mousedown',ev=>{if(!ev.target.closest('.stb'))$('stb').classList.remove('vis');if(!ev.target.closest('.dp-wrap'))$('dpInp')?.classList.remove('vis')});

function renderHdr(){$('hd').textContent=T.full(T.today())}

function render(){renderTL();renderFlt();renderEd();renderCon();renderHdr();if(S.insO)renderIns()}

// ═══ INIT ═══
DB.load();applyTh();

if(!S.entries.length){
  // Seed sample entries for onboarding
  const today=new Date(),d1=T.str(today);
  const y=new Date(today);y.setDate(y.getDate()-1);const d2=T.str(y);
  const d3=new Date(today);d3.setDate(d3.getDate()-2);const d3s=T.str(d3);

  const e1=mkE('daily');e1.date=d1;e1.title='Welcome to Pulsar Journal';e1.body='This is your thinking surface — a place to anchor thoughts to time and build meaning through reflection.\n\nHighlight any text and mark it as an Insight to surface patterns. Pin important fragments for reference.\n\nPrompts appear on new entries. They\'re suggestions, not requirements.\n\n⌘K opens the command palette. ⌘J creates a quick entry. ⌘. toggles focus mode.';e1.tags=['getting-started'];e1.mood='high';e1.energy='high';
  const e2=mkE('daily');e2.date=d2;e2.title='Building momentum';e2.body='Started organizing my thoughts about the project. The key insight today was that structure emerges from consistent small entries, not from elaborate planning sessions.\n\nNeed to remember: clarity comes from writing, not before it.';e2.tags=['reflection'];e2.mood='neutral';e2.insights=[{text:'clarity comes from writing, not before it',start:180,end:222}];
  const e3=mkE('daily');e3.date=d3s;e3.title='First entry';e3.body='Decided to start journaling. Not as a diary — more as a thinking tool. Want to capture what matters before it fades.\n\nThe goal: anchor thoughts to time and let meaning accumulate.';e3.tags=['meta'];

  S.entries.push(e1,e2,e3);S.aid=e1.id;DB.save();
}

render();initVT();
</script>
</body>
</html>