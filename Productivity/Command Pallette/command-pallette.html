<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulsar ‚Äî Command Palette</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#08090b;--s1:#0e1012;--s2:#141618;--s3:#1a1c1f;--s4:#212326;--s5:#292b2f;--s6:#313336;
--bd:#1a1c1f;--bl:#252729;--bh:#38393e;
--t1:#eef0f2;--t2:#a0a4aa;--t3:#6b7078;--t4:#484c52;--t5:#363a3f;
--ac:#2dd4bf;--ac2:#14b8a6;--acd:rgba(45,212,191,.06);--acm:rgba(45,212,191,.12);--acs:rgba(45,212,191,.22);
--pur:#a78bfa;--purd:rgba(167,139,250,.07);
--am:#fbbf24;--amd:rgba(251,191,36,.07);
--r:#f87171;--rdd:rgba(248,113,113,.06);--rb:rgba(248,113,113,.18);
--blue:#60a5fa;--blued:rgba(96,165,250,.07);
--rd:8px;--rl:12px;
--f:'Outfit',system-ui,sans-serif;--m:'JetBrains Mono',ui-monospace,monospace;
--sh:0 20px 60px rgba(0,0,0,.5),0 4px 14px rgba(0,0,0,.3);
}
html{height:100%;background:var(--bg);color:var(--t1);font-family:var(--f);-webkit-font-smoothing:antialiased}
body{min-height:100vh;display:flex;flex-direction:column}

/* Header */
.hdr{padding:14px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd);background:var(--s1);position:sticky;top:0;z-index:50}
.hdr-l{display:flex;align-items:center;gap:14px}
.logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#2dd4bf,#14b8a6,#0d9488);display:grid;place-items:center;font-size:11px;font-weight:700;color:#000;box-shadow:0 2px 10px rgba(45,212,191,.2)}
.hdr h1{font-size:14px;font-weight:600;letter-spacing:-.2px}
.hdr h1 em{font-style:normal;color:var(--t4);font-weight:400;margin-left:7px;font-size:11px}
.hdr-r{display:flex;align-items:center;gap:8px}
.cmd-trigger{background:var(--s3);border:1px solid var(--bl);color:var(--t3);border-radius:var(--rd);padding:6px 14px;font-size:11px;font-weight:500;cursor:pointer;font-family:var(--f);transition:all .12s;display:flex;align-items:center;gap:8px}
.cmd-trigger:hover{border-color:var(--ac);color:var(--ac);background:var(--acd)}
kbd{background:var(--s4);border:1px solid var(--bl);border-bottom-width:2px;border-radius:4px;padding:2px 6px;font-size:9px;font-family:var(--m);color:var(--t3);font-weight:500;display:inline-block;line-height:1.4}

/* Layout */
.layout{display:grid;grid-template-columns:1fr 320px;flex:1;min-height:0}
.panel{padding:20px 28px;overflow-y:auto;border-right:1px solid var(--bd)}
.sidebar{padding:20px;overflow-y:auto;background:var(--s1)}

/* Section */
.sec{margin-bottom:24px}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.sec-t{font-size:10px;font-weight:600;color:var(--t4);text-transform:uppercase;letter-spacing:.8px}
.sec-acts{display:flex;gap:4px}
.btn-sm{background:var(--s3);border:1px solid var(--bl);color:var(--t3);border-radius:6px;padding:4px 10px;font-size:10px;font-weight:500;cursor:pointer;font-family:var(--f);transition:all .1s}
.btn-sm:hover{border-color:var(--bh);color:var(--t2);background:var(--s4)}
.btn-sm.primary{background:var(--ac);border-color:var(--ac);color:#000}
.btn-sm.primary:hover{filter:brightness(1.1)}

/* Panel search */
.panel-search{display:flex;align-items:center;gap:6px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rd);padding:0 10px;margin-bottom:14px}
.panel-search svg{color:var(--t4);flex-shrink:0}
.panel-search input{flex:1;background:none;border:none;color:var(--t1);font-size:12px;font-family:var(--f);padding:8px 0;outline:none}
.panel-search input::placeholder{color:var(--t4)}

/* Command list */
.cmd-list{display:flex;flex-direction:column;gap:2px}
.cmd-item{display:grid;grid-template-columns:28px 1fr auto auto;align-items:center;gap:0;padding:8px 10px;background:var(--s2);border:1px solid transparent;border-radius:var(--rd);transition:all .1s;cursor:default}
.cmd-item:hover{background:var(--s3);border-color:var(--bd)}
.cmd-item.disabled{opacity:.35}
.cmd-item.conflict{border-color:var(--rb);background:var(--rdd)}
.cmd-icon{width:28px;height:28px;border-radius:6px;display:grid;place-items:center;font-size:12px;flex-shrink:0}
.cmd-icon.navigation{background:var(--blued);color:var(--blue)}
.cmd-icon.creation{background:var(--acd);color:var(--ac)}
.cmd-icon.editing{background:var(--purd);color:var(--pur)}
.cmd-icon.search{background:var(--amd);color:var(--am)}
.cmd-body{padding:0 10px;min-width:0}
.cmd-name{font-size:12px;font-weight:500;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cmd-desc{font-size:10px;color:var(--t4);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cmd-short{min-width:80px;text-align:right;padding-right:8px}
.cmd-short .keys{display:inline-flex;gap:2px}
.cmd-short .keys kbd{font-size:8px;padding:2px 5px}
.cmd-short .no-short{font-size:9px;color:var(--t5);font-family:var(--m)}
.cmd-acts{display:flex;gap:3px}
.cmd-acts button{background:none;border:1px solid transparent;width:26px;height:26px;border-radius:5px;cursor:pointer;display:grid;place-items:center;font-size:10px;transition:all .1s}
.cmd-acts .act-edit{color:var(--blue);background:var(--blued);border-color:rgba(96,165,250,.12)}
.cmd-acts .act-edit:hover{background:rgba(96,165,250,.15);border-color:rgba(96,165,250,.25)}
.cmd-acts .act-dis{color:var(--am);background:var(--amd);border-color:rgba(251,191,36,.12)}
.cmd-acts .act-dis:hover{background:rgba(251,191,36,.15);border-color:rgba(251,191,36,.25)}
.cmd-acts .act-del{color:var(--r);background:var(--rdd);border-color:var(--rb)}
.cmd-acts .act-del:hover{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.3)}
/* Drag reorder */
.cmd-item{cursor:grab}
.cmd-item:active{cursor:grabbing}
.cmd-item.dragging{opacity:.3}
.cmd-item.drag-over-top{box-shadow:inset 0 2px 0 var(--ac)}
.cmd-item.drag-over-bot{box-shadow:inset 0 -2px 0 var(--ac)}

/* Category badge */
.cat-dot{width:3px;height:3px;border-radius:50%;display:inline-block;margin-right:1px}

/* Conflict warning */
.conflict-warn{display:flex;align-items:center;gap:6px;padding:8px 10px;background:var(--rdd);border:1px solid var(--rb);border-radius:var(--rd);font-size:10px;color:var(--r);margin-bottom:10px}

/* ‚ïê‚ïê‚ïê Sidebar ‚ïê‚ïê‚ïê */
.sb-card{background:var(--s2);border:1px solid var(--bd);border-radius:var(--rl);padding:16px;margin-bottom:12px}
.sb-card h3{font-size:11px;font-weight:600;color:var(--t2);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.sb-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.sb-stat{background:var(--s3);border-radius:var(--rd);padding:10px 12px}
.sb-stat .sv{font-size:20px;font-weight:700;font-family:var(--m);letter-spacing:-.5px}
.sb-stat .sl{font-size:8px;color:var(--t4);font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-top:2px}
.sv.teal{color:var(--ac)}.sv.pur{color:var(--pur)}.sv.blue{color:var(--blue)}.sv.am{color:var(--am)}

.sc-row{display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--bd)}
.sc-row:last-child{border:none}
.sc-lbl{font-size:10px;color:var(--t3)}
.sc-keys{display:flex;gap:2px}

.log{font-family:var(--m);font-size:10px;max-height:200px;overflow-y:auto}
.log-entry{padding:4px 0;border-bottom:1px solid var(--bd);display:flex;gap:6px;animation:fadeIn .15s ease}
.log-entry:last-child{border:none}
.log-time{color:var(--t5);flex-shrink:0;font-size:9px}
.log-msg{color:var(--t3)}.log-msg .hl{color:var(--ac);font-weight:500}
.log-empty{color:var(--t5);text-align:center;padding:12px;font-size:10px}

/* ‚ïê‚ïê‚ïê Palette ‚ïê‚ïê‚ïê */
.pal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:flex;align-items:flex-start;justify-content:center;padding-top:min(18vh,150px);opacity:0;pointer-events:none;transition:opacity .1s;backdrop-filter:blur(10px)}
.pal-bg.open{opacity:1;pointer-events:auto}
.pal{width:580px;max-width:95vw;max-height:440px;background:var(--s2);border:1px solid var(--bl);border-radius:var(--rl);box-shadow:var(--sh),0 0 0 1px rgba(45,212,191,.04);transform:scale(.97) translateY(-6px);transition:transform .12s cubic-bezier(.32,1.2,.5,1);display:flex;flex-direction:column;overflow:hidden}
.pal-bg.open .pal{transform:scale(1) translateY(0)}

.pal-top{display:flex;align-items:center;padding:0 16px;border-bottom:1px solid var(--bd);gap:8px}
.pal-top .p-icon{color:var(--ac);font-size:14px;flex-shrink:0;font-family:var(--m);font-weight:600}
.pal-inp{flex:1;background:none;border:none;color:var(--t1);font-size:14px;font-family:var(--m);font-weight:400;padding:14px 0;outline:none;letter-spacing:-.2px}
.pal-inp::placeholder{color:var(--t4)}
.pal-esc{background:var(--s4);border:1px solid var(--bl);border-radius:4px;padding:2px 7px;font-size:9px;font-family:var(--m);color:var(--t4);cursor:pointer;flex-shrink:0}
.pal-esc:hover{color:var(--t2)}

.pal-hints{display:flex;gap:8px;padding:5px 16px;border-bottom:1px solid var(--bd);background:rgba(14,16,18,.6)}
.pal-hint{font-size:9px;font-family:var(--m);color:var(--t4)}
.pal-hint code{color:var(--ac);font-weight:500}

.pal-body{flex:1;overflow-y:auto;padding:4px}

/* Recent section */
.pal-sec{padding:4px 10px 2px;font-size:9px;font-weight:600;color:var(--t5);text-transform:uppercase;letter-spacing:.6px;display:flex;align-items:center;justify-content:space-between}
.pal-sec .cnt{color:var(--t5);font-weight:400;font-size:8px}

.pal-r{display:flex;align-items:center;gap:10px;padding:7px 12px;border-radius:var(--rd);cursor:pointer;transition:background .05s;border:1px solid transparent;margin:1px 0}
.pal-r:hover,.pal-r.active{background:var(--s3)}
.pal-r.active{background:var(--acm);border-color:rgba(45,212,191,.1)}
.pal-r-icon{width:26px;height:26px;border-radius:6px;display:grid;place-items:center;font-size:12px;flex-shrink:0}
.pal-r-icon.navigation{background:var(--blued);color:var(--blue)}
.pal-r-icon.creation{background:var(--acd);color:var(--ac)}
.pal-r-icon.editing{background:var(--purd);color:var(--pur)}
.pal-r-icon.search{background:var(--amd);color:var(--am)}
.pal-r-body{flex:1;min-width:0}
.pal-r-name{font-size:12px;font-weight:500;color:var(--t1)}
.pal-r-desc{font-size:9.5px;color:var(--t4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px}
.pal-r-meta{display:flex;align-items:center;gap:6px;flex-shrink:0}
.pal-r-short kbd{font-size:8px;padding:1px 4px}
.pal-r-arrow{color:var(--t5);font-size:10px;opacity:0;transition:opacity .08s;font-family:var(--m)}
.pal-r.active .pal-r-arrow{opacity:1;color:var(--ac)}
.pal-empty{padding:28px;text-align:center;color:var(--t4);font-size:12px}

.pal-foot{display:flex;align-items:center;gap:12px;padding:8px 16px;border-top:1px solid var(--bd);background:var(--s1)}
.pal-foot span{font-size:9px;color:var(--t4);display:flex;align-items:center;gap:4px;font-family:var(--m)}
.pal-foot kbd{font-size:8px;padding:1px 4px;margin:0 1px}

/* ‚ïê‚ïê‚ïê Edit Modal ‚ïê‚ïê‚ïê */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .12s;backdrop-filter:blur(6px)}
.mo.open{opacity:1;pointer-events:auto}
.mbox{background:var(--s2);border:1px solid var(--bl);border-radius:var(--rl);padding:28px;width:420px;transform:scale(.94);transition:transform .15s cubic-bezier(.4,0,.2,1);box-shadow:var(--sh)}
.mo.open .mbox{transform:scale(1)}
.mbox h2{font-size:15px;font-weight:600;margin-bottom:20px}
.mbox label{display:block;font-size:9px;color:var(--t4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px;font-weight:600}
.mbox input,.mbox textarea,.mbox select{width:100%;background:var(--s4);border:1px solid var(--bd);border-radius:6px;padding:9px 11px;color:var(--t1);font-size:12px;font-family:var(--f);outline:none;margin-bottom:14px;transition:border-color .1s}
.mbox input:focus,.mbox textarea:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--acd)}
.mbox textarea{height:60px;resize:none;line-height:1.4}
.mbox select{cursor:pointer;-webkit-appearance:none;margin-bottom:14px}
.mbox .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* Shortcut recorder */
.rec-wrap{margin-bottom:14px}
.rec-display{display:flex;align-items:center;gap:8px;min-height:40px;background:var(--s4);border:1px solid var(--bd);border-radius:6px;padding:6px 12px;transition:border-color .1s}
.rec-display.recording{border-color:var(--ac);box-shadow:0 0 0 3px var(--acd);animation:pulse 1.2s ease infinite}
.rec-display.conflict{border-color:var(--r);box-shadow:0 0 0 3px var(--rdd)}
.rec-keys{display:flex;gap:3px;flex:1;min-height:24px;align-items:center;flex-wrap:wrap}
.rec-keys kbd{font-size:10px;padding:3px 8px;background:var(--s5);border-color:var(--bh)}
.rec-keys .placeholder{font-size:11px;color:var(--t4)}
.rec-btns{display:flex;gap:4px;flex-shrink:0}
.rec-btns button{padding:4px 10px;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer;font-family:var(--f);border:none;transition:all .1s}
.rec-btns .rec-btn{background:var(--acm);color:var(--ac)}
.rec-btns .rec-btn.active{background:var(--r);color:#fff;animation:pulse 1.2s ease infinite}
.rec-btns .clr-btn{background:var(--s5);color:var(--t3)}
.rec-conflict{font-size:10px;color:var(--r);margin-top:4px;display:flex;align-items:center;gap:4px}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}

.macts{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.macts button{padding:8px 20px;border-radius:var(--rd);font-size:12px;font-weight:600;cursor:pointer;font-family:var(--f);border:none;transition:all .1s}
.macts .bc{background:var(--s4);color:var(--t2)}
.macts .bc:hover{background:var(--s5)}
.macts .bs{background:var(--ac);color:#000}
.macts .bs:hover{filter:brightness(1.1)}

/* Toast */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(70px);background:var(--s3);border:1px solid var(--bl);border-radius:var(--rl);padding:10px 18px;font-size:12px;color:var(--t2);display:flex;align-items:center;gap:8px;z-index:500;transition:transform .25s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast .t-dot{width:6px;height:6px;border-radius:50%;background:var(--ac);flex-shrink:0}
.toast .t-cmd{color:var(--ac);font-weight:600;font-family:var(--m);font-size:11px}

::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}
.cmd-item{animation:fadeIn .12s ease both}

@media(max-width:860px){.layout{grid-template-columns:1fr}.sidebar{border-top:1px solid var(--bd)}}
</style>
</head>
<body>
<div class="hdr">
  <div class="hdr-l"><div class="logo">P</div><h1>Command Palette<em>dashboard</em></h1></div>
  <div class="hdr-r"><button class="cmd-trigger" onclick="openPal()"><span>Command</span><kbd id="trigKbd"></kbd></button></div>
</div>
<div class="layout">
  <div class="panel" id="panel"></div>
  <div class="sidebar" id="sidebar"></div>
</div>
<div class="pal-bg" id="palBg" onclick="if(event.target===this)closePal()">
  <div class="pal"><div class="pal-top"><span class="p-icon">‚åò</span><input class="pal-inp" id="palInp" placeholder="Type a command..." autocomplete="off" spellcheck="false"><span class="pal-esc" onclick="closePal()">ESC</span></div>
  <div class="pal-hints"><span class="pal-hint"><code>&gt;</code> navigate</span><span class="pal-hint"><code>+</code> create</span><span class="pal-hint"><code>?</code> search</span></div>
  <div class="pal-body" id="palBody"></div>
  <div class="pal-foot"><span><kbd>‚Üë</kbd><kbd>‚Üì</kbd> navigate</span><span><kbd>‚Üµ</kbd> execute</span><span><kbd>esc</kbd> close</span></div>
  </div>
</div>
<div class="mo" id="mo" onclick="if(event.target===this)closeMo()"><div class="mbox">
  <h2 id="moTi">Edit command</h2>
  <label>Name</label><input id="eName" maxlength="50">
  <label>Description</label><textarea id="eDesc"></textarea>
  <div class="row"><div><label>Category</label><select id="eCat"><option value="navigation">Navigation</option><option value="creation">Creation</option><option value="editing">Editing</option><option value="search">Search</option></select></div>
  <div><label>Action</label><select id="eAct"><option value="navigate">Navigate</option><option value="create">Create</option><option value="toggle">Toggle</option></select></div></div>
  <label>Keyboard shortcut</label>
  <div class="rec-wrap"><div class="rec-display" id="recDisp"><div class="rec-keys" id="recKeys"><span class="placeholder">No shortcut set</span></div><div class="rec-btns"><button class="rec-btn" id="recBtn" onclick="toggleRec()">Record</button><button class="clr-btn" onclick="clearRec()">Clear</button></div></div><div class="rec-conflict" id="recConflict" style="display:none">‚ö† Conflicts with: <b id="recConName"></b></div></div>
  <div class="macts"><button class="bc" onclick="closeMo()">Cancel</button><button class="bs" onclick="saveMo()">Save</button></div>
</div></div>
<div class="toast" id="toast"><span class="t-dot"></span><span id="toastMsg"></span></div>

<script>
// ‚ïê‚ïê‚ïê Platform ‚ïê‚ïê‚ïê
const IS_MAC=/Mac|iPhone|iPad/.test(navigator.platform||navigator.userAgent);
const MOD=IS_MAC?'‚åò':'Ctrl';
const MOD_KEY=IS_MAC?'Meta':'Control';
const KEY_MAP={Meta:'‚åò',Control:'Ctrl',Alt:IS_MAC?'‚å•':'Alt',Shift:IS_MAC?'‚áß':'Shift',ArrowUp:'‚Üë',ArrowDown:'‚Üì',ArrowLeft:'‚Üê',ArrowRight:'‚Üí',Enter:'‚Üµ',Backspace:'‚å´',Delete:'‚å¶',Escape:'Esc',Tab:'‚á•',' ':'Space'};
function keyLabel(k){return KEY_MAP[k]||k.replace(/^Key/,'').replace(/^Digit/,'')}
function modFirst(keys){const order=['Meta','Control','Alt','Shift'];return keys.sort((a,b)=>{const ai=order.indexOf(a),bi=order.indexOf(b);if(ai>=0&&bi>=0)return ai-bi;if(ai>=0)return -1;if(bi>=0)return 1;return 0})}

// ‚ïê‚ïê‚ïê Data ‚ïê‚ïê‚ïê
const SK='pulsar_cmd_v2';
const CATS=['navigation','creation','editing','search'];
const CAT_ICONS={navigation:'‚Üí',creation:'+',editing:'‚úé',search:'‚åï'};
const CAT_PREFIX={'>':'navigation','+':'creation','?':'search'};
const ACTION_MSGS={navigate:'Navigated to',create:'Created',toggle:'Toggled'};

let cmds=[],editId=null,palOpen=false,activeIdx=0;
let recent=[],actionLog=[];
let recording=false,recKeys=[];

function gid(){return 'c_'+Math.random().toString(36).slice(2,8)}
function save(){localStorage.setItem(SK,JSON.stringify({cmds,recent}))}
function load(){const r=localStorage.getItem(SK);if(r){try{const d=JSON.parse(r);cmds=d.cmds||[];recent=d.recent||[]}catch(e){seed()}}else seed()}

function seed(){
  cmds=[
    {id:gid(),name:'Go to Dashboard',desc:'Navigate to the main dashboard',cat:'navigation',action:'navigate',keys:['Meta','d'],enabled:true},
    {id:gid(),name:'Go to Habits',desc:'Open the habit tracker',cat:'navigation',action:'navigate',keys:['Meta','h'],enabled:true},
    {id:gid(),name:'Go to Goals',desc:'Open goal tracking',cat:'navigation',action:'navigate',keys:['Meta','g'],enabled:true},
    {id:gid(),name:'Go to Tasks',desc:'Open task board',cat:'navigation',action:'navigate',keys:[],enabled:true},
    {id:gid(),name:'Go to Calendar',desc:'Open calendar view',cat:'navigation',action:'navigate',keys:[],enabled:true},
    {id:gid(),name:'Go to Settings',desc:'Open platform settings',cat:'navigation',action:'navigate',keys:['Meta','Comma'],enabled:true},
    {id:gid(),name:'New Task',desc:'Create a new task quickly',cat:'creation',action:'create',keys:['Meta','n'],enabled:true},
    {id:gid(),name:'New Note',desc:'Start a blank note',cat:'creation',action:'create',keys:[],enabled:true},
    {id:gid(),name:'New Goal',desc:'Define a new goal',cat:'creation',action:'create',keys:[],enabled:true},
    {id:gid(),name:'New Habit',desc:'Add a habit to track',cat:'creation',action:'create',keys:[],enabled:true},
    {id:gid(),name:'Toggle Sidebar',desc:'Show or hide sidebar',cat:'editing',action:'toggle',keys:['Meta','b'],enabled:true},
    {id:gid(),name:'Toggle Dark Mode',desc:'Switch theme',cat:'editing',action:'toggle',keys:[],enabled:true},
    {id:gid(),name:'Toggle Focus Mode',desc:'Minimize distractions',cat:'editing',action:'toggle',keys:['Meta','Shift','f'],enabled:true},
    {id:gid(),name:'Search Notes',desc:'Full-text search notes',cat:'search',action:'navigate',keys:['Meta','Shift','s'],enabled:true},
    {id:gid(),name:'Search Tasks',desc:'Find tasks by keyword',cat:'search',action:'navigate',keys:[],enabled:true},
    {id:gid(),name:'Search Everything',desc:'Global search',cat:'search',action:'navigate',keys:['Meta','Slash'],enabled:true},
  ];
  recent=[];save();
}

function renderKbd(keys){if(!keys||!keys.length)return '';return modFirst([...keys]).map(k=>`<kbd>${esc(keyLabel(k))}</kbd>`).join('')}
function keysStr(keys){return modFirst([...keys]).map(k=>keyLabel(k)).join('+')}

// ‚ïê‚ïê‚ïê Conflicts ‚ïê‚ïê‚ïê
function findConflict(keys,excludeId){
  if(!keys.length)return null;
  const s=keysStr(keys).toLowerCase();
  return cmds.find(c=>c.id!==excludeId&&c.keys.length&&keysStr(c.keys).toLowerCase()===s);
}
function getConflicts(){
  const map={},conf=new Set();
  cmds.forEach(c=>{if(!c.keys.length)return;const s=keysStr(c.keys).toLowerCase();if(map[s])conf.add(map[s]).add(c.id);else map[s]=c.id});
  return conf;
}

// ‚ïê‚ïê‚ïê Filtering ‚ïê‚ïê‚ïê
function filterCmds(q){
  let query=q.trim().toLowerCase(),catF=null;
  if(query.length&&CAT_PREFIX[query[0]]){catF=CAT_PREFIX[query[0]];query=query.slice(1).trim()}
  return cmds.filter(c=>{if(!c.enabled)return false;if(catF&&c.cat!==catF)return false;if(!query)return true;return c.name.toLowerCase().includes(query)||c.desc.toLowerCase().includes(query)});
}
function groupByCat(list){const g={};list.forEach(c=>{(g[c.cat]=g[c.cat]||[]).push(c)});return g}

// ‚ïê‚ïê‚ïê Render ‚ïê‚ïê‚ïê
function render(){renderPanel();renderSidebar();document.getElementById('trigKbd').innerHTML=`${MOD}+K`}

let panelFilter='';
function renderPanel(){
  const p=document.getElementById('panel'),conf=getConflicts();
  const shown=panelFilter?cmds.filter(c=>c.name.toLowerCase().includes(panelFilter)||c.cat.includes(panelFilter)):cmds;
  let h=`<div class="sec"><div class="sec-hdr"><span class="sec-t">Commands ¬∑ ${cmds.length}</span><div class="sec-acts"><button class="btn-sm primary" onclick="addCmd()">+ Add</button></div></div>
  <div class="panel-search"><svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="7" cy="7" r="5"/><line x1="11" y1="11" x2="14" y2="14"/></svg><input placeholder="Filter commands..." value="${esc(panelFilter)}" oninput="panelFilter=this.value.toLowerCase();renderPanel()"></div>`;

  if(conf.size){h+=`<div class="conflict-warn">‚ö† ${conf.size} command${conf.size>1?'s':''} with shortcut conflicts</div>`}

  h+=`<div class="cmd-list">`;
  shown.forEach((c,i)=>{
    const hasConf=conf.has(c.id);
    h+=`<div class="cmd-item${c.enabled?'':' disabled'}${hasConf?' conflict':''}" draggable="true" data-idx="${i}" style="animation-delay:${i*15}ms"
      ondragstart="drgS(event,${i})" ondragover="drgO(event,${i})" ondragleave="drgL(event)" ondrop="drgD(event,${i})" ondragend="drgE(event)">
      <div class="cmd-icon ${c.cat}">${CAT_ICONS[c.cat]}</div>
      <div class="cmd-body"><div class="cmd-name">${esc(c.name)}</div><div class="cmd-desc">${esc(c.desc)}</div></div>
      <div class="cmd-short">${c.keys.length?`<span class="keys">${renderKbd(c.keys)}</span>`:`<span class="no-short">‚Äî</span>`}</div>
      <div class="cmd-acts">
        <button class="act-edit" onclick="event.stopPropagation();openEdit('${c.id}')" title="Edit">‚úèÔ∏è</button>
        <button class="act-dis" onclick="event.stopPropagation();togEn('${c.id}')" title="${c.enabled?'Disable':'Enable'}">${c.enabled?'‚óâ':'‚óØ'}</button>
        <button class="act-del" onclick="event.stopPropagation();delCmd('${c.id}')" title="Delete">‚úï</button>
      </div></div>`;
  });
  h+=`</div></div>`;
  p.innerHTML=h;
}

function renderSidebar(){
  const sb=document.getElementById('sidebar');
  const total=cmds.length,en=cmds.filter(c=>c.enabled).length,wk=cmds.filter(c=>c.keys.length).length,cats=new Set(cmds.map(c=>c.cat)).size;
  let h=`<div class="sb-card"><h3>üìä Overview</h3><div class="sb-stats">
    <div class="sb-stat"><div class="sv teal">${en}</div><div class="sl">Active</div></div>
    <div class="sb-stat"><div class="sv pur">${total-en}</div><div class="sl">Disabled</div></div>
    <div class="sb-stat"><div class="sv blue">${wk}</div><div class="sl">With shortcut</div></div>
    <div class="sb-stat"><div class="sv am">${cats}</div><div class="sl">Categories</div></div>
  </div></div>`;

  h+=`<div class="sb-card"><h3>‚å®Ô∏è Keyboard</h3>`;
  const scs=[['Open palette',MOD,'K'],['Close','Esc'],['Navigate','‚Üë','‚Üì'],['Execute','‚Üµ'],['Filter: nav','>','...'],['Filter: create','+','...'],['Filter: search','?','...']];
  scs.forEach(s=>{h+=`<div class="sc-row"><span class="sc-lbl">${s[0]}</span><div class="sc-keys">${s.slice(1).map(k=>`<kbd>${k}</kbd>`).join('')}</div></div>`});
  h+=`</div>`;

  h+=`<div class="sb-card"><h3>üìã Activity</h3><div class="log" id="logArea">`;
  if(actionLog.length)actionLog.forEach(l=>{h+=`<div class="log-entry"><span class="log-time">${l.time}</span><span class="log-msg">${l.verb} <span class="hl">${esc(l.name)}</span></span></div>`});
  else h+=`<div class="log-empty">Execute commands to see activity</div>`;
  h+=`</div></div>`;
  sb.innerHTML=h;
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ‚ïê‚ïê‚ïê Panel actions ‚ïê‚ïê‚ïê
function addCmd(){
  const c={id:gid(),name:'New Command',desc:'',cat:'navigation',action:'navigate',keys:[],enabled:true};
  cmds.unshift(c);save();openEdit(c.id);
}
let drgSrc=null;
function drgS(e,i){drgSrc=i;e.dataTransfer.effectAllowed='move';e.currentTarget.classList.add('dragging')}
function drgO(e,i){e.preventDefault();e.dataTransfer.dropEffect='move';
  document.querySelectorAll('.drag-over-top,.drag-over-bot').forEach(x=>x.classList.remove('drag-over-top','drag-over-bot'));
  if(i!==drgSrc)e.currentTarget.classList.add(i<drgSrc?'drag-over-top':'drag-over-bot')}
function drgL(e){e.currentTarget.classList.remove('drag-over-top','drag-over-bot')}
function drgD(e,i){e.preventDefault();
  document.querySelectorAll('.drag-over-top,.drag-over-bot,.dragging').forEach(x=>x.classList.remove('drag-over-top','drag-over-bot','dragging'));
  if(drgSrc===null||drgSrc===i)return;
  const c=cmds.splice(drgSrc,1)[0];cmds.splice(i,0,c);save();renderPanel()}
function drgE(e){document.querySelectorAll('.drag-over-top,.drag-over-bot,.dragging').forEach(x=>x.classList.remove('drag-over-top','drag-over-bot','dragging'));drgSrc=null}
function togEn(id){const c=cmds.find(x=>x.id===id);if(c){c.enabled=!c.enabled;save();render()}}
function delCmd(id){cmds=cmds.filter(c=>c.id!==id);save();render()}

// ‚ïê‚ïê‚ïê Edit Modal ‚ïê‚ïê‚ïê
function openEdit(id){
  const c=cmds.find(x=>x.id===id);if(!c)return;editId=id;
  document.getElementById('moTi').textContent='Edit command';
  document.getElementById('eName').value=c.name;
  document.getElementById('eDesc').value=c.desc;
  document.getElementById('eCat').value=c.cat;
  document.getElementById('eAct').value=c.action;
  recKeys=[...c.keys];recording=false;updRec();
  document.getElementById('mo').classList.add('open');
  setTimeout(()=>document.getElementById('eName').focus(),80);
}
function closeMo(){document.getElementById('mo').classList.remove('open');recording=false;document.getElementById('recBtn').classList.remove('active');document.getElementById('recBtn').textContent='Record'}
function saveMo(){
  const c=cmds.find(x=>x.id===editId);if(!c)return;
  c.name=document.getElementById('eName').value.trim()||'Untitled';
  c.desc=document.getElementById('eDesc').value.trim();
  c.cat=document.getElementById('eCat').value;
  c.action=document.getElementById('eAct').value;
  c.keys=[...recKeys];
  closeMo();save();render();rebindShortcuts();
}

// ‚ïê‚ïê‚ïê Shortcut Recorder ‚ïê‚ïê‚ïê
function toggleRec(){
  recording=!recording;
  const btn=document.getElementById('recBtn');
  if(recording){btn.textContent='Press keys...';btn.classList.add('active');document.getElementById('recDisp').classList.add('recording');recKeys=[]}
  else{btn.textContent='Record';btn.classList.remove('active');document.getElementById('recDisp').classList.remove('recording')}
  updRec();
}
function clearRec(){recKeys=[];recording=false;document.getElementById('recBtn').textContent='Record';document.getElementById('recBtn').classList.remove('active');document.getElementById('recDisp').classList.remove('recording');updRec()}
function updRec(){
  const el=document.getElementById('recKeys');
  if(!recKeys.length)el.innerHTML='<span class="placeholder">No shortcut set</span>';
  else el.innerHTML=modFirst([...recKeys]).map(k=>`<kbd>${esc(keyLabel(k))}</kbd>`).join('');
  // Conflict check
  const conf=findConflict(recKeys,editId);
  const ce=document.getElementById('recConflict');
  if(conf){ce.style.display='flex';document.getElementById('recConName').textContent=conf.name;document.getElementById('recDisp').classList.add('conflict')}
  else{ce.style.display='none';document.getElementById('recDisp').classList.remove('conflict')}
}

// Global key listener for recorder
document.addEventListener('keydown',e=>{
  if(!recording)return;
  e.preventDefault();e.stopPropagation();
  const k=e.key==='Meta'?'Meta':e.key==='Control'?'Control':e.key==='Alt'?'Alt':e.key==='Shift'?'Shift':e.code||e.key;
  // Build combo: modifiers + one regular key
  const mods=[];
  if(e.metaKey)mods.push('Meta');if(e.ctrlKey)mods.push('Control');if(e.altKey)mods.push('Alt');if(e.shiftKey)mods.push('Shift');
  const isModOnly=['Meta','Control','Alt','Shift'].includes(k);
  if(!isModOnly){recKeys=[...mods,k.length===1?k.toLowerCase():k];recording=false;
    document.getElementById('recBtn').textContent='Record';document.getElementById('recBtn').classList.remove('active');document.getElementById('recDisp').classList.remove('recording')}
  else recKeys=[...mods];
  updRec();
},true);

// ‚ïê‚ïê‚ïê Palette ‚ïê‚ïê‚ïê
function openPal(){palOpen=true;activeIdx=0;document.getElementById('palBg').classList.add('open');const inp=document.getElementById('palInp');inp.value='';inp.focus();renderPal('')}
function closePal(){palOpen=false;document.getElementById('palBg').classList.remove('open')}

function renderPal(query){
  const list=filterCmds(query),groups=groupByCat(list);
  const pb=document.getElementById('palBody');
  if(!list.length){pb.innerHTML='<div class="pal-empty">No commands found</div>';return}

  let h='',fi=0;
  // Recent first (if no query)
  if(!query.trim()&&recent.length){
    const recCmds=recent.map(id=>cmds.find(c=>c.id===id&&c.enabled)).filter(Boolean).slice(0,3);
    if(recCmds.length){
      h+=`<div class="pal-sec">Recent</div>`;
      recCmds.forEach(c=>{h+=palItem(c,fi,query);fi++});
    }
  }
  const catOrder=['navigation','creation','editing','search'];
  catOrder.forEach(cat=>{
    if(!groups[cat])return;
    h+=`<div class="pal-sec">${cat} <span class="cnt">${groups[cat].length}</span></div>`;
    groups[cat].forEach(c=>{h+=palItem(c,fi,query);fi++});
  });
  pb.innerHTML=h;
  const el=pb.querySelector('.pal-r.active');if(el)el.scrollIntoView({block:'nearest'});
}

function palItem(c,idx,query){
  const a=idx===activeIdx;
  return`<div class="pal-r${a?' active':''}" data-idx="${idx}" data-id="${c.id}" onmouseenter="activeIdx=${idx};renderPal(document.getElementById('palInp').value)" onclick="execCmd('${c.id}')">
    <div class="pal-r-icon ${c.cat}">${CAT_ICONS[c.cat]}</div>
    <div class="pal-r-body"><div class="pal-r-name">${hl(c.name,query)}</div>${c.desc?`<div class="pal-r-desc">${esc(c.desc)}</div>`:''}</div>
    <div class="pal-r-meta">${c.keys.length?`<span class="pal-r-short">${renderKbd(c.keys)}</span>`:''}<span class="pal-r-arrow">‚Üµ</span></div></div>`;
}

function hl(text,query){let q=query.trim().toLowerCase();if(q.length&&CAT_PREFIX[q[0]])q=q.slice(1).trim();if(!q)return esc(text);const i=text.toLowerCase().indexOf(q);if(i<0)return esc(text);return esc(text.slice(0,i))+`<span style="color:var(--ac);font-weight:600">${esc(text.slice(i,i+q.length))}</span>`+esc(text.slice(i+q.length))}

function execCmd(id){
  const c=cmds.find(x=>x.id===id);if(!c)return;
  closePal();
  // Recent
  recent=recent.filter(r=>r!==id);recent.unshift(id);if(recent.length>5)recent.pop();
  // Log
  const t=new Date().toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const verb=ACTION_MSGS[c.action]||'Executed';
  actionLog.unshift({name:c.name,cat:c.cat,time:t,verb});if(actionLog.length>25)actionLog.pop();
  showToast(`${verb} ${c.name}`);save();renderSidebar();
}

function showToast(msg){const t=document.getElementById('toast');document.getElementById('toastMsg').textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),2200)}

// Palette input
document.getElementById('palInp').addEventListener('input',e=>{activeIdx=0;renderPal(e.target.value)});

// ‚ïê‚ïê‚ïê Shortcut bindings ‚ïê‚ïê‚ïê
let boundShortcuts={};
function rebindShortcuts(){
  boundShortcuts={};
  cmds.forEach(c=>{if(!c.enabled||!c.keys.length)return;const s=keysStr(c.keys).toLowerCase();boundShortcuts[s]=c.id});
}

// ‚ïê‚ïê‚ïê Global keyboard ‚ïê‚ïê‚ïê
document.addEventListener('keydown',e=>{
  if(recording)return;
  // Palette toggle
  if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==='k'){e.preventDefault();palOpen?closePal():openPal();return}
  if(palOpen){
    if(e.key==='Escape'){closePal();return}
    const list=filterCmds(document.getElementById('palInp').value);
    if(e.key==='ArrowDown'){e.preventDefault();activeIdx=Math.min(activeIdx+1,list.length-1);renderPal(document.getElementById('palInp').value);return}
    if(e.key==='ArrowUp'){e.preventDefault();activeIdx=Math.max(activeIdx-1,0);renderPal(document.getElementById('palInp').value);return}
    if(e.key==='Enter'){e.preventDefault();if(list[activeIdx])execCmd(list[activeIdx].id);return}
    return;
  }
  // Modal escape
  if(e.key==='Escape'&&document.getElementById('mo').classList.contains('open')){closeMo();return}
  // Bound shortcuts
  const mods=[];
  if(e.metaKey)mods.push('‚åò');if(e.ctrlKey)mods.push('Ctrl');if(e.altKey)mods.push(IS_MAC?'‚å•':'Alt');if(e.shiftKey)mods.push(IS_MAC?'‚áß':'Shift');
  const key=e.key.length===1?e.key.toLowerCase():e.code||e.key;
  const raw=[];if(e.metaKey)raw.push('Meta');if(e.ctrlKey)raw.push('Control');if(e.altKey)raw.push('Alt');if(e.shiftKey)raw.push('Shift');raw.push(key);
  const s=keysStr(raw).toLowerCase();
  if(boundShortcuts[s]){e.preventDefault();execCmd(boundShortcuts[s])}
});

// ‚ïê‚ïê‚ïê Init ‚ïê‚ïê‚ïê
load();render();rebindShortcuts();
</script>
</body>
</html>