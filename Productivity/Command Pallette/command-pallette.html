<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulsar — Command Palette</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
--bg:#08090b;--s1:#0f1113;--s2:#151719;--s3:#1c1e21;--s4:#22252a;
--border:#1c1e21;--border-light:#272a2f;
--text:#f0f0f0;--text-dim:#9ca3af;--text-dimmer:#6b7280;--text-dimmest:#4b5563;
--accent:#14b8a6;--accent-dim:rgba(20,184,166,0.1);--accent-bright:#2dd4bf;
--blue:#3b82f6;--blue-dim:rgba(59,130,246,0.1);
--purple:#8b5cf6;--purple-dim:rgba(139,92,246,0.1);
--amber:#f59e0b;--amber-dim:rgba(245,158,11,0.1);
--red:#ef4444;--red-dim:rgba(239,68,68,0.1);
--radius:10px;--radius-sm:6px;
--font:'DM Sans',system-ui,sans-serif;
--mono:'JetBrains Mono',monospace;
--shadow:0 4px 24px rgba(0,0,0,0.4);
}

html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-font-smoothing:antialiased;overflow:hidden}

/* Header */
.header{height:64px;background:var(--s1);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:16px}
.logo{width:36px;height:36px;background:linear-gradient(135deg,var(--accent-bright),var(--accent));border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:#000;box-shadow:0 2px 8px rgba(20,184,166,0.3)}
.header h1{font-size:15px;font-weight:600;letter-spacing:-0.3px}
.header h1 span{color:var(--text-dimmest);font-weight:400;margin-left:8px;font-size:12px}
.trigger{background:var(--s3);border:1px solid var(--border-light);color:var(--text-dim);padding:8px 16px;border-radius:var(--radius-sm);font:500 12px var(--font);cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.15s;min-height:36px}
.trigger:hover{background:var(--s4);border-color:var(--accent);color:var(--accent)}
.trigger kbd{background:var(--s4);border:1px solid var(--border-light);padding:2px 6px;border-radius:4px;font:500 10px var(--mono);color:var(--text-dimmer)}

/* Main layout */
.main{display:flex;height:calc(100vh - 64px);overflow:hidden}
.panel{flex:1;background:var(--bg);overflow-y:auto;overflow-x:hidden}
.panel-inner {
  padding: 32px;
  max-width: 1200px;
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin: 32px;
}
.sidebar{width:320px;background:var(--s1);border-left:1px solid var(--border);overflow-y:auto;overflow-x:hidden}
.sidebar-inner{padding:24px}

/* Section header */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.section-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dimmest);display:flex;align-items:center;gap:8px}
.section-title .badge{background:var(--s3);color:var(--accent);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.btn-add{background:var(--accent);border:none;color:#000;padding:8px 16px;border-radius:var(--radius-sm);font:600 12px var(--font);cursor:pointer;transition:all 0.15s;min-height:36px}
.btn-add:hover{background:var(--accent-bright);transform:translateY(-1px)}

/* Filter */
.filter{background:var(--s2);border:1px solid var(--border);border-radius:var(--radius-sm);display:flex;align-items:center;gap:8px;padding:0 12px;margin-bottom:16px;transition:all 0.15s;height:40px}
.filter:focus-within{border-color:var(--accent);background:var(--s3)}
.filter svg{width:16px;height:16px;color:var(--text-dimmer);flex-shrink:0}
.filter input{flex:1;background:none;border:none;color:var(--text);font:400 13px var(--font);outline:none}
.filter input::placeholder{color:var(--text-dimmer)}
.filter .clear{background:none;border:none;color:var(--text-dimmest);cursor:pointer;padding:4px;border-radius:4px;display:flex;opacity:0;pointer-events:none;transition:all 0.15s}
.filter.has-value .clear{opacity:1;pointer-events:auto}
.filter .clear:hover{background:var(--s4);color:var(--text-dim)}

/* Conflict warning */
.warning{background:var(--red-dim);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius-sm);padding:12px;display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:12px;color:var(--red)}
.warning svg{width:16px;height:16px;flex-shrink:0}

/* Command list */
.commands{display:flex;flex-direction:column;gap:8px}
.cmd{background:var(--s2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:grid;grid-template-columns:40px 1fr auto auto;gap:16px;align-items:center;cursor:grab;transition:all 0.15s;min-height:72px}
.cmd:hover{background:var(--s3);border-color:var(--border-light);transform:translateX(2px)}
.cmd:active{cursor:grabbing}
.cmd.disabled{opacity:0.4}
.cmd.conflict{border-color:rgba(239,68,68,0.4);background:var(--red-dim)}
.cmd.dragging{opacity:0.3;pointer-events:none}
.cmd.ghost{position:fixed;z-index:9999;pointer-events:none;opacity:0.95;box-shadow:var(--shadow);transform:rotate(1deg)}

.icon{width:40px;height:40px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;flex-shrink:0}
.icon.nav{background:var(--blue-dim);color:var(--blue)}
.icon.create{background:var(--accent-dim);color:var(--accent)}
.icon.edit{background:var(--purple-dim);color:var(--purple)}
.icon.search{background:var(--amber-dim);color:var(--amber)}

.cmd-body{min-width:0}
.cmd-name{font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cmd-desc{font-size:12px;color:var(--text-dimmer);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.shortcut{display:flex;gap:4px;align-items:center}
.shortcut kbd{background:var(--s4);border:1px solid var(--border-light);padding:4px 8px;border-radius:4px;font:500 11px var(--mono);color:var(--text-dim)}
.shortcut .none{color:var(--text-dimmest);font-size:12px}

.actions{display:flex;gap:6px}
.actions button{width:36px;height:36px;background:none;border:1px solid transparent;border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;padding:0}
.actions button svg{width:16px;height:16px}
.actions .edit{background:var(--blue-dim);color:var(--blue);border-color:rgba(59,130,246,0.2)}
.actions .edit:hover{background:rgba(59,130,246,0.2);transform:scale(1.1)}
.actions .toggle{background:var(--amber-dim);color:var(--amber);border-color:rgba(245,158,11,0.2)}
.actions .toggle:hover{background:rgba(245,158,11,0.2);transform:scale(1.1)}
.actions .delete{background:var(--red-dim);color:var(--red);border-color:rgba(239,68,68,0.2)}
.actions .delete:hover{background:rgba(239,68,68,0.2);transform:scale(1.1)}

/* Sidebar cards */
.card{background:var(--s2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.card h3{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card h3 svg{width:16px;height:16px}

.stats{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.stat{background:var(--s3);border-radius:var(--radius-sm);padding:16px;text-align:center}
.stat-value{font:700 24px var(--mono);line-height:1;margin-bottom:6px}
.stat-value.teal{color:var(--accent)}
.stat-value.purple{color:var(--purple)}
.stat-value.blue{color:var(--blue)}
.stat-value.amber{color:var(--amber)}
.stat-label{font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dimmest);font-weight:600}

.shortcuts{display:flex;flex-direction:column}
.shortcut-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.shortcut-row:last-child{border:none}
.shortcut-row span{font-size:11px;color:var(--text-dimmer)}
.shortcut-row .keys{display:flex;gap:4px}
.shortcut-row kbd{background:var(--s3);border:1px solid var(--border);padding:2px 6px;border-radius:4px;font:500 10px var(--mono);color:var(--text-dim)}

.log{max-height:240px;overflow-y:auto;font:400 11px var(--mono)}
.log-item{display:flex;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.log-item:last-child{border:none}
.log-time{color:var(--text-dimmest);flex-shrink:0;min-width:70px}
.log-msg{color:var(--text-dimmer)}
.log-msg .hl{color:var(--accent);font-weight:600}
.log-empty{text-align:center;padding:24px;color:var(--text-dimmest);font-size:12px}

/* Palette modal */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:100;display:flex;align-items:flex-start;justify-content:center;padding-top:120px;opacity:0;pointer-events:none;transition:opacity 0.2s}
.overlay.open{opacity:1;pointer-events:auto}

.palette{width:600px;max-width:90vw;max-height:480px;background:var(--s2);border:1px solid var(--border-light);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;transform:scale(0.95) translateY(-20px);transition:transform 0.2s cubic-bezier(0.4,0,0.2,1)}
.overlay.open .palette{transform:scale(1) translateY(0)}

.palette-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;min-height:60px;flex-shrink:0}
.palette-icon{color:var(--accent);font-size:18px;font-weight:600;font-family:var(--mono)}
.palette-input{flex:1;background:none;border:none;color:var(--text);font:500 15px var(--mono);outline:none}
.palette-input::placeholder{color:var(--text-dimmer)}
.palette-esc{background:var(--s3);border:1px solid var(--border);padding:4px 10px;border-radius:4px;font:500 10px var(--mono);color:var(--text-dimmer);cursor:pointer;transition:all 0.15s}
.palette-esc:hover{background:var(--s4)}

.palette-hints{padding:8px 20px;border-bottom:1px solid var(--border);background:var(--s1);display:flex;gap:16px;font:400 10px var(--mono);color:var(--text-dimmer);flex-shrink:0}
.palette-hints code{color:var(--accent);background:var(--accent-dim);padding:2px 6px;border-radius:4px;font-weight:600}

.palette-body{flex:1;overflow-y:auto;overflow-x:hidden;padding:8px}
.palette-section{padding:8px 12px 4px;font:600 10px var(--font);text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dimmest)}
.palette-item{padding:12px;border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.1s;margin:2px 0}
.palette-item:hover{background:var(--s3)}
.palette-item.active{background:var(--accent-dim);border:1px solid rgba(20,184,166,0.2)}
.palette-item .icon{width:32px;height:32px;font-size:14px}
.palette-item-body{flex:1;min-width:0}
.palette-item-name{font:600 13px var(--font);color:var(--text);margin-bottom:2px}
.palette-item-desc{font:400 11px var(--font);color:var(--text-dimmer);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.palette-item-meta{display:flex;align-items:center;gap:8px}
.palette-empty{padding:40px;text-align:center;font:400 13px var(--font);color:var(--text-dimmer)}

.palette-footer{padding:12px 20px;border-top:1px solid var(--border);background:var(--s1);display:flex;gap:16px;font:400 10px var(--mono);color:var(--text-dimmer);flex-shrink:0}

/* Edit modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s}
.modal.open{opacity:1;pointer-events:auto}
.modal-box{width:480px;max-width:90vw;max-height:90vh;overflow-y:auto;background:var(--s2);border:1px solid var(--border-light);border-radius:var(--radius);padding:32px;box-shadow:var(--shadow);transform:scale(0.95);transition:transform 0.2s}
.modal.open .modal-box{transform:scale(1)}
.modal h2{font-size:18px;font-weight:600;margin-bottom:24px}
.modal label{display:block;font:600 10px var(--font);text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:8px}
.modal input,.modal textarea,.modal select{width:100%;background:var(--s3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;color:var(--text);font:400 13px var(--font);margin-bottom:16px;outline:none;transition:all 0.15s}
.modal input:focus,.modal textarea:focus,.modal select:focus{border-color:var(--accent);background:var(--s4)}
.modal textarea{resize:none;height:80px;line-height:1.5}
.modal select{cursor:pointer}
.modal .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.recorder{background:var(--s3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;display:flex;align-items:center;gap:12px;margin-bottom:16px;min-height:48px;transition:all 0.15s}
.recorder.active{border-color:var(--accent);background:var(--accent-dim)}
.recorder.conflict{border-color:var(--red);background:var(--red-dim)}
.recorder-keys{flex:1;display:flex;gap:4px;flex-wrap:wrap;min-height:24px;align-items:center}
.recorder-keys .placeholder{color:var(--text-dimmer);font-size:12px}
.recorder-keys kbd{background:var(--s4);border:1px solid var(--border-light);padding:4px 8px;border-radius:4px;font:500 11px var(--mono)}
.recorder-btns{display:flex;gap:6px}
.recorder-btns button{padding:6px 12px;border:none;border-radius:var(--radius-sm);font:600 11px var(--font);cursor:pointer;transition:all 0.15s}
.recorder-btns .record{background:var(--accent-dim);color:var(--accent)}
.recorder-btns .record.active{background:var(--red);color:#fff}
.recorder-btns .clear{background:var(--s4);color:var(--text-dim)}
.recorder-conflict{margin-top:8px;font-size:11px;color:var(--red);display:none}
.recorder-conflict.show{display:block}

.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
.modal-actions button{padding:10px 24px;border:none;border-radius:var(--radius-sm);font:600 13px var(--font);cursor:pointer;transition:all 0.15s;min-height:40px}
.modal-actions .cancel{background:var(--s3);color:var(--text-dim)}
.modal-actions .cancel:hover{background:var(--s4)}
.modal-actions .save{background:var(--accent);color:#000}
.modal-actions .save:hover{background:var(--accent-bright)}

/* Toast */
.toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--s3);border:1px solid var(--border-light);border-radius:var(--radius);padding:12px 20px;box-shadow:var(--shadow);display:flex;align-items:center;gap:12px;z-index:300;transition:transform 0.3s;font:500 13px var(--font);min-height:48px}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast-dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}

/* Empty state */
.empty{padding:80px 40px;text-align:center}
.empty svg{width:64px;height:64px;margin:0 auto 20px;opacity:0.3}
.empty h3{font-size:16px;font-weight:600;color:var(--text-dim);margin-bottom:8px}
.empty p{font-size:13px;color:var(--text-dimmer)}

/* Scrollbar */
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--s4)}

/* Responsive */
@media(max-width:1024px){
.sidebar{display:none}
}
</style>
</head>
<body>
<div class="header">
  <div class="header-left">
    <div class="logo">P</div>
    <h1>Command Palette <span>Dashboard</span></h1>
  </div>
  <button class="trigger" onclick="openPalette()">
    <span>Command</span>
    <kbd id="triggerKbd"></kbd>
  </button>
</div>

<div class="main">
  <div class="panel">
    <div class="panel-inner" id="panel"></div>
  </div>
  <div class="sidebar">
    <div class="sidebar-inner" id="sidebar"></div>
  </div>
</div>

<div class="overlay" id="paletteOverlay" onclick="if(event.target===this)closePalette()">
  <div class="palette">
    <div class="palette-header">
      <span class="palette-icon">⌘</span>
      <input class="palette-input" id="paletteInput" placeholder="Type a command..." autocomplete="off">
      <span class="palette-esc" onclick="closePalette()">ESC</span>
    </div>
    <div class="palette-hints">
      <span><code>&gt;</code> navigate</span>
      <span><code>+</code> create</span>
      <span><code>?</code> search</span>
    </div>
    <div class="palette-body" id="paletteBody"></div>
    <div class="palette-footer">
      <span><kbd>↑</kbd><kbd>↓</kbd> navigate</span>
      <span><kbd>↵</kbd> execute</span>
      <span><kbd>esc</kbd> close</span>
    </div>
  </div>
</div>

<div class="modal" id="editModal" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <h2>Edit Command</h2>
    <label>Name</label>
    <input id="editName" maxlength="50">
    <label>Description</label>
    <textarea id="editDesc"></textarea>
    <div class="row">
      <div>
        <label>Category</label>
        <select id="editCat">
          <option value="navigation">Navigation</option>
          <option value="creation">Creation</option>
          <option value="editing">Editing</option>
          <option value="search">Search</option>
        </select>
      </div>
      <div>
        <label>Action</label>
        <select id="editAction">
          <option value="navigate">Navigate</option>
          <option value="create">Create</option>
          <option value="toggle">Toggle</option>
        </select>
      </div>
    </div>
    <label>Keyboard Shortcut</label>
    <div class="recorder" id="recorder">
      <div class="recorder-keys" id="recorderKeys">
        <span class="placeholder">No shortcut set</span>
      </div>
      <div class="recorder-btns">
        <button class="record" id="recordBtn" onclick="toggleRecord()">Record</button>
        <button class="clear" onclick="clearShortcut()">Clear</button>
      </div>
    </div>
    <div class="recorder-conflict" id="recorderConflict">⚠ Conflicts with: <strong id="conflictName"></strong></div>
    <div class="modal-actions">
      <button class="cancel" onclick="closeModal()">Cancel</button>
      <button class="save" onclick="saveCommand()">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <span class="toast-dot"></span>
  <span id="toastMsg"></span>
</div>

<script>
const IS_MAC=/Mac/.test(navigator.platform);
const MOD=IS_MAC?'⌘':'Ctrl';
const MOD_KEY=IS_MAC?'Meta':'Control';
const KEYS={Meta:'⌘',Control:'Ctrl',Alt:IS_MAC?'⌥':'Alt',Shift:IS_MAC?'⇧':'Shift',ArrowUp:'↑',ArrowDown:'↓',Enter:'↵',Escape:'Esc',' ':'Space'};
const ICONS={nav:'→',create:'+',edit:'✎',search:'⌕'};
const CATS={'>':'navigation','+':'creation','?':'search'};

const SK='pulsar_cmds';
let cmds=[],recent=[],log=[],filter='',editId=null,recKeys=[],recording=false,palActive=0;
let dragSrc=null,dragGhost=null;

function keyLabel(k){return KEYS[k]||k.replace(/^Key/,'').replace(/^Digit/,'')}
function keysStr(arr){const order=['Meta','Control','Alt','Shift'];return arr.sort((a,b)=>{const ai=order.indexOf(a),bi=order.indexOf(b);return ai>=0&&bi>=0?ai-bi:ai>=0?-1:bi>=0?1:0}).map(keyLabel).join('+')}

function svg(name){
const icons={
search:'<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M16 16l5 5"/></svg>',
edit:'<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 3l4 4L7 21H3v-4L17 3z"/></svg>',
power:'<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v9m-6 3a7 7 0 1012 0"/></svg>',
trash:'<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M8 6V4h8v2m1 0v14H7V6h10z"/></svg>',
warning:'<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm0 6l.01 7h-.02L12 8zm0 10a1 1 0 110 2 1 1 0 010-2z"/></svg>',
chart:'<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 17h4v4H3v-4zm7-7h4v11h-4V10zm7-7h4v18h-4V3z"/></svg>',
keyboard:'<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M6 16h12M7 9h1m3 0h1m3 0h1m3 0h1"/></svg>',
activity:'<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12h4l3-9 4 18 3-9h4"/></svg>'
};
return icons[name]||'';
}

function load(){
const d=localStorage.getItem(SK);
if(d){try{const p=JSON.parse(d);cmds=p.cmds||[];recent=p.recent||[];log=p.log||[]}catch(e){seed()}}else seed();
}

function save(){localStorage.setItem(SK,JSON.stringify({cmds,recent,log:log.slice(0,50)}))}

function seed(){
cmds=[
{id:gid(),name:'Go to Dashboard',desc:'Navigate to main dashboard',cat:'navigation',action:'navigate',keys:['Meta','d'],enabled:true},
{id:gid(),name:'Go to Habits',desc:'Open habit tracker',cat:'navigation',action:'navigate',keys:['Meta','h'],enabled:true},
{id:gid(),name:'Go to Goals',desc:'Open goal tracking',cat:'navigation',action:'navigate',keys:['Meta','g'],enabled:true},
{id:gid(),name:'Go to Tasks',desc:'Open task board',cat:'navigation',action:'navigate',keys:['Meta','t'],enabled:true},
{id:gid(),name:'Go to Calendar',desc:'Open calendar view',cat:'navigation',action:'navigate',keys:['Meta','c'],enabled:true},
{id:gid(),name:'New Task',desc:'Create a new task',cat:'creation',action:'create',keys:['Meta','n'],enabled:true},
{id:gid(),name:'New Note',desc:'Start a blank note',cat:'creation',action:'create',keys:['Meta','Shift','n'],enabled:true},
{id:gid(),name:'Toggle Sidebar',desc:'Show or hide sidebar',cat:'editing',action:'toggle',keys:['Meta','b'],enabled:true},
{id:gid(),name:'Toggle Focus Mode',desc:'Minimize distractions',cat:'editing',action:'toggle',keys:['Meta','Shift','f'],enabled:true},
{id:gid(),name:'Search Notes',desc:'Full-text search',cat:'search',action:'navigate',keys:['Meta','Shift','s'],enabled:true},
{id:gid(),name:'Search Everything',desc:'Global search',cat:'search',action:'navigate',keys:['Meta','Slash'],enabled:true}
];
save();
}

function gid(){return'c_'+Date.now().toString(36)+Math.random().toString(36).slice(2,9)}

function render(){renderPanel();renderSidebar();document.getElementById('triggerKbd').textContent=MOD+'+K'}

function renderPanel(){
const conf=getConflicts();
const shown=filter?cmds.filter(c=>c.name.toLowerCase().includes(filter)||c.desc.toLowerCase().includes(filter)):cmds;
let h=`<div class="section-header">
<div class="section-title">Commands <span class="badge">${cmds.length}</span></div>
<button class="btn-add" onclick="addCmd()">+ Add Command</button>
</div>
<div class="filter${filter?' has-value':''}">
${svg('search')}
<input placeholder="Filter commands..." value="${esc(filter)}" oninput="filter=this.value.toLowerCase();render()">
<button class="clear" onclick="filter='';render()">✕</button>
</div>`;
if(conf.size)h+=`<div class="warning">${svg('warning')} ${conf.size} command${conf.size>1?'s':''} with conflicts</div>`;
if(!shown.length){
h+=`<div class="empty">${svg('search')}<h3>No commands found</h3><p>Try adjusting your filter or add a command</p></div>`;
}else{
h+=`<div class="commands">`;
shown.forEach((c,i)=>{
const idx=cmds.indexOf(c);
h+=`<div class="cmd${c.enabled?'':' disabled'}${conf.has(c.id)?' conflict':''}" draggable="true" data-idx="${idx}" ondragstart="dragStart(event,${idx})" ondragover="dragOver(event,${idx})" ondragend="dragEnd()">
<div class="icon ${c.cat==='navigation'?'nav':c.cat==='creation'?'create':c.cat==='editing'?'edit':'search'}">${ICONS[c.cat==='navigation'?'nav':c.cat==='creation'?'create':c.cat==='editing'?'edit':'search']}</div>
<div class="cmd-body"><div class="cmd-name">${esc(c.name)}</div><div class="cmd-desc">${esc(c.desc)}</div></div>
<div class="shortcut">${c.keys.length?c.keys.map(k=>`<kbd>${keyLabel(k)}</kbd>`).join(''):'<span class="none">—</span>'}</div>
<div class="actions">
<button class="edit" onclick="openEdit('${c.id}')" title="Edit">${svg('edit')}</button>
<button class="toggle" onclick="toggle('${c.id}')" title="${c.enabled?'Disable':'Enable'}">${svg('power')}</button>
<button class="delete" onclick="del('${c.id}')" title="Delete">${svg('trash')}</button>
</div>
</div>`;
});
h+=`</div>`;
}
document.getElementById('panel').innerHTML=h;
}

function renderSidebar(){
const en=cmds.filter(c=>c.enabled).length;
const wk=cmds.filter(c=>c.keys.length).length;
let h=`<div class="card"><h3>${svg('chart')} Overview</h3><div class="stats">
<div class="stat"><div class="stat-value teal">${en}</div><div class="stat-label">Active</div></div>
<div class="stat"><div class="stat-value purple">${cmds.length-en}</div><div class="stat-label">Disabled</div></div>
<div class="stat"><div class="stat-value blue">${wk}</div><div class="stat-label">Shortcuts</div></div>
<div class="stat"><div class="stat-value amber">${new Set(cmds.map(c=>c.cat)).size}</div><div class="stat-label">Categories</div></div>
</div></div>`;
h+=`<div class="card"><h3>${svg('keyboard')} Shortcuts</h3><div class="shortcuts">`;
[['Open palette',MOD,'K'],['Navigate','↑','↓'],['Execute','↵'],['Filter: nav','>'],['Filter: create','+'],['Filter: search','?']].forEach(s=>{
h+=`<div class="shortcut-row"><span>${s[0]}</span><div class="keys">${s.slice(1).map(k=>`<kbd>${k}</kbd>`).join('')}</div></div>`;
});
h+=`</div></div>`;
h+=`<div class="card"><h3>${svg('activity')} Activity</h3><div class="log">`;
if(log.length){
log.slice(0,12).forEach(l=>h+=`<div class="log-item"><span class="log-time">${l.time}</span><span class="log-msg">${l.verb} <span class="hl">${esc(l.name)}</span></span></div>`);
}else h+=`<div class="log-empty">Execute commands to see activity</div>`;
h+=`</div></div>`;
document.getElementById('sidebar').innerHTML=h;
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function getConflicts(){
const m={},c=new Set();
cmds.forEach(x=>{if(!x.enabled||!x.keys.length)return;const s=keysStr(x.keys).toLowerCase();if(m[s])c.add(m[s]).add(x.id);else m[s]=x.id});
return c;
}

function findConflict(keys,exclude){
if(!keys.length)return null;
const s=keysStr(keys).toLowerCase();
return cmds.find(c=>c.id!==exclude&&c.enabled&&c.keys.length&&keysStr(c.keys).toLowerCase()===s);
}

function addCmd(){
const c={id:gid(),name:'New Command',desc:'',cat:'navigation',action:'navigate',keys:[],enabled:true};
cmds.unshift(c);save();openEdit(c.id);
}

function toggle(id){const c=cmds.find(x=>x.id===id);if(c){c.enabled=!c.enabled;save();render();bindShortcuts()}}

function del(id){if(!confirm('Delete this command?'))return;cmds=cmds.filter(c=>c.id!==id);recent=recent.filter(r=>r!==id);save();render();bindShortcuts()}

// Drag & drop
function dragStart(e,idx){
dragSrc=idx;
const el=e.currentTarget;
el.classList.add('dragging');
dragGhost=el.cloneNode(true);
dragGhost.classList.remove('dragging');
dragGhost.classList.add('ghost');
dragGhost.style.width=el.offsetWidth+'px';
dragGhost.style.pointerEvents='none';
document.body.appendChild(dragGhost);
const move=(me)=>{if(dragGhost){dragGhost.style.left=me.clientX-el.offsetWidth/2+'px';dragGhost.style.top=me.clientY-36+'px'}};
move(e);
document.addEventListener('mousemove',move);
dragGhost._move=move;
e.dataTransfer.effectAllowed='move';
e.dataTransfer.setDragImage(new Image(),0,0);
}

function dragOver(e,idx){
if(dragSrc===null||dragSrc===idx)return;
e.preventDefault();
const list=document.querySelector('.commands');
if(!list)return;
const items=Array.from(list.children);
const src=items[dragSrc];
const tgt=items[idx];
if(!src||!tgt)return;
if(dragSrc<idx)tgt.parentNode.insertBefore(src,tgt.nextSibling);
else tgt.parentNode.insertBefore(src,tgt);
const[moved]=cmds.splice(dragSrc,1);
cmds.splice(idx,0,moved);
dragSrc=idx;
}

function dragEnd(){
if(dragGhost){
if(dragGhost._move)document.removeEventListener('mousemove',dragGhost._move);
dragGhost.remove();
dragGhost=null;
}
document.querySelectorAll('.dragging').forEach(x=>x.classList.remove('dragging'));
if(dragSrc!==null){save();render()}
dragSrc=null;
}

// Edit modal
function openEdit(id){
const c=cmds.find(x=>x.id===id);
if(!c)return;
editId=id;
document.getElementById('editName').value=c.name;
document.getElementById('editDesc').value=c.desc;
document.getElementById('editCat').value=c.cat;
document.getElementById('editAction').value=c.action;
recKeys=[...c.keys];
recording=false;
updateRecorder();
document.getElementById('editModal').classList.add('open');
setTimeout(()=>document.getElementById('editName').focus(),100);
}

function closeModal(){
document.getElementById('editModal').classList.remove('open');
recording=false;
document.getElementById('recordBtn').classList.remove('active');
}

function saveCommand(){
const c=cmds.find(x=>x.id===editId);
if(!c)return;
c.name=document.getElementById('editName').value.trim()||'Untitled';
c.desc=document.getElementById('editDesc').value.trim();
c.cat=document.getElementById('editCat').value;
c.action=document.getElementById('editAction').value;
c.keys=[...recKeys];
closeModal();save();render();bindShortcuts();toast(`Saved ${c.name}`);
}

function toggleRecord(){
recording=!recording;
const btn=document.getElementById('recordBtn');
const rec=document.getElementById('recorder');
if(recording){
btn.textContent='Press keys...';
btn.classList.add('active');
rec.classList.add('active');
recKeys=[];
}else{
btn.textContent='Record';
btn.classList.remove('active');
rec.classList.remove('active');
}
updateRecorder();
}

function clearShortcut(){
recKeys=[];
recording=false;
document.getElementById('recordBtn').classList.remove('active');
document.getElementById('recorder').classList.remove('active');
updateRecorder();
}

function updateRecorder(){
const el=document.getElementById('recorderKeys');
if(!recKeys.length)el.innerHTML='<span class="placeholder">No shortcut set</span>';
else el.innerHTML=recKeys.map(k=>`<kbd>${keyLabel(k)}</kbd>`).join('');
const conf=findConflict(recKeys,editId);
const ce=document.getElementById('recorderConflict');
const rec=document.getElementById('recorder');
if(conf){
ce.classList.add('show');
document.getElementById('conflictName').textContent=conf.name;
rec.classList.add('conflict');
}else{
ce.classList.remove('show');
rec.classList.remove('conflict');
}
}

document.addEventListener('keydown',e=>{
if(!recording)return;
e.preventDefault();
const k=e.key==='Meta'?'Meta':e.key==='Control'?'Control':e.key==='Alt'?'Alt':e.key==='Shift'?'Shift':e.code||e.key;
const mods=[];
if(e.metaKey)mods.push('Meta');
if(e.ctrlKey)mods.push('Control');
if(e.altKey)mods.push('Alt');
if(e.shiftKey)mods.push('Shift');
const isMod=['Meta','Control','Alt','Shift'].includes(k);
if(!isMod){
recKeys=[...mods,k.length===1?k.toLowerCase():k];
recording=false;
document.getElementById('recordBtn').classList.remove('active');
document.getElementById('recorder').classList.remove('active');
}else recKeys=[...mods];
updateRecorder();
},true);

// Palette
function openPalette(){
palActive=0;
document.getElementById('paletteOverlay').classList.add('open');
const inp=document.getElementById('paletteInput');
inp.value='';
inp.focus();
renderPalette('');
}

function closePalette(){
document.getElementById('paletteOverlay').classList.remove('open');
}

function renderPalette(q){
let query=q.trim().toLowerCase(),cat=null;
if(query.length&&CATS[query[0]]){cat=CATS[query[0]];query=query.slice(1).trim()}
const list=cmds.filter(c=>{
if(!c.enabled)return false;
if(cat&&c.cat!==cat)return false;
if(!query)return true;
return c.name.toLowerCase().includes(query)||c.desc.toLowerCase().includes(query);
});
const pb=document.getElementById('paletteBody');
if(!list.length){pb.innerHTML='<div class="palette-empty">No commands found</div>';return}
let h='',idx=0;
if(!q.trim()&&recent.length){
const rec=recent.map(id=>cmds.find(c=>c.id===id&&c.enabled)).filter(Boolean).slice(0,3);
if(rec.length){
h+=`<div class="palette-section">Recent</div>`;
rec.forEach(c=>{h+=palItem(c,idx++,q)});
}
}
['navigation','creation','editing','search'].forEach(ct=>{
const g=list.filter(c=>c.cat===ct);
if(!g.length)return;
h+=`<div class="palette-section">${ct}</div>`;
g.forEach(c=>h+=palItem(c,idx++,q));
});
pb.innerHTML=h;
const el=pb.querySelector('.palette-item.active');
if(el)el.scrollIntoView({block:'nearest',behavior:'smooth'});
}

function palItem(c,idx,q){
return`<div class="palette-item${idx===palActive?' active':''}" data-idx="${idx}" data-id="${c.id}" onmouseenter="palActive=${idx};renderPalette(document.getElementById('paletteInput').value)" onclick="exec('${c.id}')">
<div class="icon ${c.cat==='navigation'?'nav':c.cat==='creation'?'create':c.cat==='editing'?'edit':'search'}">${ICONS[c.cat==='navigation'?'nav':c.cat==='creation'?'create':c.cat==='editing'?'edit':'search']}</div>
<div class="palette-item-body"><div class="palette-item-name">${esc(c.name)}</div><div class="palette-item-desc">${esc(c.desc)}</div></div>
<div class="palette-item-meta">${c.keys.length?c.keys.map(k=>`<kbd>${keyLabel(k)}</kbd>`).join(''):''}
</div>
</div>`;
}

function exec(id){
const c=cmds.find(x=>x.id===id);
if(!c)return;
closePalette();
recent=recent.filter(r=>r!==id);
recent.unshift(id);
if(recent.length>6)recent.pop();
const t=new Date().toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
log.unshift({name:c.name,time:t,verb:c.action==='navigate'?'Navigated to':c.action==='create'?'Created':'Toggled'});
toast(`Executed ${c.name}`);
save();renderSidebar();
}

function toast(msg){
const t=document.getElementById('toast');
document.getElementById('toastMsg').textContent=msg;
t.classList.add('show');
clearTimeout(t._t);
t._t=setTimeout(()=>t.classList.remove('show'),2500);
}

let palDebounce;
document.getElementById('paletteInput').addEventListener('input',e=>{
palActive=0;
clearTimeout(palDebounce);
palDebounce=setTimeout(()=>renderPalette(e.target.value),50);
});

// Shortcuts
let bound={};
function bindShortcuts(){
bound={};
cmds.forEach(c=>{if(!c.enabled||!c.keys.length)return;bound[keysStr(c.keys).toLowerCase()]=c.id});
}

document.addEventListener('keydown',e=>{
if(recording)return;
if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==='k'){e.preventDefault();document.getElementById('paletteOverlay').classList.contains('open')?closePalette():openPalette();return}
if(document.getElementById('paletteOverlay').classList.contains('open')){
if(e.key==='Escape'){closePalette();return}
const list=cmds.filter(c=>c.enabled);
if(e.key==='ArrowDown'){e.preventDefault();palActive=Math.min(palActive+1,list.length-1);renderPalette(document.getElementById('paletteInput').value)}
if(e.key==='ArrowUp'){e.preventDefault();palActive=Math.max(palActive-1,0);renderPalette(document.getElementById('paletteInput').value)}
if(e.key==='Enter'){e.preventDefault();const item=document.querySelector(`[data-idx="${palActive}"]`);if(item)exec(item.dataset.id)}
return;
}
if(e.key==='Escape'&&document.getElementById('editModal').classList.contains('open')){closeModal();return}
const keys=[];
if(e.metaKey)keys.push('Meta');
if(e.ctrlKey)keys.push('Control');
if(e.altKey)keys.push('Alt');
if(e.shiftKey)keys.push('Shift');
keys.push(e.key.length===1?e.key.toLowerCase():e.code||e.key);
const s=keysStr(keys).toLowerCase();
if(bound[s]){e.preventDefault();exec(bound[s])}
});

load();render();bindShortcuts();
</script>
</body>
</html>