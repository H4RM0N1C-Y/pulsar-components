<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Timeline Task Planner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .no-select { user-select: none; }
  .timeline-container { overflow: hidden; position: relative; }
  .timeline-inner { display: flex; position: absolute; height: 100%; cursor: grab; }
  .timeline-inner.dragging { cursor: grabbing; transition: none; }
  .day-header { height: 100%; border-right: 1px solid #404040; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; background-color: #191919; color: #9b9b9b; }
  .day-header.highlighted { background-color: #2a2a2a; }
  .day-header.today { background-color: #2d2d2d; font-weight: 600; color: #e0e0e0; }
  .modal-section { border-bottom: 1px solid #374151; padding-bottom: 1rem; margin-bottom: 1rem; }
  .modal-section:last-child { border-bottom: none; }
  /* ADDED: Styles for handwriting screenshots */
  .screenshot-thumbnail { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; }
  .screenshot-container { display: inline-block; position: relative; margin-right: 8px; margin-bottom: 8px; }
  .screenshot-delete { position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
</style>
</head>
<body class="bg-[#191919]">

<div class="max-w-7xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4 text-[#e0e0e0]">Timeline Task Planner</h1>

  <div class="bg-[#1e1e1e] border border-[#2d2d2d] rounded overflow-hidden">
    <div class="flex border-b border-[#404040]">
      <div class="w-64 h-12 flex items-center px-3 font-semibold bg-[#1a1a1a] border-r border-[#404040] text-[#9b9b9b]">
        <span class="flex-1">Tasks</span>
        <button id="addTaskBtn" class="w-6 h-6 bg-[#2d2d2d] text-[#9b9b9b] rounded flex items-center justify-center hover:bg-[#3a3a3a] hover:text-[#e0e0e0]">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
      </div>
      <div class="flex-1 h-12 relative timeline-container">
        <div id="dayHeader" class="timeline-inner no-select"></div>
      </div>
    </div>
    <div class="timeline-body flex flex-col overflow-hidden"></div>
  </div>
</div>

<!-- NEW TASK MODAL -->
<div id="newTaskModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
  <div class="bg-gray-800 rounded-lg w-11/12 max-w-2xl max-h-[90vh] relative p-6 overflow-y-auto border border-gray-700">
    <button id="closeNewTaskModal" class="absolute top-4 right-4 w-8 h-8 bg-gray-700 rounded hover:bg-gray-600 flex items-center justify-center z-10">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    
    <h2 class="text-2xl font-bold mb-6 text-white">Create New Task</h2>
    
    <!-- Basic Info -->
    <div class="modal-section">
      <h3 class="text-lg font-semibold mb-3 text-white">Basic Information</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium mb-1 text-gray-300">Task Name *</label>
          <input id="newTaskName" type="text" placeholder="Enter task name" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Color</label>
            <input id="newTaskColor" type="color" value="#3b82f6" class="w-full h-10 p-0 border-0 rounded">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Icon / Emoji</label>
            <input id="newTaskIcon" type="text" placeholder="üìã" maxlength="2" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white text-center text-2xl">
          </div>
        </div>
      </div>
    </div>
    
    <!-- Timeline -->
    <div class="modal-section">
      <h3 class="text-lg font-semibold mb-3 text-white">Timeline</h3>
      <div class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Start Date *</label>
            <input id="newTaskStartDate" type="date" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">End Date *</label>
            <input id="newTaskEndDate" type="date" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
          </div>
        </div>
      </div>
    </div>
    
    <!-- Priority -->
    <div class="modal-section">
      <h3 class="text-lg font-semibold mb-3 text-white">Priority & Context</h3>
      <div class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Importance</label>
            <select id="newTaskImportance" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
              <option value="">Select</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Category</label>
            <input id="newTaskCategory" type="text" placeholder="Work, Personal, etc." class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
          </div>
        </div>
      </div>
    </div>
    
    <!-- Notes -->
    <div class="modal-section">
      <h3 class="text-lg font-semibold mb-3 text-white">Notes</h3>
      <div>
        <textarea id="newTaskNotes" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400" rows="3" placeholder="Add any notes..."></textarea>
      </div>
    </div>
    
    <!-- Actions -->
    <div class="flex gap-2 mt-6">
      <button id="createTaskBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Create Task</button>
      <button id="cancelNewTaskBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Cancel</button>
    </div>
  </div>
</div>

<!-- TASK DETAIL MODAL -->
<div id="taskDetailModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
  <div class="bg-gray-800 rounded-lg w-11/12 max-w-6xl h-5/6 relative flex border border-gray-700 overflow-hidden">
    <button id="closeDetailModal" class="absolute top-4 right-4 w-8 h-8 bg-gray-700 rounded hover:bg-gray-600 flex items-center justify-center z-10">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    
    <!-- Main Content Area -->
    <div class="flex-1 p-6 overflow-y-auto">
      <h2 class="text-2xl font-bold mb-6 text-white">Task Details</h2>
      
      <!-- üß© Identity & Visual -->
      <div class="modal-section">
        <h3 class="text-lg font-semibold mb-3 text-white flex items-center gap-2">
          üß© Identity & Visual
        </h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Title</label>
            <input id="detailTitle" type="text" placeholder="Task title" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Color</label>
              <input id="detailColor" type="color" value="#3b82f6" class="w-full h-10 p-0 border-0 rounded">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Icon / Emoji</label>
              <input id="detailIcon" type="text" placeholder="üìù" maxlength="2" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white text-center text-2xl">
            </div>
          </div>
          <!-- REMOVED: Parent Task field - parentId is handled internally, not user-editable -->
        </div>
      </div>

      <!-- üìù Content -->
      <div class="modal-section">
        <h3 class="text-lg font-semibold mb-3 text-white flex items-center gap-2">
          üìù Content
        </h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Notes (Markdown)</label>
            <textarea id="detailNotes" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400" rows="4" placeholder="# Notes
- Add markdown here..."></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Tags</label>
              <input id="detailTags" type="text" placeholder="work, urgent, meeting" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Category</label>
              <input id="detailCategory" type="text" placeholder="Development" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Project Link</label>
            <input id="detailProjectLink" type="url" placeholder="https://..." class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
          </div>
        </div>
      </div>

      <!-- ‚è± Time -->
      <div class="modal-section">
        <h3 class="text-lg font-semibold mb-3 text-white flex items-center gap-2">
          ‚è± Time
        </h3>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Start Date & Time</label>
              <input id="detailStartTime" type="datetime-local" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Due Date & Time</label>
              <input id="detailDueTime" type="datetime-local" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Recurrence Rule</label>
            <select id="detailRecurrenceRule" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
              <option value="">None</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="biweekly">Bi-weekly</option>
              <option value="monthly">Monthly</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>
      </div>

      <!-- üéØ Priority & Context -->
      <div class="modal-section">
        <h3 class="text-lg font-semibold mb-3 text-white flex items-center gap-2">
          üéØ Priority & Context
        </h3>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Importance Level</label>
              <select id="detailImportance" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
                <option value="">Select</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Impact Score</label>
              <input id="detailImpactScore" type="number" min="1" max="10" placeholder="1-10" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Location</label>
              <input id="detailLocation" type="text" placeholder="Office, Home, etc." class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Energy Mode</label>
              <select id="detailEnergyMode" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white">
                <option value="">Select</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-300">Device Requirement</label>
              <input id="detailDeviceRequirement" type="text" placeholder="Laptop, Phone, etc." class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
            </div>
            <div class="flex items-end">
              <label class="flex items-center space-x-2 pb-2">
                <input id="detailFocusEligible" type="checkbox" class="w-4 h-4">
                <span class="text-sm text-gray-300">Focus Eligible</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- üìé Resources -->
      <div class="modal-section">
        <h3 class="text-lg font-semibold mb-3 text-white flex items-center gap-2">
          üìé Resources
        </h3>
        <div class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Attachments</label>
            <input id="detailAttachments" type="file" multiple class="border border-gray-600 p-2 rounded w-full text-sm bg-gray-700 text-gray-300">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Linked Docs / Pages</label>
            <input id="detailLinkedDocs" type="text" placeholder="Comma-separated URLs" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Web Clips</label>
            <input id="detailWebClips" type="url" placeholder="https://..." class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
          </div>
          <!-- REPLACED: Canvas with image upload/paste system -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Handwriting Screenshots</label>
            <div class="border border-gray-600 rounded p-3 bg-gray-900">
              <div id="handwritingScreenshots" class="mb-2"></div>
              <input id="detailHandwritingUpload" type="file" accept="image/*" multiple class="hidden">
              <button onclick="document.getElementById('detailHandwritingUpload').click()" class="px-3 py-1 bg-gray-700 text-white rounded text-sm hover:bg-gray-600 mr-2">Upload Images</button>
              <input id="handwritingPasteArea" type="text" placeholder="Click here and paste images" class="px-3 py-1 bg-gray-700 text-white rounded text-sm w-48">
            </div>
          </div>
        </div>
      </div>

      <!-- üîÑ Progress / Logic -->
      <div class="modal-section">
        <h3 class="text-lg font-semibold mb-3 text-white flex items-center gap-2">
          üîÑ Progress / Logic
        </h3>
        <div class="space-y-3">
          <!-- REMOVED: State dropdown - state is derived, not user-editable -->
          <!-- REMOVED: Completion timestamp - this is a system field -->
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Dependencies</label>
            <input id="detailDependencies" type="text" placeholder="Task IDs or names" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-300">Block Reason</label>
            <textarea id="detailBlockReason" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white placeholder-gray-400" rows="3" placeholder="Why is this blocked?"></textarea>
          </div>
        </div>
      </div>

      <!-- ‚öô Actions -->
      <div class="modal-section">
        <h3 class="text-lg font-semibold mb-3 text-white flex items-center gap-2">
          ‚öô Actions
        </h3>
        <div class="flex flex-wrap gap-2">
          <button id="saveTaskBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
          <button id="cancelTaskBtn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Cancel</button>
          <button id="deleteTaskBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
          <button id="duplicateTaskBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Duplicate</button>
        </div>
      </div>
    </div>

    <!-- üß† Subtasks Panel (Right Sidebar) -->
    <div id="subtasksPanel" class="w-96 border-l border-gray-700 bg-gray-900 p-6 overflow-y-auto">
      <h3 class="text-lg font-semibold mb-4 text-white flex items-center gap-2">
        üß† Subtasks
      </h3>
      
      <!-- Add Subtask Section -->
      <div class="mb-6 p-4 bg-gray-800 rounded border border-gray-700">
        <h4 class="text-sm font-semibold mb-3 text-gray-300">Add New Subtask</h4>
        <div class="space-y-2">
          <input id="newSubtaskTitle" type="text" placeholder="Subtask title" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white text-sm placeholder-gray-400">
          <div class="grid grid-cols-2 gap-2">
            <input id="newSubtaskStart" type="date" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white text-sm">
            <input id="newSubtaskDue" type="date" class="border border-gray-600 p-2 rounded w-full bg-gray-700 text-white text-sm">
          </div>
          <button id="addSubtaskBtn" class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm disabled:opacity-50" disabled>Add Subtask</button>
        </div>
      </div>

      <!-- Subtasks List -->
      <div id="subtasksList" class="space-y-2">
        <!-- Subtasks will be dynamically added here -->
      </div>
    </div>
  </div>
</div>

<!-- REMOVED: Entire subtask detail modal - inline editing in panel instead -->

<script>
const totalDays = 60;
const dayWidth = 110;
const firstTimelineDate = new Date("2026-01-01");
let tasks = [
  { 
    id: 1, 
    title: "Science Project", // RENAMED: name -> title
    type: "parent", 
    color: "#3b82f6", 
    start: 2, 
    duration: 4, 
    icon: "üî¨",
    completed: false, // ADDED: explicit completed field
    subtasks: [
      {title: "Research", start: 0, duration: 2, color: "#2563eb", completed: true},
      {title: "Write Report", start: 2, duration: 1, color: "#1d4ed8", completed: false},
      {title: "Create Poster", start: 3, duration: 1, color: "#1e40af", completed: false}
    ],
    system: { // ADDED: system fields
      createdAt: new Date().toISOString(),
      lastModified: new Date().toISOString()
    }
  },
  { 
    id: 2, 
    title: "Math HW", // RENAMED: name -> title
    type: "regular", 
    color: "#8b5cf6", 
    start: 3, 
    duration: 2, 
    icon: "üìê",
    completed: false,
    system: {
      createdAt: new Date().toISOString(),
      lastModified: new Date().toISOString()
    }
  },
  { 
    id: 3, 
    title: "ELA Essay", // RENAMED: name -> title
    type: "parent", 
    color: "#22c55e", 
    start: 0, 
    duration: 5, 
    icon: "‚úçÔ∏è",
    completed: false,
    subtasks: [
      {title: "Find Sources", start: 0, duration: 2, color: "#16a34a", completed: true},
      {title: "Write Report", start: 2, duration: 3, color: "#15803d", completed: false}
    ],
    system: {
      createdAt: new Date().toISOString(),
      lastModified: new Date().toISOString()
    }
  }
];
let currentTask = null;
let nextTaskId = 4;

const dayHeader = document.getElementById("dayHeader");
const timelineBody = document.querySelector(".timeline-body");
const taskDetailModal = document.getElementById("taskDetailModal");
const closeDetailBtn = document.getElementById("closeDetailModal");
let currentSubtask = null;
let currentSubtaskIndex = null;

// NEW TASK MODAL
const newTaskModal = document.getElementById("newTaskModal");
const closeNewTaskBtn = document.getElementById("closeNewTaskModal");
const cancelNewTaskBtn = document.getElementById("cancelNewTaskBtn");
const createTaskBtn = document.getElementById("createTaskBtn");

function generateDays(){
  dayHeader.innerHTML = "";
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  for(let i=0;i<totalDays;i++){
    const date = new Date(firstTimelineDate);
    date.setDate(date.getDate() + i);
    const div = document.createElement("div");
    div.style.width = dayWidth+"px";
    div.className = "day-header flex flex-col justify-center items-center";
    
    const dateOnly = new Date(date);
    dateOnly.setHours(0, 0, 0, 0);
    if(dateOnly.getTime() === today.getTime()) {
      div.classList.add("today");
    }

    const yearDiv = document.createElement("div");
    yearDiv.textContent = date.getFullYear();
    yearDiv.className = "text-[#6b6b6b] text-xs";

    const monthDayDiv = document.createElement("div");
    monthDayDiv.textContent = date.toLocaleDateString("en-US",{month:"short",day:"2-digit"});
    monthDayDiv.className = "text-sm font-semibold text-[#9b9b9b]";

    div.appendChild(yearDiv);
    div.appendChild(monthDayDiv);
    dayHeader.appendChild(div);
  }
}
generateDays();

function renderTasks(){
  timelineBody.innerHTML = "";
  tasks.forEach(task=>{
    const row = document.createElement("div");
    row.className = "flex border-b border-[#404040]";

    const left = document.createElement("div");
    left.className = `w-64 border-r border-[#404040]`;
    left.style.backgroundColor = "#1a1a1a";
    
    if(task.subtasks && task.subtasks.length > 0){
      const parentTitle = document.createElement("div");
      parentTitle.className = "font-semibold border-b border-[#404040] flex items-center cursor-pointer hover:bg-[#252525] text-[#e0e0e0] gap-2";
      parentTitle.style.height = "50px";
      parentTitle.style.borderLeft = `3px solid ${task.color}`;
      parentTitle.style.paddingLeft = "8px";
      parentTitle.style.paddingRight = "8px";
      
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = task.completed || false;
      checkbox.className = "w-4 h-4 cursor-pointer";
      checkbox.addEventListener("click", (e) => {
        e.stopPropagation();
        task.completed = e.target.checked;
        // ADDED: Parent-subtask sync rule
        if(task.completed && task.subtasks) {
          task.subtasks.forEach(st => st.completed = true);
        }
        updateTaskState(task);
        renderTasks();
      });
      parentTitle.appendChild(checkbox);
      
      if(task.icon) {
        const icon = document.createElement("span");
        icon.textContent = task.icon;
        parentTitle.appendChild(icon);
      }
      
      const taskNameSpan = document.createElement("span");
      taskNameSpan.textContent = task.title; // CHANGED: name -> title
      taskNameSpan.className = "flex-1";
      if(task.completed) {
        taskNameSpan.className += " line-through text-gray-500";
      }
      parentTitle.appendChild(taskNameSpan);
      
      const stateBadge = document.createElement("span");
      stateBadge.className = "text-xs px-2 py-1 rounded";
      const state = getTaskState(task);
      if(state === "completed") {
        stateBadge.className += " bg-green-600 text-white";
        stateBadge.textContent = "‚úì Done";
      } else if(state === "overdue") {
        stateBadge.className += " bg-red-600 text-white";
        stateBadge.textContent = "‚ö† Overdue";
      } else if(state === "in-progress") {
        stateBadge.className += " bg-blue-600 text-white";
        stateBadge.textContent = "‚Üí Today";
      } else {
        stateBadge.className += " bg-gray-600 text-gray-300";
        stateBadge.textContent = "‚óã Later";
      }
      parentTitle.appendChild(stateBadge);
      
      parentTitle.addEventListener("click", (e) => {
        if(e.target !== checkbox) openTaskDetail(task);
      });
      left.appendChild(parentTitle);
      
      task.subtasks.forEach((st, idx)=>{
        const subRow = document.createElement("div");
        subRow.className = "pl-6 border-b border-[#404040] last:border-b-0 text-sm flex items-center cursor-pointer hover:bg-[#252525] text-[#9b9b9b] gap-2";
        subRow.style.height = "40px";
        subRow.style.borderLeft = `3px solid ${st.color || task.color}`;
        subRow.style.paddingLeft = "8px";
        subRow.style.paddingRight = "8px";
        
        const subCheckbox = document.createElement("input");
        subCheckbox.type = "checkbox";
        subCheckbox.checked = st.completed || false;
        subCheckbox.className = "w-4 h-4 cursor-pointer";
        subCheckbox.addEventListener("click", (e) => {
          e.stopPropagation();
          st.completed = e.target.checked;
          // ADDED: Check if all subtasks completed to update parent
          checkParentCompletion(task);
          updateSubtaskState(task, st);
          renderTasks();
        });
        subRow.appendChild(subCheckbox);
        
        const nameSpan = document.createElement("span");
        nameSpan.textContent = st.title; // CHANGED: name -> title
        nameSpan.className = "flex-1";
        if(st.completed) {
          nameSpan.className += " line-through text-gray-500";
        }
        subRow.appendChild(nameSpan);
        
        const stateBadge = document.createElement("span");
        stateBadge.className = "text-xs px-2 py-1 rounded";
        const subState = getSubtaskState(task, st);
        if(subState === "completed") {
          stateBadge.className += " bg-green-600 text-white";
          stateBadge.textContent = "‚úì";
        } else if(subState === "overdue") {
          stateBadge.className += " bg-red-600 text-white";
          stateBadge.textContent = "‚ö†";
        } else if(subState === "in-progress") {
          stateBadge.className += " bg-blue-600 text-white";
          stateBadge.textContent = "‚Üí";
        } else {
          stateBadge.className += " bg-gray-600 text-gray-300";
          stateBadge.textContent = "‚óã";
        }
        subRow.appendChild(stateBadge);
        
        subRow.addEventListener("click", (e) => {
          if(e.target !== subCheckbox) openTaskDetail(task); // Changed to open parent task detail
        });
        left.appendChild(subRow);
      });
    } else {
      const title = document.createElement("div");
      title.className = "font-semibold flex items-center cursor-pointer hover:bg-[#252525] text-[#e0e0e0] gap-2";
      title.style.height = "50px";
      title.style.borderLeft = `3px solid ${task.color}`;
      title.style.paddingLeft = "8px";
      title.style.paddingRight = "8px";
      
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = task.completed || false;
      checkbox.className = "w-4 h-4 cursor-pointer";
      checkbox.addEventListener("click", (e) => {
        e.stopPropagation();
        task.completed = e.target.checked;
        updateTaskState(task);
        renderTasks();
      });
      title.appendChild(checkbox);
      
      if(task.icon) {
        const icon = document.createElement("span");
        icon.textContent = task.icon;
        title.appendChild(icon);
      }
      
      const nameSpan = document.createElement("span");
      nameSpan.textContent = task.title; // CHANGED: name -> title
      nameSpan.className = "flex-1";
      if(task.completed) {
        nameSpan.className += " line-through text-gray-500";
      }
      title.appendChild(nameSpan);
      
      const stateBadge = document.createElement("span");
      stateBadge.className = "text-xs px-2 py-1 rounded";
      const state = getTaskState(task);
      if(state === "completed") {
        stateBadge.className += " bg-green-600 text-white";
        stateBadge.textContent = "‚úì Done";
      } else if(state === "overdue") {
        stateBadge.className += " bg-red-600 text-white";
        stateBadge.textContent = "‚ö† Overdue";
      } else if(state === "in-progress") {
        stateBadge.className += " bg-blue-600 text-white";
        stateBadge.textContent = "‚Üí Today";
      } else {
        stateBadge.className += " bg-gray-600 text-gray-300";
        stateBadge.textContent = "‚óã Later";
      }
      title.appendChild(stateBadge);
      
      title.addEventListener("click", (e) => {
        if(e.target !== checkbox) openTaskDetail(task);
      });
      left.appendChild(title);
    }
    row.appendChild(left);

    const right = document.createElement("div");
    right.className = `flex-1 relative`;
    right.style.backgroundColor = "#1a1a1a";
    right.style.overflow="hidden";

    const dayGrid = document.createElement("div");
    dayGrid.className="absolute inset-0 flex pointer-events-none";
    dayGrid.style.width = totalDays*dayWidth + "px";
    
    const todayCalc = new Date();
    todayCalc.setHours(0, 0, 0, 0);
    
    for(let i=0;i<totalDays;i++){
      const date = new Date(firstTimelineDate);
      date.setDate(date.getDate() + i);
      const dateOnly = new Date(date);
      dateOnly.setHours(0, 0, 0, 0);
      
      const div = document.createElement("div");
      div.style.width = dayWidth+"px";
      div.style.height = "100%";
      div.className="border-r border-[#404040]";
      
      if(dateOnly.getTime() === todayCalc.getTime()) {
        div.style.backgroundColor = "#2d2d2d";
      }
      
      dayGrid.appendChild(div);
    }
    right.appendChild(dayGrid);

    if(task.subtasks && task.subtasks.length > 0){
      const bigParentDiv = document.createElement("div");
      bigParentDiv.className = `absolute top-0 bottom-0`;
      bigParentDiv.style.backgroundColor = task.color;
      bigParentDiv.style.left = (task.start*dayWidth)+"px";
      bigParentDiv.style.width = (task.duration*dayWidth) + "px";
      
      const parentContainer = document.createElement("div");
      parentContainer.className = "relative w-full h-full flex flex-col";
      
      const parentBlockRow = document.createElement("div");
      parentBlockRow.className = "relative border-b";
      parentBlockRow.style.borderColor = task.color + "80";
      parentBlockRow.style.height = "50px";
      parentContainer.appendChild(parentBlockRow);
      
      task.subtasks.forEach((st, idx)=>{
        const subtaskRow = document.createElement("div");
        subtaskRow.className = `relative ${idx < task.subtasks.length - 1 ? 'border-b' : ''}`;
        subtaskRow.style.borderColor = task.color + "80";
        subtaskRow.style.height = "40px";
        
        const subtaskBlock = document.createElement("div");
        subtaskBlock.className = "absolute rounded m-1";
        subtaskBlock.style.backgroundColor = st.color || task.color;
        subtaskBlock.style.left = (st.start * dayWidth) + "px";
        subtaskBlock.style.width = (st.duration * dayWidth - 8) + "px";
        subtaskBlock.style.top = "4px";
        subtaskBlock.style.bottom = "4px";
        
        subtaskRow.appendChild(subtaskBlock);
        parentContainer.appendChild(subtaskRow);
      });
      
      bigParentDiv.appendChild(parentContainer);
      right.appendChild(bigParentDiv);
    } else {
      const block = document.createElement("div");
      block.className=`absolute top-0 bottom-0 text-white text-sm px-3 py-2`;
      block.style.backgroundColor = task.color;
      block.style.left = (task.start*dayWidth)+"px";
      block.style.width = (task.duration*dayWidth) + "px";
      right.appendChild(block);
    }

    row.appendChild(right);
    timelineBody.appendChild(row);
  });
}
renderTasks();

// ADDED: Check if all subtasks are completed to update parent
function checkParentCompletion(task) {
  if(task.subtasks && task.subtasks.length > 0) {
    const allCompleted = task.subtasks.every(st => st.completed);
    task.completed = allCompleted;
    if(!allCompleted) {
      task.completed = false;
    }
  }
}

// MODIFIED: State calculation based on completed and due date
function getTaskState(task) {
  if(task.completed) return "completed";
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const taskStartDate = new Date(firstTimelineDate);
  taskStartDate.setDate(taskStartDate.getDate() + task.start);
  taskStartDate.setHours(0, 0, 0, 0);
  
  const taskDueDate = new Date(taskStartDate);
  taskDueDate.setDate(taskDueDate.getDate() + task.duration - 1);
  taskDueDate.setHours(0, 0, 0, 0);
  
  if(today > taskDueDate) return "overdue";
  if(today.getTime() === taskDueDate.getTime()) return "in-progress";
  return "not-started";
}

function getSubtaskState(parentTask, subtask) {
  if(subtask.completed) return "completed";
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const parentStartDate = new Date(firstTimelineDate);
  parentStartDate.setDate(parentStartDate.getDate() + parentTask.start);
  
  const subtaskStartDate = new Date(parentStartDate);
  subtaskStartDate.setDate(subtaskStartDate.getDate() + subtask.start);
  subtaskStartDate.setHours(0, 0, 0, 0);
  
  const subtaskDueDate = new Date(subtaskStartDate);
  subtaskDueDate.setDate(subtaskDueDate.getDate() + subtask.duration - 1);
  subtaskDueDate.setHours(0, 0, 0, 0);
  
  if(today > subtaskDueDate) return "overdue";
  if(today.getTime() === subtaskDueDate.getTime()) return "in-progress";
  return "not-started";
}

// MODIFIED: Update system fields
function updateTaskState(task) {
  if(task.completed && !task.system.completedAt) {
    task.system.completedAt = new Date().toISOString();
  } else if(!task.completed) {
    delete task.system.completedAt;
  }
}

function updateSubtaskState(parentTask, subtask) {
  // Subtask state is derived, no need for completedAt on subtasks
}

// ADDED: Handwriting screenshot handling
function setupHandwritingHandlers() {
  const uploadInput = document.getElementById('detailHandwritingUpload');
  const pasteArea = document.getElementById('handwritingPasteArea');
  const screenshotsDiv = document.getElementById('handwritingScreenshots');
  
  if(!currentTask) return;
  if(!currentTask.handwritingScreenshots) currentTask.handwritingScreenshots = [];
  
  // Display existing screenshots
  screenshotsDiv.innerHTML = '';
  currentTask.handwritingScreenshots.forEach((src, idx) => {
    const container = document.createElement('div');
    container.className = 'screenshot-container';
    
    const img = document.createElement('img');
    img.src = src;
    img.className = 'screenshot-thumbnail';
    
    const deleteBtn = document.createElement('div');
    deleteBtn.className = 'screenshot-delete';
    deleteBtn.textContent = '√ó';
    deleteBtn.onclick = () => {
      currentTask.handwritingScreenshots.splice(idx, 1);
      setupHandwritingHandlers();
    };
    
    container.appendChild(img);
    container.appendChild(deleteBtn);
    screenshotsDiv.appendChild(container);
  });
  
  // Handle file upload
  uploadInput.onchange = (e) => {
    Array.from(e.target.files).forEach(file => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        currentTask.handwritingScreenshots.push(ev.target.result);
        setupHandwritingHandlers();
      };
      reader.readAsDataURL(file);
    });
  };
  
  // Handle paste
  pasteArea.onpaste = (e) => {
    const items = e.clipboardData.items;
    for(let item of items) {
      if(item.type.indexOf('image') !== -1) {
        const blob = item.getAsFile();
        const reader = new FileReader();
        reader.onload = (ev) => {
          currentTask.handwritingScreenshots.push(ev.target.result);
          setupHandwritingHandlers();
        };
        reader.readAsDataURL(blob);
      }
    }
  };
}

function openTaskDetail(task) {
  currentTask = task;
  taskDetailModal.classList.remove("hidden");
  
  // Populate fields with proper naming
  document.getElementById("detailTitle").value = task.title || "";
  document.getElementById("detailColor").value = task.color || "#3b82f6";
  document.getElementById("detailIcon").value = task.icon || "";
  document.getElementById("detailNotes").value = task.notes || "";
  document.getElementById("detailTags").value = task.tags || "";
  document.getElementById("detailCategory").value = task.category || "";
  document.getElementById("detailProjectLink").value = task.projectLink || "";
  document.getElementById("detailImportance").value = task.importance || "";
  document.getElementById("detailImpactScore").value = task.impactScore || "";
  document.getElementById("detailLocation").value = task.location || "";
  document.getElementById("detailEnergyMode").value = task.energyMode || "";
  document.getElementById("detailDeviceRequirement").value = task.deviceRequirement || "";
  document.getElementById("detailFocusEligible").checked = task.focusEligible || false;
  document.getElementById("detailLinkedDocs").value = task.linkedDocs || "";
  document.getElementById("detailWebClips").value = task.webClips || "";
  document.getElementById("detailDependencies").value = task.dependencies || "";
  document.getElementById("detailBlockReason").value = task.blockReason || "";
  document.getElementById("detailRecurrenceRule").value = task.recurrenceRule || "";
  
  // Convert dates for datetime-local inputs
  if(task.startTime) {
    document.getElementById("detailStartTime").value = task.startTime;
  }
  if(task.dueTime) {
    document.getElementById("detailDueTime").value = task.dueTime;
  }
  
  // Setup handwriting screenshots
  setupHandwritingHandlers();
  
  // Show/hide subtasks panel
  if(task.subtasks && task.subtasks.length > 0) {
    subtasksPanel.classList.remove("hidden");
    renderSubtasksList(task);
  } else {
    subtasksPanel.classList.add("hidden");
  }
  
  // Set date constraints for new subtasks
  const parentStartDate = new Date(firstTimelineDate);
  parentStartDate.setDate(parentStartDate.getDate() + task.start);
  const parentEndDate = new Date(parentStartDate);
  parentEndDate.setDate(parentEndDate.getDate() + task.duration - 1);
  
  document.getElementById("newSubtaskStart").min = parentStartDate.toISOString().split('T')[0];
  document.getElementById("newSubtaskStart").max = parentEndDate.toISOString().split('T')[0];
  document.getElementById("newSubtaskDue").min = parentStartDate.toISOString().split('T')[0];
  document.getElementById("newSubtaskDue").max = parentEndDate.toISOString().split('T')[0];
}

// MODIFIED: Inline subtask editing in panel
function renderSubtasksList(task) {
  const list = document.getElementById("subtasksList");
  list.innerHTML = "";
  
  if(!task.subtasks || task.subtasks.length === 0) {
    list.innerHTML = '<p class="text-gray-400 text-sm">No subtasks yet</p>';
    return;
  }
  
  task.subtasks.forEach((subtask, idx) => {
    const subtaskDiv = document.createElement("div");
    subtaskDiv.className = "p-3 bg-gray-800 rounded border border-gray-700";
    
    const header = document.createElement("div");
    header.className = "flex items-center justify-between mb-2";
    
    const titleDiv = document.createElement("div");
    titleDiv.className = "flex items-center gap-2 flex-1";
    
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = subtask.completed || false;
    checkbox.className = "w-4 h-4 cursor-pointer";
    checkbox.addEventListener("change", (e) => {
      e.stopPropagation();
      subtask.completed = e.target.checked;
      checkParentCompletion(task);
      updateSubtaskState(task, subtask);
      renderTasks();
      renderSubtasksList(task);
    });
    
    // ADDED: Inline title editing
    const titleInput = document.createElement("input");
    titleInput.type = "text";
    titleInput.value = subtask.title;
    titleInput.className = "bg-transparent text-white text-sm font-medium flex-1 border-none outline-none";
    titleInput.onchange = (e) => {
      subtask.title = e.target.value;
      renderTasks();
    };
    
    titleDiv.appendChild(checkbox);
    titleDiv.appendChild(titleInput);
    
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700";
    deleteBtn.textContent = "Delete";
    deleteBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if(confirm("Delete this subtask?")) {
        task.subtasks.splice(idx, 1);
        if(task.subtasks.length === 0) {
          task.type = "regular";
          delete task.subtasks;
        }
        renderTasks();
        renderSubtasksList(task);
      }
    });
    
    header.appendChild(titleDiv);
    header.appendChild(deleteBtn);
    
    const details = document.createElement("div");
    details.className = "space-y-2";
    
    // ADDED: Inline due date editing
    const dueDateDiv = document.createElement("div");
    dueDateDiv.className = "flex items-center gap-2 text-xs";
    const dueDateLabel = document.createElement("span");
    dueDateLabel.textContent = "Due:";
    dueDateLabel.className = "text-gray-400";
    const dueDateInput = document.createElement("input");
    dueDateInput.type = "date";
    dueDateInput.className = "bg-gray-700 text-white text-xs px-2 py-1 rounded border border-gray-600";
    
    // Calculate current due date
    const parentStartDate = new Date(firstTimelineDate);
    parentStartDate.setDate(parentStartDate.getDate() + task.start);
    const subtaskDueDate = new Date(parentStartDate);
    subtaskDueDate.setDate(subtaskDueDate.getDate() + subtask.start + subtask.duration - 1);
    dueDateInput.value = subtaskDueDate.toISOString().split('T')[0];
    
    dueDateInput.onchange = (e) => {
      const newDueDate = new Date(e.target.value);
      const newStart = Math.floor((newDueDate - parentStartDate)/(1000*60*60*24)) - subtask.duration + 1;
      if(newStart >= 0 && newStart + subtask.duration <= task.duration) {
        subtask.start = newStart;
        renderTasks();
      } else {
        alert("Due date must be within parent task dates");
        dueDateInput.value = subtaskDueDate.toISOString().split('T')[0];
      }
    };
    
    dueDateDiv.appendChild(dueDateLabel);
    dueDateDiv.appendChild(dueDateInput);
    
    // ADDED: Inline color editing
    const colorDiv = document.createElement("div");
    colorDiv.className = "flex items-center gap-2 text-xs";
    const colorLabel = document.createElement("span");
    colorLabel.textContent = "Color:";
    colorLabel.className = "text-gray-400";
    const colorInput = document.createElement("input");
    colorInput.type = "color";
    colorInput.value = subtask.color || task.color;
    colorInput.className = "w-8 h-6 rounded cursor-pointer";
    colorInput.onchange = (e) => {
      subtask.color = e.target.value;
      renderTasks();
    };
    
    colorDiv.appendChild(colorLabel);
    colorDiv.appendChild(colorInput);
    
    details.appendChild(dueDateDiv);
    details.appendChild(colorDiv);
    
    subtaskDiv.appendChild(header);
    subtaskDiv.appendChild(details);
    list.appendChild(subtaskDiv);
  });
}

// Close modal
closeDetailBtn.addEventListener("click", ()=>{
  taskDetailModal.classList.add("hidden");
  currentTask = null;
});

document.getElementById("cancelTaskBtn").addEventListener("click", ()=>{
  taskDetailModal.classList.add("hidden");
  currentTask = null;
});

// Save task
document.getElementById("saveTaskBtn").addEventListener("click", ()=>{
  if(!currentTask) return;
  
  // Update all fields with proper naming
  currentTask.title = document.getElementById("detailTitle").value;
  currentTask.color = document.getElementById("detailColor").value;
  currentTask.icon = document.getElementById("detailIcon").value;
  currentTask.notes = document.getElementById("detailNotes").value;
  currentTask.tags = document.getElementById("detailTags").value;
  currentTask.category = document.getElementById("detailCategory").value;
  currentTask.projectLink = document.getElementById("detailProjectLink").value;
  currentTask.importance = document.getElementById("detailImportance").value;
  currentTask.impactScore = document.getElementById("detailImpactScore").value;
  currentTask.location = document.getElementById("detailLocation").value;
  currentTask.energyMode = document.getElementById("detailEnergyMode").value;
  currentTask.deviceRequirement = document.getElementById("detailDeviceRequirement").value;
  currentTask.focusEligible = document.getElementById("detailFocusEligible").checked;
  currentTask.linkedDocs = document.getElementById("detailLinkedDocs").value;
  currentTask.webClips = document.getElementById("detailWebClips").value;
  currentTask.dependencies = document.getElementById("detailDependencies").value;
  currentTask.blockReason = document.getElementById("detailBlockReason").value;
  currentTask.recurrenceRule = document.getElementById("detailRecurrenceRule").value;
  currentTask.startTime = document.getElementById("detailStartTime").value;
  currentTask.dueTime = document.getElementById("detailDueTime").value;
  
  // ADDED: Update system lastModified
  if(!currentTask.system) currentTask.system = {};
  currentTask.system.lastModified = new Date().toISOString();
  
  renderTasks();
  taskDetailModal.classList.add("hidden");
  currentTask = null;
});

// Delete task
document.getElementById("deleteTaskBtn").addEventListener("click", ()=>{
  if(!currentTask) return;
  if(confirm("Are you sure you want to delete this task?")) {
    tasks = tasks.filter(t => t.id !== currentTask.id);
    renderTasks();
    taskDetailModal.classList.add("hidden");
    currentTask = null;
  }
});

// Duplicate task
document.getElementById("duplicateTaskBtn").addEventListener("click", ()=>{
  if(!currentTask) return;
  const newTask = JSON.parse(JSON.stringify(currentTask));
  newTask.id = nextTaskId++;
  newTask.title = newTask.title + " (Copy)";
  newTask.start = Math.min(currentTask.start + currentTask.duration, totalDays - currentTask.duration);
  newTask.completed = false;
  // ADDED: Reset system fields for duplicate
  newTask.system = {
    createdAt: new Date().toISOString(),
    lastModified: new Date().toISOString()
  };
  tasks.push(newTask);
  renderTasks();
  alert("Task duplicated!");
});

// Add subtask
const newSubtaskTitle = document.getElementById("newSubtaskTitle");
const newSubtaskStart = document.getElementById("newSubtaskStart");
const newSubtaskDue = document.getElementById("newSubtaskDue");
const addSubtaskBtn = document.getElementById("addSubtaskBtn");

[newSubtaskTitle, newSubtaskStart, newSubtaskDue].forEach(input => {
  input.addEventListener("input", () => {
    addSubtaskBtn.disabled = !(newSubtaskTitle.value && newSubtaskStart.value && newSubtaskDue.value);
  });
});

addSubtaskBtn.addEventListener("click", () => {
  if(!currentTask) return;
  
  const title = newSubtaskTitle.value; // CHANGED: name -> title
  const startDate = new Date(newSubtaskStart.value);
  const endDate = new Date(newSubtaskDue.value);
  
  if(!title || !startDate || !endDate || endDate < startDate) return;
  
  const relativeStart = Math.floor((startDate - firstTimelineDate)/(1000*60*60*24)) - currentTask.start;
  const duration = Math.floor((endDate - startDate)/(1000*60*60*24)) + 1;
  
  if(!currentTask.subtasks) {
    currentTask.subtasks = [];
    currentTask.type = "parent";
  }
  
  const darkenColor = (hex, percent) => {
    const num = parseInt(hex.replace('#', ''), 16);
    const r = Math.max(0, Math.floor((num >> 16) * (1 - percent)));
    const g = Math.max(0, Math.floor(((num >> 8) & 0x00FF) * (1 - percent)));
    const b = Math.max(0, Math.floor((num & 0x0000FF) * (1 - percent)));
    return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
  };
  
  currentTask.subtasks.push({
    title: title, // CHANGED: name -> title
    start: relativeStart,
    duration: duration,
    color: darkenColor(currentTask.color || "#3b82f6", 0.2),
    completed: false
  });
  
  renderTasks();
  renderSubtasksList(currentTask);
  
  newSubtaskTitle.value = "";
  newSubtaskStart.value = "";
  newSubtaskDue.value = "";
  addSubtaskBtn.disabled = true;
});

// Timeline dragging
let isDragging=false, startX, currentTranslate=0;
dayHeader.addEventListener("mousedown", e=>{
  isDragging=true; startX=e.pageX; dayHeader.classList.add("dragging");
});
document.addEventListener("mouseup", ()=>{
  isDragging=false; dayHeader.classList.remove("dragging");
});
document.addEventListener("mousemove", e=>{
  if(!isDragging) return;
  const dx = e.pageX - startX;
  currentTranslate += dx;
  const maxTranslate=0;
  const minTranslate=-(totalDays*dayWidth - 7*dayWidth);
  if(currentTranslate>maxTranslate) currentTranslate=maxTranslate;
  if(currentTranslate<minTranslate) currentTranslate=minTranslate;
  dayHeader.style.transform = `translateX(${currentTranslate}px)`;
  timelineBody.querySelectorAll(".flex-1 > .absolute").forEach(inner=>{
    inner.style.transform = `translateX(${currentTranslate}px)`;
  });
  startX = e.pageX;
});

// NEW TASK CREATION FUNCTIONALITY
// Open new task modal
document.getElementById("addTaskBtn").addEventListener("click", ()=>{
  newTaskModal.classList.remove("hidden");
  
  // Set default date values
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  
  document.getElementById("newTaskStartDate").value = today.toISOString().split('T')[0];
  document.getElementById("newTaskEndDate").value = tomorrow.toISOString().split('T')[0];
  document.getElementById("newTaskColor").value = "#3b82f6";
  document.getElementById("newTaskIcon").value = "üìã";
});

// Close new task modal
closeNewTaskBtn.addEventListener("click", ()=>{
  newTaskModal.classList.add("hidden");
  clearNewTaskForm();
});

cancelNewTaskBtn.addEventListener("click", ()=>{
  newTaskModal.classList.add("hidden");
  clearNewTaskForm();
});

// Create new task
createTaskBtn.addEventListener("click", ()=>{
  const title = document.getElementById("newTaskName").value; // CHANGED: name -> title
  const startDate = new Date(document.getElementById("newTaskStartDate").value);
  const endDate = new Date(document.getElementById("newTaskEndDate").value);
  
  if(!title || !startDate || !endDate) {
    alert("Please fill in all required fields (Name, Start Date, End Date)");
    return;
  }
  
  if(endDate < startDate) {
    alert("End date must be after or equal to start date");
    return;
  }
  
  // Calculate start position and duration relative to timeline
  const start = Math.floor((startDate - firstTimelineDate)/(1000*60*60*24));
  const duration = Math.floor((endDate - startDate)/(1000*60*60*24)) + 1;
  
  if(start < 0) {
    alert("Start date cannot be before January 1, 2026");
    return;
  }
  
  if(start >= totalDays) {
    alert("Start date is too far in the future for this timeline");
    return;
  }
  
  const newTask = {
    id: nextTaskId++,
    title: title, // CHANGED: name -> title
    type: "regular",
    color: document.getElementById("newTaskColor").value || "#3b82f6",
    start: start,
    duration: duration,
    icon: document.getElementById("newTaskIcon").value || "üìã",
    completed: false,
    importance: document.getElementById("newTaskImportance").value,
    category: document.getElementById("newTaskCategory").value,
    notes: document.getElementById("newTaskNotes").value,
    system: { // ADDED: system fields
      createdAt: new Date().toISOString(),
      lastModified: new Date().toISOString()
    }
  };
  
  tasks.push(newTask);
  renderTasks();
  newTaskModal.classList.add("hidden");
  clearNewTaskForm();
});

// Clear new task form
function clearNewTaskForm() {
  document.getElementById("newTaskName").value = "";
  document.getElementById("newTaskStartDate").value = "";
  document.getElementById("newTaskEndDate").value = "";
  document.getElementById("newTaskColor").value = "#3b82f6";
  document.getElementById("newTaskIcon").value = "";
  document.getElementById("newTaskImportance").value = "";
  document.getElementById("newTaskCategory").value = "";
  document.getElementById("newTaskNotes").value = "";
}
</script>
</body>
</html>