<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pulsar â€” Tasks</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESET + TOKENS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  /* backgrounds */
  --bg:#08080f;
  --bg-panel:#0d0d18;
  --bg-card:#11111f;
  --bg-hover:#16162a;
  --bg-active:#1c1c32;

  /* text */
  --text:#e2deff;
  --text-2:#8b82cc;
  --text-3:#3d3870;

  /* borders */
  --border:#1e1e38;
  --border-2:#28284a;

  /* accent â€” purple */
  --accent:#7c5cfc;
  --accent-2:#9b7eff;
  --accent-glow:rgba(124,92,252,.18);
  --accent-dim:rgba(124,92,252,.09);

  /* status colours */
  --red:#f87171;     --red-bg:rgba(248,113,113,.08);
  --green:#34d399;   --green-bg:rgba(52,211,153,.08);
  --blue:#60a5fa;    --blue-bg:rgba(96,165,250,.08);
  --orange:#fb923c;  --orange-bg:rgba(251,146,60,.08);
  --yellow:#fbbf24;  --yellow-bg:rgba(251,191,36,.08);
  --muted:#3d3870;

  /* timeline */
  --day-w:96px;
  --row-h:56px;
  --sub-h:46px;
  --head-h:44px;
  --label-w:268px;

  --font:'Space Grotesk',sans-serif;
  --body:'Inter',sans-serif;
  --ease:140ms ease-out;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--body);font-size:13px;overflow:hidden}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SHELL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app{display:flex;flex-direction:column;height:100vh;padding:16px 22px 0}

/* â”€â”€ Header â”€â”€ */
header{display:flex;align-items:center;gap:12px;padding-bottom:14px;border-bottom:1px solid var(--border);flex-shrink:0}
.logo{font-family:var(--font);font-weight:700;font-size:1.15rem;letter-spacing:-.3px;display:flex;align-items:center;gap:7px;color:var(--text);text-decoration:none}
.logo-icon{width:26px;height:26px;border-radius:7px;background:var(--accent);display:flex;align-items:center;justify-content:center}
.logo-icon svg{width:14px;height:14px;stroke:#fff;stroke-width:2.5;fill:none}
.logo span{color:var(--accent-2)}
.vtabs{display:flex;gap:3px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:3px}
.vtab{display:flex;align-items:center;gap:5px;padding:6px 14px;border-radius:5px;font-size:12px;font-weight:500;color:var(--text-2);cursor:pointer;border:none;background:transparent;font-family:var(--body);transition:all var(--ease)}
.vtab:hover{color:var(--text);background:var(--bg-hover)}
.vtab.active{background:var(--accent);color:#fff}
.vtab svg{width:12px;height:12px;stroke:currentColor;stroke-width:2;fill:none}
.sp1{flex:1}
.searchw{position:relative}
.searchw svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:13px;height:13px;stroke:var(--text-3);stroke-width:2;pointer-events:none}
.search{background:var(--bg-card);border:1px solid var(--border);border-radius:7px;padding:7px 12px 7px 30px;color:var(--text);width:210px;font-size:12px;font-family:var(--body);transition:border-color var(--ease)}
.search:focus{outline:none;border-color:var(--accent);background:var(--bg-hover)}
.search::placeholder{color:var(--text-3)}
.hbtn{display:flex;align-items:center;gap:5px;background:var(--bg-card);border:1px solid var(--border);border-radius:7px;padding:7px 13px;color:var(--text-2);font-size:12px;font-weight:500;cursor:pointer;font-family:var(--body);transition:all var(--ease)}
.hbtn:hover{background:var(--bg-hover);color:var(--text)}
.hbtn svg{width:12px;height:12px;stroke:currentColor;stroke-width:2;fill:none}
.hbtn-accent{background:var(--accent);border-color:var(--accent);color:#fff}
.hbtn-accent:hover{background:#6b4de8}

/* â”€â”€ Views â”€â”€ */
.views{flex:1;display:flex;flex-direction:column;min-height:0}
.vpanel{display:none;flex-direction:column;flex:1;min-height:0}
.vpanel.active{display:flex}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATUS PILLS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sp{padding:2px 8px;border-radius:100px;font-size:9px;font-weight:600;white-space:nowrap;flex-shrink:0}
.s-overdue{background:var(--red-bg);color:var(--red);border:1px solid rgba(248,113,113,.22)}
.s-done{background:var(--green-bg);color:var(--green);border:1px solid rgba(52,211,153,.22)}
.s-active{background:var(--blue-bg);color:var(--blue);border:1px solid rgba(96,165,250,.22)}
.s-urgent{background:var(--orange-bg);color:var(--orange);border:1px solid rgba(251,146,60,.22)}
.s-soon{background:var(--yellow-bg);color:var(--yellow);border:1px solid rgba(251,191,36,.22)}
.s-later{background:var(--bg-card);color:var(--muted);border:1px solid var(--border)}

/* importance badge */
.ib{display:inline-flex;align-items:center;padding:2px 7px;border-radius:3px;font-size:9px;font-weight:600}
.i-critical{background:rgba(248,113,113,.1);color:var(--red)}
.i-high{background:rgba(251,146,60,.1);color:var(--orange)}
.i-medium{background:rgba(251,191,36,.1);color:var(--yellow)}
.i-low{background:rgba(52,211,153,.1);color:var(--green)}

/* checkbox */
.cb{width:15px;height:15px;border:2px solid var(--border-2);border-radius:3px;cursor:pointer;appearance:none;background:transparent;transition:all var(--ease);flex-shrink:0}
.cb:checked{background:var(--accent);border-color:var(--accent)}
.cb:checked::after{content:'âœ“';display:flex;align-items:center;justify-content:center;color:#fff;font-size:9px;font-weight:700;height:100%}
.cb:hover{border-color:var(--accent)}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LIST VIEW
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-row{display:flex;gap:5px;margin-bottom:11px;flex-shrink:0;padding-top:14px}
.chip{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:11px;color:var(--text-2);cursor:pointer;transition:all var(--ease);font-weight:500}
.chip:hover{color:var(--text);border-color:var(--border-2)}
.chip.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent-2)}

.listwrap{flex:1;display:flex;flex-direction:column;background:var(--bg-panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;min-height:0}
.list-head{display:flex;height:var(--head-h);border-bottom:1px solid var(--border);background:var(--bg-card);flex-shrink:0}
.fixed-head{display:grid;grid-template-columns:4px 34px 296px;flex-shrink:0;border-right:2px solid var(--border)}
.shwrap{flex:1;overflow:hidden;cursor:grab;user-select:none}
.shwrap.drag{cursor:grabbing}
.shead{display:flex;height:100%}
.col-h{display:flex;align-items:center;gap:5px;padding:0 12px;font-family:var(--font);font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.7px;border-right:1px solid var(--border);flex-shrink:0;white-space:nowrap}





.listbody{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.listbody::-webkit-scrollbar{width:4px}
.listbody::-webkit-scrollbar-thumb{background:var(--border-2);border-radius:2px}

.task-group{margin-bottom:0;display:flex;flex-direction:column}
.task-group:nth-child(even){background:rgba(255,255,255,.022)}
.taskrow{display:flex;cursor:pointer;transition:background var(--ease)}
.taskrow:hover{background:rgba(255,255,255,.04)}

.row-fixed{display:grid;grid-template-columns:4px 34px 296px;flex-shrink:0;border-right:2px solid var(--border);align-items:stretch}
.row-scroll{display:flex;overflow:hidden;align-items:center}
.cell{display:flex;align-items:center;padding:0 12px;border-right:1px solid var(--border);overflow:hidden;flex-shrink:0;min-height:var(--row-h)}
.cell:last-child{border-right:none}
.c-bar{padding:0;border-right:none;align-items:stretch;min-height:unset}
.cbar-fill{width:4px;height:100%}
.c-cb{justify-content:center;padding:0;min-width:34px}
.c-title{gap:7px;min-width:296px;overflow:hidden}
.subs-wrap{overflow:hidden;transition:height 220ms cubic-bezier(.4,0,.2,1)}
.subrow{display:flex;cursor:pointer;transition:background var(--ease)}
.subrow .row-fixed{min-height:var(--sub-h)}
.subrow .row-scroll{min-height:var(--sub-h)}
.subrow .cell{min-height:var(--sub-h)}
.expbtn{width:18px;height:18px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;cursor:pointer;border-radius:3px;flex-shrink:0;transition:all var(--ease)}
.expbtn:hover{background:var(--bg-active)}
.expbtn svg{width:9px;height:9px;stroke:var(--text-3);stroke-width:2;fill:none;transition:transform var(--ease)}
.expbtn.open svg{transform:rotate(90deg)}
.tnm{flex:1;font-family:var(--font);font-weight:500;font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tnm.done{text-decoration:line-through;color:var(--text-3);opacity:.65}
.sub-indent{width:22px;flex-shrink:0;position:relative}
.sub-indent::before{content:'';position:absolute;left:7px;top:-4px;width:1px;height:100%;background:var(--border-2)}
.sub-indent::after{content:'';position:absolute;left:7px;top:50%;width:8px;height:1px;background:var(--border-2)}
.ct{font-size:11px;color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cd{font-size:11px;color:var(--text-2);white-space:nowrap}
.clink{display:flex;align-items:center;gap:4px;color:var(--accent-2);text-decoration:none;font-size:11px;white-space:nowrap}
.clink:hover{color:var(--accent)}
.clink svg{width:9px;height:9px;stroke:currentColor;stroke-width:2;fill:none;flex-shrink:0}
.ugw{display:flex;align-items:center;gap:5px;width:100%}
.ugbar{height:4px;border-radius:2px;background:var(--bg-active);flex:1;overflow:hidden}
.ugfill{height:100%;border-radius:2px}
.uglbl{font-size:10px;color:var(--text-3);min-width:18px;text-align:right}
.imd{display:flex;align-items:center;gap:4px}
.idots{display:flex;gap:2px}
.idot{width:4px;height:4px;border-radius:50%;background:var(--border-2)}
.idot.on{background:var(--accent)}
.isc{font-size:10px;color:var(--text-2)}
.btag{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.18);border-radius:4px;font-size:10px;color:var(--red)}
.btag svg{width:8px;height:8px;stroke:currentColor;stroke-width:2;fill:none}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text-3);gap:10px}
.empty svg{width:36px;height:36px;stroke:currentColor;stroke-width:1;fill:none;opacity:.3}
.empty p{font-size:12px;color:var(--text-2)}

/* column widths */
.cw140{min-width:140px}.cw110{min-width:110px}.cw100{min-width:100px}.cw160{min-width:160px}.cw130{min-width:130px}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   KANBAN VIEW
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ktool{display:flex;align-items:center;gap:8px;margin-bottom:11px;flex-shrink:0;padding-top:14px}
.vmtog{display:flex;gap:2px;background:var(--bg-card);border:1px solid var(--border);border-radius:7px;padding:3px}
.vmbtn{background:transparent;border:none;padding:5px 11px;font-size:11px;font-weight:500;color:var(--text-2);cursor:pointer;border-radius:4px;transition:all var(--ease);font-family:var(--body)}
.vmbtn.active{background:var(--accent);color:#fff}
.board{flex:1;display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;min-height:0}
.board::-webkit-scrollbar{height:4px}
.board::-webkit-scrollbar-thumb{background:var(--border-2);border-radius:2px}
.kcol{width:285px;min-width:285px;flex-shrink:0;background:var(--bg-panel);border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;max-height:100%}
.kcol-head{padding:11px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;flex-shrink:0}
.kdot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.kcol-title{font-family:var(--font);font-weight:600;font-size:12px;color:var(--text);flex:1}
.kcol-ct{background:var(--bg-active);color:var(--text-2);font-size:10px;font-weight:600;padding:1px 7px;border-radius:10px}
.kcol-body{flex:1;overflow-y:auto;padding:7px;display:flex;flex-direction:column;gap:6px}
.kcol-body::-webkit-scrollbar{width:3px}
.kcol-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.kcard{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all var(--ease);border-left:3px solid}
.kcard:hover{background:var(--bg-hover);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.35)}
.kcard-top{display:flex;align-items:flex-start;gap:7px;padding:9px}
.kcard-body{flex:1;min-width:0}
.ktrow{display:flex;align-items:center;gap:5px;margin-bottom:5px}
.kexpbtn{width:15px;height:15px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;cursor:pointer;border-radius:3px;flex-shrink:0;transition:all var(--ease)}
.kexpbtn:hover{background:var(--bg-active)}
.kexpbtn svg{width:8px;height:8px;stroke:var(--text-3);stroke-width:2;fill:none;transition:transform var(--ease)}
.kexpbtn.open svg{transform:rotate(90deg)}
.kti{font-size:13px;flex-shrink:0}
.ktn{flex:1;font-family:var(--font);font-weight:500;font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ktn.done{text-decoration:line-through;color:var(--text-3);opacity:.65}
.kmeta{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:4px}
.kdate{font-size:10px;color:var(--text-3);display:flex;align-items:center;gap:3px}
.kdate svg{width:9px;height:9px;stroke:currentColor;stroke-width:2;fill:none}
.mtag{background:var(--bg-active);color:var(--text-2);padding:2px 6px;border-radius:3px;font-size:9px}
.kfoot{padding:0 9px 8px;display:flex;align-items:center;gap:7px}
.progbar{height:3px;background:var(--bg-active);border-radius:2px;flex:1;overflow:hidden}
.progfill{height:100%;border-radius:2px;background:var(--accent)}
.proglbl{font-size:10px;color:var(--text-3)}
.ksubs{border-top:1px solid var(--border);padding:6px 9px}
.ksubrow{display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid var(--border)}
.ksubrow:last-child{border-bottom:none}
.ksubnm{flex:1;font-size:11px;color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ksubnm.done{text-decoration:line-through;color:var(--text-3)}
.kempty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 12px;color:var(--text-3);gap:6px;flex:1}
.kempty svg{width:26px;height:26px;stroke:currentColor;stroke-width:1;fill:none;opacity:.3}
.kempty p{font-size:11px}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TIMELINE VIEW
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tltool{display:flex;align-items:center;gap:7px;margin-bottom:11px;flex-shrink:0}
.zoombtns{display:flex;gap:2px;background:var(--bg-card);border:1px solid var(--border);border-radius:7px;padding:3px}
.zoombtn{background:transparent;border:none;width:26px;height:26px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:4px;color:var(--text-2);transition:all var(--ease);font-size:14px;font-weight:600;font-family:var(--body)}
.zoombtn:hover{background:var(--bg-hover);color:var(--text)}

.tlwrap{flex:1;display:flex;flex-direction:column;background:var(--bg-panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;min-height:0}
.tl-head{display:flex;border-bottom:1px solid var(--border);height:var(--head-h);flex-shrink:0}
.tl-lbl-head{width:var(--label-w);flex-shrink:0;display:flex;align-items:center;padding:0 13px;gap:9px;background:var(--bg-card);border-right:1px solid var(--border)}
.tl-lbl-head span{flex:1;font-family:var(--font);font-size:11px;font-weight:600;color:var(--text-2);text-transform:uppercase;letter-spacing:.5px}
.days-wrap{flex:1;overflow:hidden;position:relative;cursor:grab}
.days-wrap:active{cursor:grabbing}
.days-head{display:flex;position:absolute;height:100%;cursor:grab;user-select:none}
.days-head.drag{cursor:grabbing}
.day-col{min-width:var(--day-w);height:100%;border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg-card);flex-shrink:0;transition:background var(--ease)}
.day-col.today{background:var(--accent-dim);border-right-color:rgba(124,92,252,.3)}
.day-col.weekend{background:rgba(255,255,255,.008)}
.day-yr{font-size:9px;color:var(--text-3);}
.day-lbl{font-family:var(--font);font-weight:500;font-size:11px;color:var(--text-2)}
.day-col.today .day-lbl{color:var(--accent-2);font-weight:700}

.tl-body{flex:1;overflow-y:auto;min-height:0;scrollbar-width:thin;scrollbar-color:var(--border) transparent;background:var(--bg-card)}
.tl-body::-webkit-scrollbar{width:4px}
.tl-body::-webkit-scrollbar-thumb{background:var(--border-2);border-radius:2px}

.tl-row{display:flex;border-bottom:1px solid var(--border);align-items:stretch}
.tl-row:last-child{border-bottom:none}
.tl-lbl{width:var(--label-w);flex-shrink:0;background:var(--bg-card);border-right:1px solid var(--border);display:flex;flex-direction:column}
.tl-task-row{height:var(--row-h);display:flex;align-items:center;gap:7px;padding:0 10px;cursor:pointer;border-left:3px solid transparent;transition:background var(--ease)}
.tl-task-row:hover{background:var(--bg-hover)}
.tl-sub-row{height:var(--sub-h);display:flex;align-items:center;gap:7px;padding:0 10px 0 24px;cursor:pointer;border-left:3px solid transparent;border-top:1px solid var(--border);transition:background var(--ease)}
.tl-sub-row:hover{background:var(--bg-hover)}
.tlnm{flex:1;font-family:var(--font);font-weight:500;font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tlnm.done{text-decoration:line-through;color:var(--text-3);opacity:.6}
.tlsubnm{flex:1;font-size:11px;color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tlsubnm.done{text-decoration:line-through;color:var(--text-3)}

/* tl-grid is the clipping viewport â€” it never moves */
.tl-grid{flex:1;position:relative;overflow:hidden;background:var(--bg-card)}
/* tl-inner is what actually gets translateX'd */
.tl-inner{position:absolute;top:0;left:0;height:100%}
.grid-bg{position:absolute;top:0;left:0;height:100%;display:flex;pointer-events:none}
.grid-day{width:var(--day-w);height:100%;border-right:1px solid var(--border);flex-shrink:0}
.grid-day.today{background:rgb(29,29,29)}

/* â”€â”€ Task bars â€” reference style â”€â”€ */
/* main bar: fills row top:4/bottom:4, radius:4px */
.tl-bar{position:absolute;border-radius:4px;cursor:pointer;z-index:2;transition:filter 110ms ease}
.tl-bar:hover{filter:brightness(1.1)}
.tl-bar.done-bar{opacity:.45;filter:saturate(.35)}
/* subtask bar: fixed height 28px, radius:3px */
.tl-sub-bar{position:absolute;border-radius:3px;height:28px;cursor:pointer;z-index:2;transition:filter 110ms ease}
.tl-sub-bar:hover{filter:brightness(1.1)}
.tl-sub-bar.done-bar{opacity:.35;filter:saturate(.35)}

/* â”€â”€ Today column header â”€â”€ */
.day-col-today{background:rgb(29,29,29)!important}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(10px);padding:20px}
.moverlay.open{display:flex}
.modal{background:#1a1a1f;border:1px solid rgba(255,255,255,.08);border-radius:16px;width:100%;max-width:680px;max-height:88vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 40px 100px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,.04)}

/* head */
.m-head{display:flex;align-items:center;gap:10px;padding:18px 20px 0;flex-shrink:0}
.m-head-color{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.m-head h2{font-family:var(--font);font-size:13px;font-weight:600;color:var(--text-2);flex:1;text-transform:uppercase;letter-spacing:.5px}
.mclosebtn{width:26px;height:26px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.06);border:none;border-radius:6px;cursor:pointer;color:var(--text-2);transition:all var(--ease);flex-shrink:0}
.mclosebtn:hover{background:rgba(255,255,255,.1);color:var(--text)}
.mclosebtn svg{width:11px;height:11px;stroke:currentColor;stroke-width:2;fill:none}

/* title row */
.m-title-row{display:flex;align-items:center;gap:10px;padding:12px 20px 16px;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,.06)}
.m-title-icon{font-size:22px;flex-shrink:0;cursor:pointer;line-height:1}
.m-title-input{flex:1;background:transparent;border:none;font-family:var(--font);font-size:1.15rem;font-weight:600;color:var(--text);outline:none;min-width:0}
.m-title-input::placeholder{color:var(--text-3)}
.m-title-color{width:22px;height:22px;border:none;border-radius:6px;padding:0;cursor:pointer;background:transparent;flex-shrink:0;overflow:hidden}
.m-title-color::-webkit-color-swatch-wrapper{padding:0}
.m-title-color::-webkit-color-swatch{border:none;border-radius:6px}

/* tabs */
.m-tabs{display:flex;gap:0;padding:0 20px;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0}
.m-tab{padding:10px 14px;font-size:11px;font-weight:600;color:var(--text-3);cursor:pointer;border-bottom:2px solid transparent;transition:all var(--ease);text-transform:uppercase;letter-spacing:.5px;margin-bottom:-1px}
.m-tab:hover{color:var(--text-2)}
.m-tab.active{color:var(--accent-2);border-bottom-color:var(--accent)}

/* body */
.m-body{flex:1;overflow-y:auto;min-height:0}
.m-body::-webkit-scrollbar{width:3px}
.m-body::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
.m-tab-panel{display:none;padding:18px 20px;flex-direction:column;gap:14px}
.m-tab-panel.active{display:flex}

/* fields */
.mrow{display:grid;gap:12px}
.mrow-2{grid-template-columns:1fr 1fr}
.mrow-3{grid-template-columns:1fr 1fr 1fr}
.mrow-4{grid-template-columns:1fr 1fr 1fr 1fr}
.mfield{display:flex;flex-direction:column;gap:5px}
.mfield label{font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}
.mfield input,.mfield select,.mfield textarea{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:8px 11px;color:var(--text);font-size:12.5px;font-family:var(--body);transition:all var(--ease);-webkit-appearance:none}
.mfield input:focus,.mfield select:focus,.mfield textarea:focus{outline:none;border-color:var(--accent);background:rgba(124,92,252,.08)}
.mfield input::placeholder,.mfield textarea::placeholder{color:var(--text-3)}
.mfield textarea{resize:vertical;min-height:80px;line-height:1.6}
.mfield select option{background:#1a1a1f}
.mfield input[type="color"]{padding:3px;height:36px;cursor:pointer}
.mchk{display:flex;align-items:center;gap:8px;padding:2px 0;cursor:pointer}
.mchk input{accent-color:var(--accent)}
.mchk span{font-size:12.5px;color:var(--text-2)}

/* insight */
.m-insight{background:rgba(124,92,252,.07);border:1px solid rgba(124,92,252,.18);border-radius:8px;padding:10px 13px;display:flex;align-items:flex-start;gap:8px}
.mi-icon{color:var(--accent-2);flex-shrink:0;margin-top:1px}
.mi-icon svg{width:13px;height:13px;stroke:currentColor;stroke-width:2;fill:none}
.mi-text{font-size:12px;color:var(--text-2);line-height:1.6}
.mi-text strong{color:var(--accent-2);font-weight:600}

/* subtasks */
.sub-add{display:grid;grid-template-columns:1fr 100px 100px auto;gap:8px;align-items:end;margin-bottom:10px}
.sub-list{display:flex;flex-direction:column;gap:5px}
.sub-item{display:flex;align-items:center;gap:8px;padding:8px 11px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:8px;cursor:pointer;transition:background var(--ease)}
.sub-item:hover{background:rgba(255,255,255,.06)}
.sub-item-title{flex:1;font-size:12.5px;color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sub-item-title.done{text-decoration:line-through;color:var(--text-3)}
.sub-item-date{font-size:11px;color:var(--text-3);flex-shrink:0}
.sub-del{width:22px;height:22px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:4px;cursor:pointer;color:var(--text-3);transition:all var(--ease);flex-shrink:0}
.sub-del:hover{background:rgba(248,113,113,.12);color:var(--red)}
.sub-del svg{width:10px;height:10px;stroke:currentColor;stroke-width:2;fill:none}

/* foot */
.m-foot{display:flex;gap:7px;align-items:center;padding:14px 20px;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0}
.m-foot-left{flex:1;display:flex;gap:7px}
.mbtn{border:1px solid transparent;border-radius:8px;padding:8px 16px;font-size:12px;font-weight:500;cursor:pointer;transition:all var(--ease);display:flex;align-items:center;gap:5px;font-family:var(--body);white-space:nowrap}
.mbtn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.mbtn-primary:hover{background:#6b4de8}
.mbtn-sec{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.08);color:var(--text-2)}
.mbtn-sec:hover{background:rgba(255,255,255,.1);color:var(--text)}
.mbtn-danger{background:transparent;border-color:rgba(248,113,113,.3);color:var(--red)}
.mbtn-danger:hover{background:rgba(248,113,113,.1)}
.mbtn-ghost{background:transparent;border-color:transparent;color:var(--text-3)}
.mbtn-ghost:hover{color:var(--text-2)}
.mbtn-sm{padding:6px 11px;font-size:11px}
.mbtn svg{width:12px;height:12px;stroke:currentColor;stroke-width:2;fill:none}

/* subtask modal */
.smodal{background:#1a1a1f;border:1px solid rgba(255,255,255,.08);border-radius:14px;width:100%;max-width:460px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 40px 100px rgba(0,0,0,.7)}
.smodal .m-head{border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:14px}
.smodal .m-body{padding:16px 20px;display:flex;flex-direction:column;gap:12px}
.smodal .m-foot{border-top:1px solid rgba(255,255,255,.06)}
</style>
</head>
<body>
<div class="app">

<!-- â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo">
    <div class="logo-icon"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
    Pulsar<span>.</span>
  </div>
  <nav class="vtabs">
    <button class="vtab active" data-v="list">
      <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3" cy="6" r=".5" fill="currentColor"/><circle cx="3" cy="12" r=".5" fill="currentColor"/><circle cx="3" cy="18" r=".5" fill="currentColor"/></svg>
      List
    </button>
    <button class="vtab" data-v="kanban">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="11" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/></svg>
      Kanban
    </button>
    <button class="vtab" data-v="timeline">
      <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Timeline
    </button>
  </nav>
  <div class="sp1"></div>
  <div class="searchw">
    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input class="search" id="gSearch" placeholder="Search tasksâ€¦" autocomplete="off">
  </div>
  <button class="hbtn hbtn-accent" id="gAdd">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    Add Task
  </button>
</header>

<!-- â•â•â•â•â•â•â•â• VIEWS â•â•â•â•â•â•â•â• -->
<div class="views">

  <!-- LIST -->
  <div class="vpanel active" id="v-list">
    <div class="filter-row" id="listChips">
      <div class="chip active" data-f="all">All</div>
      <div class="chip" data-f="overdue">Overdue</div>
      <div class="chip" data-f="inprogress">Active</div>
      <div class="chip" data-f="soon">Soon</div>
      <div class="chip" data-f="done">Done</div>
      <div class="chip" data-f="later">Later</div>
    </div>
    <div class="listwrap">
      <div class="list-head">
        <div class="fixed-head">
          <div></div><div></div>
          <div class="col-h" style="min-width:296px" data-ls="title">Tasks</div>
        </div>
        <div class="shwrap" id="lshwrap">
          <div class="shead" id="lshead">
            <div class="col-h cw140" data-ls="project">Project</div>
            <div class="col-h cw110" data-ls="dueDate">Due</div>
            <div class="col-h cw110" data-ls="startDate">Start</div>
            <div class="col-h cw100" data-ls="estimate">Est</div>
            <div class="col-h cw130" data-ls="importance">Priority</div>
            <div class="col-h cw160" data-ls="urgency">Urgency</div>
            <div class="col-h cw130" data-ls="impact">Impact</div>
            <div class="col-h cw110" data-ls="state">State</div>
            <div class="col-h cw130" data-ls="blockReason">Blocked</div>
            <div class="col-h cw140">Link</div>
          </div>
        </div>
      </div>
      <div class="listbody" id="listbody"></div>
    </div>
  </div>

  <!-- KANBAN -->
  <div class="vpanel" id="v-kanban">
    <div class="ktool">
      <div class="vmtog">
        <button class="vmbtn active" data-km="state">By State</button>
        <button class="vmbtn" data-km="category">By Category</button>
      </div>
    </div>
    <div class="board" id="board"></div>
  </div>

  <!-- TIMELINE -->
  <div class="vpanel" id="v-timeline">
    <div class="tltool">
      <button class="hbtn" id="goToday">
        <svg viewBox="0 0 24 24" width="12" height="12"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Today
      </button>
    </div>
    <div class="tlwrap">
      <div class="tl-head">
        <div class="tl-lbl-head"><span>Tasks</span></div>
        <div class="days-wrap"><div class="days-head" id="daysHead"></div></div>
      </div>
      <div class="tl-body" id="tlbody"></div>
    </div>
  </div>

</div>
</div>

<!-- â•â•â•â•â•â•â•â• TASK MODAL â•â•â•â•â•â•â•â• -->
<div class="moverlay" id="moverlay">
  <div class="modal">
    <div class="m-head">
      <div class="m-head-color" id="mHeadColor"></div>
      <h2 id="mTitle">New Task</h2>
      <button class="mclosebtn" id="mClose"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="m-title-row">
      <span class="m-title-icon" id="mIconDisplay">ğŸ“‹</span>
      <input class="m-title-input" type="text" id="mFTitle" placeholder="Task nameâ€¦">
      <input class="m-title-color" type="color" id="mColor" value="#7c5cfc">
    </div>
    <div class="m-tabs">
      <div class="m-tab active" data-tab="details">Details</div>
      <div class="m-tab" data-tab="schedule">Schedule</div>
      <div class="m-tab" data-tab="priority">Priority</div>
      <div class="m-tab" data-tab="subtasks">Subtasks</div>
      <div class="m-tab" data-tab="notes">Notes</div>
    </div>
    <div class="m-body">
      <!-- Details -->
      <div class="m-tab-panel active" id="tab-details">
        <div class="mrow mrow-2">
          <div class="mfield"><label>Project</label><input type="text" id="mProject" placeholder="Project name"></div>
          <div class="mfield"><label>Category</label><input type="text" id="mCat" placeholder="Category"></div>
        </div>
        <div class="mrow mrow-2">
          <div class="mfield"><label>Icon</label><input type="text" id="mIcon" maxlength="2" placeholder="ğŸ“‹" style="font-size:16px;text-align:center"></div>
          <div class="mfield"><label>Tags</label><input type="text" id="mTags" placeholder="tag1, tag2â€¦"></div>
        </div>
        <div class="mrow">
          <div class="mfield"><label>Project Link</label><input type="url" id="mLink" placeholder="https://â€¦"></div>
        </div>
        <div class="m-insight" id="mInsight" style="display:none">
          <div class="mi-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg></div>
          <div class="mi-text" id="mInsightText"></div>
        </div>
      </div>
      <!-- Schedule -->
      <div class="m-tab-panel" id="tab-schedule">
        <div class="mrow mrow-2">
          <div class="mfield"><label>Start Date</label><input type="date" id="mStart"></div>
          <div class="mfield"><label>Due Date</label><input type="date" id="mDue"></div>
        </div>
        <div class="mrow mrow-2">
          <div class="mfield"><label>Due Time</label><input type="time" id="mDueTime"></div>
          <div class="mfield"><label>Est. Hours</label><input type="number" id="mEst" min="0" step="0.5" placeholder="0"></div>
        </div>
        <div class="mrow">
          <div class="mfield"><label>Recurrence</label>
            <select id="mRec"><option value="">None</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option></select>
          </div>
        </div>
      </div>
      <!-- Priority -->
      <div class="m-tab-panel" id="tab-priority">
        <div class="mrow mrow-2">
          <div class="mfield"><label>Importance</label>
            <select id="mImportance"><option value="">â€”</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select>
          </div>
          <div class="mfield"><label>Impact (1â€“10)</label><input type="number" id="mImpact" min="1" max="10" placeholder="0"></div>
        </div>
        <div class="mrow mrow-2">
          <div class="mfield"><label>Energy</label>
            <select id="mEnergy"><option value="">â€”</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select>
          </div>
          <div class="mfield" style="justify-content:flex-end">
            <label>&nbsp;</label>
            <label class="mchk"><input type="checkbox" id="mFocus"><span>Focus Eligible</span></label>
          </div>
        </div>
        <div class="mrow">
          <div class="mfield"><label>Block Reason</label><input type="text" id="mBlock" placeholder="Why is this blocked?"></div>
        </div>
        <div class="mrow">
          <div class="mfield"><label>Dependencies</label><input type="text" id="mDeps" placeholder="Task IDs: 1, 2, 3â€¦"></div>
        </div>
      </div>
      <!-- Subtasks -->
      <div class="m-tab-panel" id="tab-subtasks">
        <div class="sub-add">
          <div class="mfield"><label>Title</label><input type="text" id="mSubT" placeholder="Subtask nameâ€¦"></div>
          <div class="mfield"><label>Start</label><input type="date" id="mSubS"></div>
          <div class="mfield"><label>Due</label><input type="date" id="mSubD"></div>
          <button class="mbtn mbtn-sec mbtn-sm" id="mAddSub" disabled>+ Add</button>
        </div>
        <div class="sub-list" id="mSubList"></div>
      </div>
      <!-- Notes -->
      <div class="m-tab-panel" id="tab-notes">
        <div class="mfield"><label>Notes</label><textarea id="mNotes" placeholder="Context, decisions, detailsâ€¦" style="min-height:160px"></textarea></div>
      </div>
    </div>
    <div class="m-foot">
      <div class="m-foot-left">
        <button class="mbtn mbtn-danger" id="mDelete">Delete</button>
        <button class="mbtn mbtn-ghost" id="mDup">Duplicate</button>
      </div>
      <button class="mbtn mbtn-sec" id="mCancel">Cancel</button>
      <button class="mbtn mbtn-primary" id="mSave">Save Task</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• SUBTASK MODAL â•â•â•â•â•â•â•â• -->
<div class="moverlay" id="soverlay">
  <div class="smodal">
    <div class="m-head" style="border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:14px">
      <div class="m-head-color" id="sHeadColor"></div>
      <h2 id="sTitle">Subtask</h2>
      <button class="mclosebtn" id="sClose"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="m-body" style="padding:16px 20px;display:flex;flex-direction:column;gap:12px">
      <div class="mfield"><label>Title</label><input type="text" id="sFTitle" placeholder="Subtask nameâ€¦" style="font-size:14px"></div>
      <div class="mrow mrow-2">
        <div class="mfield"><label>Start Date</label><input type="date" id="sStart"></div>
        <div class="mfield"><label>Due Date</label><input type="date" id="sDue"></div>
      </div>
      <div class="mrow mrow-2">
        <div class="mfield"><label>Importance</label>
          <select id="sImportance"><option value="">â€”</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select>
        </div>
        <div class="mfield"><label>Impact (1â€“10)</label><input type="number" id="sImpact" min="1" max="10" placeholder="0"></div>
      </div>
      <label class="mchk"><input type="checkbox" id="sCompleted"><span>Completed</span></label>
    </div>
    <div class="m-foot">
      <div class="m-foot-left">
        <button class="mbtn mbtn-danger mbtn-sm" id="sDelete">Remove</button>
      </div>
      <button class="mbtn mbtn-sec" id="sCancel">Cancel</button>
      <button class="mbtn mbtn-primary" id="sSave">Save</button>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(()=>{
let _id=100;const uid=()=>_id++;
function createTask(p={}){const n=new Date().toISOString();return{id:p.id??uid(),title:p.title||'',icon:p.icon||'ğŸ“‹',color:p.color||'#7c5cfc',project:p.project||'',category:p.category||'',tags:p.tags||'',startDate:p.startDate||'',dueDate:p.dueDate||'',dueTime:p.dueTime||'',recurrence:p.recurrence||'',estimate:p.estimate||0,projectLink:p.projectLink||'',importance:p.importance||'',impactScore:p.impactScore||0,energyMode:p.energyMode||'',focusEligible:p.focusEligible!==undefined?p.focusEligible:true,notes:p.notes||'',dependencies:p.dependencies||'',blockReason:p.blockReason||'',completed:p.completed||false,subtasks:p.subtasks?p.subtasks.map(s=>createSub(s)):null,system:{createdAt:p.system?.createdAt||n,lastModified:n,completedAt:p.system?.completedAt||null,version:p.system?.version||1,autoPriorityWeight:0}};}
function createSub(p={}){return{title:p.title||'',startDate:p.startDate||'',dueDate:p.dueDate||'',importance:p.importance||'',impactScore:p.impactScore||0,completed:p.completed||false};}
function derived(t){
  const today=new Date();today.setHours(0,0,0,0);
  const due=t.dueDate?new Date(t.dueDate+'T00:00:00'):null;
  const start=t.startDate?new Date(t.startDate+'T00:00:00'):null;
  if(!due)return{label:'later',urgencyScore:0,isUrgent:false,daysUntilDue:null};
  const dDue=Math.floor((due-today)/864e5);
  const dStart=start?Math.floor((start-today)/864e5):dDue;
  let ug=dDue<=0?10:dDue<=1?9:dDue<=3?7:dDue<=7?5:dDue<=14?3:1;
  const im={low:2,medium:5,high:8,critical:10};
  t.system.autoPriorityWeight=(im[t.importance]||0)*.4+(t.impactScore||0)*.3+ug*.3;
  let label='later',isUrgent=false;
  if(t.completed)label='done';
  else if(dDue<0)label='overdue';
  else if(dStart<=0&&dDue>=0){label='inprogress';isUrgent=dDue<=1;}
  else if(dDue<=3)label='soon';
  return{label,urgencyScore:ug,isUrgent,daysUntilDue:dDue};
}
function subDerived(s){
  if(s.completed)return{label:'done',isUrgent:false,urgencyScore:0};
  if(!s.dueDate)return{label:'later',isUrgent:false,urgencyScore:0};
  const today=new Date();today.setHours(0,0,0,0);
  const due=new Date(s.dueDate+'T00:00:00');
  const start=s.startDate?new Date(s.startDate+'T00:00:00'):null;
  const d=Math.floor((due-today)/864e5);
  const ds=start?Math.floor((start-today)/864e5):d;
  const ug=d<=0?10:d<=1?9:d<=3?7:d<=7?5:3;
  if(d<0)return{label:'overdue',isUrgent:false,urgencyScore:ug};
  if(ds<=0&&d>=0)return{label:'inprogress',isUrgent:d<=1,urgencyScore:ug};
  if(d<=3)return{label:'soon',isUrgent:false,urgencyScore:ug};
  return{label:'later',isUrgent:false,urgencyScore:ug};
}
function sCls(label,urg){if(label==='inprogress'&&urg)return's-urgent';return{overdue:'s-overdue',done:'s-done',inprogress:'s-active',soon:'s-soon',later:'s-later'}[label]||'s-later';}
function sTxt(label,urg){if(label==='inprogress'&&urg)return'Urgent';return{overdue:'Overdue',done:'Done',inprogress:'Active',soon:'Soon',later:'Later'}[label]||'Later';}
let _tasks=[],_listeners=[];
function _notify(){_listeners.forEach(fn=>fn());}
window.PULSAR={
  getTasks:()=>_tasks,
  addTask(p){const t=createTask(p);_tasks.push(t);derived(t);_notify();return t;},
  updateTask(id,p){const t=_tasks.find(t=>t.id===id);if(!t)return;Object.assign(t,p);t.system.lastModified=new Date().toISOString();t.system.version++;if(t.completed&&!t.system.completedAt)t.system.completedAt=new Date().toISOString();if(!t.completed)t.system.completedAt=null;derived(t);_notify();},
  deleteTask(id){_tasks=_tasks.filter(t=>t.id!==id);_notify();},
  duplicateTask(id){const t=_tasks.find(t=>t.id===id);if(!t)return;const d=createTask(JSON.parse(JSON.stringify(t)));d.title+=' (Copy)';d.completed=false;d.system.completedAt=null;if(d.subtasks)d.subtasks.forEach(s=>s.completed=false);_tasks.push(d);derived(d);_notify();},
  toggleTask(id){const t=_tasks.find(t=>t.id===id);if(!t)return;t.completed=!t.completed;t.system.lastModified=new Date().toISOString();t.system.completedAt=t.completed?new Date().toISOString():null;if(t.completed&&t.subtasks)t.subtasks.forEach(s=>s.completed=true);derived(t);_notify();},
  toggleSub(tid,si){const t=_tasks.find(t=>t.id===tid);if(!t||!t.subtasks||!t.subtasks[si])return;t.subtasks[si].completed=!t.subtasks[si].completed;t.completed=t.subtasks.every(s=>s.completed);t.system.lastModified=new Date().toISOString();t.system.completedAt=t.completed?new Date().toISOString():null;derived(t);_notify();},
  derived,subDerived,sCls,sTxt,createTask,createSub,
  subscribe(fn){_listeners.push(fn);},
  filtered(filter,q){
    q=(q||'').toLowerCase();
    return _tasks.filter(t=>{
      if(filter&&filter!=='all'){const d=derived(t);if(filter==='inprogress'&&(d.label==='inprogress'||d.label==='soon')){}else if(d.label!==filter)return false;}
      if(q)return[t.title,t.project,t.tags,t.category].some(v=>(v||'').toLowerCase().includes(q));
      return true;
    });
  },
  seed(data){_tasks=data.map(p=>createTask(p));_tasks.forEach(derived);_id=Math.max(_id,..._tasks.map(t=>t.id+1));_notify();},
};
PULSAR.seed([
  {id:1,title:'Q1 Product Strategy',icon:'ğŸ¯',color:'#7c5cfc',project:'Strategy',category:'Planning',tags:'quarterly,leadership',startDate:'2026-02-18',dueDate:'2026-03-05',dueTime:'17:00',importance:'critical',impactScore:9,estimate:8,projectLink:'https://notion.so/strategy',notes:'Define roadmap priorities for Q1.',subtasks:[{title:'Market Analysis Report',startDate:'2026-02-18',dueDate:'2026-02-22',importance:'high',impactScore:7},{title:'Competitive Landscape Review',startDate:'2026-02-22',dueDate:'2026-02-26',importance:'high',impactScore:8},{title:'Draft Strategy Slides',startDate:'2026-02-26',dueDate:'2026-03-01',importance:'medium',impactScore:6},{title:'Leadership Review Meeting',startDate:'2026-03-01',dueDate:'2026-03-05',importance:'medium',impactScore:5}]},
  {id:2,title:'User Research Synthesis',icon:'ğŸ“Š',color:'#a78bfa',project:'Research',category:'UX',tags:'research,users',startDate:'2026-02-10',dueDate:'2026-02-23',importance:'high',impactScore:7,estimate:6,subtasks:[{title:'Compile Interview Transcripts',startDate:'2026-02-10',dueDate:'2026-02-14',completed:true,importance:'medium',impactScore:5},{title:'Identify Key Pain Points',startDate:'2026-02-14',dueDate:'2026-02-18',importance:'high',impactScore:8},{title:'Create Persona Documents',startDate:'2026-02-18',dueDate:'2026-02-20',importance:'medium',impactScore:6},{title:'Write Research Report',startDate:'2026-02-20',dueDate:'2026-02-23',importance:'high',impactScore:7}]},
  {id:3,title:'Design System Update',icon:'ğŸ¨',color:'#34d399',project:'Design',category:'Engineering',tags:'design,components',startDate:'2026-03-01',dueDate:'2026-03-14',importance:'medium',impactScore:6,estimate:12,subtasks:[{title:'Audit Color Tokens',startDate:'2026-03-01',dueDate:'2026-03-04',importance:'low',impactScore:4},{title:'Define Typography Scale',startDate:'2026-03-04',dueDate:'2026-03-08',importance:'medium',impactScore:6},{title:'Update Component Docs',startDate:'2026-03-08',dueDate:'2026-03-12',importance:'medium',impactScore:5},{title:'Migration Guide',startDate:'2026-03-12',dueDate:'2026-03-14',importance:'high',impactScore:7}]},
  {id:4,title:'API Documentation',icon:'ğŸ“',color:'#fbbf24',project:'Engineering',category:'Docs',tags:'api,docs',startDate:'2026-02-05',dueDate:'2026-02-16',importance:'high',impactScore:5,estimate:4,blockReason:'Waiting on API v2 from backend',subtasks:[{title:'Auth Endpoints',startDate:'2026-02-05',dueDate:'2026-02-08',completed:true,importance:'high',impactScore:6},{title:'CRUD Examples',startDate:'2026-02-08',dueDate:'2026-02-12',importance:'medium',impactScore:5},{title:'Error Code Reference',startDate:'2026-02-12',dueDate:'2026-02-16',importance:'medium',impactScore:4}]},
  {id:5,title:'Performance Optimization',icon:'âš¡',color:'#f87171',project:'Engineering',category:'Perf',tags:'speed,core',startDate:'2026-02-20',dueDate:'2026-03-07',importance:'high',impactScore:8,estimate:16,dependencies:'3',subtasks:[{title:'Profiling Analysis',startDate:'2026-02-20',dueDate:'2026-02-23',importance:'high',impactScore:7},{title:'Bundle Size Optimization',startDate:'2026-02-23',dueDate:'2026-02-27',importance:'high',impactScore:8},{title:'Component Render Perf',startDate:'2026-02-27',dueDate:'2026-03-03',importance:'medium',impactScore:6},{title:'Load Testing',startDate:'2026-03-03',dueDate:'2026-03-07',importance:'medium',impactScore:7}]},
  {id:6,title:'Client Presentation Prep',icon:'ğŸ¤',color:'#f472b6',project:'Sales',category:'Client',tags:'client,demo',startDate:'2026-02-24',dueDate:'2026-02-27',dueTime:'10:00',importance:'critical',impactScore:9,estimate:5,subtasks:[{title:'Demo Environment Setup',startDate:'2026-02-24',dueDate:'2026-02-25',importance:'critical',impactScore:8},{title:'Slide Deck',startDate:'2026-02-25',dueDate:'2026-02-26',importance:'high',impactScore:9},{title:'Rehearse Flow',startDate:'2026-02-26',dueDate:'2026-02-27',importance:'medium',impactScore:6}]},
  {id:7,title:'Team Retrospective',icon:'ğŸ”„',color:'#22d3ee',project:'Operations',category:'Team',tags:'team,process',startDate:'2026-02-22',dueDate:'2026-02-22',dueTime:'14:00',importance:'medium',impactScore:4,estimate:2,recurrence:'biweekly'},
  {id:8,title:'Security Audit Prep',icon:'ğŸ”’',color:'#dc2626',project:'Engineering',category:'Security',tags:'security,compliance',startDate:'2026-03-10',dueDate:'2026-03-28',importance:'critical',impactScore:10,estimate:20},
  {id:9,title:'Weekly Standup Notes',icon:'ğŸ“‹',color:'#64748b',project:'Operations',category:'Admin',tags:'meeting,weekly',startDate:'2026-02-17',dueDate:'2026-02-17',importance:'low',impactScore:2,estimate:0.5,completed:true},
  {id:10,title:'Onboarding New Hires',icon:'ğŸ‘‹',color:'#818cf8',project:'HR',category:'Team',tags:'onboarding,training',startDate:'2026-03-03',dueDate:'2026-03-10',importance:'medium',impactScore:5,estimate:8},
]);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEW SWITCHER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $=id=>document.getElementById(id);
let activeView='list';
document.querySelectorAll('.vtab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.vtab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.vpanel').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    activeView=tab.dataset.v;
    document.getElementById('v-'+activeView).classList.add('active');
    if(activeView==='timeline')tlScrollToday();
  });
});
$('gSearch').oninput=()=>{renderList();renderKanban();renderTL();};
$('gAdd').onclick=()=>openModal(null);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIST VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lSort='dueDate',lDir=1,lFilter='all',lExp=new Set();

const impCls=i=>({critical:'i-critical',high:'i-high',medium:'i-medium',low:'i-low'}[i]||'');
const fmtDate=d=>d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'â€”';
const ugClr=s=>s>=9?'var(--red)':s>=7?'var(--orange)':s>=5?'var(--yellow)':s>=3?'var(--accent-2)':'var(--muted)';

function lSortV(t,k){
  const d=PULSAR.derived(t);
  switch(k){
    case'title':return t.title.toLowerCase();
    case'project':return(t.project||'').toLowerCase();
    case'dueDate':return t.dueDate||'9999';
    case'startDate':return t.startDate||'9999';
    case'estimate':return t.estimate||0;
    case'importance':return{critical:4,high:3,medium:2,low:1}[t.importance]||0;
    case'urgency':return d.urgencyScore;
    case'impact':return t.impactScore||0;
    case'state':return{overdue:5,inprogress:4,soon:3,later:2,done:1}[d.label]||0;
    case'blockReason':return t.blockReason?0:1;
    default:return 0;
  }
}

function renderList(){
  const body=$('listbody');
  let tasks=[...PULSAR.filtered(lFilter,$('gSearch').value)].sort((a,b)=>{const av=lSortV(a,lSort),bv=lSortV(b,lSort);return av<bv?-lDir:av>bv?lDir:0;});
  if(!tasks.length){body.innerHTML=`<div class="empty"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg><p>No tasks found</p></div>`;return;}
  let html='';
  tasks.forEach(t=>{
    const d=PULSAR.derived(t);const hasSubs=t.subtasks&&t.subtasks.length;const isExp=lExp.has(t.id);
    html+=`<div class="task-group">`;
    html+=lTaskHTML(t,d,hasSubs,isExp);
    if(hasSubs){
      html+=`<div class="subs-wrap" data-subs="${t.id}" style="height:${isExp?'auto':'0px'}">`;
      t.subtasks.forEach((s,i)=>html+=lSubHTML(t,s,i,PULSAR.subDerived(s)));
      html+=`</div>`;
    }
    html+=`</div>`;
  });
  body.innerHTML=html;
  lBind();
}

function lTaskHTML(t,d,hasSubs,isExp){
  const sc=PULSAR.sCls(d.label,d.isUrgent),ug=d.urgencyScore;
  let imp=hasSubs?`<span style="font-size:11px;color:var(--text-3)">${t.subtasks.filter(s=>s.completed).length}/${t.subtasks.length}</span>`:'';
  let impBadge=t.importance?`<span class="ib ${impCls(t.importance)}">${t.importance.charAt(0).toUpperCase()+t.importance.slice(1)}</span>`:'<span class="ct">â€”</span>';
  let dots='<span class="ct">â€”</span>';
  if(t.impactScore){let dd='';for(let i=1;i<=10;i++)dd+=`<div class="idot${i<=t.impactScore?' on':''}"></div>`;dots=`<div class="imd"><div class="idots">${dd}</div><span class="isc">${t.impactScore}</span></div>`;}
  let link='<span class="ct">â€”</span>';
  if(t.projectLink){try{const h=new URL(t.projectLink).hostname.replace('www.','');link=`<a class="clink" href="${t.projectLink}" target="_blank" onclick="event.stopPropagation()"><svg viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/></svg>${h}</a>`;}catch(e){}}
  let blocked='<span class="ct">â€”</span>';
  if(t.blockReason)blocked=`<div class="btag"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/></svg>Blocked</div>`;
  return `<div class="taskrow" data-id="${t.id}">
    <div class="row-fixed">
      <div class="cell c-bar"><div class="cbar-fill" style="background:${t.color}"></div></div>
      <div class="cell c-cb"><input type="checkbox" class="cb l-tchk" data-id="${t.id}" ${t.completed?'checked':''}></div>
      <div class="cell c-title">
        <button class="expbtn${isExp?' open':''}" data-id="${t.id}" style="${hasSubs?'':'visibility:hidden'}">
          <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
        </button>
        <span style="font-size:13px;flex-shrink:0">${t.icon}</span>
        <span class="tnm${t.completed?' done':''}" data-open="${t.id}">${t.title}</span>
        ${imp}
      </div>
    </div>
    <div class="row-scroll l-rs" data-id="${t.id}">
      <div class="cell cw140"><span class="ct">${t.project||'â€”'}</span></div>
      <div class="cell cw110"><span class="cd">${fmtDate(t.dueDate)}</span></div>
      <div class="cell cw110"><span class="cd">${fmtDate(t.startDate)}</span></div>
      <div class="cell cw100"><span class="ct">${t.estimate?t.estimate+'h':'â€”'}</span></div>
      <div class="cell cw130">${impBadge}</div>
      <div class="cell cw160"><div class="ugw"><div class="ugbar"><div class="ugfill" style="width:${ug*10}%;background:${ugClr(ug)}"></div></div><span class="uglbl">${ug}</span></div></div>
      <div class="cell cw130">${dots}</div>
      <div class="cell cw110"><span class="sp ${sc}">${PULSAR.sTxt(d.label,d.isUrgent)}</span></div>
      <div class="cell cw130">${blocked}</div>
      <div class="cell cw140">${link}</div>
    </div>
  </div>`;
}

function lSubHTML(parent,sub,idx,sd){
  const sc=PULSAR.sCls(sd.label,sd.isUrgent);
  let impBadge=sub.importance?`<span class="ib ${impCls(sub.importance)}">${sub.importance.charAt(0).toUpperCase()+sub.importance.slice(1)}</span>`:'<span class="ct">â€”</span>';
  let dots='<span class="ct">â€”</span>';
  if(sub.impactScore){let dd='';for(let i=1;i<=10;i++)dd+=`<div class="idot${i<=sub.impactScore?' on':''}"></div>`;dots=`<div class="imd"><div class="idots">${dd}</div><span class="isc">${sub.impactScore}</span></div>`;}
  const ug=sd.urgencyScore;
  return `<div class="subrow" data-parent="${parent.id}" data-idx="${idx}">
    <div class="row-fixed">
      <div class="cell c-bar"><div class="cbar-fill" style="background:${parent.color}"></div></div>
      <div class="cell c-cb"><input type="checkbox" class="cb l-schk" data-parent="${parent.id}" data-idx="${idx}" ${sub.completed?'checked':''}></div>
      <div class="cell c-title"><div class="sub-indent"></div><span class="tnm${sub.completed?' done':''}" style="font-weight:400;font-size:11px">${sub.title}</span></div>
    </div>
    <div class="row-scroll l-rs">
      <div class="cell cw140"><span class="ct">â€”</span></div>
      <div class="cell cw110"><span class="cd">${fmtDate(sub.dueDate)}</span></div>
      <div class="cell cw110"><span class="cd">${fmtDate(sub.startDate)}</span></div>
      <div class="cell cw100"><span class="ct">â€”</span></div>
      <div class="cell cw130">${impBadge}</div>
      <div class="cell cw160"><div class="ugw"><div class="ugbar"><div class="ugfill" style="width:${ug*10}%;background:${ugClr(ug)}"></div></div><span class="uglbl">${ug}</span></div></div>
      <div class="cell cw130">${dots}</div>
      <div class="cell cw110"><span class="sp ${sc}">${PULSAR.sTxt(sd.label,sd.isUrgent)}</span></div>
      <div class="cell cw130"><span class="ct">â€”</span></div>
      <div class="cell cw140"><span class="ct">â€”</span></div>
    </div>
  </div>`;
}

function lBind(){
  document.querySelectorAll('.l-tchk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();PULSAR.toggleTask(parseInt(cb.dataset.id));});
  document.querySelectorAll('.l-schk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();PULSAR.toggleSub(parseInt(cb.dataset.parent),parseInt(cb.dataset.idx));});
  document.querySelectorAll('.expbtn').forEach(btn=>btn.onclick=e=>{
    e.stopPropagation();
    const id=parseInt(btn.dataset.id);
    const wrap=document.querySelector(`.subs-wrap[data-subs="${id}"]`);
    if(!wrap)return;
    const isOpen=lExp.has(id);
    if(isOpen){
      wrap.style.height=wrap.offsetHeight+'px';
      wrap.offsetHeight;
      wrap.style.height='0px';
      lExp.delete(id);
      btn.classList.remove('open');
    } else {
      wrap.style.height='0px';
      wrap.offsetHeight;
      const full=wrap.scrollHeight+'px';
      wrap.style.height=full;
      wrap.addEventListener('transitionend',()=>{if(lExp.has(id))wrap.style.height='auto';},{once:true});
      lExp.add(id);
      btn.classList.add('open');
    }
  });
  document.querySelectorAll('[data-open]').forEach(el=>el.onclick=e=>{e.stopPropagation();const t=PULSAR.getTasks().find(t=>t.id===parseInt(el.dataset.open));if(t)openModal(t);});
  document.querySelectorAll('.taskrow').forEach(row=>row.onclick=e=>{if(e.target.classList.contains('cb')||e.target.closest('.expbtn')||e.target.closest('.clink')||e.target.dataset.open)return;const t=PULSAR.getTasks().find(t=>t.id===parseInt(row.dataset.id));if(t)openModal(t);});
  document.querySelectorAll('.subrow').forEach(row=>row.onclick=e=>{
    if(e.target.classList.contains('cb'))return;
    const parentId=parseInt(row.dataset.parent);
    const idx=parseInt(row.dataset.idx);
    const t=PULSAR.getTasks().find(t=>t.id===parentId);
    if(!t)return;
    // open parent modal first (sets _cur), then open subtask modal on top
    openModal(t);
    requestAnimationFrame(()=>{
      // switch to subtasks tab
      document.querySelectorAll('.m-tab').forEach(tab=>tab.classList.toggle('active',tab.dataset.tab==='subtasks'));
      document.querySelectorAll('.m-tab-panel').forEach(p=>p.classList.toggle('active',p.id==='tab-subtasks'));
      openSubModal(idx);
    });
  });
}

document.querySelectorAll('#listChips .chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#listChips .chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');lFilter=c.dataset.f;renderList();});


// header scroll drag + sync
(()=>{
  const wrap=$('lshwrap');let drag=false,sx=0,sl=0;
  wrap.addEventListener('mousedown',e=>{drag=true;wrap.classList.add('drag');sx=e.pageX;sl=wrap.scrollLeft;});
  document.addEventListener('mouseup',()=>{drag=false;wrap.classList.remove('drag');});
  document.addEventListener('mousemove',e=>{if(!drag)return;wrap.scrollLeft=sl-(e.pageX-sx);syncLScroll();});
  wrap.addEventListener('scroll',syncLScroll);
  function syncLScroll(){document.querySelectorAll('.l-rs').forEach(r=>r.scrollLeft=wrap.scrollLeft);}
  window._syncLScroll=syncLScroll;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KANBAN VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let kMode='state',kExp=new Set();
const STATE_COLS=[{id:'overdue',label:'Overdue',dot:'var(--red)'},{id:'inprogress',label:'Active',dot:'var(--blue)'},{id:'soon',label:'Soon',dot:'var(--yellow)'},{id:'later',label:'Later',dot:'var(--muted)'},{id:'done',label:'Done',dot:'var(--green)'}];

document.querySelectorAll('[data-km]').forEach(btn=>{btn.onclick=()=>{document.querySelectorAll('[data-km]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');kMode=btn.dataset.km;renderKanban();};});

function renderKanban(){
  const board=$('board');const q=$('gSearch').value.toLowerCase();
  const tasks=PULSAR.getTasks().filter(t=>!q||[t.title,t.project,t.tags,t.category].some(v=>(v||'').toLowerCase().includes(q)));
  let cols;
  if(kMode==='state'){cols=STATE_COLS;}
  else{const cats=new Set();tasks.forEach(t=>t.category?cats.add(t.category):null);cols=[...[...cats].map(c=>({id:c,label:c,dot:'var(--accent-2)'})),{id:'_none',label:'Uncategorized',dot:'var(--muted)'}];}
  board.innerHTML='';
  cols.forEach(col=>{
    const kCol=kMode==='state'?col.id:'category';
    const colTasks=tasks.filter(t=>(kMode==='state'?PULSAR.derived(t).label:t.category||'_none')===col.id);
    const el=document.createElement('div');el.className='kcol';
    let html=`<div class="kcol-head"><div class="kdot" style="background:${col.dot}"></div><div class="kcol-title">${col.label}</div><div class="kcol-ct">${colTasks.length}</div></div><div class="kcol-body">`;
    if(!colTasks.length)html+=`<div class="kempty"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6"/></svg><p>No tasks</p></div>`;
    else colTasks.forEach(t=>html+=kCardHTML(t));
    html+=`</div>`;
    el.innerHTML=html;
    board.appendChild(el);
  });
  kBind();
}

function kCardHTML(t){
  const d=PULSAR.derived(t);const hasSubs=t.subtasks&&t.subtasks.length;const isExp=kExp.has(t.id);
  const done=hasSubs?t.subtasks.filter(s=>s.completed).length:0;
  const pct=hasSubs?Math.round(done/t.subtasks.length*100):0;
  let meta=`<span class="sp ${PULSAR.sCls(d.label,d.isUrgent)}">${PULSAR.sTxt(d.label,d.isUrgent)}</span>`;
  if(t.importance)meta+=`<span class="ib ${impCls(t.importance)}">${t.importance}</span>`;
  if(t.project)meta+=`<span class="mtag">${t.project}</span>`;
  const ds=t.dueDate?new Date(t.dueDate+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):null;
  let subsHTML='';
  if(hasSubs&&isExp){subsHTML='<div class="ksubs">';t.subtasks.forEach((s,i)=>{const sd=PULSAR.subDerived(s);subsHTML+=`<div class="ksubrow"><input type="checkbox" class="cb k-schk" data-parent="${t.id}" data-idx="${i}" ${s.completed?'checked':''}><span class="ksubnm${s.completed?' done':''}">${s.title}</span><span class="sp ${PULSAR.sCls(sd.label,sd.isUrgent)}">${PULSAR.sTxt(sd.label,sd.isUrgent)}</span></div>`;});subsHTML+='</div>';}
  return `<div class="kcard" data-id="${t.id}" style="border-left-color:${t.color}">
    <div class="kcard-top">
      <input type="checkbox" class="cb k-tchk" data-id="${t.id}" ${t.completed?'checked':''} style="margin-top:2px">
      <div class="kcard-body">
        <div class="ktrow">
          ${hasSubs?`<button class="kexpbtn${isExp?' open':''}" data-id="${t.id}"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></button>`:'<span style="width:15px"></span>'}
          <span class="kti">${t.icon}</span>
          <span class="ktn${t.completed?' done':''}">${t.title}</span>
        </div>
        <div class="kmeta">${meta}</div>
        ${ds?`<div class="kdate"><svg viewBox="0 0 24 24" width="9" height="9"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${ds}</div>`:''}
      </div>
    </div>
    ${hasSubs?`<div class="kfoot"><div class="progbar"><div class="progfill" style="width:${pct}%"></div></div><span class="proglbl">${done}/${t.subtasks.length}</span></div>`:''}
    ${subsHTML}
  </div>`;
}

function kBind(){
  document.querySelectorAll('.k-tchk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();PULSAR.toggleTask(parseInt(cb.dataset.id));});
  document.querySelectorAll('.k-schk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();PULSAR.toggleSub(parseInt(cb.dataset.parent),parseInt(cb.dataset.idx));});
  document.querySelectorAll('.kexpbtn').forEach(btn=>btn.onclick=e=>{e.stopPropagation();const id=parseInt(btn.dataset.id);kExp.has(id)?kExp.delete(id):kExp.add(id);renderKanban();});
  document.querySelectorAll('.kcard').forEach(card=>card.onclick=e=>{if(e.target.classList.contains('cb')||e.target.closest('.kexpbtn'))return;const t=PULSAR.getTasks().find(t=>t.id===parseInt(card.dataset.id));if(t)openModal(t);});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMELINE VIEW  (matches original architecture exactly)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TL_START=new Date('2026-01-01');TL_START.setHours(0,0,0,0);
const TOTAL_DAYS=120;
let DAY_W=96;
let translateX=0,isDragging=false,dragStartX=0;
const today=new Date();today.setHours(0,0,0,0);
const todayOffset=Math.floor((today-TL_START)/864e5);

function dateOff(ds){if(!ds)return null;return Math.floor((new Date(ds+'T00:00:00')-TL_START)/864e5);}
function isWeekend(i){const d=new Date(TL_START);d.setDate(d.getDate()+i);const w=d.getDay();return w===0||w===6;}
function darken(hex,p){const n=parseInt(hex.replace('#',''),16);const r=Math.max(0,Math.floor((n>>16)*(1-p)));const g=Math.max(0,Math.floor(((n>>8)&0xff)*(1-p)));const b=Math.max(0,Math.floor((n&0xff)*(1-p)));return'#'+((r<<16)|(g<<8)|b).toString(16).padStart(6,'0');}

function renderDaysHead(){
  const head=$('daysHead');head.innerHTML='';
  head.style.cssText=`position:absolute;top:0;left:0;height:100%;display:block;user-select:none;cursor:grab`;
  head.style.width=(TOTAL_DAYS*DAY_W)+'px';

  for(let i=0;i<TOTAL_DAYS;i++){
    const d=new Date(TL_START);d.setDate(d.getDate()+i);
    const isToday=i===todayOffset,isWE=isWeekend(i);
    const col=document.createElement('div');
    col.style.cssText=`position:absolute;left:${i*DAY_W}px;top:0;width:${DAY_W}px;height:100%;`
      +`display:flex;flex-direction:column;align-items:center;justify-content:center;`
      +`border-right:1px solid var(--border);box-sizing:border-box;`
      +`background:${isToday?'rgb(29,29,29)':'var(--bg-card)'}`;

    const yr=document.createElement('div');
    yr.style.cssText=`font-size:0.6875rem;color:var(--text-3);font-weight:300;font-family:var(--body)`;
    yr.textContent=d.getFullYear();

    const dt=document.createElement('div');
    dt.style.cssText=`font-family:var(--font);font-weight:500;font-size:0.8125rem;`
      +`color:${isToday?'var(--accent-2)':'var(--text-2)'}`;
    dt.textContent=d.toLocaleDateString('en-US',{month:'short',day:'2-digit'});

    col.appendChild(yr);
    col.appendChild(dt);
    head.appendChild(col);
  }
}

function createGridBg(numSubs){
  const ROW_H=56,SUB_H=46;
  const bg=document.createElement('div');
  bg.className='grid-bg';
  bg.style.width=(TOTAL_DAYS*DAY_W)+'px';
  bg.style.height=(ROW_H+numSubs*SUB_H)+'px';
  for(let i=0;i<TOTAL_DAYS;i++){
    const col=document.createElement('div');
    col.className='grid-day'+(i===todayOffset?' today':'');
    col.style.width=DAY_W+'px';
    col.style.flexShrink='0';
    bg.appendChild(col);
  }
  return bg;
}

function renderTasks(){
  const body=$('tlbody');body.innerHTML='';
  const q=$('gSearch').value.toLowerCase();
  const tasks=PULSAR.getTasks().filter(t=>!q||[t.title,t.project].some(v=>(v||'').toLowerCase().includes(q)));
  tasks.forEach(task=>{
    const d=PULSAR.derived(task);
    const hasSubs=task.subtasks&&task.subtasks.length;
    const numSubs=hasSubs?task.subtasks.length:0;
    const startOff=dateOff(task.startDate);
    const dueOff=dateOff(task.dueDate);
    const row=document.createElement('div');row.className='tl-row';

    // Label
    const label=document.createElement('div');label.className='tl-lbl';
    const titleRow=document.createElement('div');titleRow.className='tl-task-row';titleRow.style.borderLeftColor=task.color;
    const sc=PULSAR.sCls(d.label,d.isUrgent);
    titleRow.innerHTML=`<input type="checkbox" class="cb tl-tchk" data-id="${task.id}" ${task.completed?'checked':''}><span style="font-size:13px;flex-shrink:0">${task.icon}</span><span class="tlnm${task.completed?' done':''}">${task.title}</span><span class="sp ${sc}">${PULSAR.sTxt(d.label,d.isUrgent)}</span>`;
    titleRow.querySelector('.tl-tchk').onclick=e=>{e.stopPropagation();PULSAR.toggleTask(task.id);};
    titleRow.onclick=e=>{if(e.target.classList.contains('cb'))return;openModal(task);};
    label.appendChild(titleRow);
    if(hasSubs){
      task.subtasks.forEach((sub,idx)=>{
        const sd=PULSAR.subDerived(sub);
        const sRow=document.createElement('div');sRow.className='tl-sub-row';sRow.style.borderLeftColor=task.color;
        sRow.innerHTML=`<input type="checkbox" class="cb tl-schk" data-parent="${task.id}" data-idx="${idx}" ${sub.completed?'checked':''}><span class="tlsubnm${sub.completed?' done':''}">${sub.title}</span><span class="sp ${PULSAR.sCls(sd.label,sd.isUrgent)}">${PULSAR.sTxt(sd.label,sd.isUrgent)}</span>`;
        sRow.querySelector('.tl-schk').onclick=e=>{e.stopPropagation();PULSAR.toggleSub(task.id,idx);};
        sRow.onclick=e=>{if(e.target.classList.contains('cb'))return;openModal(task);requestAnimationFrame(()=>{document.querySelectorAll('.m-tab').forEach(tab=>tab.classList.toggle('active',tab.dataset.tab==='subtasks'));document.querySelectorAll('.m-tab-panel').forEach(p=>p.classList.toggle('active',p.id==='tab-subtasks'));openSubModal(idx);});};
        label.appendChild(sRow);
      });
    }

    // Grid â€” tl-grid is fixed clipping viewport, tl-inner scrolls
    const ROW_H=56, SUB_H=46;
    const grid=document.createElement('div');grid.className='tl-grid';
    const totalH=ROW_H+numSubs*SUB_H;
    const inner=document.createElement('div');inner.className='tl-inner';
    inner.style.width=(TOTAL_DAYS*DAY_W)+'px';
    inner.style.height=totalH+'px';
    inner.appendChild(createGridBg(numSubs));

    // â”€â”€ Main task bar â€” explicit top + height so it always renders â”€â”€
    if(startOff!==null&&dueOff!==null&&startOff<TOTAL_DAYS&&dueOff>=0){
      const s=Math.max(0,startOff),e=Math.min(TOTAL_DAYS-1,dueOff);
      const bw=(e-s+1)*DAY_W-8;
      if(bw>0){
        const barH=ROW_H-8; // 4px inset top and bottom
        const bar=document.createElement('div');
        bar.className='tl-bar'+(task.completed?' done-bar':'');
        bar.style.cssText=`left:${s*DAY_W+4}px;width:${bw}px;top:4px;height:${barH}px;background:${task.color}`;
        bar.onclick=()=>openModal(task);
        inner.appendChild(bar);
      }
    }

    // â”€â”€ Main bar â€” top row only, not spanning subtasks â”€â”€
    if(startOff!==null&&dueOff!==null&&startOff<TOTAL_DAYS&&dueOff>=0){
      const s=Math.max(0,startOff),e=Math.min(TOTAL_DAYS-1,dueOff);
      const bw=(e-s+1)*DAY_W-8;
      if(bw>0){
        const bar=document.createElement('div');
        bar.className='tl-bar'+(task.completed?' done-bar':'');
        bar.style.cssText=`left:${s*DAY_W+4}px;width:${bw}px;top:4px;height:${ROW_H-8}px;background:${task.color}`;
        bar.onclick=()=>openModal(task);
        inner.appendChild(bar);
      }
    }

    // â”€â”€ Subtask section â€” dark inset "dropdown" panel behind bars â”€â”€
    if(hasSubs&&startOff!==null){
      // dark inset bg spanning the full subtask area width of the parent
      const ps=Math.max(0,startOff),pe=Math.min(TOTAL_DAYS-1,dueOff??startOff);
      const panelW=(pe-ps+1)*DAY_W-8;
      // dark panel starts at same top as main bar, uses darkened task color, no transparency
      const darken=(hex,p)=>{const n=parseInt(hex.replace('#',''),16);const r=Math.max(0,Math.floor((n>>16)*(1-p)));const g=Math.max(0,Math.floor(((n>>8)&0xff)*(1-p)));const b=Math.max(0,Math.floor((n&0xff)*(1-p)));return'#'+((r<<16)|(g<<8)|b).toString(16).padStart(6,'0');};
      if(panelW>0){
        const panel=document.createElement('div');
        panel.style.cssText=`position:absolute;left:${ps*DAY_W+4}px;width:${panelW}px;`
          +`top:4px;height:${ROW_H-8+numSubs*SUB_H}px;`
          +`background:${darken(task.color,0.72)};border-radius:4px;pointer-events:none;z-index:1`;
        inner.appendChild(panel);
      }

      task.subtasks.forEach((sub,idx)=>{
        const sOff=dateOff(sub.startDate)??startOff;
        const dOff=dateOff(sub.dueDate);if(dOff===null)return;
        const s=Math.max(0,sOff),e=Math.min(TOTAL_DAYS-1,dOff);
        const bw=(e-s+1)*DAY_W-16;if(bw<=0)return;
        const bar=document.createElement('div');
        bar.className='tl-sub-bar'+(sub.completed?' done-bar':'');
        bar.style.cssText=`left:${s*DAY_W+8}px;width:${bw}px;`
          +`top:${ROW_H+idx*SUB_H+6}px;height:28px;`
          +`background:${task.color};opacity:${sub.completed?0.45:1};z-index:2`;
        bar.onclick=()=>openModal(task);
        inner.appendChild(bar);
      });
    }

    // â”€â”€ Today overlay â€” purple tint over everything â”€â”€
    if(todayOffset>=0&&todayOffset<TOTAL_DAYS){
      const overlay=document.createElement('div');
      overlay.style.cssText=`position:absolute;top:0;left:${todayOffset*DAY_W}px;width:${DAY_W}px;height:100%;`
        +`background:rgba(124,92,252,0.12);pointer-events:none;z-index:3`;
      inner.appendChild(overlay);
    }

    grid.style.minHeight=totalH+'px';
    row.style.height=totalH+'px';
    grid.appendChild(inner);
    row.appendChild(label);row.appendChild(grid);
    body.appendChild(row);
  });
  syncTL();
}

function syncTL(){
  const totalW=TOTAL_DAYS*DAY_W;
  const wrapW=document.querySelector('.days-wrap')?.offsetWidth||800;
  const minT=-(totalW-wrapW);
  translateX=Math.max(minT,Math.min(0,translateX));
  $('daysHead').style.transform=`translateX(${translateX}px)`;
  document.querySelectorAll('.tl-inner').forEach(inner=>{inner.style.transform=`translateX(${translateX}px)`;});
}

function renderTL(){renderDaysHead();renderTasks();}

const daysHead=$('daysHead');
// Drag â€” both the days header and the grid body move together
function tlStartDrag(e){isDragging=true;dragStartX=e.pageX;document.body.style.userSelect='none';}
function tlEndDrag(){isDragging=false;document.body.style.userSelect='';}
daysHead.addEventListener('mousedown',tlStartDrag);
$('tlbody').addEventListener('mousedown',e=>{if(e.target.closest('.tl-lbl'))return;tlStartDrag(e);});
document.addEventListener('mouseup',tlEndDrag);
document.addEventListener('mousemove',e=>{if(!isDragging)return;translateX+=e.pageX-dragStartX;dragStartX=e.pageX;syncTL();});

function tlScrollToday(){
  const wrap=document.querySelector('.days-wrap');if(!wrap)return;
  const cw=wrap.offsetWidth;
  translateX=-(todayOffset*DAY_W-cw/2+DAY_W/2);
  syncTL();
}
$('goToday').onclick=tlScrollToday;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _cur=null,_isNew=false;

// tabs
document.querySelectorAll('.m-tab').forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll('.m-tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.m-tab-panel').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-'+tab.dataset.tab).classList.add('active');
  };
});

// live color dot + icon preview
$('mColor').oninput=()=>$('mHeadColor').style.background=$('mColor').value;
$('mIcon').oninput=()=>$('mIconDisplay').textContent=$('mIcon').value||'ğŸ“‹';

function closeModal(){$('moverlay').classList.remove('open');_cur=null;}
$('mClose').onclick=closeModal;$('mCancel').onclick=closeModal;
$('moverlay').onclick=e=>{if(e.target===$('moverlay'))closeModal();};
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeModal();closeSubModal();}});

function renderSubList(){
  const list=$('mSubList');
  if(!_cur?.subtasks||!_cur.subtasks.length){list.innerHTML='<p style="font-size:11px;color:var(--text-3);padding:4px 0">No subtasks yet</p>';return;}
  list.innerHTML='';
  _cur.subtasks.forEach((s,i)=>{
    const row=document.createElement('div');row.className='sub-item';
    row.innerHTML=`
      <input type="checkbox" style="accent-color:var(--accent);flex-shrink:0" ${s.completed?'checked':''}>
      <span class="sub-item-title${s.completed?' done':''}">${s.title||'Untitled'}</span>
      <span class="sub-item-date">${s.dueDate?fmtDate(s.dueDate):''}</span>
      <button class="sub-del"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
    row.querySelector('input').onchange=e=>{e.stopPropagation();s.completed=!s.completed;renderSubList();};
    row.querySelector('.sub-del').onclick=e=>{e.stopPropagation();_cur.subtasks.splice(i,1);if(!_cur.subtasks.length)_cur.subtasks=null;renderSubList();};
    row.onclick=e=>{if(e.target.tagName==='INPUT'||e.target.closest('.sub-del'))return;openSubModal(i);};
    list.appendChild(row);
  });
}

['mSubT','mSubS','mSubD'].forEach(id=>$(id).oninput=()=>$('mAddSub').disabled=!$('mSubT').value.trim());
$('mAddSub').onclick=()=>{
  const title=$('mSubT').value.trim();if(!title)return;
  if(!_cur.subtasks)_cur.subtasks=[];
  _cur.subtasks.push(PULSAR.createSub({title,startDate:$('mSubS').value,dueDate:$('mSubD').value}));
  $('mSubT').value='';$('mSubS').value='';$('mSubD').value='';$('mAddSub').disabled=true;
  renderSubList();
};

function genInsight(t){
  const d=PULSAR.derived(t);let msg='';
  if(d.label==='overdue')msg=`<strong>âš  Overdue:</strong> ${Math.abs(d.daysUntilDue)} day${Math.abs(d.daysUntilDue)>1?'s':''} past due.`;
  else if(t.blockReason)msg=`<strong>ğŸš« Blocked:</strong> "${t.blockReason}"`;
  else if(t.dependencies)msg=`<strong>ğŸ”— Depends on:</strong> [${t.dependencies}]`;
  else if(d.isUrgent&&t.importance==='critical')msg=`<strong>âš¡ Critical & urgent</strong> â€” due ${d.daysUntilDue===0?'today':'tomorrow'}.`;
  else if(t.subtasks?.length){const dn=t.subtasks.filter(s=>s.completed).length;msg=`<strong>ğŸ“Š Progress:</strong> ${dn}/${t.subtasks.length} subtasks (${Math.round(dn/t.subtasks.length*100)}%)`;}
  const el=$('mInsight');
  if(msg){$('mInsightText').innerHTML=msg;el.style.display='flex';}else el.style.display='none';
}

function openModal(taskOrNull){
  _isNew=!taskOrNull||!PULSAR.getTasks().find(t=>t.id===taskOrNull?.id);
  if(_isNew){const t0=new Date().toISOString().split('T')[0],t1=new Date(Date.now()+864e5).toISOString().split('T')[0];_cur=PULSAR.createTask(taskOrNull||{startDate:t0,dueDate:t1});}
  else _cur=taskOrNull;
  // reset tabs
  document.querySelectorAll('.m-tab').forEach((t,i)=>t.classList.toggle('active',i===0));
  document.querySelectorAll('.m-tab-panel').forEach((p,i)=>p.classList.toggle('active',i===0));
  $('mTitle').textContent=_isNew?'New Task':'Edit Task';
  $('mFTitle').value=_cur.title;
  $('mIcon').value=_cur.icon||'ğŸ“‹';$('mIconDisplay').textContent=_cur.icon||'ğŸ“‹';
  $('mColor').value=_cur.color||'#7c5cfc';$('mHeadColor').style.background=_cur.color||'#7c5cfc';
  $('mProject').value=_cur.project||'';$('mCat').value=_cur.category||'';$('mTags').value=_cur.tags||'';
  $('mLink').value=_cur.projectLink||'';
  $('mStart').value=_cur.startDate||'';$('mDue').value=_cur.dueDate||'';$('mDueTime').value=_cur.dueTime||'';
  $('mEst').value=_cur.estimate||'';$('mRec').value=_cur.recurrence||'';
  $('mImportance').value=_cur.importance||'';$('mImpact').value=_cur.impactScore||'';
  $('mEnergy').value=_cur.energyMode||'';$('mFocus').checked=_cur.focusEligible;
  $('mNotes').value=_cur.notes||'';$('mDeps').value=_cur.dependencies||'';$('mBlock').value=_cur.blockReason||'';
  $('mSubT').value='';$('mSubS').value='';$('mSubD').value='';$('mAddSub').disabled=true;
  renderSubList();genInsight(_cur);
  $('moverlay').classList.add('open');
}

$('mSave').onclick=()=>{
  if(!_cur)return;
  const u={title:$('mFTitle').value.trim()||'Untitled',project:$('mProject').value,icon:$('mIcon').value||'ğŸ“‹',color:$('mColor').value,category:$('mCat').value,tags:$('mTags').value,startDate:$('mStart').value,dueDate:$('mDue').value,dueTime:$('mDueTime').value,estimate:parseFloat($('mEst').value)||0,recurrence:$('mRec').value,projectLink:$('mLink').value,importance:$('mImportance').value,impactScore:parseInt($('mImpact').value)||0,energyMode:$('mEnergy').value,focusEligible:$('mFocus').checked,notes:$('mNotes').value,dependencies:$('mDeps').value,blockReason:$('mBlock').value,subtasks:_cur.subtasks};
  if(_isNew){Object.assign(_cur,u);PULSAR.addTask(_cur);}else PULSAR.updateTask(_cur.id,u);
  closeModal();
};
$('mDelete').onclick=()=>{if(!_cur||_isNew)return;if(!confirm('Delete this task?'))return;PULSAR.deleteTask(_cur.id);closeModal();};
$('mDup').onclick=()=>{if(!_cur)return;if(!_isNew)PULSAR.duplicateTask(_cur.id);closeModal();};

/* â”€â”€ Subtask modal â”€â”€ */
let _subIdx=null;
function closeSubModal(){$('soverlay').classList.remove('open');_subIdx=null;}
$('sClose').onclick=closeSubModal;$('sCancel').onclick=closeSubModal;
$('soverlay').onclick=e=>{if(e.target===$('soverlay'))closeSubModal();};

function openSubModal(idx){
  if(!_cur?.subtasks?.[idx])return;
  _subIdx=idx;const s=_cur.subtasks[idx];
  $('sHeadColor').style.background=_cur.color||'#7c5cfc';
  $('sTitle').textContent='Subtask';
  $('sFTitle').value=s.title||'';
  $('sStart').value=s.startDate||'';$('sDue').value=s.dueDate||'';
  $('sImportance').value=s.importance||'';$('sImpact').value=s.impactScore||'';
  $('sCompleted').checked=s.completed||false;
  $('soverlay').classList.add('open');
}
$('sSave').onclick=()=>{
  if(_subIdx===null||!_cur?.subtasks)return;
  const s=_cur.subtasks[_subIdx];
  s.title=$('sFTitle').value.trim()||'Untitled';
  s.startDate=$('sStart').value;s.dueDate=$('sDue').value;
  s.importance=$('sImportance').value;s.impactScore=parseInt($('sImpact').value)||0;
  s.completed=$('sCompleted').checked;
  closeSubModal();renderSubList();
};
$('sDelete').onclick=()=>{
  if(_subIdx===null||!_cur?.subtasks)return;
  _cur.subtasks.splice(_subIdx,1);if(!_cur.subtasks.length)_cur.subtasks=null;
  closeSubModal();renderSubList();
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
PULSAR.subscribe(()=>{renderList();renderKanban();if(activeView==='timeline'||true)renderTL();});
renderList();renderKanban();renderTL();
setTimeout(()=>{tlScrollToday();if(window._syncLScroll)window._syncLScroll();},80);
</script>
</body>
</html>