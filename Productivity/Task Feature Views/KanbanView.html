<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pulsar Kanban View</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg-app:#0f0f0f;--bg-panel:#161616;--bg-card:#1a1a1a;--bg-hover:#242424;--bg-active:#2a2a2a;
--text-primary:#e8e8e8;--text-secondary:#a0a0a0;--text-muted:#606060;
--border:#2a2a2a;--border-subtle:#222;--accent:#3b82f6;--accent-dim:#1e3a5f;
--success:#22c55e;--success-bg:#0d2818;--warning:#f59e0b;--warning-bg:#2b1d0a;
--error:#ef4444;--error-bg:#2a0f0f;--inprogress:#3b82f6;--inprogress-bg:#0f1a2a;
--urgent:#f97316;--urgent-bg:#2b150a;--later:#606060;--later-bg:#1a1a1a;
--font-display:'Space Grotesk',sans-serif;--font-body:'Inter',sans-serif;
--trans:140ms ease-out;
}
html,body{height:100%}
body{background:var(--bg-app);color:var(--text-primary);font-family:var(--font-body);font-size:13px;line-height:1.5}
.app{display:flex;flex-direction:column;height:100%;max-width:1920px;margin:0 auto;padding:20px 24px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-shrink:0}
h1{font-family:var(--font-display);font-weight:700;font-size:1.5rem;color:var(--text-primary)}
.toolbar{display:flex;gap:8px;align-items:center}
.search-box{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:8px 14px;color:var(--text-primary);width:240px;font-size:13px}
.search-box:focus{outline:none;border-color:var(--accent)}
.search-box::placeholder{color:var(--text-muted)}
.btn{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:8px 16px;color:var(--text-secondary);font-size:12px;font-weight:500;cursor:pointer;transition:all var(--trans);display:flex;align-items:center;gap:6px}
.btn:hover{background:var(--bg-hover);color:var(--text-primary);border-color:#333}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-primary:hover{background:#2563eb;border-color:#2563eb}
.btn-active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
.btn svg{width:14px;height:14px;stroke:currentColor;stroke-width:2}
.kanban-container{flex:1;display:flex;gap:16px;overflow-x:auto;padding-bottom:8px;min-height:0}
.kanban-container::-webkit-scrollbar{height:8px}
.kanban-container::-webkit-scrollbar-track{background:var(--bg-panel);border-radius:4px}
.kanban-container::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.kanban-container::-webkit-scrollbar-thumb:hover{background:#444}
.kanban-column{width:320px;min-width:320px;max-width:320px;flex-shrink:0;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;max-height:100%}
.column-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.column-title{display:flex;align-items:center;gap:10px;flex:1}
.column-title-text{font-family:var(--font-display);font-weight:600;font-size:13px;color:var(--text-primary);background:transparent;border:none;outline:none;padding:2px 4px;border-radius:4px;transition:background var(--trans);flex:1;min-width:0}
.column-title-text:hover{background:var(--bg-hover)}
.column-title-text:focus{background:var(--bg-active);color:var(--text-primary)}
.column-count{background:var(--bg-active);color:var(--text-secondary);font-size:11px;font-weight:600;padding:2px 8px;border-radius:10px;margin-left:auto;flex-shrink:0}
.column-body{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.column-body::-webkit-scrollbar{width:6px}
.column-body::-webkit-scrollbar-track{background:transparent}
.column-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.task-card{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all var(--trans);position:relative}
.task-card:hover{border-color:#444;background:var(--bg-hover)}
.task-card-header{display:flex;align-items:flex-start;gap:10px;padding:12px;border-left:3px solid var(--accent);border-radius:6px 0 0 0}
.task-card-check{flex-shrink:0;margin-top:2px}
.checkbox{width:16px;height:16px;border:2px solid var(--border);border-radius:4px;cursor:pointer;appearance:none;background:transparent;transition:all var(--trans);flex-shrink:0}
.checkbox:checked{background:var(--accent);border-color:var(--accent)}
.checkbox:checked::after{content:'‚úì';display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700;height:100%}
.checkbox:hover{border-color:var(--text-secondary)}
.task-card-content{flex:1;min-width:0;overflow:hidden}
.task-card-title-row{display:flex;align-items:center;gap:8px;margin-bottom:4px;min-width:0;max-width:100%}
.task-icon{font-size:14px;flex-shrink:0}
.task-name{font-family:var(--font-display);font-weight:500;font-size:13px;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
.task-name.completed{text-decoration:line-through;color:var(--text-muted);opacity:0.7}
.task-card-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.meta-tag{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:500;background:var(--bg-active);color:var(--text-secondary)}
.status-pill{padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600;white-space:nowrap}
.status-overdue{background:var(--error-bg);color:var(--error);border:1px solid var(--error)}
.status-done{background:var(--success-bg);color:var(--success);border:1px solid var(--success)}
.status-inprogress{background:var(--inprogress-bg);color:var(--inprogress);border:1px solid var(--inprogress)}
.status-urgent{background:var(--urgent-bg);color:var(--urgent);border:1px solid var(--urgent)}
.status-soon{background:var(--warning-bg);color:var(--warning);border:1px solid var(--warning)}
.status-later{background:var(--later-bg);color:var(--later);border:1px solid #444}
.importance-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:600}
.imp-critical{background:rgba(239,68,68,0.15);color:var(--error)}
.imp-high{background:rgba(249,115,22,0.15);color:var(--urgent)}
.imp-medium{background:rgba(245,158,11,0.15);color:var(--warning)}
.imp-low{background:rgba(34,197,94,0.15);color:var(--success)}
.task-card-date{font-size:11px;color:var(--text-muted);margin-top:8px;display:flex;align-items:center;gap:4px}
.task-card-date svg{width:12px;height:12px;stroke:currentColor}
.expand-btn{width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;border-radius:4px;transition:all var(--trans);background:transparent;border:none;color:var(--text-muted)}
.expand-btn:hover{background:var(--bg-active);color:var(--text-primary)}
.expand-btn svg{width:12px;height:12px;stroke:currentColor;stroke-width:2;transition:transform var(--trans)}
.expand-btn.expanded svg{transform:rotate(90deg)}
.subtasks-container{border-top:1px solid var(--border-subtle);padding:8px 12px;background:var(--bg-panel)}
.subtask-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border-subtle)}
.subtask-item:last-child{border-bottom:none}
.subtask-name{flex:1;font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.subtask-name.completed{text-decoration:line-through;color:var(--text-muted)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--bg-panel);border:1px solid var(--border);border-radius:12px;width:95%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-header h2{font-family:var(--font-display);font-weight:600;font-size:1.125rem;color:var(--text-primary)}
.close-btn{width:30px;height:30px;display:flex;align-items:center;justify-content:center;background:var(--bg-hover);border:none;border-radius:6px;cursor:pointer;transition:background var(--trans)}
.close-btn:hover{background:var(--bg-active)}
.close-btn svg{width:14px;height:14px;stroke:var(--text-secondary);stroke-width:2}
.modal-body{flex:1;overflow-y:auto;padding:24px}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;padding:18px 24px;border-top:1px solid var(--border);flex-shrink:0}
.form-section{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border-subtle)}
.form-section:last-child{margin-bottom:0;border-bottom:none;padding-bottom:0}
.section-label{font-family:var(--font-display);font-weight:600;font-size:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.form-row{display:grid;gap:14px;margin-bottom:14px}
.form-row:last-child{margin-bottom:0}
.form-row.cols-2{grid-template-columns:1fr 1fr}
.form-row.cols-3{grid-template-columns:1fr 1fr 1fr}
.form-row.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-size:11px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.field input,.field select,.field textarea{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:9px 12px;color:var(--text-primary);font-size:13px;transition:border-color var(--trans);font-family:var(--font-body)}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--accent);background:var(--bg-hover)}
.field input::placeholder,.field textarea::placeholder{color:var(--text-muted)}
.field textarea{resize:vertical;min-height:90px;line-height:1.6}
.field input[type="color"]{padding:3px;height:40px;cursor:pointer}
.checkbox-row{display:flex;align-items:center;gap:10px;padding:8px 0}
.checkbox-row span{font-size:13px;color:var(--text-secondary)}
.subtask-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:14px}
.subtask-add-row{display:grid;grid-template-columns:1fr 110px 110px auto;gap:10px;align-items:end}
.subtask-add-row input{padding:8px 10px;font-size:12px}
.subtask-add-row .btn{padding:8px 12px;font-size:11px}
.subtask-list{margin-top:14px;display:flex;flex-direction:column;gap:8px}
.subtask-modal-item{display:grid;grid-template-columns:22px 1fr 100px 100px 80px 80px 60px 30px;gap:10px;align-items:center;padding:10px;background:var(--bg-panel);border-radius:6px;border:1px solid var(--border-subtle)}
.subtask-modal-item input[type="text"]{background:transparent;border:none;color:var(--text-primary);font-size:12px;padding:0}
.subtask-modal-item input[type="text"]:focus{outline:none}
.subtask-modal-item input[type="date"],.subtask-modal-item select{padding:5px 7px;font-size:11px}
.subtask-del{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:4px;cursor:pointer;color:var(--text-muted);transition:all var(--trans)}
.subtask-del:hover{background:var(--error-bg);color:var(--error)}
.btn-danger{background:var(--error);border-color:var(--error);color:#fff}
.btn-danger:hover{background:#dc2626;border-color:#dc2626}
.btn-success{background:var(--success);border-color:var(--success);color:#fff}
.btn-success:hover{background:#16a34a;border-color:#16a34a}
.ai-insight{background:var(--accent-dim);border:1px solid var(--accent);border-radius:8px;padding:12px 14px;margin-top:14px;display:flex;align-items:flex-start;gap:12px}
.ai-insight svg{width:18px;height:18px;stroke:var(--accent);flex-shrink:0;margin-top:2px}
.ai-insight-text{font-size:12px;color:var(--text-secondary);line-height:1.6}
.ai-insight-text strong{color:var(--accent);font-weight:600}
.view-toggle{display:flex;gap:4px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:4px}
.view-toggle-btn{background:transparent;border:none;padding:6px 12px;font-size:11px;font-weight:500;color:var(--text-muted);cursor:pointer;border-radius:4px;transition:all var(--trans)}
.view-toggle-btn:hover{color:var(--text-secondary)}
.view-toggle-btn.active{background:var(--accent);color:#fff}
.empty-column{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;color:var(--text-muted);text-align:center}
.empty-column svg{width:40px;height:40px;stroke:var(--text-muted);stroke-width:1;margin-bottom:12px;opacity:0.5}
.empty-column p{font-size:12px}
</style>
</head>
<body>
<div class="app">
<header>
<h1>Kanban View</h1>
<div class="toolbar">
<input type="text" class="search-box" id="searchBox" placeholder="Search tasks...">
<div class="view-toggle">
<button class="view-toggle-btn active" data-mode="state">By State</button>
<button class="view-toggle-btn" data-mode="category">By Category</button>
</div>
<button class="btn btn-primary" id="addTaskBtn"><svg viewBox="0 0 24 24" fill="none"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Task</button>
</div>
</header>
<div class="kanban-container" id="kanbanContainer"></div>
</div>
<div class="modal-overlay" id="taskModal">
<div class="modal">
<div class="modal-header">
<h2 id="modalTitle">Task Details</h2>
<button class="close-btn" id="modalClose"><svg viewBox="0 0 24 24" fill="none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
</div>
<div class="modal-body">
<div class="form-section">
<div class="section-label">üß© Identity</div>
<div class="form-row cols-2">
<div class="field"><label>Title</label><input type="text" id="mTitle"></div>
<div class="field"><label>Project</label><input type="text" id="mProject"></div>
</div>
<div class="form-row cols-4">
<div class="field"><label>Icon</label><input type="text" id="mIcon" maxlength="2" style="text-align:center;font-size:18px"></div>
<div class="field"><label>Color</label><input type="color" id="mColor"></div>
<div class="field"><label>Category</label><input type="text" id="mCategory"></div>
<div class="field"><label>Tags</label><input type="text" id="mTags" placeholder="comma separated"></div>
</div>
</div>
<div class="form-section">
<div class="section-label">üìÖ Schedule & Planning</div>
<div class="form-row cols-4">
<div class="field"><label>Start Date</label><input type="date" id="mStartDate"></div>
<div class="field"><label>Due Date</label><input type="date" id="mDueDate"></div>
<div class="field"><label>Start Time</label><input type="time" id="mStartTime"></div>
<div class="field"><label>Due Time</label><input type="time" id="mDueTime"></div>
</div>
<div class="form-row cols-3">
<div class="field"><label>Recurrence</label>
<select id="mRecurrence"><option value="">None</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option></select>
</div>
<div class="field"><label>Time Estimate (hrs)</label><input type="number" id="mEstimate" min="0" step="0.5"></div>
<div class="field"><label>Project Link</label><input type="url" id="mLink" placeholder="https://..."></div>
</div>
</div>
<div class="form-section">
<div class="section-label">üéØ Priority & Impact</div>
<div class="form-row cols-3">
<div class="field"><label>Importance</label>
<select id="mImportance"><option value="">Select</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select>
</div>
<div class="field"><label>Impact Score (1-10)</label><input type="number" id="mImpact" min="1" max="10"></div>
<div class="field"><label>Energy Required</label>
<select id="mEnergy"><option value="">Select</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select>
</div>
</div>
<div class="checkbox-row"><input type="checkbox" class="checkbox" id="mFocus"><span>Focus Eligible</span></div>
<div class="ai-insight" id="aiInsight" style="display:none">
<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
<div class="ai-insight-text" id="aiInsightText"></div>
</div>
</div>
<div class="form-section">
<div class="section-label">üìù Content & Context</div>
<div class="field"><label>Notes</label><textarea id="mNotes" placeholder="Task description, context, and notes..."></textarea></div>
<div class="form-row cols-2">
<div class="field"><label>Linked Docs</label><input type="text" id="mLinkedDocs" placeholder="Document URLs..."></div>
<div class="field"><label>Web Clips</label><input type="url" id="mWebClips"></div>
</div>
</div>
<div class="form-section">
<div class="section-label">üîÑ Dependencies & Blockers</div>
<div class="form-row cols-2">
<div class="field"><label>Depends On (Task IDs)</label><input type="text" id="mDeps" placeholder="1, 2, 3..."></div>
<div class="field"><label>Block Reason</label><input type="text" id="mBlock" placeholder="Why is this blocked?"></div>
</div>
</div>
<div class="form-section">
<div class="section-label">üß† Subtasks</div>
<div class="subtask-panel">
<div class="subtask-add-row">
<div class="field"><label>Title</label><input type="text" id="subTitle" placeholder="Subtask name"></div>
<div class="field"><label>Start</label><input type="date" id="subStart"></div>
<div class="field"><label>Due</label><input type="date" id="subDue"></div>
<button class="btn btn-primary" id="addSubBtn" disabled>Add</button>
</div>
<div class="subtask-list" id="subtaskList"></div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-danger" id="deleteBtn">Delete</button>
<button class="btn btn-success" id="duplicateBtn">Duplicate</button>
<button class="btn" id="cancelBtn">Cancel</button>
<button class="btn btn-primary" id="saveBtn">Save Changes</button>
</div>
</div>
</div>
<script>
const CONFIG={startDate:new Date('2026-01-01')};
let tasks=[],currentTask=null,nextId=1,viewMode='state',expandedTasks=new Set(),columnNames={later:'Later',inprogress:'In Progress',soon:'Soon',overdue:'Overdue',done:'Done'};

function createTask(p={}){
const now=new Date().toISOString();
return{id:p.id||nextId++,title:p.title||'',icon:p.icon||'üìã',color:p.color||'#3b82f6',project:p.project||'',category:p.category||'',tags:p.tags||'',startDate:p.startDate||'',dueDate:p.dueDate||'',startTime:p.startTime||'',dueTime:p.dueTime||'',recurrence:p.recurrence||'',estimate:p.estimate||0,projectLink:p.projectLink||'',importance:p.importance||'',impactScore:p.impactScore||0,energyMode:p.energyMode||'',focusEligible:p.focusEligible!==undefined?p.focusEligible:true,notes:p.notes||'',linkedDocs:p.linkedDocs||'',webClips:p.webClips||'',dependencies:p.dependencies||'',blockReason:p.blockReason||'',completed:p.completed||false,subtasks:p.subtasks||null,system:{createdAt:p.system?.createdAt||now,lastModified:now,completedAt:p.system?.completedAt||null,version:p.system?.version||1,autoPriorityWeight:0}};
}

function createSubtask(p={}){
return{title:p.title||'',startDate:p.startDate||'',dueDate:p.dueDate||'',importance:p.importance||'',impactScore:p.impactScore||0,completed:p.completed||false};
}

function computeDerived(task){
const today=new Date();today.setHours(0,0,0,0);
const dueDate=task.dueDate?new Date(task.dueDate+'T00:00:00'):null;
const startDate=task.startDate?new Date(task.startDate+'T00:00:00'):null;
if(!dueDate)return{label:'later',urgencyScore:0,isUrgent:false,daysUntilDue:null};
const daysUntilDue=Math.floor((dueDate-today)/(864e5));
const daysUntilStart=startDate?Math.floor((startDate-today)/(864e5)):daysUntilDue;
const isOverdue=daysUntilDue<0&&!task.completed;
const isInProgress=daysUntilStart<=0&&daysUntilDue>=0&&!task.completed;
let urgencyScore=daysUntilDue<=0?10:daysUntilDue<=1?9:daysUntilDue<=3?7:daysUntilDue<=7?5:daysUntilDue<=14?3:1;
const impMap={low:2,medium:5,high:8,critical:10};
const impScore=impMap[task.importance]||0;
task.system.autoPriorityWeight=impScore*0.4+(task.impactScore||0)*0.3+urgencyScore*0.3;
let label='later',isUrgent=false;
if(task.completed)label='done';
else if(isOverdue)label='overdue';
else if(daysUntilDue<=1)label='soon';
else if(isInProgress){label='inprogress';isUrgent=daysUntilDue<=1;}
else if(daysUntilDue<=3)label='soon';
return{label,urgencyScore,isUrgent,daysUntilDue};
}

function getSubtaskState(sub){
if(sub.completed)return{label:'done',isUrgent:false};
if(!sub.dueDate)return{label:'later',isUrgent:false};
const today=new Date();today.setHours(0,0,0,0);
const dueDate=new Date(sub.dueDate+'T00:00:00');
const startDate=sub.startDate?new Date(sub.startDate+'T00:00:00'):null;
const daysUntil=Math.floor((dueDate-today)/(864e5));
const daysUntilStart=startDate?Math.floor((startDate-today)/(864e5)):daysUntil;
if(daysUntil<0)return{label:'overdue',isUrgent:false};
if(daysUntilStart<=0&&daysUntil>=0)return{label:'inprogress',isUrgent:daysUntil<=1};
if(daysUntil<=3)return{label:'soon',isUrgent:false};
return{label:'later',isUrgent:false};
}

function statusClass(label,isUrgent){
if(label==='overdue')return'status-overdue';
if(label==='done')return'status-done';
if(label==='inprogress')return isUrgent?'status-urgent':'status-inprogress';
if(label==='soon')return'status-soon';
return'status-later';
}

function statusText(label,isUrgent){
if(label==='overdue')return'Overdue';
if(label==='done')return'Done';
if(label==='inprogress')return isUrgent?'Urgent':'Active';
if(label==='soon')return'Soon';
return'Later';
}

function importanceClass(imp){
if(imp==='critical')return'imp-critical';
if(imp==='high')return'imp-high';
if(imp==='medium')return'imp-medium';
if(imp==='low')return'imp-low';
return'';
}

function formatDate(d){
if(!d)return'';
const date=new Date(d+'T00:00:00');
return date.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}

function searchTasks(arr,q){
if(!q)return arr;
const lq=q.toLowerCase();
return arr.filter(t=>t.title.toLowerCase().includes(lq)||(t.project||'').toLowerCase().includes(lq)||(t.tags||'').toLowerCase().includes(lq)||(t.category||'').toLowerCase().includes(lq));
}

function getColumns(){
if(viewMode==='state'){
return[{id:'later',title:columnNames.later},{id:'inprogress',title:columnNames.inprogress},{id:'soon',title:columnNames.soon},{id:'overdue',title:columnNames.overdue},{id:'done',title:columnNames.done}];
}else{
const cats=new Set();
tasks.forEach(t=>{if(t.category)cats.add(t.category);});
const cols=[...cats].map(c=>({id:'cat_'+c,title:c}));
cols.push({id:'cat_uncategorized',title:'Uncategorized'});
return cols;
}
}

function getTaskColumn(task){
if(viewMode==='state'){
const d=computeDerived(task);
return d.label;
}else{
return task.category?'cat_'+task.category:'cat_uncategorized';
}
}

function render(){
const container=document.getElementById('kanbanContainer');
const query=document.getElementById('searchBox').value;
let filtered=searchTasks(tasks,query);
const columns=getColumns();
container.innerHTML='';
columns.forEach(col=>{
const colTasks=filtered.filter(t=>getTaskColumn(t)===col.id);
const colEl=document.createElement('div');
colEl.className='kanban-column';
colEl.dataset.column=col.id;
colEl.innerHTML=`<div class="column-header"><div class="column-title"><input type="text" class="column-title-text" value="${col.title}" data-col="${col.id}"></div><span class="column-count">${colTasks.length}</span></div><div class="column-body" data-column="${col.id}"></div>`;
const body=colEl.querySelector('.column-body');
if(colTasks.length===0){
const empty=document.createElement('div');
empty.className='empty-column';
empty.innerHTML=`<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg><p>No tasks</p>`;
body.insertBefore(empty,body.firstChild);
}else{
colTasks.forEach(task=>{
const card=createTaskCard(task);
body.appendChild(card);
});
}
container.appendChild(colEl);
});
bindColumnEvents();
}

function createTaskCard(task){
const d=computeDerived(task);
const hasSubtasks=task.subtasks&&task.subtasks.length>0;
const isExpanded=expandedTasks.has(task.id);
const card=document.createElement('div');
card.className='task-card';
card.dataset.id=task.id;
let html=`<div class="task-card-header" style="border-left-color:${task.color}"><div class="task-card-check"><input type="checkbox" class="checkbox task-check"${task.completed?' checked':''}></div><div class="task-card-content"><div class="task-card-title-row">`;
if(hasSubtasks){
html+=`<button class="expand-btn${isExpanded?' expanded':''}" data-id="${task.id}"><svg viewBox="0 0 24 24" fill="none"><path d="M9 18l6-6-6-6"/></svg></button>`;
}
html+=`<span class="task-icon">${task.icon||'üìã'}</span><span class="task-name${task.completed?' completed':''}">${task.title}</span></div><div class="task-card-meta"><span class="status-pill ${statusClass(d.label,d.isUrgent)}">${statusText(d.label,d.isUrgent)}</span>`;
if(task.importance){
html+=`<span class="importance-badge ${importanceClass(task.importance)}">${task.importance.charAt(0).toUpperCase()+task.importance.slice(1)}</span>`;
}
if(task.project){
html+=`<span class="meta-tag">${task.project}</span>`;
}
html+=`</div>`;
if(task.dueDate){
html+=`<div class="task-card-date"><svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${formatDate(task.dueDate)}</div>`;
}
html+=`</div></div>`;
if(hasSubtasks&&isExpanded){
html+=`<div class="subtasks-container">`;
task.subtasks.forEach((sub,idx)=>{
const ss=getSubtaskState(sub);
html+=`<div class="subtask-item" data-parent="${task.id}" data-idx="${idx}"><input type="checkbox" class="checkbox sub-check"${sub.completed?' checked':''}><span class="subtask-name${sub.completed?' completed':''}">${sub.title}</span><span class="status-pill ${statusClass(ss.label,ss.isUrgent)}" style="font-size:9px;padding:2px 6px">${statusText(ss.label,ss.isUrgent)}</span></div>`;
});
html+=`</div>`;
}
card.innerHTML=html;
const cb=card.querySelector('.task-check');
cb.onclick=e=>{
e.stopPropagation();
task.completed=cb.checked;
task.system.lastModified=new Date().toISOString();
task.system.completedAt=task.completed?new Date().toISOString():null;
if(task.completed&&task.subtasks)task.subtasks.forEach(s=>s.completed=true);
render();
};
card.querySelectorAll('.sub-check').forEach(scb=>{
scb.onclick=e=>{
e.stopPropagation();
const item=scb.closest('.subtask-item');
const pid=parseInt(item.dataset.parent);
const idx=parseInt(item.dataset.idx);
const t=tasks.find(x=>x.id===pid);
if(t&&t.subtasks&&t.subtasks[idx]!==undefined){
t.subtasks[idx].completed=scb.checked;
checkParentCompletion(t);
render();
}
};
});
const expandBtn=card.querySelector('.expand-btn');
if(expandBtn){
expandBtn.onclick=e=>{
e.stopPropagation();
const id=parseInt(expandBtn.dataset.id);
if(expandedTasks.has(id))expandedTasks.delete(id);
else expandedTasks.add(id);
render();
};
}
card.onclick=e=>{
if(e.target.classList.contains('checkbox')||e.target.closest('.expand-btn'))return;
openModal(task);
};
return card;
}

function checkParentCompletion(task){
if(task.subtasks&&task.subtasks.length>0){
task.completed=task.subtasks.every(s=>s.completed);
task.system.lastModified=new Date().toISOString();
task.system.completedAt=task.completed?new Date().toISOString():null;
}
}

function bindColumnEvents(){
document.querySelectorAll('.column-title-text').forEach(input=>{
input.onchange=()=>{
const colId=input.dataset.col;
if(viewMode==='state'&&columnNames[colId]!==undefined){
columnNames[colId]=input.value;
}
};
});
}

document.querySelectorAll('.view-toggle-btn').forEach(btn=>{
btn.onclick=()=>{
document.querySelectorAll('.view-toggle-btn').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
viewMode=btn.dataset.mode;
render();
};
});

document.getElementById('searchBox').oninput=render;

const modal=document.getElementById('taskModal');
const closeModal=()=>modal.classList.remove('open');
document.getElementById('modalClose').onclick=closeModal;
document.getElementById('cancelBtn').onclick=closeModal;
modal.onclick=e=>{if(e.target===modal)closeModal();};
document.onkeydown=e=>{if(e.key==='Escape')closeModal();};

function openModal(task){
currentTask=task;
document.getElementById('modalTitle').textContent=task.id&&tasks.includes(task)?'Edit Task':'New Task';
document.getElementById('mTitle').value=task.title;
document.getElementById('mProject').value=task.project||'';
document.getElementById('mIcon').value=task.icon||'üìã';
document.getElementById('mColor').value=task.color||'#3b82f6';
document.getElementById('mCategory').value=task.category||'';
document.getElementById('mTags').value=task.tags||'';
document.getElementById('mStartDate').value=task.startDate||'';
document.getElementById('mDueDate').value=task.dueDate||'';
document.getElementById('mStartTime').value=task.startTime||'';
document.getElementById('mDueTime').value=task.dueTime||'';
document.getElementById('mRecurrence').value=task.recurrence||'';
document.getElementById('mEstimate').value=task.estimate||'';
document.getElementById('mLink').value=task.projectLink||'';
document.getElementById('mImportance').value=task.importance||'';
document.getElementById('mImpact').value=task.impactScore||'';
document.getElementById('mEnergy').value=task.energyMode||'';
document.getElementById('mFocus').checked=task.focusEligible;
document.getElementById('mNotes').value=task.notes||'';
document.getElementById('mLinkedDocs').value=task.linkedDocs||'';
document.getElementById('mWebClips').value=task.webClips||'';
document.getElementById('mDeps').value=task.dependencies||'';
document.getElementById('mBlock').value=task.blockReason||'';
renderSubtaskList();
generateAIInsight(task);
modal.classList.add('open');
}

function renderSubtaskList(){
const list=document.getElementById('subtaskList');
if(!currentTask.subtasks||currentTask.subtasks.length===0){
list.innerHTML='<p style="font-size:11px;color:var(--text-muted);margin-top:10px">No subtasks yet</p>';
return;
}
let html='';
currentTask.subtasks.forEach((sub,i)=>{
html+=`<div class="subtask-modal-item" data-idx="${i}"><input type="checkbox" class="checkbox modal-sub-check"${sub.completed?' checked':''}><input type="text" class="modal-sub-title" value="${sub.title}"><input type="date" class="modal-sub-start" value="${sub.startDate||''}"><input type="date" class="modal-sub-due" value="${sub.dueDate||''}"><select class="modal-sub-imp"><option value="">‚Äî</option><option value="low"${sub.importance==='low'?' selected':''}>Low</option><option value="medium"${sub.importance==='medium'?' selected':''}>Medium</option><option value="high"${sub.importance==='high'?' selected':''}>High</option><option value="critical"${sub.importance==='critical'?' selected':''}>Critical</option></select><input type="number" class="modal-sub-impact" value="${sub.impactScore||''}" min="1" max="10" placeholder="1-10"><span style="font-size:10px;color:var(--text-muted);text-align:center">${i+1}</span><button class="subtask-del" data-idx="${i}"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>`;
});
list.innerHTML=html;
list.querySelectorAll('.modal-sub-check').forEach((cb,i)=>{cb.onchange=()=>{currentTask.subtasks[i].completed=cb.checked;};});
list.querySelectorAll('.modal-sub-title').forEach((inp,i)=>{inp.onchange=()=>{currentTask.subtasks[i].title=inp.value;};});
list.querySelectorAll('.modal-sub-start').forEach((inp,i)=>{inp.onchange=()=>{currentTask.subtasks[i].startDate=inp.value;};});
list.querySelectorAll('.modal-sub-due').forEach((inp,i)=>{inp.onchange=()=>{currentTask.subtasks[i].dueDate=inp.value;};});
list.querySelectorAll('.modal-sub-imp').forEach((sel,i)=>{sel.onchange=()=>{currentTask.subtasks[i].importance=sel.value;};});
list.querySelectorAll('.modal-sub-impact').forEach((inp,i)=>{inp.onchange=()=>{currentTask.subtasks[i].impactScore=parseInt(inp.value)||0;};});
list.querySelectorAll('.subtask-del').forEach(btn=>{
btn.onclick=()=>{
const idx=parseInt(btn.dataset.idx);
currentTask.subtasks.splice(idx,1);
if(currentTask.subtasks.length===0)currentTask.subtasks=null;
renderSubtaskList();
};
});
}

['subTitle','subStart','subDue'].forEach(id=>{
document.getElementById(id).oninput=()=>{
document.getElementById('addSubBtn').disabled=!document.getElementById('subTitle').value;
};
});

document.getElementById('addSubBtn').onclick=()=>{
const title=document.getElementById('subTitle').value;
if(!title)return;
if(!currentTask.subtasks)currentTask.subtasks=[];
currentTask.subtasks.push(createSubtask({title,startDate:document.getElementById('subStart').value,dueDate:document.getElementById('subDue').value}));
document.getElementById('subTitle').value='';
document.getElementById('subStart').value='';
document.getElementById('subDue').value='';
document.getElementById('addSubBtn').disabled=true;
renderSubtaskList();
};

function generateAIInsight(task){
const insight=document.getElementById('aiInsight');
const text=document.getElementById('aiInsightText');
const d=computeDerived(task);
let msg='';
if(d.label==='overdue'){
msg=`<strong>‚ö†Ô∏è Overdue Alert:</strong> This task is ${Math.abs(d.daysUntilDue)} day${Math.abs(d.daysUntilDue)>1?'s':''} overdue.`;
}else if(task.blockReason){
msg=`<strong>üö´ Blocked:</strong> "${task.blockReason}".`;
}else if(task.dependencies){
msg=`<strong>üîó Dependencies:</strong> This task depends on tasks [${task.dependencies}].`;
}else if(d.isUrgent&&task.importance==='critical'){
msg=`<strong>‚ö° High Priority:</strong> Critical task due ${d.daysUntilDue===0?'today':d.daysUntilDue===1?'tomorrow':'soon'}.`;
}else if(task.subtasks&&task.subtasks.length>0){
const done=task.subtasks.filter(s=>s.completed).length;
const total=task.subtasks.length;
const pct=Math.round((done/total)*100);
msg=`<strong>üìä Progress:</strong> ${done}/${total} subtasks (${pct}%).`;
}
if(msg){text.innerHTML=msg;insight.style.display='flex';}
else{insight.style.display='none';}
}

document.getElementById('saveBtn').onclick=()=>{
if(!currentTask)return;
currentTask.title=document.getElementById('mTitle').value||'Untitled';
currentTask.project=document.getElementById('mProject').value;
currentTask.icon=document.getElementById('mIcon').value||'üìã';
currentTask.color=document.getElementById('mColor').value;
currentTask.category=document.getElementById('mCategory').value;
currentTask.tags=document.getElementById('mTags').value;
currentTask.startDate=document.getElementById('mStartDate').value;
currentTask.dueDate=document.getElementById('mDueDate').value;
currentTask.startTime=document.getElementById('mStartTime').value;
currentTask.dueTime=document.getElementById('mDueTime').value;
currentTask.recurrence=document.getElementById('mRecurrence').value;
currentTask.estimate=parseFloat(document.getElementById('mEstimate').value)||0;
currentTask.projectLink=document.getElementById('mLink').value;
currentTask.importance=document.getElementById('mImportance').value;
currentTask.impactScore=parseInt(document.getElementById('mImpact').value)||0;
currentTask.energyMode=document.getElementById('mEnergy').value;
currentTask.focusEligible=document.getElementById('mFocus').checked;
currentTask.notes=document.getElementById('mNotes').value;
currentTask.linkedDocs=document.getElementById('mLinkedDocs').value;
currentTask.webClips=document.getElementById('mWebClips').value;
currentTask.dependencies=document.getElementById('mDeps').value;
currentTask.blockReason=document.getElementById('mBlock').value;
currentTask.system.lastModified=new Date().toISOString();
currentTask.system.version++;
checkParentCompletion(currentTask);
if(!tasks.find(t=>t.id===currentTask.id))tasks.push(currentTask);
render();
closeModal();
currentTask=null;
};

document.getElementById('deleteBtn').onclick=()=>{
if(!currentTask||!confirm('Delete this task permanently?'))return;
tasks=tasks.filter(t=>t.id!==currentTask.id);
expandedTasks.delete(currentTask.id);
render();
closeModal();
currentTask=null;
};

document.getElementById('duplicateBtn').onclick=()=>{
if(!currentTask)return;
const dup=JSON.parse(JSON.stringify(currentTask));
const newTask=createTask(dup);
newTask.title+=' (Copy)';
newTask.completed=false;
newTask.system.completedAt=null;
if(newTask.subtasks)newTask.subtasks.forEach(s=>s.completed=false);
tasks.push(newTask);
render();
closeModal();
alert('Task duplicated successfully');
};

document.getElementById('addTaskBtn').onclick=()=>{
const today=new Date().toISOString().split('T')[0];
const tomorrow=new Date(Date.now()+864e5).toISOString().split('T')[0];
currentTask=createTask({startDate:today,dueDate:tomorrow});
openModal(currentTask);
};

tasks=[
createTask({id:1,title:'Q1 Product Strategy',icon:'üéØ',color:'#3b82f6',project:'Strategy',category:'Planning',tags:'quarterly,leadership',startDate:'2026-01-28',dueDate:'2026-02-05',dueTime:'17:00',importance:'critical',impactScore:9,estimate:8,projectLink:'https://notion.so/strategy-2026',notes:'Define roadmap priorities for Q1',subtasks:[
createSubtask({title:'Conduct Market Analysis Report',startDate:'2026-01-28',dueDate:'2026-01-30',importance:'high',impactScore:7}),
createSubtask({title:'Complete Competitive Landscape Review',startDate:'2026-01-30',dueDate:'2026-02-02',importance:'high',impactScore:8}),
createSubtask({title:'Draft Strategy Presentation Slides',startDate:'2026-02-02',dueDate:'2026-02-04',importance:'medium',impactScore:6}),
createSubtask({title:'Schedule Leadership Review Meeting',startDate:'2026-02-04',dueDate:'2026-02-05',importance:'medium',impactScore:5})
]}),
createTask({id:2,title:'User Research Synthesis',icon:'üìä',color:'#8b5cf6',project:'Research',category:'UX',tags:'research,users',startDate:'2026-01-25',dueDate:'2026-01-31',importance:'high',impactScore:7,estimate:6,projectLink:'https://figma.com/research',subtasks:[
createSubtask({title:'Compile Interview Transcripts',startDate:'2026-01-25',dueDate:'2026-01-27',completed:true,importance:'medium',impactScore:5}),
createSubtask({title:'Identify Key User Pain Points',startDate:'2026-01-27',dueDate:'2026-01-29',importance:'high',impactScore:8}),
createSubtask({title:'Create Persona Documents',startDate:'2026-01-29',dueDate:'2026-01-30',importance:'medium',impactScore:6}),
createSubtask({title:'Write Final Research Report',startDate:'2026-01-30',dueDate:'2026-01-31',importance:'high',impactScore:7})
]}),
createTask({id:3,title:'Design System Update',icon:'üé®',color:'#22c55e',project:'Design',category:'Engineering',tags:'design,components',startDate:'2026-02-10',dueDate:'2026-02-20',importance:'medium',impactScore:6,estimate:12,projectLink:'https://storybook.company.io',subtasks:[
createSubtask({title:'Audit Current Color Token Usage',startDate:'2026-02-10',dueDate:'2026-02-12',importance:'low',impactScore:4}),
createSubtask({title:'Define New Typography Scale',startDate:'2026-02-12',dueDate:'2026-02-15',importance:'medium',impactScore:6}),
createSubtask({title:'Update Component Library Docs',startDate:'2026-02-15',dueDate:'2026-02-18',importance:'medium',impactScore:5}),
createSubtask({title:'Create Migration Guide for Teams',startDate:'2026-02-18',dueDate:'2026-02-20',importance:'high',impactScore:7})
]}),
createTask({id:4,title:'API Documentation',icon:'üìù',color:'#f59e0b',project:'Engineering',category:'Engineering',tags:'api,docs',startDate:'2026-01-20',dueDate:'2026-01-29',importance:'high',impactScore:5,estimate:4,blockReason:'Waiting on API v2 release from backend team',subtasks:[
createSubtask({title:'Document Authentication Endpoints',startDate:'2026-01-20',dueDate:'2026-01-23',completed:true,importance:'high',impactScore:6}),
createSubtask({title:'Write CRUD Operation Examples',startDate:'2026-01-23',dueDate:'2026-01-26',importance:'medium',impactScore:5}),
createSubtask({title:'Add Error Code Reference Table',startDate:'2026-01-26',dueDate:'2026-01-29',importance:'medium',impactScore:4})
]}),
createTask({id:5,title:'Team Retrospective',icon:'üîÑ',color:'#06b6d4',project:'Operations',category:'Team',tags:'team,process',startDate:'2026-02-05',dueDate:'2026-02-05',dueTime:'14:00',importance:'medium',impactScore:4,estimate:2,recurrence:'biweekly'}),
createTask({id:6,title:'Performance Optimization Sprint',icon:'‚ö°',color:'#ef4444',project:'Engineering',category:'Engineering',tags:'speed,core',startDate:'2026-02-01',dueDate:'2026-02-15',importance:'high',impactScore:8,estimate:16,dependencies:'3',projectLink:'https://github.com/company/perf',subtasks:[
createSubtask({title:'Run Performance Profiling Analysis',startDate:'2026-02-01',dueDate:'2026-02-04',importance:'high',impactScore:7}),
createSubtask({title:'Optimize JavaScript Bundle Size',startDate:'2026-02-04',dueDate:'2026-02-08',importance:'high',impactScore:8}),
createSubtask({title:'Improve Component Render Performance',startDate:'2026-02-08',dueDate:'2026-02-12',importance:'medium',impactScore:6}),
createSubtask({title:'Execute Load Testing & Validation',startDate:'2026-02-12',dueDate:'2026-02-15',importance:'medium',impactScore:7})
]}),
createTask({id:7,title:'Weekly Standup Notes',icon:'üìã',color:'#64748b',project:'Operations',category:'Admin',tags:'meeting,weekly',startDate:'2026-01-20',dueDate:'2026-01-20',importance:'low',impactScore:2,estimate:0.5,completed:true}),
createTask({id:8,title:'Client Presentation Prep',icon:'üé§',color:'#ec4899',project:'Sales',category:'Sales',tags:'client,demo',startDate:'2026-02-08',dueDate:'2026-02-12',dueTime:'10:00',importance:'critical',impactScore:9,estimate:5,projectLink:'https://slides.company.io/client-demo',subtasks:[
createSubtask({title:'Prepare Demo Environment Setup',startDate:'2026-02-08',dueDate:'2026-02-09',importance:'critical',impactScore:8}),
createSubtask({title:'Create Slide Deck with Case Studies',startDate:'2026-02-09',dueDate:'2026-02-11',importance:'high',impactScore:9}),
createSubtask({title:'Rehearse Presentation Flow',startDate:'2026-02-11',dueDate:'2026-02-12',importance:'medium',impactScore:6})
]}),
createTask({id:9,title:'Budget Review Meeting',icon:'üí∞',color:'#10b981',project:'Finance',category:'Planning',tags:'budget,q1',startDate:'2026-01-15',dueDate:'2026-01-22',importance:'high',impactScore:7,estimate:3,completed:true}),
createTask({id:10,title:'Onboarding New Hires',icon:'üëã',color:'#6366f1',project:'HR',category:'Team',tags:'onboarding,training',startDate:'2026-02-03',dueDate:'2026-02-10',importance:'medium',impactScore:5,estimate:8}),
createTask({id:11,title:'Security Audit Preparation',icon:'üîí',color:'#dc2626',project:'Engineering',category:'Engineering',tags:'security,compliance',startDate:'2026-02-15',dueDate:'2026-02-28',importance:'critical',impactScore:10,estimate:20}),
createTask({id:12,title:'Marketing Campaign Launch',icon:'üì£',color:'#f97316',project:'Marketing',category:'Marketing',tags:'campaign,launch',startDate:'2026-01-28',dueDate:'2026-01-30',importance:'high',impactScore:8,estimate:6}),
createTask({id:13,title:'Database Migration Planning',icon:'üóÑÔ∏è',color:'#0891b2',project:'Engineering',category:'Engineering',tags:'database,migration',startDate:'2026-02-20',dueDate:'2026-03-05',importance:'high',impactScore:9,estimate:24}),
createTask({id:14,title:'Customer Feedback Analysis',icon:'üìà',color:'#a855f7',project:'Research',category:'UX',tags:'feedback,analysis',startDate:'2026-01-18',dueDate:'2026-01-25',importance:'medium',impactScore:6,estimate:4,completed:true}),
createTask({id:15,title:'Vendor Contract Renewal',icon:'üìÑ',color:'#84cc16',project:'Operations',category:'Admin',tags:'contracts,vendor',startDate:'2026-01-10',dueDate:'2026-01-28',importance:'low',impactScore:3,estimate:2})
];
nextId=16;
expandedTasks.add(1);
expandedTasks.add(2);
render();
</script>
</body>
</html>