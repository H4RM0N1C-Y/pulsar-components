<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Pulsar ‚Äî Habit Tracker</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@300;400;500&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0b0c0e;--s1:#131416;--s2:#181a1d;--s3:#1d1f23;--s4:#252729;
--bd:#1e1f23;--bl:#2a2b30;--bh:#38393f;
--t1:#ededef;--t2:#9d9ea4;--t3:#6e6f76;--t4:#4a4b51;
--ac:#818cf8;--acd:rgba(129,140,248,.08);--acm:rgba(129,140,248,.18);
--g:#34d399;--gbg:rgba(52,211,153,.1);--gb:rgba(52,211,153,.25);
--am:#fbbf24;
--tbg:rgba(129,140,248,.05);
--rd:6px;--rl:10px;
--f:'DM Sans',system-ui,sans-serif;--m:'JetBrains Mono',ui-monospace,monospace;
--sh:0 8px 28px rgba(0,0,0,.4);
}
html{height:100%;background:var(--bg);color:var(--t1);font-family:var(--f);-webkit-font-smoothing:antialiased}
body{min-height:100vh;display:flex;flex-direction:column}

/* Header */
.hdr{padding:16px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:100;background:rgba(11,12,14,.9);backdrop-filter:blur(16px)}
.hdr-l{display:flex;align-items:center;gap:14px}
.logo{width:26px;height:26px;border-radius:7px;background:linear-gradient(135deg,#818cf8,#a78bfa,#c084fc);display:grid;place-items:center;font-size:11px;font-weight:700;color:#fff;box-shadow:0 2px 8px rgba(129,140,248,.2)}
.hdr h1{font-size:14px;font-weight:600;letter-spacing:-.3px}
.hdr h1 em{font-style:normal;color:var(--t4);font-weight:400;margin-left:7px;font-size:11px}
.hdr-r{display:flex;align-items:center;gap:8px}
.mnav{display:flex;align-items:center;background:var(--s1);border:1px solid var(--bd);border-radius:var(--rd);padding:2px;gap:1px}
.mnav button{background:none;border:none;color:var(--t3);cursor:pointer;width:28px;height:26px;border-radius:5px;font-size:14px;transition:all .12s;display:grid;place-items:center}
.mnav button:hover{color:var(--t1);background:var(--s3)}
.mnav .mlbl{font-size:11px;font-weight:500;color:var(--t2);padding:0 10px;font-family:var(--m);white-space:nowrap;min-width:116px;text-align:center;letter-spacing:-.2px}
.btn-t{background:var(--s1);border:1px solid var(--bd);color:var(--t2);border-radius:var(--rd);padding:5px 11px;font-size:10px;font-weight:500;cursor:pointer;font-family:var(--f);transition:all .12s}
.btn-t:hover{border-color:var(--ac);color:var(--ac);background:var(--acd)}
.btn-t.hid{display:none}
.btn-a{background:var(--ac);color:#fff;border:none;border-radius:var(--rd);padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer;font-family:var(--f);transition:all .15s}
.btn-a:hover{filter:brightness(1.12);transform:translateY(-1px)}

/* Main */
.main{flex:1;padding:0 28px 48px}

/* Empty */
.empty{display:flex;flex-direction:column;align-items:center;padding:90px 20px;text-align:center}
.empty-i{font-size:42px;margin-bottom:18px;opacity:.7}
.empty h2{font-size:16px;font-weight:600;margin-bottom:8px}
.empty p{font-size:12px;color:var(--t3);max-width:280px;line-height:1.55;margin-bottom:24px}
.empty button{background:var(--ac);color:#fff;border:none;border-radius:var(--rd);padding:9px 22px;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--f)}

/* Grid */
.gw{margin-top:18px;overflow-x:auto;border:1px solid var(--bd);border-radius:var(--rl);background:var(--s1)}
.grid{width:100%;border-collapse:collapse;table-layout:fixed;min-width:680px}
.grid th,.grid td{text-align:center;vertical-align:middle}
.grid thead th{font-size:9px;font-weight:600;color:var(--t4);padding:12px 0 10px;border-bottom:1px solid var(--bd);text-transform:uppercase;letter-spacing:.5px}
.grid thead th.hth{text-align:left;padding-left:14px;font-size:10px;letter-spacing:.6px;min-width:160px;width:160px;position:sticky;left:0;background:var(--s1);z-index:2}
.grid thead th.dth{min-width:28px;width:28px;padding:12px 0 8px}
.grid thead th.dth .dn{display:block;font-size:10px;font-weight:700;font-family:var(--m);margin-top:3px;color:var(--t3)}
.grid thead th.tdy{color:var(--ac)}
.grid thead th.tdy .dn{color:var(--ac)}
.grid thead th.lock{opacity:.3}

/* Rows */
.grid tbody tr{transition:background .08s}
.grid tbody tr:hover{background:rgba(255,255,255,.012)}
.grid td{border-bottom:1px solid var(--bd);height:40px;padding:0}
.grid td.hc{text-align:left;padding:0 10px 0 14px;position:sticky;left:0;background:var(--s1);z-index:1}
.grid tbody tr:hover td.hc{background:var(--s2)}

/* Habit name */
.hi{display:flex;align-items:center;gap:9px;cursor:grab}
.hi:active{cursor:grabbing}
.hi .he{font-size:15px;flex-shrink:0;width:20px;text-align:center}
.hi .hn{font-size:12.5px;font-weight:450;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:115px}

/* Day cells */
.grid td.dtd{padding:3px}
.grid td.tdy-td{background:var(--tbg)}

/* Cell ‚Äî simple check / no-check */
.c{width:24px;height:24px;border-radius:var(--rd);margin:0 auto;display:flex;align-items:center;justify-content:center;transition:all .1s;border:1.5px solid var(--bd);user-select:none;-webkit-user-select:none;position:relative}

/* Active (today) */
.c.active{cursor:pointer}
.c.active:hover{border-color:var(--bh);background:var(--s3);transform:scale(1.12)}

/* Done */
.c.done{background:var(--gbg);border-color:var(--gb)}
.c.done .ck{opacity:1;transform:scale(1)}

/* Locked (past/future) */
.c.locked{cursor:default;opacity:.3}
.c.locked.done{opacity:0.55}

/* Check icon */
.ck{opacity:0;transform:scale(.3);transition:all .15s cubic-bezier(.34,1.56,.64,1);color:var(--g);display:flex;pointer-events:none}
.ck svg{width:13px;height:13px}

/* Pop animation */
@keyframes popCk{0%{transform:scale(.85)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
.c.pop{animation:popCk .25s cubic-bezier(.34,1.56,.64,1)}

/* Add row */
.grid .add-row td{border-bottom:none;height:42px}
.add-btn{background:none;border:1px dashed var(--bd);border-radius:var(--rd);color:var(--t4);font-size:10px;cursor:pointer;padding:5px 12px;font-family:var(--f);transition:all .12s;display:inline-flex;align-items:center;gap:5px;font-weight:500}
.add-btn:hover{border-color:var(--ac);color:var(--ac);background:var(--acd)}

/* Summary */
.summary{margin-top:28px;display:grid;grid-template-columns:1fr 240px;gap:18px;align-items:start}
.chbox{background:var(--s1);border:1px solid var(--bd);border-radius:var(--rl);padding:20px}
.chbox h3{font-size:10px;color:var(--t4);font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px}
.ccw{position:relative;height:155px}
.ccw canvas{width:100%;height:100%;display:block}
.stats{display:flex;flex-direction:column;gap:10px}
.sc{background:var(--s1);border:1px solid var(--bd);border-radius:var(--rl);padding:16px 18px}
.sc .sl{font-size:9px;color:var(--t4);text-transform:uppercase;letter-spacing:.6px;font-weight:600;margin-bottom:5px}
.sc .sv{font-size:28px;font-weight:700;font-family:var(--m);letter-spacing:-1px}
.sc .ss{font-size:9px;color:var(--t4);margin-top:4px;font-weight:500}
.sc.grn .sv{color:var(--g)}
.sc.amb .sv{color:var(--am)}

/* Chart tooltip */
.chtip{position:absolute;z-index:20;background:var(--s3);border:1px solid var(--bl);border-radius:var(--rl);padding:12px 14px;pointer-events:none;opacity:0;transition:opacity .15s,transform .15s;box-shadow:var(--sh);min-width:145px;transform:translateY(4px)}
.chtip.show{opacity:1;transform:translateY(0)}
.chtip .ct-date{font-size:10px;font-weight:600;color:var(--t2);margin-bottom:8px;font-family:var(--m)}
.chtip .ct-pct{font-size:22px;font-weight:700;font-family:var(--m);color:var(--ac);letter-spacing:-.5px}
.chtip .ct-bar{height:3px;background:var(--bd);border-radius:2px;margin:8px 0;overflow:hidden}
.chtip .ct-fill{height:100%;background:var(--g);border-radius:2px;transition:width .2s}
.chtip .ct-detail{font-size:9px;color:var(--t3);display:flex;gap:12px;font-family:var(--m)}
.chtip .ct-detail span{display:flex;align-items:center;gap:4px}
.chtip .ct-detail .dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}

/* Context Menu */
.ctx{position:fixed;z-index:200;background:var(--s2);border:1px solid var(--bl);border-radius:var(--rl);padding:4px;min-width:160px;box-shadow:var(--sh);opacity:0;transform:scale(.94) translateY(-4px);transition:all .1s;pointer-events:none}
.ctx.open{opacity:1;transform:scale(1) translateY(0);pointer-events:auto}
.ctx button{display:flex;align-items:center;gap:7px;width:100%;background:none;border:none;color:var(--t1);font-size:11px;padding:8px 11px;border-radius:6px;cursor:pointer;font-family:var(--f);text-align:left;transition:background .08s}
.ctx button:hover{background:var(--s4)}
.ctx button.dng{color:#f87171}
.ctx .sep{height:1px;background:var(--bd);margin:3px 2px}
.dcf{display:none;margin:4px;padding:11px;background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.18);border-radius:var(--rd)}
.dcf.show{display:block}
.dcf p{font-size:11px;color:var(--t2);margin-bottom:9px}
.dcf button{padding:5px 13px;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer;font-family:var(--f);border:none;margin-right:6px}
.dcf .dy{background:#f87171;color:#fff}
.dcf .dn{background:var(--s4);color:var(--t2)}

/* Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .12s;backdrop-filter:blur(6px)}
.mo.open{opacity:1;pointer-events:auto}
.mbox{background:var(--s1);border:1px solid var(--bl);border-radius:var(--rl);padding:26px;width:360px;transform:scale(.94);transition:transform .15s cubic-bezier(.4,0,.2,1);box-shadow:var(--sh)}
.mo.open .mbox{transform:scale(1)}
.mbox h2{font-size:15px;font-weight:600;margin-bottom:20px}
.mbox label{display:block;font-size:9px;color:var(--t4);margin-bottom:5px;text-transform:uppercase;letter-spacing:.6px;font-weight:600}
.mbox input,.mbox select{width:100%;background:var(--s3);border:1px solid var(--bd);border-radius:var(--rd);padding:9px 11px;color:var(--t1);font-size:13px;font-family:var(--f);outline:none;margin-bottom:15px;transition:border-color .12s}
.mbox input:focus{border-color:var(--ac);box-shadow:0 0 0 3px var(--acd)}
.mbox select{cursor:pointer;-webkit-appearance:none;appearance:none}
.ep{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:16px}
.ep button{width:33px;height:33px;border-radius:var(--rd);border:1.5px solid var(--bd);background:var(--s3);cursor:pointer;font-size:15px;display:grid;place-items:center;transition:all .1s}
.ep button:hover{border-color:var(--bh);transform:scale(1.1)}
.ep button.sel{border-color:var(--ac);background:var(--acd)}
.macts{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.macts button{padding:8px 20px;border-radius:var(--rd);font-size:12px;font-weight:600;cursor:pointer;font-family:var(--f);border:none;transition:all .12s}
.macts .bc{background:var(--s4);color:var(--t2)}
.macts .bc:hover{background:var(--bl)}
.macts .bs{background:var(--ac);color:#fff}
.macts .bs:hover{filter:brightness(1.1)}

/* Undo */
.undo{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(70px);background:var(--s3);border:1px solid var(--bl);border-radius:var(--rl);padding:9px 16px;font-size:11px;color:var(--t2);display:flex;align-items:center;gap:12px;z-index:500;transition:transform .25s cubic-bezier(.4,0,.2,1);box-shadow:var(--sh)}
.undo.show{transform:translateX(-50%) translateY(0)}
.undo button{background:var(--ac);color:#fff;border:none;border-radius:5px;padding:4px 12px;font-size:10px;font-weight:600;cursor:pointer;font-family:var(--f)}

/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}

/* Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}
.grid tbody tr{animation:fadeIn .18s ease both}
.grid tbody tr:nth-child(1){animation-delay:10ms}.grid tbody tr:nth-child(2){animation-delay:25ms}
.grid tbody tr:nth-child(3){animation-delay:40ms}.grid tbody tr:nth-child(4){animation-delay:55ms}
.grid tbody tr:nth-child(5){animation-delay:70ms}.grid tbody tr:nth-child(6){animation-delay:85ms}
.grid tbody tr:nth-child(7){animation-delay:100ms}.grid tbody tr:nth-child(8){animation-delay:115ms}

@media(max-width:768px){
  .hdr{padding:12px 16px}
  .main{padding:0 16px 36px}
  .summary{grid-template-columns:1fr}
  .grid thead th.hth{min-width:120px;width:120px}
  .hi .hn{max-width:80px;font-size:11px}
}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-l"><div class="logo">P</div><h1>Habits<em>monthly</em></h1></div>
  <div class="hdr-r">
    <button class="btn-t hid" id="btnT" onclick="goNow()">Today</button>
    <div class="mnav">
      <button onclick="chgM(-1)">‚Äπ</button>
      <span class="mlbl" id="mLbl"></span>
      <button onclick="chgM(1)">‚Ä∫</button>
    </div>
    <button class="btn-a" onclick="openMo()">+ Add habit</button>
  </div>
</div>

<div class="main" id="mainArea"></div>

<div class="ctx" id="ctx">
  <button onclick="editH()">‚úèÔ∏è&ensp;Edit</button>
  <div class="sep"></div>
  <button class="dng" onclick="confirmDel()">üóë&ensp;Delete</button>
  <div class="dcf" id="dcf"><p>Delete habit and all history?</p><button class="dy" onclick="delH()">Delete</button><button class="dn" onclick="cancelDel()">Cancel</button></div>
</div>

<div class="undo" id="undoT"><span id="undoM"></span><button onclick="doUndo()">Undo</button></div>

<div class="mo" id="mo" onclick="if(event.target===this)closeMo()">
  <div class="mbox">
    <h2 id="moTi">Add habit</h2>
    <label>Icon</label><div class="ep" id="epick"></div>
    <label>Name</label><input id="hInp" placeholder="e.g. Morning run" maxlength="40" onkeydown="if(event.key==='Enter')saveH()">
    <label>Category</label>
    <select id="tInp"><option value="health">Health</option><option value="mind">Mind</option><option value="work">Work</option><option value="creative">Creative</option><option value="social">Social</option><option value="self-care">Self-care</option></select>
    <div class="macts"><button class="bc" onclick="closeMo()">Cancel</button><button class="bs" onclick="saveH()">Save</button></div>
  </div>
</div>

<script>
const SK='pulsar_hv5',DOW=['S','M','T','W','T','F','S'],EMOJIS=['üèÉ','üìñ','üíª','üßò','‚úçÔ∏è','üò¥','üíß','üéØ','üé®','üèãÔ∏è','üß†','üå±','üìù','üéµ','üçé','‚è∞','üö´','üí™','üìö','‚òï'];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];

let S={habits:[],comp:{},mOff:0},editId=null,ctxId=null,selEmoji='üéØ',reorderSrc=null,undoStack=[];

// Dates
function mDates(off){
  const n=new Date(),y=n.getFullYear(),m=n.getMonth()+(off||0)+S.mOff;
  const d1=new Date(y,m,1),cnt=new Date(d1.getFullYear(),d1.getMonth()+1,0).getDate();
  return Array.from({length:cnt},(_,i)=>{const x=new Date(d1.getFullYear(),d1.getMonth(),i+1);x.setHours(12,0,0,0);return x});
}
function fmt(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function isToday(d){const t=new Date();return d.getFullYear()===t.getFullYear()&&d.getMonth()===t.getMonth()&&d.getDate()===t.getDate()}
function isFuture(d){const t=new Date();t.setHours(0,0,0,0);const dc=new Date(d);dc.setHours(0,0,0,0);return dc>t}
function ck(h,d){return h+'::'+d}

// Persistence
function save(){localStorage.setItem(SK,JSON.stringify(S))}
function load(){const r=localStorage.getItem(SK);if(r){try{S=JSON.parse(r)}catch(e){seed()}}else seed()}

function seed(){
  const defs=[
    {id:gid(),name:'Morning exercise',tag:'health',emoji:'üèÉ'},
    {id:gid(),name:'Read 30 min',tag:'mind',emoji:'üìñ'},
    {id:gid(),name:'Deep work',tag:'work',emoji:'üíª'},
    {id:gid(),name:'Meditate',tag:'mind',emoji:'üßò'},
    {id:gid(),name:'Journal',tag:'creative',emoji:'‚úçÔ∏è'},
    {id:gid(),name:'No screens 9pm',tag:'self-care',emoji:'üö´'},
  ];
  S={habits:defs,comp:{},mOff:0};
  const dates=mDates(0);
  const pats=[[1,1,0,1,1,1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1,1,1,0,1,1,0,1],[1,0,1,1,1,0,1,1,0,1,1,0,1,0,1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,0,1],[1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,1],[1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1],[0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0],[1,0,1,0,1,1,0,1,0,1,0,1,1,0,1,0,1,0,1,1,0,1,0,1,0,1,1,0,1,0,1]];
  defs.forEach((h,hi)=>{dates.forEach((d,di)=>{
    if(!isFuture(d)&&!isToday(d)&&pats[hi]&&pats[hi][di])S.comp[ck(h.id,fmt(d))]=true;
  })});
  save();
}
function gid(){return 'h_'+Math.random().toString(36).slice(2,9)}

// Undo
function pushU(msg,fn){undoStack.push({msg,fn});const t=document.getElementById('undoT');document.getElementById('undoM').textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),3500)}
function doUndo(){if(!undoStack.length)return;undoStack.pop().fn();save();render();document.getElementById('undoT').classList.remove('show')}

// Nav
function chgM(d){S.mOff+=d;save();render()}
function goNow(){S.mOff=0;save();render()}

// Render
function render(){
  const dates=mDates(0),ma=document.getElementById('mainArea'),d0=dates[0];
  document.getElementById('mLbl').textContent=`${MONTHS[d0.getMonth()]} ${d0.getFullYear()}`;
  const now=new Date(),isCur=d0.getMonth()===now.getMonth()&&d0.getFullYear()===now.getFullYear();

  if(!S.habits.length){
    ma.innerHTML=`<div class="empty"><div class="empty-i">‚ú¶</div><h2>Start tracking</h2><p>Add your first habit and mark it day by day.</p><button onclick="openMo()">+ Add first habit</button></div>`;return;
  }

  let h='<div class="gw"><table class="grid"><thead><tr><th class="hth">Habit</th>';
  dates.forEach(d=>{
    const td=isToday(d),fut=isFuture(d);
    h+=`<th class="dth${td?' tdy':''}${!td&&(fut||!isToday(d))?' lock':''}" ${!td&&!fut?'':''}>${DOW[d.getDay()]}<span class="dn">${d.getDate()}</span></th>`;
  });
  h+='</tr></thead><tbody>';

  S.habits.forEach((hab,hi)=>{
    h+=`<tr draggable="true" data-i="${hi}" ondragstart="rDS(event,${hi})" ondragover="rDO(event,${hi})" ondragleave="rDL(event)" ondrop="rDP(event,${hi})" ondragend="rDE(event)">`;
    h+=`<td class="hc"><div class="hi" oncontextmenu="showCtx(event,'${hab.id}')"><span class="he">${hab.emoji||'üéØ'}</span><span class="hn">${esc(hab.name)}</span></div></td>`;

    dates.forEach(d=>{
      const key=ck(hab.id,fmt(d)),done=!!S.comp[key],td=isToday(d),fut=isFuture(d);
      const locked=!td;
      const cls=['c'];
      if(done)cls.push('done');
      if(td)cls.push('active');
      if(locked)cls.push('locked');
      const tdcls='dtd'+(td?' tdy-td':'');

      h+=`<td class="${tdcls}"><div class="${cls.join(' ')}" ${td?`data-h="${hab.id}" data-d="${fmt(d)}"`:''}><span class="ck"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3.5 8.5 6.5 11.5 12.5 4.5"/></svg></span></div></td>`;
    });
    h+='</tr>';
  });
  h+=`<tr class="add-row"><td class="hc"><button class="add-btn" onclick="openMo()">+ Add</button></td><td colspan="${dates.length}"></td></tr>`;
  h+='</tbody></table></div>';
  h+=renderSum(dates);
  ma.innerHTML=h;

  // Bind only active (today) cells
  ma.querySelectorAll('.c.active').forEach(el=>{
    el.addEventListener('mousedown',cDown);
    el.addEventListener('touchstart',cTch,{passive:false});
  });

  requestAnimationFrame(()=>{drawChart(dates);setupHover()});
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// Cell click ‚Äî only today
function cDown(e){e.preventDefault();toggle(e.currentTarget)}
function cTch(e){e.preventDefault();toggle(e.currentTarget)}
function toggle(el){
  const key=ck(el.dataset.h,el.dataset.d),prev=JSON.parse(JSON.stringify(S.comp));
  if(S.comp[key])delete S.comp[key];else S.comp[key]=true;
  save();
  el.classList.toggle('done',!!S.comp[key]);
  el.classList.add('pop');setTimeout(()=>el.classList.remove('pop'),300);
}

// Drag reorder
function rDS(e,i){reorderSrc=i;e.dataTransfer.effectAllowed='move';e.currentTarget.style.opacity='.3'}
function rDO(e,i){e.preventDefault();if(i!==reorderSrc)e.currentTarget.style.boxShadow=`inset 0 ${i<reorderSrc?'2':'-2'}px 0 var(--ac)`}
function rDL(e){e.currentTarget.style.boxShadow=''}
function rDP(e,i){e.preventDefault();e.currentTarget.style.boxShadow='';if(reorderSrc===null||reorderSrc===i)return;
  const hb=S.habits.splice(reorderSrc,1)[0];S.habits.splice(i,0,hb);save();render()}
function rDE(e){e.currentTarget.style.opacity='';reorderSrc=null;document.querySelectorAll('tr').forEach(r=>r.style.boxShadow='')}

// Context
function showCtx(e,hid){e.preventDefault();e.stopPropagation();ctxId=hid;const m=document.getElementById('ctx');
  document.getElementById('dcf').classList.remove('show');
  m.style.left=Math.min(e.clientX,innerWidth-170)+'px';m.style.top=Math.min(e.clientY,innerHeight-130)+'px';m.classList.add('open')}
document.addEventListener('click',e=>{if(!e.target.closest('.ctx'))document.getElementById('ctx').classList.remove('open')});
function confirmDel(){document.getElementById('dcf').classList.add('show')}
function cancelDel(){document.getElementById('dcf').classList.remove('show')}
function delH(){if(!ctxId)return;const prev={h:S.habits.map(x=>({...x})),c:{...S.comp}},nm=S.habits.find(h=>h.id===ctxId)?.name||'';
  S.habits=S.habits.filter(h=>h.id!==ctxId);Object.keys(S.comp).forEach(k=>{if(k.startsWith(ctxId+'::'))delete S.comp[k]});
  save();render();document.getElementById('ctx').classList.remove('open');pushU(`Deleted "${nm}"`,()=>{S.habits=prev.h;S.comp=prev.c})}
function editH(){if(!ctxId)return;const h=S.habits.find(x=>x.id===ctxId);if(!h)return;
  editId=h.id;document.getElementById('moTi').textContent='Edit';document.getElementById('hInp').value=h.name;document.getElementById('tInp').value=h.tag||'health';
  selEmoji=h.emoji||'üéØ';buildEP();document.getElementById('mo').classList.add('open');document.getElementById('ctx').classList.remove('open');setTimeout(()=>document.getElementById('hInp').focus(),100)}

// Modal
function buildEP(){document.getElementById('epick').innerHTML=EMOJIS.map(e=>`<button type="button" class="${e===selEmoji?'sel':''}" onclick="pE(this,'${e}')">${e}</button>`).join('')}
function pE(b,e){selEmoji=e;document.querySelectorAll('.ep button').forEach(x=>x.classList.remove('sel'));b.classList.add('sel')}
function openMo(){editId=null;selEmoji='üéØ';document.getElementById('moTi').textContent='Add habit';document.getElementById('hInp').value='';document.getElementById('tInp').value='health';buildEP();document.getElementById('mo').classList.add('open');setTimeout(()=>document.getElementById('hInp').focus(),100)}
function closeMo(){document.getElementById('mo').classList.remove('open')}
function saveH(){const name=document.getElementById('hInp').value.trim();if(!name)return;const tag=document.getElementById('tInp').value;
  if(editId){const h=S.habits.find(x=>x.id===editId);if(h){h.name=name;h.tag=tag;h.emoji=selEmoji}}
  else S.habits.push({id:gid(),name,tag,emoji:selEmoji});save();closeMo();render()}

// Summary
function calcR(dates){const hc=S.habits.length;if(!hc)return[];
  return dates.map(d=>{if(isFuture(d))return null;let dn=0;S.habits.forEach(h=>{if(S.comp[ck(h.id,fmt(d))])dn++});return{pct:Math.round(dn/hc*100),done:dn,total:hc}})}

function renderSum(dates){
  if(!S.habits.length)return '';
  const rates=calcR(dates),hc=S.habits.length,vr=rates.filter(r=>r!==null),tp=vr.length*hc;
  let td=0;vr.forEach(r=>td+=r.done);
  const con=tp?Math.round(td/tp*100):0;
  let bestH='‚Äî',bestP=0;
  S.habits.forEach(h=>{let d=0,t=0;dates.forEach(dt=>{if(!isFuture(dt)){t++;if(S.comp[ck(h.id,fmt(dt))])d++}});const p=t?Math.round(d/t*100):0;if(p>bestP){bestP=p;bestH=h.emoji+' '+h.name}});
  return `<div class="summary">
    <div class="chbox"><h3>Completion rate</h3><div class="ccw"><canvas id="cc"></canvas>
    <div class="chtip" id="chtip"><div class="ct-date"></div><div class="ct-pct"></div><div class="ct-bar"><div class="ct-fill"></div></div><div class="ct-detail"><span><span class="dot" style="background:var(--g)"></span><b class="ct-dn">0</b> done</span><span><span class="dot" style="background:#f87171"></span><b class="ct-mn">0</b> missed</span></div></div>
    </div></div>
    <div class="stats">
      <div class="sc ${con>=70?'grn':'amb'}"><div class="sl">Consistency</div><div class="sv">${con}%</div><div class="ss">${td} / ${tp} completed</div></div>
      <div class="sc"><div class="sl">Top habit</div><div class="sv" style="font-size:13px;color:var(--ac);letter-spacing:-.2px">${esc(bestH)}</div><div class="ss">${bestP}% this month</div></div>
    </div></div>`;
}

// Chart
let chPts=[];
function drawChart(dates,hovIdx){
  const canvas=document.getElementById('cc');if(!canvas||!S.habits.length)return;
  const rates=calcR(dates),dpr=window.devicePixelRatio||1,rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  canvas.style.width=rect.width+'px';canvas.style.height=rect.height+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height,pad={t:8,r:8,b:24,l:32},cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
  ctx.clearRect(0,0,W,H);

  for(let i=0;i<=4;i++){
    const y=pad.t+ch-ch*i/4;
    ctx.strokeStyle='#1e1f23';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle='#4a4b51';ctx.font='8px "JetBrains Mono",monospace';ctx.textAlign='right';ctx.fillText(i*25+'%',pad.l-5,y+3);
  }

  const pts=[],vi=rates.map((r,i)=>r!==null?i:-1).filter(i=>i>=0),nv=vi.length;
  if(!nv)return;
  vi.forEach((di,j)=>{
    const r=rates[di],x=pad.l+(cw/Math.max(nv-1,1))*j,y=pad.t+ch-ch*r.pct/100;
    pts.push({x,y,pct:r.pct,done:r.done,total:r.total,date:dates[di]});
  });
  chPts=pts;

  // X labels
  ctx.textAlign='center';ctx.font='8px "JetBrains Mono",monospace';
  const step=Math.max(1,Math.floor(nv/8));
  pts.forEach((p,i)=>{if(i%step===0||i===pts.length-1){ctx.fillStyle=isToday(p.date)?'#818cf8':'#4a4b51';ctx.fillText(p.date.getDate(),p.x,H-5)}});

  if(pts.length<2){const p=pts[0];ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fillStyle='#818cf8';ctx.fill();return}

  // Area
  const grad=ctx.createLinearGradient(0,pad.t,0,pad.t+ch);
  grad.addColorStop(0,'rgba(129,140,248,.06)');grad.addColorStop(1,'rgba(129,140,248,0)');
  ctx.beginPath();ctx.moveTo(pts[0].x,pad.t+ch);pts.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.lineTo(pts[pts.length-1].x,pad.t+ch);ctx.closePath();ctx.fillStyle=grad;ctx.fill();

  // Lines
  ctx.beginPath();pts.forEach((p,i)=>{if(!i)ctx.moveTo(p.x,p.y);else ctx.lineTo(p.x,p.y)});
  ctx.strokeStyle='#818cf8';ctx.lineWidth=1.5;ctx.stroke();

  // Dots
  pts.forEach((p,i)=>{
    const isHov=hovIdx===i;
    const r=isHov?5:2.5;
    ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fillStyle='#818cf8';ctx.fill();
    if(!isHov){ctx.beginPath();ctx.arc(p.x,p.y,1,0,Math.PI*2);ctx.fillStyle='#0b0c0e';ctx.fill()}
  });
}

// Chart hover with bounce
let chTimer=null,chIdx=-1,bounceAnim=null;
function setupHover(){
  const canvas=document.getElementById('cc');if(!canvas)return;
  canvas.onmousemove=e=>{
    const rect=canvas.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
    let cl=-1,md=Infinity;
    chPts.forEach((p,i)=>{const d=Math.hypot(p.x-mx,p.y-my);if(d<md&&d<22){md=d;cl=i}});
    if(cl!==chIdx){
      clearTimeout(chTimer);cancelAnimationFrame(bounceAnim);
      const tip=document.getElementById('chtip');
      if(cl<0){tip.classList.remove('show');chIdx=-1;drawChart(mDates(0),-1);return}
      chIdx=cl;
      // Immediate bounce on dot
      doBounce(cl);
      // Show tooltip after 0.5s
      chTimer=setTimeout(()=>{
        if(chIdx!==cl)return;
        const p=chPts[cl];if(!p)return;
        tip.querySelector('.ct-date').textContent=p.date.toLocaleDateString('en',{weekday:'short',month:'short',day:'numeric'});
        tip.querySelector('.ct-pct').textContent=p.pct+'%';
        tip.querySelector('.ct-fill').style.width=p.pct+'%';
        tip.querySelector('.ct-dn').textContent=p.done;
        tip.querySelector('.ct-mn').textContent=p.total-p.done;
        const cr=canvas.getBoundingClientRect();
        let tx=p.x-72;tx=Math.max(4,Math.min(tx,cr.width-155));
        tip.style.left=tx+'px';tip.style.top=(p.y-95)+'px';
        tip.classList.add('show');
      },500);
    }
  };
  canvas.onmouseleave=()=>{
    clearTimeout(chTimer);chIdx=-1;
    const tip=document.getElementById('chtip');if(tip)tip.classList.remove('show');
    drawChart(mDates(0),-1);
  };
}

function doBounce(idx){
  const start=performance.now(),dur=250;
  cancelAnimationFrame(bounceAnim);
  function frame(t){
    const p=(t-start)/dur;
    if(p>=1){drawChart(mDates(0),idx);return}
    // Scale: 1 -> 1.6 -> 1 (spring)
    const s=p<.4?1+1.5*(p/.4):1+1.5*(1-(p-.4)/.6);
    drawChartBounce(mDates(0),idx,s);
    bounceAnim=requestAnimationFrame(frame);
  }
  bounceAnim=requestAnimationFrame(frame);
}

function drawChartBounce(dates,hovIdx,scale){
  const canvas=document.getElementById('cc');if(!canvas||!S.habits.length)return;
  const rates=calcR(dates),dpr=window.devicePixelRatio||1,rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
  canvas.style.width=rect.width+'px';canvas.style.height=rect.height+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const W=rect.width,H=rect.height,pad={t:8,r:8,b:24,l:32},cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
  ctx.clearRect(0,0,W,H);

  for(let i=0;i<=4;i++){const y=pad.t+ch-ch*i/4;ctx.strokeStyle='#1e1f23';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();ctx.fillStyle='#4a4b51';ctx.font='8px "JetBrains Mono",monospace';ctx.textAlign='right';ctx.fillText(i*25+'%',pad.l-5,y+3)}

  const pts=[],vi=rates.map((r,i)=>r!==null?i:-1).filter(i=>i>=0),nv=vi.length;
  if(!nv)return;
  vi.forEach((di,j)=>{const r=rates[di],x=pad.l+(cw/Math.max(nv-1,1))*j,y=pad.t+ch-ch*r.pct/100;pts.push({x,y,pct:r.pct,done:r.done,total:r.total,date:dates[di]})});

  ctx.textAlign='center';ctx.font='8px "JetBrains Mono",monospace';
  const step=Math.max(1,Math.floor(nv/8));
  pts.forEach((p,i)=>{if(i%step===0||i===pts.length-1){ctx.fillStyle=isToday(p.date)?'#818cf8':'#4a4b51';ctx.fillText(p.date.getDate(),p.x,H-5)}});
  if(pts.length<2)return;

  const grad=ctx.createLinearGradient(0,pad.t,0,pad.t+ch);
  grad.addColorStop(0,'rgba(129,140,248,.06)');grad.addColorStop(1,'rgba(129,140,248,0)');
  ctx.beginPath();ctx.moveTo(pts[0].x,pad.t+ch);pts.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.lineTo(pts[pts.length-1].x,pad.t+ch);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
  ctx.beginPath();pts.forEach((p,i)=>{if(!i)ctx.moveTo(p.x,p.y);else ctx.lineTo(p.x,p.y)});
  ctx.strokeStyle='#818cf8';ctx.lineWidth=1.5;ctx.stroke();

  pts.forEach((p,i)=>{
    const r=i===hovIdx?2.5*scale:2.5;
    ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fillStyle='#818cf8';ctx.fill();
    if(i!==hovIdx){ctx.beginPath();ctx.arc(p.x,p.y,1,0,Math.PI*2);ctx.fillStyle='#0b0c0e';ctx.fill()}
  });
}

// Keys
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeMo();document.getElementById('ctx').classList.remove('open')}
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();doUndo()}
});

// Init
load();render();
window.addEventListener('resize',()=>{const c=document.getElementById('cc');if(c)drawChart(mDates(0),-1)});
</script>
</body>
</html>