<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulsar Dashboard</title>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --sp-1: 4px; --sp-2: 8px; --sp-3: 12px; --sp-4: 16px; --sp-6: 24px;
  --surface-0: oklch(0.12 0.02 290);
  --surface-1: oklch(0.15 0.02 290);
  --surface-2: oklch(0.18 0.02 290);
  --surface-3: oklch(0.22 0.02 290);
  --surface-4: oklch(0.26 0.02 290);
  --border:        oklch(0.24 0.01 290);
  --border-subtle: oklch(0.20 0.01 290);
  --text-1: oklch(0.95 0 0);
  --text-2: oklch(0.62 0 0);
  --text-3: oklch(0.40 0 0);
  --accent-blue: oklch(0.6 0.15 260);
  --sidebar-w:    240px;
  --sidebar-w-sm: 60px;
  --topbar-h:     56px;
  --icon-size:    28px;
  --icon-r:       6px;
  --ease:     cubic-bezier(0.4, 0, 0.2, 1);
  --ease-out: cubic-bezier(0.0, 0.0, 0.2, 1);
  --dur:      280ms;
  --dur-fast: 140ms;
}
html, body { width: 100%; height: 100%; background: var(--surface-0); color: var(--text-1);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
  font-size: 13px; line-height: 1.4; -webkit-font-smoothing: antialiased; }
body { display: grid; grid-template-columns: var(--sidebar-w) 1fr;
  grid-template-rows: var(--topbar-h) 1fr;
  transition: grid-template-columns var(--dur) var(--ease); }
body.collapsed { grid-template-columns: var(--sidebar-w-sm) 1fr; }
.sidebar { grid-row: 1/-1; grid-column: 1; background: var(--surface-1);
  border-right: 1px solid var(--border); padding: var(--sp-2);
  display: flex; flex-direction: column; gap: var(--sp-1);
  width: var(--sidebar-w); overflow: hidden;
  transition: width var(--dur) var(--ease); }
body.collapsed .sidebar { width: var(--sidebar-w-sm); }
.profile { display: flex; align-items: center; gap: var(--sp-2);
  padding: 6px var(--sp-2); background: var(--surface-2);
  border-radius: var(--icon-r); flex-shrink: 0; }
.search { display: flex; align-items: center; gap: var(--sp-2);
  padding: var(--sp-2) 14px; background: var(--surface-2);
  border-radius: 32px; margin: var(--sp-2) 0; flex-shrink: 0;
  transition: background var(--dur-fast) var(--ease), gap var(--dur) var(--ease); }
.search:focus-within { background: var(--surface-3); }
body.collapsed .search { gap: 0; padding-right: var(--sp-2); }
.search__icon { color: var(--text-2); flex-shrink: 0; display: flex;
  align-items: center; justify-content: center; width: 14px; height: 14px; }
.search__input { flex: 1; background: none; border: none; outline: none;
  color: var(--text-1); font-size: 12px; font-family: inherit;
  min-width: 0; max-width: 200px;
  transition: opacity var(--dur) var(--ease), max-width var(--dur) var(--ease); }
.search__input::placeholder { color: var(--text-2); }
body.collapsed .search__input { opacity: 0; max-width: 0; pointer-events: none; overflow: hidden; }
.switcher { flex-shrink: 0; position: relative;
  background: transparent; border: 1px solid transparent;
  border-radius: var(--icon-r); overflow: hidden; cursor: pointer;
  transition: border-color var(--dur-fast) var(--ease), background var(--dur-fast) var(--ease); }
.switcher:hover,
body.collapsed .switcher:hover { background: var(--surface-2); border-color: var(--border-subtle); }
.switcher.is-open { background: var(--surface-2); border-color: var(--border); }
.carousel { position: relative; height: 44px; flex-shrink: 0; }
.carousel::after { content: ''; position: absolute; left: var(--sp-2); right: var(--sp-2);
  bottom: 0; height: 1px; background: var(--border-subtle); opacity: 0;
  transition: opacity 200ms var(--ease); }
.switcher.is-open .carousel::after { opacity: 1; }
.carousel__item { position: absolute; inset: 0;
  display: flex; align-items: center; gap: var(--sp-2); padding: 0 var(--sp-2);
  pointer-events: none; z-index: 1;
  transition: opacity var(--dur-fast) var(--ease), transform var(--dur-fast) var(--ease); }
.carousel__item .icon { pointer-events: auto; cursor: pointer; transition: transform 140ms ease, box-shadow 140ms ease; }
.carousel__item .icon:hover { transform: scale(1.08); }
.carousel__item .icon:active { transform: scale(0.96); }
.carousel__item.is-current .icon.icon--active { box-shadow: 0 0 0 2px oklch(0.55 0.12 290); }
.carousel__label-click { pointer-events: auto; cursor: pointer; flex: 1; }
.carousel__overlay { position: absolute; inset: 0; z-index: 10; }
.carousel__controls { position: absolute; right: var(--sp-2); top: 50%;
  transform: translateY(-50%); display: flex; flex-direction: column;
  z-index: 11; opacity: 0; transition: opacity 100ms var(--ease); pointer-events: none; }
.switcher:hover .carousel__controls,
.switcher.is-open .carousel__controls { opacity: 1; pointer-events: auto; }
body.collapsed .carousel__controls { display: none; }
.carousel__btn { width: 16px; height: 14px; border: none; background: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-2); border-radius: 3px;
  transition: color var(--dur-fast) var(--ease); }
.carousel__btn:hover { color: var(--text-1); }
.icon { width: var(--icon-size); height: var(--icon-size); min-width: var(--icon-size);
  border-radius: var(--icon-r);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 600; flex-shrink: 0; }
.label { display: flex; flex-direction: column; overflow: hidden; max-width: 200px;
  transition: opacity var(--dur) var(--ease), max-width var(--dur) var(--ease);
  white-space: nowrap; }
body.collapsed .label { opacity: 0; max-width: 0; pointer-events: none; }
.label__name { font-size: 12px; font-weight: 500; color: var(--text-1);
  overflow: hidden; text-overflow: ellipsis; }
.label__sub { font-size: 11px; color: var(--text-2); }
.pillar-dropdown { overflow: hidden; height: 0; opacity: 0; pointer-events: none;
  transition: height 360ms cubic-bezier(0.16,1,0.3,1); }
.switcher.is-open .pillar-dropdown { pointer-events: auto; }
body.collapsed .pillar-dropdown { height: 0 !important; opacity: 0 !important; pointer-events: none !important; }
.dropdown__content { }
.dropdown__section { padding: var(--sp-1); }
.dropdown__section + .dropdown__section { border-top: 1px solid var(--border-subtle); }
.dropdown__section-label { font-size: 9px; font-weight: 700; color: var(--text-3);
  text-transform: uppercase; letter-spacing: 0.08em; padding: 8px var(--sp-3) 3px; }
.dropdown__item { display: flex; align-items: center; gap: var(--sp-2);
  padding: 5px var(--sp-2); border-radius: 5px; cursor: pointer;
  transition: background var(--dur-fast) var(--ease); }
.dropdown__item:hover { background: var(--surface-3); }
.dropdown__item-icon { width: 22px; height: 22px; min-width: 22px; border-radius: 4px;
  background: var(--surface-3); display: flex; align-items: center;
  justify-content: center; flex-shrink: 0; }
.dropdown__item-name { flex: 1; font-size: 12px; font-weight: 500; color: var(--text-1);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dropdown__item-badge { font-size: 9px; font-weight: 600; padding: 1px 5px;
  border-radius: 20px; background: var(--surface-4); color: var(--text-2); flex-shrink: 0; }
.dropdown__footer { padding: var(--sp-1); border-top: 1px solid var(--border-subtle); }
.dropdown__footer-btn { width: 100%; display: flex; align-items: center; gap: var(--sp-2);
  padding: 5px var(--sp-2); border-radius: 5px; border: none; background: none;
  cursor: pointer; color: var(--text-2); font-size: 11px; font-family: inherit; font-weight: 500;
  transition: background var(--dur-fast) var(--ease), color var(--dur-fast) var(--ease); }
.dropdown__footer-btn:hover { background: var(--surface-3); color: var(--text-1); }
.nav-item { display: flex; align-items: center; gap: var(--sp-2);
  padding: var(--sp-2); border-radius: var(--icon-r); cursor: pointer; flex-shrink: 0;
  transition: background var(--dur-fast) var(--ease); }
.nav-item:hover { background: var(--surface-2); }
.spacer { flex: 1; }
.topbar { grid-row: 1; grid-column: 2; background: var(--surface-1);
  border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 var(--sp-6); }
.breadcrumb { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text-2); flex-wrap: wrap; }
.breadcrumb__sep { color: var(--text-3); font-size: 11px; padding: 0 1px; user-select: none; }
.breadcrumb__link { color: oklch(0.65 0.12 260); text-decoration: none; cursor: pointer; transition: color 120ms; padding: 1px 3px; border-radius: 4px; }
.breadcrumb__link:hover { color: var(--text-1); background: var(--surface-2); }
.breadcrumb__current { color: var(--text-1); font-weight: 500; padding: 1px 3px; }
.main { grid-row: 2; grid-column: 2; background: var(--surface-0); overflow-y: auto; padding: var(--sp-6); }
.toggle { position: fixed; bottom: var(--sp-6); right: var(--sp-6);
  width: 40px; height: 40px; background: var(--surface-2); border: 1px solid var(--border);
  border-radius: var(--icon-r); cursor: pointer; display: flex; align-items: center;
  justify-content: center; color: var(--text-2); font-size: 12px; z-index: 100;
  transition: background var(--dur-fast) var(--ease), color var(--dur-fast) var(--ease); }
.toggle:hover { background: var(--surface-3); color: var(--text-1); }
.content-area { animation: pgIn 220ms cubic-bezier(0.16,1,0.3,1); }
@keyframes pgIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 60vh; gap: var(--sp-3); color: var(--text-3); }
.empty-state__icon { opacity: 0.35; }
.empty-state__text { font-size: 13px; }
.pg-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; }
.pg-title { font-size: 20px; font-weight: 600; color: var(--text-1); letter-spacing: -0.3px; line-height: 1.2; }
.pg-sub { font-size: 12px; color: var(--text-2); margin-top: 3px; }
.pg-badge { font-size: 10px; font-weight: 600; padding: 3px 9px; border-radius: 20px;
  background: var(--surface-3); color: var(--text-2); align-self: flex-start; }
.pg-section { margin-bottom: 24px; }
.pg-section-label { font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.08em; color: var(--text-3); margin-bottom: 10px; }
.cg { display: grid; gap: 10px; }
.cg-1 { grid-template-columns: 1fr; }
.cg-2 { grid-template-columns: repeat(2,1fr); }
.cg-3 { grid-template-columns: repeat(3,1fr); }
.cg-a { grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); }
.card { background: var(--surface-2); border: 1px solid var(--border-subtle);
  border-radius: 10px; padding: 14px; cursor: pointer; position: relative; overflow: hidden;
  transition: background 140ms ease, border-color 140ms ease, transform 140ms ease; }
.card:hover { background: var(--surface-3); border-color: var(--border); transform: translateY(-1px); }
.card-icon { width: 30px; height: 30px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center; margin-bottom: 10px; flex-shrink: 0; }
.card-title { font-size: 12px; font-weight: 600; color: var(--text-1); margin-bottom: 3px; }
.card-sub { font-size: 11px; color: var(--text-2); line-height: 1.4; }
.card-value { font-size: 22px; font-weight: 700; color: var(--text-1); letter-spacing: -0.4px; margin-top: 5px; }
.card-trend { font-size: 10px; color: oklch(0.65 0.14 150); margin-top: 2px; }
.card-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; }
.card-row .card-icon { margin-bottom: 0; }
.card-row .card-body { flex: 1; min-width: 0; }
.card-accent::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px; border-radius: 10px 0 0 10px; background: var(--ca, var(--surface-4)); }
.prog { height: 3px; border-radius: 2px; background: var(--surface-4); margin-top: 10px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 2px; background: var(--ca, var(--accent-blue));
  transition: width 600ms cubic-bezier(0.16,1,0.3,1); }
.tag { display: inline-flex; align-items: center; font-size: 10px; font-weight: 600;
  padding: 2px 7px; border-radius: 20px; background: var(--surface-3); color: var(--text-2); }
.tag-on  { background: oklch(0.22 0.08 150); color: oklch(0.72 0.14 150); }
.tag-new { background: oklch(0.22 0.08 260); color: oklch(0.72 0.14 260); }
.tag-hi  { background: oklch(0.22 0.08 20);  color: oklch(0.72 0.14 20); }
.card-badge { position: absolute; top: 10px; right: 10px; font-size: 9px; font-weight: 700;
  padding: 2px 6px; border-radius: 20px; background: var(--surface-4); color: var(--text-2); }
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: oklch(.22 .02 280); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: oklch(.28 .03 280); }
.calv18-wrap{width:100%;font-family:system-ui,sans-serif;font-size:14px}
.calv18-wrap *{box-sizing:border-box;margin:0;padding:0}
.calv18-wrap ::-webkit-scrollbar{width:5px}
.calv18-wrap ::-webkit-scrollbar-track{background:transparent}
.calv18-wrap ::-webkit-scrollbar-thumb{background:var(--surface-3);border-radius:3px}
.cv18{width:100%;background:var(--surface-1);border-radius:14px;border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;height:620px}
.cv18-hdr{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0}
.cv18-nav{display:flex;gap:5px}
.cv18-nav-btn{width:32px;height:32px;border-radius:6px;border:1px solid var(--border);background:var(--surface-2);color:var(--text-2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.cv18-nav-btn:hover{border-color:oklch(0.6 0.15 260);color:var(--text-1)}
.cv18-nav-btn svg{width:14px;height:14px}
.cv18-title{font-size:1.1rem;font-weight:600;min-width:150px;color:var(--text-1);letter-spacing:-0.01em}
.cv18-title span{color:var(--text-3);font-weight:400;margin-left:5px;font-size:0.9rem}
.cv18-clock{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--surface-2);border-radius:8px;border:1px solid var(--border)}
.cv18-clock-display{font-family:monospace;font-size:0.9rem;font-weight:500;color:var(--text-1);min-width:75px}
.cv18-clock-toggle{width:26px;height:14px;background:var(--surface-3);border-radius:7px;cursor:pointer;position:relative;transition:background 0.2s;flex-shrink:0}
.cv18-clock-toggle.on{background:oklch(0.6 0.15 260)}
.cv18-clock-toggle::after{content:'';position:absolute;top:2px;left:2px;width:10px;height:10px;background:#fff;border-radius:50%;transition:transform 0.2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.cv18-clock-toggle.on::after{transform:translateX(12px)}
.cv18-clock-label{font-size:.6rem;color:var(--text-3)}
.cv18-tabs{display:flex;gap:3px;background:var(--surface-2);padding:3px;border-radius:8px;position:relative;margin-left:auto}
.cv18-tab{padding:6px 13px;border-radius:5px;font-size:.75rem;font-weight:500;color:var(--text-2);cursor:pointer;border:none;background:transparent;position:relative;z-index:1;transition:color 0.2s;font-family:inherit}
.cv18-tab:hover{color:var(--text-1)}
.cv18-tab.on{color:#fff}
.cv18-tab-bg{position:absolute;background:oklch(0.6 0.15 260);border-radius:5px;transition:all 0.3s cubic-bezier(0.22,1,0.36,1);z-index:0}
.cv18-actions{display:flex;gap:8px}
.cv18-btn{height:32px;padding:0 13px;border-radius:6px;border:none;font-size:.75rem;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:inherit;transition:all 0.2s}
.cv18-btn-ghost{background:var(--surface-2);color:var(--text-2);border:1px solid var(--border)}
.cv18-btn-ghost:hover{background:var(--surface-3);color:var(--text-1)}
.cv18-btn-pri{background:oklch(0.6 0.15 260);color:#fff}
.cv18-btn-pri:hover{background:oklch(0.65 0.15 260)}
.cv18-main{flex:1;overflow:hidden;position:relative}
.cv18-view{position:absolute;inset:0;padding:14px 16px;overflow:hidden;display:flex;flex-direction:column}
.cv18-view.anim-zi{animation:cv18zi .25s cubic-bezier(0.22,1,0.36,1)}
.cv18-view.anim-zo{animation:cv18zo .25s cubic-bezier(0.22,1,0.36,1)}
.cv18-view.anim-sl{animation:cv18sl .25s cubic-bezier(0.22,1,0.36,1)}
.cv18-view.anim-sr{animation:cv18sr .25s cubic-bezier(0.22,1,0.36,1)}
@keyframes cv18zi{from{opacity:0;transform:scale(.96)}
to{opacity:1;transform:scale(1)}
}
@keyframes cv18zo{from{opacity:0;transform:scale(1.04)}to{opacity:1;transform:scale(1)}}
@keyframes cv18sl{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes cv18sr{from{opacity:0;transform:translateX(-40px)}to{opacity:1;transform:translateX(0)}}
.cv18-chk{width:17px;height:17px;border-radius:4px;border:2px solid rgba(255,255,255,.25);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;background:transparent}
.cv18-chk:hover{border-color:rgba(255,255,255,.5);transform:scale(1.08)}
.cv18-chk.done{border-color:oklch(.72 .14 150);background:oklch(.72 .14 150)}
.cv18-chk.done::after{content:'✓';font-size:9px;font-weight:700;color:#111}
.cv18-chk.auto{border-color:#666;background:#666;opacity:.7}
.cv18-chk.auto::after{content:'✓';font-size:9px;font-weight:700;color:#333}
.cv18-chk.pop{animation:cv18pop .4s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes cv18pop{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
.cv18-yr-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;overflow-y:auto;flex:1;padding:2px}
.cv18-yr-mo{background:var(--surface-2);border-radius:8px;padding:12px;cursor:pointer;transition:all 0.2s;border:1px solid transparent}
.cv18-yr-mo:hover{border-color:oklch(0.6 0.15 260);transform:translateY(-2px)}
.cv18-yr-mo-name{font-size:.8rem;font-weight:600;color:var(--text-2);margin-bottom:8px}
.cv18-yr-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;font-size:.55rem;color:var(--text-3)}
.cv18-yr-d{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:3px}
.cv18-yr-d.ev{background:oklch(.22 .06 260);color:oklch(.72 .14 260)}
.cv18-yr-d.td{background:oklch(0.6 0.15 260);color:#fff;font-weight:600}
.cv18-mo-wrap{display:flex;flex-direction:column;flex:1;overflow:hidden}
.cv18-mo-hdr{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:6px;flex-shrink:0}
.cv18-mo-hdr span{font-size:.65rem;font-weight:600;color:var(--text-3);text-align:center;padding:5px 0;text-transform:uppercase;letter-spacing:.5px}
.cv18-mo-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;flex:1;overflow-y:auto}
.cv18-mo-day{min-height:68px;background:var(--surface-2);border-radius:6px;padding:7px;cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;border:1px solid transparent}
.cv18-mo-day:hover{background:var(--surface-3);border-color:var(--border)}
.cv18-mo-day.ot{opacity:.3}
.cv18-mo-day.td{border-color:oklch(0.6 0.15 260)}
.cv18-mo-day-num{font-size:.85rem;font-weight:600;color:var(--text-2);margin-bottom:auto}
.cv18-mo-day.td .cv18-mo-day-num{color:oklch(.72 .14 260)}
.cv18-dot-pill{display:inline-flex;align-items:center;gap:3px;padding:3px 6px;background:var(--surface-3);border-radius:20px;margin-top:5px;cursor:pointer;transition:all 0.2s}
.cv18-dot-pill:hover{background:var(--surface-4)}
.cv18-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;transition:all 0.2s}
.cv18-dot.done{background:#555!important}
.cv18-dot-more{font-size:.55rem;color:var(--text-3);margin-left:2px}
.cv18-wk-wrap{display:flex;flex-direction:column;flex:1;min-height:0}
.cv18-wk-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;flex:1;min-height:0}
.cv18-wk-col{background:var(--surface-2);border-radius:8px;display:flex;flex-direction:column;min-width:0;min-height:0;transition:all 0.2s;border:1px solid transparent}
.cv18-wk-col:hover{background:var(--surface-3)}
.cv18-wk-hdr{padding:9px 7px;text-align:center;border-bottom:1px solid var(--border);flex-shrink:0}
.cv18-wk-hdr .nm{font-size:.65rem;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}
.cv18-wk-hdr .dt{font-size:1.1rem;font-weight:600;color:var(--text-2);margin-top:2px}
.cv18-wk-col.td{border-color:oklch(0.6 0.15 260)}
.cv18-wk-col.td .cv18-wk-hdr .nm,.cv18-wk-col.td .cv18-wk-hdr .dt{color:oklch(.72 .14 260)}
.cv18-wk-body{padding:5px;flex:1;display:flex;flex-direction:column;gap:4px;overflow-y:auto;min-height:0}
.cv18-wk-ev{padding:7px 9px;border-radius:5px;cursor:pointer;transition:all 0.2s;display:flex;align-items:flex-start;gap:7px;flex-shrink:0}
.cv18-wk-ev:hover{filter:brightness(1.1);transform:translateX(2px)}
.cv18-wk-ev .info{flex:1;min-width:0}
.cv18-wk-ev .title{font-size:.75rem;font-weight:500;color:#fff;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cv18-wk-ev .time{font-size:.6rem;color:rgba(255,255,255,.6);margin-top:2px}
.cv18-wk-ev.done{background:oklch(.16 .04 150)!important;border:1px solid oklch(.3 .08 150)}
.cv18-wk-ev.done .title{color:oklch(.72 .14 150);text-decoration:line-through}
.cv18-wk-ev.auto{background:rgba(80,80,80,.1)!important;border:1px solid rgba(80,80,80,.2)}
.cv18-wk-ev.auto .title{color:#666;text-decoration:line-through}
.cv18-wk-empty{flex:1;display:flex;align-items:center;justify-content:center;color:var(--text-3);font-size:.75rem}
.cv18-day-wrap{display:flex;flex-direction:column;flex:1;overflow:hidden}
.cv18-day-hdr{display:flex;align-items:center;gap:14px;padding-bottom:10px;flex-shrink:0;flex-wrap:wrap}
.cv18-day-big{text-align:center;padding:9px 14px;background:var(--surface-2);border-radius:8px;border:1px solid var(--border)}
.cv18-day-big .num{font-size:2rem;font-weight:700;color:oklch(0.6 0.15 260);line-height:1}
.cv18-day-big .wd{font-size:.6rem;color:var(--text-3);text-transform:uppercase;margin-top:3px;font-weight:500}
.cv18-day-meta{flex:1}
.cv18-day-meta .full{font-size:.95rem;font-weight:600;color:var(--text-1)}
.cv18-day-meta .sub{font-size:.75rem;color:var(--text-2);margin-top:2px}
.cv18-day-prog{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--surface-2);border-radius:8px;border:1px solid var(--border)}
.cv18-prog-ring{width:42px;height:42px;position:relative}
.cv18-prog-ring svg{transform:rotate(-90deg);width:42px;height:42px}
.cv18-prog-ring circle{fill:none;stroke-width:5;stroke-linecap:round}
.cv18-prog-ring .bg{stroke:var(--surface-3)}
.cv18-prog-ring .fill{stroke:oklch(.72 .14 150);transition:stroke-dashoffset .5s}
.cv18-prog-ring .pct{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:600;color:var(--text-1)}
.cv18-prog-info .label{font-size:.6rem;color:var(--text-3);text-transform:uppercase}
.cv18-prog-info .detail{font-size:.8rem;color:var(--text-2);margin-top:1px}
.cv18-day-body{display:flex;gap:14px;flex:1;overflow:hidden}
.cv18-day-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.cv18-day-allday{background:var(--surface-2);border-radius:8px;padding:7px 9px;margin-bottom:8px;flex-shrink:0;border:1px solid var(--border)}
.cv18-day-allday-title{font-size:.6rem;color:var(--text-3);text-transform:uppercase;margin-bottom:5px}
.cv18-day-allday-list{display:flex;flex-wrap:wrap;gap:5px}
.cv18-day-allday-ev{padding:5px 9px;border-radius:5px;font-size:.75rem;color:#fff;cursor:pointer;display:flex;align-items:center;gap:7px;transition:all 0.2s}
.cv18-day-allday-ev:hover{filter:brightness(1.1)}
.cv18-day-allday-ev.done{background:oklch(.14 .04 150)!important;border:1px solid oklch(.28 .08 150)}
.cv18-day-allday-ev.done span{color:oklch(.72 .14 150);text-decoration:line-through}
.cv18-day-allday-ev.auto{background:rgba(80,80,80,.1)!important;border:1px solid rgba(80,80,80,.2)}
.cv18-day-allday-ev.auto span{color:#666;text-decoration:line-through}
.cv18-day-scroll{flex:1;overflow-y:auto;background:var(--surface-2);border-radius:8px;scroll-behavior:smooth;border:1px solid var(--border)}
.cv18-day-grid{display:grid;grid-template-columns:48px 1fr;position:relative}
.cv18-day-times{display:flex;flex-direction:column}
.cv18-day-time{height:52px;font-size:.6rem;color:var(--text-3);text-align:right;padding-right:7px;padding-top:2px;border-top:1px solid var(--border);font-family:monospace}
.cv18-day-time:first-child{border-top:none}
.cv18-day-hours{position:relative}
.cv18-day-hour{height:52px;border-top:1px solid var(--border);border-left:1px solid var(--border);transition:background .15s}
.cv18-day-hour:first-child{border-top:none}
.cv18-day-hour:hover{background:oklch(.22 .04 260);cursor:pointer}
.cv18-now-line{position:absolute;left:0;right:0;height:2px;background:oklch(0.6 0.15 260);z-index:100;pointer-events:none}
.cv18-now-dot{position:absolute;left:-4px;top:-3px;width:8px;height:8px;background:oklch(0.6 0.15 260);border-radius:50%}
.cv18-day-ev{position:absolute;left:6px;width:calc(100% - 12px);max-width:70%;border-radius:5px;padding:6px 7px;cursor:pointer;transition:all 0.2s;overflow:hidden;z-index:1}
.cv18-day-ev:hover{filter:brightness(1.1);transform:translateX(2px);z-index:10}
.cv18-day-ev .top{display:flex;align-items:flex-start;gap:7px}
.cv18-day-ev .info{flex:1;min-width:0}
.cv18-day-ev .title{font-size:.78rem;font-weight:500;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cv18-day-ev .time{font-size:.62rem;color:rgba(255,255,255,.6);margin-top:2px}
.cv18-day-ev.done{background:oklch(.14 .04 150)!important;border:1px solid oklch(.28 .08 150)}
.cv18-day-ev.done .title{color:oklch(.72 .14 150);text-decoration:line-through}
.cv18-day-ev.auto{background:rgba(80,80,80,.1)!important;border:1px solid rgba(80,80,80,.2)}
.cv18-day-ev.auto .title{color:#666;text-decoration:line-through}
.cv18-day-ev.small .time{display:none}
.cv18-day-side{width:170px;flex-shrink:0;display:flex;flex-direction:column;gap:9px}
.cv18-insights{background:var(--surface-2);border-radius:8px;padding:11px;border:1px solid var(--border)}
.cv18-insights-title{font-size:.6rem;font-weight:600;color:var(--text-3);text-transform:uppercase;margin-bottom:9px;display:flex;align-items:center;gap:5px}
.cv18-insight-item{display:flex;align-items:center;gap:7px;padding:5px 0;border-bottom:1px solid var(--border)}
.cv18-insight-item:last-child{border-bottom:none}
.cv18-insight-icon{width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.7rem;background:var(--surface-3)}
.cv18-insight-text{flex:1;font-size:.7rem;color:var(--text-2);line-height:1.4}
.cv18-day-notes{background:var(--surface-2);border-radius:8px;padding:11px;flex:1;display:flex;flex-direction:column;border:1px solid var(--border)}
.cv18-day-notes-title{font-size:.6rem;font-weight:600;color:var(--text-3);text-transform:uppercase;margin-bottom:7px}
.cv18-day-notes textarea{flex:1;width:100%;background:transparent;border:none;color:var(--text-1);font-size:.75rem;font-family:inherit;resize:none;line-height:1.6}
.cv18-day-notes textarea:focus{outline:none}
.cv18-day-notes textarea::placeholder{color:var(--text-3)}
.cv18-c-work{background:#3b82f6}
.cv18-c-personal{background:#8b5cf6}
.cv18-c-health{background:#10b981}
.cv18-c-urgent{background:#ef4444}
.cv18-c-meeting{background:#f59e0b}
.cv18-c-default{background:#6366f1}
.cv18-c-school{background:#64748b}
.cv18-c-skill{background:#06b6d4}
.cv18-c-pulsar{background:#ec4899}
.cv18-c-worship{background:#14b8a6}
.cv18-c-fun{background:#f97316}
.cv18-c-routine{background:#71717a}
.cv18-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0);display:flex;align-items:center;justify-content:center;z-index:9000;pointer-events:none;transition:background 0.25s}
.cv18-modal-bg.on{background:rgba(0,0,0,.7);pointer-events:auto}
.cv18-modal{background:var(--surface-1);border-radius:12px;width:100%;max-width:380px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.6);transform:scale(.95) translateY(20px);opacity:0;transition:all .25s cubic-bezier(0.22,1,0.36,1);border:1px solid var(--border)}
.cv18-modal-bg.on .cv18-modal{transform:scale(1) translateY(0);opacity:1}
.cv18-modal-hdr{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.cv18-modal-hdr h3{font-size:.95rem;font-weight:600;color:var(--text-1)}
.cv18-modal-x{width:26px;height:26px;border:none;background:var(--surface-3);color:var(--text-2);cursor:pointer;border-radius:5px;font-size:1rem;transition:all 0.2s;display:flex;align-items:center;justify-content:center}
.cv18-modal-x:hover{background:rgba(252,165,165,.1);color:oklch(.72 .14 20)}
.cv18-modal-body{padding:18px;max-height:360px;overflow-y:auto}
.cv18-fg{margin-bottom:12px}
.cv18-fg:last-child{margin-bottom:0}
.cv18-fg label{display:block;font-size:.68rem;font-weight:500;color:var(--text-2);margin-bottom:5px;text-transform:uppercase}
.cv18-fg input,.cv18-fg select{width:100%;padding:9px 11px;border-radius:5px;border:1px solid var(--border);background:var(--surface-2);color:var(--text-1);font-size:.82rem;font-family:inherit;transition:all 0.2s}
.cv18-fg input:focus,.cv18-fg select:focus{outline:none;border-color:oklch(0.6 0.15 260)}
.cv18-fg-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.cv18-fg-colors{display:flex;flex-wrap:wrap;gap:6px;margin-top:7px}
.cv18-fg-color{width:22px;height:22px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all 0.2s}
.cv18-fg-color:hover{transform:scale(1.1)}
.cv18-fg-color.on{border-color:#fff;transform:scale(1.1)}
.cv18-modal-ft{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:8px}
.cv18-modal-ft .cv18-btn{flex:1;justify-content:center;height:36px}
.cv18-btn-del{background:rgba(252,165,165,.1);color:oklch(.72 .14 20)}
.cv18-btn-del:hover{background:oklch(.65 .14 20);color:#fff}
.cv18-toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface-3);border:1px solid var(--border);padding:9px 18px;border-radius:8px;font-size:.8rem;z-index:9001;transition:all .3s;opacity:0;box-shadow:0 8px 32px rgba(0,0,0,.4);color:var(--text-1)}
.cv18-toast.on{transform:translateX(-50%) translateY(0);opacity:1}
.cv18-tooltip{position:fixed;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:5px;z-index:9002;min-width:170px;max-width:210px;opacity:0;visibility:hidden;transition:opacity .15s;box-shadow:0 8px 32px rgba(0,0,0,.4);pointer-events:none}
.cv18-tooltip.show{opacity:1;visibility:visible;pointer-events:auto}
.cv18-tip-item{padding:5px 7px;font-size:.7rem;display:flex;align-items:center;gap:7px;border-radius:4px;cursor:pointer}
.cv18-tip-item:hover{background:var(--surface-3)}
.cv18-tip-item .cv18-dot{width:5px;height:5px;flex-shrink:0}
.cv18-tip-item .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text-2)}
.cv18-tip-item.done .name{color:var(--text-3);text-decoration:line-through}
.cv18-tip-item .time{font-size:.6rem;color:var(--text-3)}
.ga{width:100%;font-family:var(--font,'Outfit',system-ui,sans-serif);color:var(--text-1)}
.ga *{box-sizing:border-box}
.ga-wrap{display:grid;grid-template-columns:1fr 280px;gap:0;min-height:580px}
.ga-list{padding:16px 20px 16px 0;overflow-y:auto;border-right:1px solid var(--border)}
.ga-side{padding:16px 0 16px 20px;overflow-y:auto}
.ga-btn-add{background:oklch(.55 .18 290);color:#fff;border:none;border-radius:8px;padding:7px 14px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;display:flex;align-items:center;gap:5px;box-shadow:0 2px 12px oklch(.3 .15 290 / .4)}
.ga-btn-add:hover{background:oklch(.6 .18 290);transform:translateY(-1px)}
.ga-empty{display:flex;flex-direction:column;align-items:center;padding:60px 20px;text-align:center;color:var(--text-3)}
.ga-empty svg{margin-bottom:14px;opacity:.4}
.ga-empty h3{font-size:15px;font-weight:600;color:var(--text-2);margin-bottom:6px}
.ga-empty p{font-size:12px;line-height:1.55;max-width:260px}
.ga-card{background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:8px;transition:border-color .12s,background .12s;position:relative;cursor:default}
.ga-card:hover{border-color:var(--border-hover,oklch(.3 .04 280));background:var(--surface-3)}
.ga-card.done{opacity:.5}
.ga-card.done:hover{opacity:.7}
.ga-card.exiting{animation:gaExit .26s cubic-bezier(.4,0,1,1) forwards;pointer-events:none}
.ga-card.settling{animation:gaSettle .35s cubic-bezier(.34,1.15,.64,1) both;outline:1px solid oklch(.3 .08 290);outline-offset:-1px}
@keyframes gaExit{to{opacity:0;transform:translateY(18px) scale(.97)}}
@keyframes gaSettle{from{opacity:0;transform:translateY(-12px) scale(.98)}to{opacity:1;transform:none}}
.ga-card-top{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px}
.ga-chk{width:18px;height:18px;border-radius:50%;border:1.5px solid var(--border-hover,oklch(.3 .06 280));cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;transition:all .12s}
.ga-chk:hover{border-color:oklch(.72 .14 150);background:oklch(.18 .05 150)}
.ga-chk.on{border-color:oklch(.72 .14 150);background:oklch(.72 .14 150)}
.ga-chk svg{opacity:0;transition:opacity .1s;width:10px;height:10px;color:#111}
.ga-chk.on svg{opacity:1}
.ga-card-body{flex:1;min-width:0}
.ga-title{font-size:13.5px;font-weight:600;color:var(--text-1);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-.1px}
.ga-card.done .ga-title{text-decoration:line-through;color:var(--text-3)}
.ga-desc{font-size:11.5px;color:var(--text-3);line-height:1.45;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.ga-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.ga-tag{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:3px 7px;border-radius:4px}
.ga-tag.work{background:oklch(.2 .06 260);color:oklch(.72 .14 260)}
.ga-tag.personal{background:oklch(.22 .06 60);color:oklch(.82 .14 60)}
.ga-tag.health{background:oklch(.2 .06 150);color:oklch(.72 .14 150)}
.ga-tag.learning{background:oklch(.2 .06 290);color:oklch(.8 .14 290)}
.ga-tag.finance{background:oklch(.2 .06 150);color:oklch(.72 .14 150)}
.ga-tag.creative{background:oklch(.2 .06 320);color:oklch(.78 .14 320)}
.ga-pri{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:3px 7px;border-radius:4px}
.ga-pri.high{background:oklch(.2 .05 20);color:oklch(.72 .14 20)}
.ga-pri.medium{background:oklch(.22 .06 60);color:oklch(.82 .14 60)}
.ga-pri.low{background:oklch(.2 .06 150);color:oklch(.72 .14 150)}
.ga-date{font-size:9px;color:var(--text-4,oklch(.35 .03 280));display:flex;align-items:center;gap:3px}
.ga-date.overdue{color:oklch(.72 .14 20)}
.ga-date.soon{color:oklch(.82 .14 60)}
.ga-prog{margin-top:10px}
.ga-prog-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.ga-prog-lbl{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}
.ga-prog-pct{font-size:10px;font-weight:600;color:var(--text-2)}
.ga-bar{height:3px;background:var(--surface-4,oklch(.2 .02 280));border-radius:2px;overflow:hidden}
.ga-fill{height:100%;border-radius:2px;transition:width .35s cubic-bezier(.4,0,.2,1);background:linear-gradient(90deg,oklch(.55 .18 290),oklch(.7 .14 290))}
.ga-fill.full{background:linear-gradient(90deg,oklch(.55 .18 150),oklch(.7 .14 150))}
.ga-subs{margin-top:10px;padding-top:8px;border-top:1px solid var(--border)}
.ga-sub-toggle{background:none;border:none;color:var(--text-3);font-size:10px;font-weight:500;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:5px;padding:0;margin-bottom:6px;transition:color .1s}
.ga-sub-toggle:hover{color:var(--text-2)}
.ga-sub-toggle .arr{transition:transform .15s;display:flex;align-items:center;color:var(--text-4,oklch(.35 .03 280))}
.ga-sub-toggle .arr.open{transform:rotate(90deg)}
.ga-sub-list.collapsed{display:none}
.ga-sub{display:flex;align-items:center;gap:8px;padding:4px 0 4px 10px;border-left:2px solid var(--border);transition:border-color .1s,background .1s;cursor:pointer;border-radius:0 4px 4px 0}
.ga-sub:hover{border-color:oklch(.3 .06 280);background:oklch(.18 .03 280 / .5)}
.ga-subck{width:14px;height:14px;border-radius:4px;border:1.5px solid oklch(.3 .04 280);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .1s}
.ga-subck:hover{border-color:oklch(.72 .14 150);background:oklch(.18 .05 150)}
.ga-subck.on{border-color:oklch(.72 .14 150);background:oklch(.72 .14 150)}
.ga-subck svg{opacity:0;width:8px;height:8px;color:#111;transition:opacity .1s}
.ga-subck.on svg{opacity:1}
.ga-subname{font-size:11.5px;color:var(--text-2);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ga-subname.done{text-decoration:line-through;color:var(--text-3)}
.ga-add-sub{display:flex;align-items:center;gap:6px;margin-top:6px;padding-left:2px}
.ga-add-sub input{flex:1;background:var(--surface-3);border:1px solid var(--border);border-radius:5px;padding:5px 8px;color:var(--text-1);font-size:11px;font-family:inherit;outline:none}
.ga-add-sub input:focus{border-color:oklch(.55 .18 290);box-shadow:0 0 0 2px oklch(.22 .06 290)}
.ga-add-sub button{background:oklch(.55 .18 290);color:#fff;border:none;border-radius:5px;width:22px;height:22px;font-size:14px;cursor:pointer;display:grid;place-items:center;font-family:inherit;transition:all .1s;flex-shrink:0}
.ga-add-sub button:hover{background:oklch(.6 .18 290)}
.ga-actions{position:absolute;top:12px;right:12px;display:flex;gap:4px;opacity:0;transition:opacity .1s}
.ga-card:hover .ga-actions{opacity:1}
.ga-actions button{background:var(--surface-3);border:1px solid var(--border);color:var(--text-3);width:24px;height:24px;border-radius:5px;cursor:pointer;display:grid;place-items:center;transition:all .1s}
.ga-actions button:hover{background:var(--surface-4,oklch(.2 .02 280));color:var(--text-1)}
.ga-actions .ga-delbtn:hover{background:oklch(.2 .05 20);color:oklch(.72 .14 20);border-color:oklch(.3 .08 20)}
.ga-sb-section{margin-bottom:22px}
.ga-sb-title{font-size:9px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px}
.ga-avg{background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px}
.ga-avg-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px}
.ga-avg-num{font-size:32px;font-weight:700;letter-spacing:-2px;color:var(--text-1);line-height:1}
.ga-avg-num span{font-size:14px;color:var(--text-3);font-weight:400}
.ga-avg-lbl{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}
.ga-avg-bar{height:4px;background:var(--surface-4,oklch(.2 .02 280));border-radius:2px;overflow:hidden}
.ga-avg-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,oklch(.55 .18 290),oklch(.7 .14 290));transition:width .6s cubic-bezier(.4,0,.2,1)}
.ga-cat-chip{font-size:9px;font-weight:600;padding:2px 6px;border-radius:4px;flex-shrink:0}
.ga-dl-item{padding:8px 0;border-bottom:1px solid var(--border)}
.ga-dl-item:last-child{border-bottom:none}
.ga-dl-body{display:flex;flex-direction:column;gap:4px}
.ga-dl-name{font-size:11.5px;font-weight:500;color:var(--text-1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ga-dl-meta{display:flex;align-items:center;gap:6px}
.ga-dl-date{font-size:9px;color:var(--text-3)}
.ga-dl-badge{font-size:8.5px;font-weight:600;padding:2px 6px;border-radius:4px;text-transform:uppercase;letter-spacing:.3px}
.ga-cat-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.ga-cat-lbl{font-size:11px;color:var(--text-2);width:60px;flex-shrink:0;text-transform:capitalize}
.ga-cat-bar{flex:1;height:3px;background:var(--surface-3);border-radius:2px;overflow:hidden}
.ga-cat-fill{height:100%;border-radius:2px;transition:width .5s cubic-bezier(.4,0,.2,1)}
.ga-cat-n{font-size:9px;color:var(--text-3);width:14px;text-align:right;flex-shrink:0}
.ga-mo{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9010;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .12s;backdrop-filter:blur(8px)}
.ga-mo.open{opacity:1;pointer-events:auto}
.ga-mbox{background:var(--surface-1);border:1px solid oklch(.28 .06 280);border-radius:14px;padding:24px;width:420px;max-height:88vh;overflow-y:auto;transform:scale(.94);transition:transform .15s cubic-bezier(.4,0,.2,1);box-shadow:0 20px 60px rgba(0,0,0,.6)}
.ga-mo.open .ga-mbox{transform:scale(1)}
.ga-mbox h3{font-size:14px;font-weight:600;margin-bottom:18px;letter-spacing:-.2px}
.ga-mbox label{display:block;font-size:9px;color:var(--text-3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px;font-weight:600}
.ga-mbox input,.ga-mbox textarea,.ga-mbox select{width:100%;background:var(--surface-3);border:1px solid var(--border);border-radius:7px;padding:8px 11px;color:var(--text-1);font-size:13px;font-family:inherit;outline:none;margin-bottom:12px;transition:border-color .12s;resize:none}
.ga-mbox input:focus,.ga-mbox textarea:focus,.ga-mbox select:focus{border-color:oklch(.55 .18 290);box-shadow:0 0 0 2px oklch(.22 .06 290)}
.ga-mbox textarea{height:64px;line-height:1.45}
.ga-mbox .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ga-macts{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
.ga-macts button{padding:7px 18px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;border:none;transition:all .12s}
.ga-macts .cancel{background:var(--surface-3);color:var(--text-2);border:1px solid var(--border)}
.ga-macts .cancel:hover{background:var(--surface-4,oklch(.2 .02 280))}
.ga-macts .save{background:oklch(.55 .18 290);color:#fff;box-shadow:0 2px 10px oklch(.3 .15 290 / .4)}
.ga-macts .save:hover{background:oklch(.6 .18 290)}
.ga-prog-wrap{margin-bottom:12px}
.ga-prog-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.ga-prog-header span{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.6px;font-weight:600}
.ga-prog-header em{font-style:normal;font-size:11px;font-weight:600;color:oklch(.7 .14 290)}
.ga-prog-track{width:100%;height:5px;background:var(--surface-3);border-radius:3px;position:relative;cursor:pointer;overflow:hidden}
.ga-prog-fill-track{height:100%;border-radius:3px;background:linear-gradient(90deg,oklch(.55 .18 290),oklch(.7 .14 290));transition:width .1s;pointer-events:none}
.ga-prog-range{position:absolute;inset:0;width:100%;height:100%;-webkit-appearance:none;appearance:none;background:transparent;outline:none;cursor:pointer;margin:0}
.ga-prog-range::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:oklch(.7 .14 290);cursor:pointer;border:2px solid var(--surface-1);box-shadow:0 0 5px oklch(.4 .14 290 / .6)}
.ga-prog-note{font-size:9px;color:var(--text-3);margin-top:4px}
.ga-confirm-mo{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:9020;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s;backdrop-filter:blur(10px)}
.ga-confirm-mo.open{opacity:1;pointer-events:auto}
.ga-confirm-box{background:var(--surface-2);border:1px solid oklch(.28 .06 280);border-radius:14px;padding:22px;width:320px;transform:scale(.93) translateY(8px);transition:transform .18s cubic-bezier(.34,1.3,.64,1);box-shadow:0 12px 48px rgba(0,0,0,.6)}
.ga-confirm-mo.open .ga-confirm-box{transform:scale(1) translateY(0)}
.ga-confirm-icon{width:36px;height:36px;border-radius:9px;background:oklch(.2 .05 20);border:1px solid oklch(.3 .08 20);display:grid;place-items:center;color:oklch(.72 .14 20);margin-bottom:12px}
.ga-confirm-title{font-size:14px;font-weight:600;color:var(--text-1);margin-bottom:5px}
.ga-confirm-desc{font-size:11.5px;color:var(--text-3);line-height:1.5;margin-bottom:18px}
.ga-confirm-desc strong{color:var(--text-2)}
.ga-confirm-acts{display:flex;gap:8px;justify-content:flex-end}
.ga-confirm-acts button{padding:7px 16px;border-radius:7px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;border:none;transition:all .12s}
.ga-cc{background:var(--surface-3);color:var(--text-2);border:1px solid var(--border)!important}
.ga-cc:hover{background:var(--surface-4,oklch(.2 .02 280))}
.ga-cd{background:oklch(.72 .14 20);color:#fff}
.ga-cd:hover{background:oklch(.76 .14 20)}
.ga-undo{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--surface-3);border:1px solid oklch(.28 .06 280);border-radius:10px;padding:8px 14px;font-size:11px;color:var(--text-2);display:flex;align-items:center;gap:10px;z-index:9030;transition:transform .25s cubic-bezier(.4,0,.2,1);box-shadow:0 8px 32px rgba(0,0,0,.5)}
.ga-undo.show{transform:translateX(-50%) translateY(0)}
.ga-undo button{background:oklch(.55 .18 290);color:#fff;border:none;border-radius:5px;padding:3px 10px;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit}
.ha{width:100%;font-family:var(--font,'Outfit',system-ui,sans-serif);color:var(--text-1)}
.ha *{box-sizing:border-box}
.ha-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.ha-hdr-r{display:flex;align-items:center;gap:8px}
.ha-nav{display:flex;align-items:center;background:var(--surface-2);border:1px solid var(--border);border-radius:8px;padding:3px;gap:1px}
.ha-nav button{background:none;border:none;color:var(--text-3);cursor:pointer;width:28px;height:28px;border-radius:6px;font-size:15px;transition:all .12s;display:grid;place-items:center}
.ha-nav button:hover{color:var(--text-1);background:var(--surface-3)}
.ha-nav .ha-lbl{font-size:16px;font-weight:700;color:var(--text-1);padding:0 14px;min-width:150px;text-align:center;letter-spacing:-.4px}
.ha-btn-today{background:var(--surface-2);border:1px solid var(--border);color:var(--text-2);border-radius:7px;padding:4px 10px;font-size:10px;font-weight:500;cursor:pointer;font-family:inherit;transition:all .12s}
.ha-btn-today:hover{border-color:oklch(.6 .18 290);color:oklch(.8 .14 290)}
.ha-btn-today.hidden{display:none}
.ha-btn-add{background:oklch(.55 .18 290);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;display:flex;align-items:center;gap:5px;box-shadow:0 2px 10px oklch(.3 .15 290 / .35)}
.ha-btn-add:hover{background:oklch(.6 .18 290);transform:translateY(-1px)}
.ha-empty{display:flex;flex-direction:column;align-items:center;padding:70px 20px;text-align:center}
.ha-empty-i{font-size:36px;margin-bottom:14px;opacity:.6}
.ha-empty h3{font-size:15px;font-weight:600;margin-bottom:6px}
.ha-empty p{font-size:12px;color:var(--text-3);max-width:260px;line-height:1.55;margin-bottom:20px}
.ha-empty button{background:oklch(.55 .18 290);color:#fff;border:none;border-radius:8px;padding:8px 20px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
.ha-gw{overflow-x:auto;border:1px solid var(--border);border-radius:10px;background:var(--surface-2)}
.ha-table{width:100%;border-collapse:collapse;table-layout:fixed;min-width:640px}
.ha-table th,.ha-table td{text-align:center;vertical-align:middle}
.ha-table thead th{font-size:9px;font-weight:600;color:var(--text-3);padding:11px 0 9px;border-bottom:1px solid var(--border);text-transform:uppercase;letter-spacing:.5px}
.ha-table thead th.ha-hth{text-align:left;padding-left:14px;font-size:10px;min-width:155px;width:155px;position:sticky;left:0;background:var(--surface-2);z-index:2}
.ha-table thead th.ha-dth{min-width:34px;width:34px;padding:11px 0 7px}
.ha-table thead th.ha-dth .ha-dn{display:block;font-size:10px;font-weight:700;margin-top:2px;color:var(--text-3)}
.ha-table thead th.ha-tdy{color:oklch(.7 .14 290)}
.ha-table thead th.ha-tdy .ha-dn{color:oklch(.7 .14 290)}
.ha-table tbody tr{transition:background .08s}
.ha-table tbody tr:hover{background:oklch(1 0 0 / .01)}
.ha-table td{border-bottom:1px solid var(--border);height:40px;padding:0}
.ha-table td.ha-hc{text-align:left;padding:0 10px 0 14px;position:sticky;left:0;background:var(--surface-2);z-index:1}
.ha-table tbody tr:hover td.ha-hc{background:var(--surface-3)}
.ha-hi{display:flex;align-items:center;gap:8px;cursor:grab}
.ha-hi:active{cursor:grabbing}
.ha-he{font-size:14px;flex-shrink:0;width:20px;text-align:center}
.ha-hn{font-size:12px;font-weight:450;color:var(--text-1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px}
.ha-table td.ha-dtd{padding:2px;text-align:center;vertical-align:middle}
.ha-table td.ha-tdy-td{background:oklch(.6 .18 290 / .04)}
.ha-c{width:22px;height:22px;border-radius:6px;margin:0 auto;display:flex;align-items:center;justify-content:center;transition:all .1s;border:1.5px solid var(--border);user-select:none;-webkit-user-select:none;position:relative}
.ha-c.ha-active{cursor:pointer}
.ha-c.ha-active:hover{border-color:var(--border-hover,oklch(.3 .04 280));background:var(--surface-3);transform:scale(1.12)}
.ha-c.ha-done{background:oklch(.72 .14 150 / .12);border-color:oklch(.72 .14 150 / .3)}
.ha-c.ha-done .ha-ck{opacity:1;transform:scale(1)}
.ha-c.ha-locked{cursor:default;opacity:.28}
.ha-c.ha-locked.ha-done{opacity:.5}
.ha-ck{opacity:0;transform:scale(.3);transition:all .15s cubic-bezier(.34,1.56,.64,1);color:oklch(.72 .14 150);display:flex;pointer-events:none}
.ha-ck svg{width:11px;height:11px}
@keyframes haPop{0%{transform:scale(1)}40%{transform:scale(1.1)}100%{transform:scale(1)}}
.ha-c.ha-pop{animation:haPop .2s ease-out}
.ha-add-row td{border-bottom:none;height:40px}
.ha-add-btn{background:none;border:1px dashed var(--border);border-radius:7px;color:var(--text-3);font-size:10px;cursor:pointer;padding:4px 12px;font-family:inherit;transition:all .12s;display:inline-flex;align-items:center;gap:5px;font-weight:500}
.ha-add-btn:hover{border-color:oklch(.55 .18 290);color:oklch(.7 .14 290)}
.ha-sum{margin-top:22px;display:grid;grid-template-columns:1fr 220px;gap:16px;align-items:stretch}
.ha-chbox{background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:18px}
.ha-chbox h4{font-size:9px;color:var(--text-3);font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-bottom:14px}
.ha-ccw{position:relative;height:148px}
.ha-ccw canvas{width:100%;height:100%;display:block}
.ha-stats{display:flex;flex-direction:column;gap:8px;height:100%}
.ha-sc{background:var(--surface-2);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.ha-sc:last-child{flex:1}
.ha-sc .ha-sl{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.6px;font-weight:600;margin-bottom:4px}
.ha-sc .ha-sv{font-size:26px;font-weight:700;letter-spacing:-1px}
.ha-sc .ha-ss{font-size:9px;color:var(--text-3);margin-top:3px}
.ha-sc.grn .ha-sv{color:oklch(.72 .14 150)}
.ha-sc.amb .ha-sv{color:oklch(.82 .14 60)}
.ha-chtip{position:absolute;z-index:20;background:var(--surface-3);border:1px solid var(--border-hover,oklch(.28 .04 280));border-radius:10px;padding:11px 13px;pointer-events:none;opacity:0;transition:opacity .15s,transform .15s;box-shadow:0 8px 24px rgba(0,0,0,.4);min-width:138px;transform:translateY(4px)}
.ha-chtip.show{opacity:1;transform:translateY(0)}
.ha-chtip .ha-ct-date{font-size:9px;font-weight:600;color:var(--text-2);margin-bottom:6px}
.ha-chtip .ha-ct-pct{font-size:20px;font-weight:700;color:oklch(.7 .14 290);letter-spacing:-.5px}
.ha-chtip .ha-ct-bar{height:3px;background:var(--border);border-radius:2px;margin:7px 0;overflow:hidden}
.ha-chtip .ha-ct-fill{height:100%;background:oklch(.72 .14 150);border-radius:2px;transition:width .2s}
.ha-chtip .ha-ct-detail{font-size:9px;color:var(--text-3);display:flex;gap:10px}
.ha-chtip .ha-ct-detail span{display:flex;align-items:center;gap:3px}
.ha-ctx{position:fixed;z-index:9050;background:var(--surface-2);border:1px solid var(--border-hover,oklch(.28 .04 280));border-radius:10px;padding:4px;min-width:150px;box-shadow:0 8px 28px rgba(0,0,0,.4);opacity:0;transform:scale(.94) translateY(-4px);transition:all .1s;pointer-events:none}
.ha-ctx.open{opacity:1;transform:scale(1) translateY(0);pointer-events:auto}
.ha-ctx button{display:flex;align-items:center;gap:7px;width:100%;background:none;border:none;color:var(--text-1);font-size:11px;padding:7px 10px;border-radius:6px;cursor:pointer;font-family:inherit;text-align:left;transition:background .08s}
.ha-ctx button:hover{background:var(--surface-3)}
.ha-ctx button.dng{color:oklch(.72 .14 20)}
.ha-ctx .ha-sep{height:1px;background:var(--border);margin:3px 2px}
.ha-dcf{display:none;margin:4px;padding:10px;background:oklch(.18 .04 20 / .4);border:1px solid oklch(.3 .08 20 / .4);border-radius:7px}
.ha-dcf.show{display:block}
.ha-dcf p{font-size:11px;color:var(--text-2);margin-bottom:8px;line-height:1.4}
.ha-dcf button{padding:4px 12px;border-radius:5px;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;border:none;margin-right:5px}
.ha-dcf .dy{background:oklch(.72 .14 20);color:#fff}
.ha-dcf .dn2{background:var(--surface-3);color:var(--text-2)}
.ha-mo{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9040;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .12s;backdrop-filter:blur(6px)}
.ha-mo.open{opacity:1;pointer-events:auto}
.ha-mbox{background:var(--surface-2);border:1px solid oklch(.28 .06 280);border-radius:14px;padding:24px;width:340px;transform:scale(.94);transition:transform .15s cubic-bezier(.4,0,.2,1);box-shadow:0 20px 60px rgba(0,0,0,.6)}
.ha-mo.open .ha-mbox{transform:scale(1)}
.ha-mbox h3{font-size:14px;font-weight:600;margin-bottom:18px;letter-spacing:-.2px}
.ha-mbox label{display:block;font-size:9px;color:var(--text-3);margin-bottom:4px;text-transform:uppercase;letter-spacing:.6px;font-weight:600}
.ha-mbox input,.ha-mbox select{width:100%;background:var(--surface-3);border:1px solid var(--border);border-radius:7px;padding:8px 11px;color:var(--text-1);font-size:13px;font-family:inherit;outline:none;margin-bottom:12px;transition:border-color .12s}
.ha-mbox input:focus{border-color:oklch(.55 .18 290);box-shadow:0 0 0 2px oklch(.22 .06 290)}
.ha-ep{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:14px}
.ha-ep button{width:32px;height:32px;border-radius:7px;border:1.5px solid var(--border);background:var(--surface-3);cursor:pointer;font-size:15px;display:grid;place-items:center;transition:all .1s}
.ha-ep button:hover{border-color:oklch(.3 .04 280);transform:scale(1.08)}
.ha-ep button.sel{border-color:oklch(.55 .18 290);background:oklch(.22 .06 290)}
.ha-macts{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
.ha-macts button{padding:7px 18px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;border:none;transition:all .12s}
.ha-macts .cancel{background:var(--surface-3);color:var(--text-2);border:1px solid var(--border)}
.ha-macts .cancel:hover{background:var(--surface-4,oklch(.2 .02 280))}
.ha-macts .save{background:oklch(.55 .18 290);color:#fff}
.ha-macts .save:hover{background:oklch(.6 .18 290)}
.ha-undo{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--surface-3);border:1px solid oklch(.28 .06 280);border-radius:10px;padding:8px 14px;font-size:11px;color:var(--text-2);display:flex;align-items:center;gap:10px;z-index:9060;transition:transform .25s cubic-bezier(.4,0,.2,1);box-shadow:0 8px 32px rgba(0,0,0,.5)}
.ha-undo.show{transform:translateX(-50%) translateY(0)}
.ha-undo button{background:oklch(.55 .18 290);color:#fff;border:none;border-radius:5px;padding:3px 10px;font-size:10px;font-weight:600;cursor:pointer;font-family:inherit}
@keyframes haFadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.ha-gw::-webkit-scrollbar{height:4px}
.ha-gw::-webkit-scrollbar-track{background:transparent}
.ha-gw::-webkit-scrollbar-thumb{background:oklch(.25 .03 280);border-radius:2px}
.ha-gw::-webkit-scrollbar-thumb:hover{background:oklch(.32 .04 280)}
.pta *{box-sizing:border-box;margin:0;padding:0}
.pta{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Segoe UI',system-ui,sans-serif;font-size:13px;color:var(--text-1);display:flex;flex-direction:column;gap:0;-webkit-font-smoothing:antialiased}
.pta-hdr{display:flex;align-items:center;gap:10px;padding-bottom:12px;border-bottom:1px solid var(--border);flex-shrink:0}
.pta-tabs{display:flex;gap:2px;background:oklch(.14 .02 290);border:1px solid var(--border);border-radius:7px;padding:3px;position:relative}
.pta-tab-pill{position:absolute;background:oklch(.55 .18 290);border-radius:4px;transition:left 220ms cubic-bezier(.34,1.2,.64,1),width 220ms cubic-bezier(.34,1.2,.64,1),top 220ms cubic-bezier(.34,1.2,.64,1),height 220ms cubic-bezier(.34,1.2,.64,1);pointer-events:none;z-index:0}
.pta-tab{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:4px;font-size:11px;font-weight:500;color:var(--text-2);cursor:pointer;border:none;background:transparent;font-family:inherit;transition:color 120ms ease-out;white-space:nowrap;position:relative;z-index:1}
.pta-tab:hover{color:var(--text-1)}
.pta-tab.active{color:#fff}
.pta-tab svg{width:11px;height:11px;stroke:currentColor;stroke-width:2;fill:none}
.pta-sp{flex:none}
.pta-search{position:relative}
.pta-search svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);width:12px;height:12px;stroke:var(--text-3);stroke-width:2;fill:none;pointer-events:none}
.pta-sinput{background:var(--surface-2);border:1px solid var(--border);border-radius:7px;padding:6px 10px 6px 28px;color:var(--text-1);width:190px;font-size:12px;font-family:inherit;outline:none;transition:border-color 120ms}
.pta-sinput:focus{border-color:oklch(.45 .1 290)}
.pta-sinput::placeholder{color:var(--text-3)}
.pta-addbtn{display:flex;align-items:center;gap:5px;background:oklch(.55 .18 290);border:none;border-radius:7px;padding:6px 13px;color:#fff;font-size:12px;font-weight:500;cursor:pointer;font-family:inherit;transition:background 120ms;white-space:nowrap}
.pta-addbtn:hover{background:oklch(.6 .18 290)}
.pta-addbtn svg{width:11px;height:11px;stroke:#fff;stroke-width:2;fill:none}
.pta-panels{flex:1;display:flex;flex-direction:column;min-height:0;padding-top:12px}
.pta-panel{display:none;flex-direction:column;flex:1;min-height:0}
.pta-panel.active{display:flex}
.pta-chips{display:flex;gap:4px;margin-bottom:10px;flex-shrink:0}
.pta-chip{background:var(--surface-2);border:1px solid var(--border);border-radius:20px;padding:3px 11px;font-size:11px;font-weight:500;color:var(--text-2);cursor:pointer;transition:all 120ms}
.pta-chip:hover{color:var(--text-1);border-color:oklch(.32 .06 290)}
.pta-chip.active{background:oklch(.22 .06 290);border-color:oklch(.45 .1 290);color:oklch(.82 .14 290)}
.pta-listwrap{flex:1;display:flex;flex-direction:column;background:var(--surface-1);border:1px solid var(--border);border-radius:10px;overflow:hidden;min-height:0}
.pta-lhead{display:flex;height:38px;border-bottom:1px solid var(--border);background:var(--surface-2);flex-shrink:0}
.pta-lhead-fixed{display:grid;grid-template-columns:3px 18px 32px 280px;flex-shrink:0;border-right:1px solid var(--border)}
.pta-lhead-swrap{flex:1;overflow:hidden;cursor:grab;user-select:none}
.pta-lhead-swrap.drag{cursor:grabbing}
.pta-shead{display:flex;height:100%}
.pta-colh{display:flex;align-items:center;gap:4px;padding:0 11px;font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.65px;border-right:1px solid var(--border-subtle);flex-shrink:0;white-space:nowrap;cursor:default}
.pta-colh:hover{color:var(--text-2)}
.pta-colh.sorted{color:oklch(.72 .14 290)}
.pta-lbody{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:oklch(.22 .02 290) transparent}
.pta-lbody::-webkit-scrollbar{width:4px}
.pta-lbody::-webkit-scrollbar-thumb{background:oklch(.22 .02 290);border-radius:2px}
.pta-group{will-change:transform}
.pta-group:last-child{border-bottom:none}
.pta-group:nth-child(even) .pta-taskrow,.pta-group:nth-child(even) .pta-subrow,.pta-group:nth-child(even) .pta-row-fixed{background:oklch(.145 .015 290)}
.pta-taskrow{display:flex;cursor:pointer;transition:background 80ms;min-height:48px}
.pta-taskrow:hover,.pta-group:nth-child(even) .pta-taskrow:hover{background:oklch(.2 .025 290)}
.pta-subrow:hover,.pta-group:nth-child(even) .pta-subrow:hover{background:oklch(.2 .025 290)}
.pta-taskrow.done{opacity:.5}
.pta-row-fixed{display:grid;grid-template-columns:3px 18px 32px 280px;flex-shrink:0;border-right:1px solid var(--border);align-items:stretch;background:inherit}
.pta-row-scroll{display:flex;overflow:hidden;align-items:center}
.pta-cell{display:flex;align-items:center;padding:0 11px;border-right:1px solid var(--border-subtle);overflow:hidden;flex-shrink:0;min-height:48px}
.pta-cell:last-child{border-right:none}
.pta-cbar{padding:0;border-right:none;align-items:stretch;min-height:unset}
.pta-cbarfill{width:3px;height:100%}
.pta-ccb{justify-content:center;padding:0;min-width:32px}
.pta-ctitle{gap:6px;min-width:280px;overflow:hidden}
.pta-subwrap{overflow:hidden;transition:height 200ms cubic-bezier(.4,0,.2,1)}
.pta-subrow{display:flex;cursor:pointer;transition:background 80ms;border-top:none}
.pta-subrow .pta-row-fixed{min-height:40px}
.pta-subrow .pta-cell{min-height:40px}
.pta-subrow:hover{background:var(--surface-2)}
.pta-expbtn{width:18px;height:18px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;cursor:pointer;border-radius:3px;flex-shrink:0;transition:all 120ms}
.pta-expbtn:hover{background:var(--surface-3)}
.pta-expbtn svg{width:9px;height:9px;stroke:var(--text-3);stroke-width:2;fill:none;transition:transform 140ms}
.pta-expbtn.open svg{transform:rotate(90deg)}
.pta-tnm{flex:1;font-size:12px;font-weight:500;color:var(--text-1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:color 200ms,opacity 200ms}
.pta-tnm.done{color:var(--text-3);opacity:.5}
.pta-tnm-inner{position:relative;display:inline-block;max-width:100%;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
.pta-tnm-inner::after{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);height:1.5px;width:0;background:currentColor;opacity:0;pointer-events:none}
.pta-tnm.done .pta-tnm-inner::after{opacity:.55;animation:pta-strike 260ms 60ms ease-out forwards}
.pta-sindent{width:20px;flex-shrink:0;position:relative}
.pta-sindent::before{content:'';position:absolute;left:6px;top:-4px;width:1px;height:100%;background:var(--border)}
.pta-sindent::after{content:'';position:absolute;left:6px;top:50%;width:8px;height:1px;background:var(--border)}
.pta-ct{font-size:11px;color:var(--text-3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pta-cd{font-size:11px;color:var(--text-2);white-space:nowrap;font-variant-numeric:tabular-nums}
.pta-link{display:flex;align-items:center;gap:4px;color:oklch(.65 .12 260);text-decoration:none;font-size:11px;white-space:nowrap}
.pta-link:hover{color:oklch(.75 .14 260)}
.pta-link svg{width:9px;height:9px;stroke:currentColor;stroke-width:2;fill:none}
.pta-sp{padding:2px 8px;border-radius:100px;font-size:9px;font-weight:600;white-space:nowrap;flex-shrink:0;display:inline-flex;align-items:center;line-height:1;width:fit-content;min-width:0}
.pta-s-overdue{background:oklch(.22 .08 20);color:oklch(.75 .16 20);border:1px solid oklch(.75 .16 20 / .22)}
.pta-s-done{background:oklch(.2 .07 150);color:oklch(.75 .14 150);border:1px solid oklch(.75 .14 150 / .22)}
.pta-s-active{background:oklch(.2 .07 260);color:oklch(.72 .14 260);border:1px solid oklch(.72 .14 260 / .22)}
.pta-s-urgent{background:oklch(.22 .08 40);color:oklch(.8 .16 40);border:1px solid oklch(.8 .16 40 / .22)}
.pta-s-soon{background:oklch(.22 .08 80);color:oklch(.82 .14 80);border:1px solid oklch(.82 .14 80 / .22)}
.pta-s-later{background:var(--surface-3);color:var(--text-3);border:1px solid var(--border)}
.pta-ib{display:inline-flex;align-items:center;padding:1px 5px;border-radius:3px;font-size:8px;font-weight:600;white-space:nowrap;letter-spacing:0}
.pta-i-critical{background:oklch(.72 .14 20 / .1);color:oklch(.72 .14 20)}
.pta-i-high{background:oklch(.82 .14 40 / .1);color:oklch(.82 .14 40)}
.pta-i-medium{background:oklch(.82 .14 60 / .1);color:oklch(.82 .14 60)}
.pta-i-low{background:oklch(.72 .14 150 / .1);color:oklch(.72 .14 150)}
.pta-drag{display:flex;align-items:center;justify-content:center;cursor:grab;opacity:.45;color:var(--text-3);transition:opacity 100ms}
.pta-drag:hover,.pta-taskrow:hover .pta-drag,.pta-tl-taskrow:hover .pta-drag{opacity:1;color:var(--text-2)}
.pta-drag:active{cursor:grabbing}
.pta-drag svg{width:12px;height:12px;pointer-events:none}
.pta-taskrow.dragging{opacity:.35}
.pta-tl-row.dragging{opacity:.35}
@keyframes pta-check-pop{0%{transform:scale(1)}70%{transform:scale(.9)}100%{transform:scale(1)}}
@keyframes pta-check-draw{0%{clip-path:inset(0 100% 0 0)}to{clip-path:inset(0 0% 0 0)}}
@keyframes pta-strike{0%{width:0}100%{width:100%}}
.pta-cb{width:14px;height:14px;border:1.5px solid oklch(.28 .04 290);border-radius:3px;cursor:pointer;appearance:none;background:transparent;transition:background 120ms,border-color 120ms,transform 120ms;flex-shrink:0;position:relative}
.pta-cb:hover{border-color:oklch(.6 .18 150 / .7);background:oklch(.6 .18 150 / .07);transform:scale(1.08)}
.pta-cb:checked{background:oklch(.6 .18 150);border-color:oklch(.6 .18 150);animation:pta-check-pop 280ms cubic-bezier(.34,1.56,.64,1)}
.pta-cb:checked::after{content:'';position:absolute;left:50%;top:50%;width:7px;height:4px;border-left:1.5px solid #fff;border-bottom:1.5px solid #fff;transform:translate(-50%,-60%) rotate(-45deg)}
.pta-ugw{display:flex;align-items:center;gap:5px;width:100%}
.pta-ugbar{height:3px;border-radius:2px;background:var(--surface-3);flex:1;overflow:hidden}
.pta-ugfill{height:100%;border-radius:2px}
.pta-uglbl{font-size:10px;color:var(--text-3);min-width:16px;text-align:right;font-variant-numeric:tabular-nums}
.pta-imd{display:flex;align-items:center;gap:4px}
.pta-idots{display:flex;gap:2px}
.pta-idot{width:4px;height:4px;border-radius:50%;background:var(--surface-3)}
.pta-idot.on{background:oklch(.6 .15 260)}
.pta-isc{font-size:10px;color:var(--text-2)}
.pta-btag{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;background:oklch(.72 .14 20 / .07);border:1px solid oklch(.72 .14 20 / .2);border-radius:4px;font-size:9px;color:oklch(.72 .14 20)}
.pta-btag svg{width:8px;height:8px;stroke:currentColor;stroke-width:2;fill:none}
.pta-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text-3);gap:10px}
.pta-empty svg{width:34px;height:34px;stroke:currentColor;stroke-width:1;fill:none;opacity:.3}
.pta-empty p{font-size:12px;color:var(--text-2)}
.pcw140{min-width:140px}
.pcw120{min-width:120px}
.pcw110{min-width:110px}
.pcw100{min-width:100px}
.pcw160{min-width:160px}
.pcw130{min-width:130px}
.pta-ktool{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-shrink:0}
.pta-kmtog{display:flex;gap:2px;background:var(--surface-2);border:1px solid var(--border);border-radius:7px;padding:3px}
.pta-kmbtn{background:transparent;border:none;padding:4px 10px;font-size:11px;font-weight:500;color:var(--text-2);cursor:pointer;border-radius:4px;transition:all 120ms;font-family:inherit}
.pta-kmbtn.active{background:oklch(.55 .18 290);color:#fff}
.pta-board{flex:1;display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;min-height:0}
.pta-board::-webkit-scrollbar{height:4px}
.pta-board::-webkit-scrollbar-thumb{background:oklch(.22 .02 290);border-radius:2px}
.pta-kcol{width:272px;min-width:272px;flex-shrink:0;background:var(--surface-1);border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;max-height:100%}
.pta-kcolhead{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;flex-shrink:0}
.pta-kdot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.pta-kcoltitle{font-size:12px;font-weight:600;color:var(--text-1);flex:1}
.pta-kcolct{background:var(--surface-3);color:var(--text-2);font-size:10px;font-weight:600;padding:1px 6px;border-radius:10px}
.pta-kcolbody{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:5px}
.pta-kcolbody::-webkit-scrollbar{width:3px}
.pta-kcolbody::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.pta-kcard{background:var(--surface-2);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 120ms;border-left:3px solid}
.pta-kcard:hover{background:var(--surface-3);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.35)}
.pta-kcard-top{display:flex;align-items:flex-start;gap:7px;padding:8px}
.pta-kcard-body{flex:1;min-width:0}
.pta-ktrow{display:flex;align-items:center;gap:5px;margin-bottom:4px}
.pta-kexpbtn{width:14px;height:14px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;cursor:pointer;border-radius:3px;flex-shrink:0;transition:all 120ms}
.pta-kexpbtn:hover{background:var(--surface-3)}
.pta-kexpbtn svg{width:8px;height:8px;stroke:var(--text-3);stroke-width:2;fill:none;transition:transform 140ms}
.pta-kexpbtn.open svg{transform:rotate(90deg)}
.pta-kti{font-size:12px;flex-shrink:0}
.pta-ktn{flex:1;font-size:12px;font-weight:500;color:var(--text-1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pta-ktn.done{color:var(--text-3);opacity:.5}
.pta-ktn-inner{position:relative;display:inline-block;max-width:100%;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
.pta-ktn-inner::after{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);height:1.5px;width:0;background:currentColor;opacity:0;pointer-events:none}
.pta-ktn.done .pta-ktn-inner::after{opacity:.55;animation:pta-strike 260ms 60ms ease-out forwards}
.pta-kmeta{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:3px}
.pta-kdate{font-size:10px;color:var(--text-3);display:flex;align-items:center;gap:3px}
.pta-kdate svg{width:8px;height:8px;stroke:currentColor;stroke-width:2;fill:none}
.pta-mtag{background:var(--surface-3);color:var(--text-2);padding:2px 5px;border-radius:3px;font-size:9px}
.pta-kfoot{padding:0 8px 7px;display:flex;align-items:center;gap:7px}
.pta-progbar{height:3px;background:var(--surface-3);border-radius:2px;flex:1;overflow:hidden}
.pta-progfill{height:100%;border-radius:2px;background:oklch(.55 .18 290)}
.pta-proglbl{font-size:10px;color:var(--text-3)}
.pta-ksubs{border-top:1px solid var(--border);padding:5px 8px;overflow:hidden;transition:height 220ms cubic-bezier(.4,0,.2,1)}
.pta-ksubrow{display:flex;align-items:center;gap:5px;padding:3px 0;border-bottom:1px solid var(--border-subtle)}
.pta-ksubrow:last-child{border-bottom:none}
.pta-ksubnm{flex:1;font-size:11px;color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pta-ksubnm.done{text-decoration:line-through;color:var(--text-3)}
.pta-kempty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:22px 10px;color:var(--text-3);gap:5px;flex:1}
.pta-kempty svg{width:24px;height:24px;stroke:currentColor;stroke-width:1;fill:none;opacity:.3}
.pta-kempty p{font-size:11px}
.pta-tltool{display:flex;align-items:center;gap:7px;margin-bottom:10px;flex-shrink:0}
.pta-tlbtn{display:flex;align-items:center;gap:5px;background:var(--surface-2);border:1px solid var(--border);border-radius:7px;padding:5px 11px;color:var(--text-2);font-size:11px;font-weight:500;cursor:pointer;font-family:inherit;transition:all 120ms}
.pta-tlbtn:hover{background:var(--surface-3);color:var(--text-1)}
.pta-tlbtn svg{width:11px;height:11px;stroke:currentColor;stroke-width:2;fill:none}
.pta-tlwrap{flex:1;display:flex;flex-direction:column;background:var(--surface-1);border:1px solid var(--border);border-radius:10px;overflow:hidden;min-height:0}
.pta-tl-head{display:flex;border-bottom:1px solid var(--border);height:40px;flex-shrink:0}
.pta-tl-lblhead{width:256px;flex-shrink:0;display:flex;align-items:center;padding:0 12px;background:var(--surface-2);border-right:1px solid var(--border)}
.pta-tl-lblhead span{font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}
.pta-days-wrap{flex:1;overflow:hidden;position:relative;cursor:grab}
.pta-days-wrap:active{cursor:grabbing}
.pta-days-head{position:absolute;top:0;left:0;height:100%;user-select:none}
.pta-tlbody{flex:1;overflow-y:auto;min-height:0;background:var(--surface-2);scrollbar-width:thin;scrollbar-color:oklch(.22 .02 290) transparent}
.pta-tlbody::-webkit-scrollbar{width:4px}
.pta-tlbody::-webkit-scrollbar-thumb{background:oklch(.22 .02 290);border-radius:2px}
.pta-tl-row{display:flex;border-bottom:1px solid var(--border-subtle);align-items:stretch;will-change:transform}
.pta-tl-row:last-child{border-bottom:none}
.pta-tl-lbl{width:256px;flex-shrink:0;background:var(--surface-2);border-right:1px solid var(--border);display:flex;flex-direction:column}
.pta-tl-taskrow{height:52px;display:flex;align-items:center;gap:7px;padding:0 10px;cursor:pointer;border-left:3px solid transparent;transition:background 80ms}
.pta-tl-taskrow:hover{background:var(--surface-3)}
.pta-tl-subrow{height:42px;display:flex;align-items:center;gap:7px;padding:0 10px 0 22px;cursor:pointer;border-left:3px solid transparent;border-top:1px solid var(--border-subtle);transition:background 80ms}
.pta-tl-subrow:hover{background:var(--surface-3)}
.pta-tlnm{flex:1;font-size:12px;font-weight:500;color:var(--text-1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pta-tlnm.done{color:var(--text-3);opacity:.5}
.pta-tlnm-inner{position:relative;display:inline-block;max-width:100%;overflow:hidden;text-overflow:ellipsis;vertical-align:middle}
.pta-tlnm-inner::after{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);height:1.5px;width:0;background:currentColor;opacity:0;pointer-events:none}
.pta-tlnm.done .pta-tlnm-inner::after{opacity:.55;animation:pta-strike 260ms 60ms ease-out forwards}
.pta-tlsubnm{flex:1;font-size:11px;color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pta-tlsubnm.done{text-decoration:line-through;color:var(--text-3)}
.pta-tl-grid{flex:1;position:relative;overflow:hidden}
.pta-tl-inner{position:absolute;top:0;left:0;height:100%}
.pta-grid-bg{position:absolute;top:0;left:0;height:100%;display:flex;pointer-events:none}
.pta-grid-day{height:100%;border-right:1px solid var(--border-subtle);flex-shrink:0}
.pta-grid-day.today{background:oklch(.22 .06 290 / .4)}
.pta-tl-bar{position:absolute;border-radius:4px;cursor:pointer;z-index:2;transition:filter 110ms}
.pta-tl-bar:hover{filter:brightness(1.12)}
.pta-tl-bar.done{opacity:.4;filter:saturate(.3)}
.pta-tl-sbar{position:absolute;border-radius:3px;height:26px;cursor:pointer;z-index:2;transition:filter 110ms}
.pta-tl-sbar:hover{filter:brightness(1.12)}
.pta-tl-sbar.done{opacity:.35;filter:saturate(.3)}
.pta-mo{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;z-index:9050;backdrop-filter:blur(10px);padding:20px}
.pta-mo.open{display:flex}
.pta-mbox{background:oklch(.15 .03 290);border:1px solid oklch(.25 .06 290);border-radius:16px;width:100%;max-width:660px;max-height:88vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 40px 100px rgba(0,0,0,.7)}
.pta-mhd{display:flex;align-items:center;gap:8px;padding:16px 18px 0;flex-shrink:0}
.pta-mhd-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.pta-mhd h3{font-size:11px;font-weight:600;color:var(--text-2);flex:1;text-transform:uppercase;letter-spacing:.5px}
.pta-mclosebtn{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:oklch(.2 .04 290);border:none;border-radius:6px;cursor:pointer;color:var(--text-2);transition:all 120ms}
.pta-mclosebtn:hover{background:oklch(.25 .05 290);color:var(--text-1)}
.pta-mclosebtn svg{width:10px;height:10px;stroke:currentColor;stroke-width:2;fill:none}
.pta-mtitle-row{display:flex;align-items:center;gap:9px;padding:10px 18px 14px;flex-shrink:0;border-bottom:1px solid oklch(.22 .04 290)}
.pta-mtitle-icon{font-size:20px;flex-shrink:0}
.pta-mtitle-input{flex:1;background:transparent;border:none;font-size:1.1rem;font-weight:600;color:var(--text-1);outline:none;font-family:inherit}
.pta-mtitle-input::placeholder{color:var(--text-3)}
.pta-mcolor{width:20px;height:20px;border:none;border-radius:5px;padding:0;cursor:pointer;background:transparent;overflow:hidden}
.pta-mcolor::-webkit-color-swatch-wrapper{padding:0}
.pta-mcolor::-webkit-color-swatch{border:none;border-radius:5px}
.pta-mtabs{display:flex;gap:0;padding:0 18px;border-bottom:1px solid oklch(.22 .04 290);flex-shrink:0}
.pta-mtab{padding:9px 12px;font-size:10px;font-weight:600;color:var(--text-3);cursor:pointer;border-bottom:2px solid transparent;transition:all 120ms;text-transform:uppercase;letter-spacing:.5px;margin-bottom:-1px}
.pta-mtab:hover{color:var(--text-2)}
.pta-mtab.active{color:oklch(.82 .14 290);border-bottom-color:oklch(.55 .18 290)}
.pta-mbody{flex:1;overflow-y:auto;min-height:0}
.pta-mbody::-webkit-scrollbar{width:3px}
.pta-mbody::-webkit-scrollbar-thumb{background:oklch(.22 .04 290);border-radius:2px}
.pta-mtpanel{display:none;padding:16px 18px;flex-direction:column;gap:12px}
.pta-mtpanel.active{display:flex}
.pta-mrow{display:grid;gap:10px}
.pta-mrow-2{grid-template-columns:1fr 1fr}
.pta-mrow-3{grid-template-columns:1fr 1fr 1fr}
.pta-mfield{display:flex;flex-direction:column;gap:5px}
.pta-mfield label{font-size:9px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}
.pta-mfield input,.pta-mfield select,.pta-mfield textarea{background:oklch(.18 .04 290);border:1px solid oklch(.25 .05 290);border-radius:7px;padding:7px 10px;color:var(--text-1);font-size:12px;font-family:inherit;transition:border-color 120ms;outline:none;-webkit-appearance:none}
.pta-mfield input:focus,.pta-mfield select:focus,.pta-mfield textarea:focus{border-color:oklch(.45 .1 290);background:oklch(.2 .05 290)}
.pta-mfield input::placeholder,.pta-mfield textarea::placeholder{color:var(--text-3)}
.pta-mfield textarea{resize:vertical;min-height:80px;line-height:1.6}
.pta-mfield select option{background:oklch(.15 .03 290)}
.pta-mchk{display:flex;align-items:center;gap:8px;cursor:pointer}
.pta-mchk input{accent-color:oklch(.55 .18 290)}
.pta-mchk span{font-size:12px;color:var(--text-2)}
.pta-insight{background:oklch(.2 .06 290 / .5);border:1px solid oklch(.35 .1 290 / .4);border-radius:8px;padding:9px 12px;display:flex;align-items:flex-start;gap:8px}
.pta-insight svg{width:12px;height:12px;stroke:oklch(.72 .14 290);stroke-width:2;fill:none;flex-shrink:0;margin-top:1px}
.pta-insight-txt{font-size:11px;color:var(--text-2);line-height:1.6}
.pta-insight-txt strong{color:oklch(.82 .14 290);font-weight:600}
.pta-sub-add{display:grid;grid-template-columns:1fr 90px 90px auto;gap:8px;align-items:end;margin-bottom:8px}
.pta-sub-list{display:flex;flex-direction:column;gap:4px}
.pta-sub-item{display:flex;align-items:center;gap:7px;padding:7px 10px;background:oklch(.18 .04 290);border:1px solid oklch(.22 .05 290);border-radius:7px;cursor:pointer;transition:background 120ms}
.pta-sub-item:hover{background:oklch(.2 .05 290)}
.pta-sub-title{flex:1;font-size:12px;color:var(--text-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pta-sub-title.done{text-decoration:line-through;color:var(--text-3)}
.pta-sub-date{font-size:10px;color:var(--text-3);flex-shrink:0}
.pta-sub-del{width:20px;height:20px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:4px;cursor:pointer;color:var(--text-3);transition:all 120ms;flex-shrink:0}
.pta-sub-del:hover{background:oklch(.72 .14 20 / .15);color:oklch(.72 .14 20)}
.pta-sub-del svg{width:9px;height:9px;stroke:currentColor;stroke-width:2;fill:none}
.pta-mfoot{display:flex;gap:6px;align-items:center;padding:12px 18px;border-top:1px solid oklch(.22 .04 290);flex-shrink:0}
.pta-mfoot-l{flex:1;display:flex;gap:6px}
.pta-mbtn{border:1px solid transparent;border-radius:8px;padding:7px 14px;font-size:12px;font-weight:500;cursor:pointer;transition:all 120ms;display:flex;align-items:center;gap:5px;font-family:inherit;white-space:nowrap}
.pta-mbtn-primary{background:oklch(.55 .18 290);border-color:oklch(.55 .18 290);color:#fff}
.pta-mbtn-primary:hover{background:oklch(.6 .18 290)}
.pta-mbtn-sec{background:oklch(.2 .04 290);border-color:oklch(.25 .05 290);color:var(--text-2)}
.pta-mbtn-sec:hover{background:oklch(.24 .05 290);color:var(--text-1)}
.pta-mbtn-danger{background:transparent;border-color:oklch(.72 .14 20 / .3);color:oklch(.72 .14 20)}
.pta-mbtn-danger:hover{background:oklch(.72 .14 20 / .1)}
.pta-mbtn-ghost{background:transparent;border-color:transparent;color:var(--text-3)}
.pta-mbtn-ghost:hover{color:var(--text-2)}
.pta-mbtn-sm{padding:5px 10px;font-size:11px}
.pta-sbox{background:oklch(.15 .03 290);border:1px solid oklch(.25 .06 290);border-radius:14px;width:100%;max-width:440px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 40px 100px rgba(0,0,0,.7)}

/* ══ TASK WORKSPACES HUB ══ */
.twh{display:flex;flex-direction:column;height:100%;min-height:0;overflow-y:auto}
.twh-header{display:flex;align-items:flex-start;justify-content:space-between;padding:28px 32px 20px;flex-shrink:0;gap:16px}
.twh-page-title{font-size:20px;font-weight:700;color:var(--text-1);letter-spacing:-.3px}
.twh-page-sub{font-size:12px;color:var(--text-3);margin-top:3px}
.twh-charts-area{display:flex;align-items:stretch;gap:10px;flex:1;min-width:0;height:180px}
.twh-chart-card{background:var(--surface-2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;display:flex;flex-direction:column;gap:10px;min-width:130px;height:100%}
.twh-chart-stacked{flex:1;min-width:180px}
.twh-status-rows{display:flex;flex-direction:column;gap:8px;flex:1;justify-content:center}
.twh-sr{display:flex;align-items:center;gap:10px}
.twh-sr-bar-wrap{flex:1;height:5px;background:rgba(255,255,255,0.07);border-radius:3px;overflow:hidden}
.twh-sr-bar{height:100%;border-radius:3px;transition:width 500ms cubic-bezier(.34,1.2,.64,1)}
.twh-sr-lbl{font-size:11px;color:var(--text-3);width:52px;flex-shrink:0}
.twh-sr-val{font-size:13px;font-weight:600;width:28px;text-align:right;flex-shrink:0}
.twh-sr-total{border-top:1px solid var(--border-subtle);padding-top:8px;margin-top:2px}
.twh-sr-total .twh-sr-bar-wrap{display:none}
.twh-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1;align-content:center}
.twh-sg-item{display:flex;flex-direction:column;gap:4px;padding:10px 14px;background:var(--surface-3);border-radius:10px}
.twh-sg-n{font-size:26px;font-weight:700;line-height:1}
.twh-sg-l{font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px}

.twh-chart-title{font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.6px;flex-shrink:0}
.twh-donut-wrap{position:relative;display:flex;align-items:center;justify-content:center;flex:1}
.twh-donut-label{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none}
.twh-donut-pct{font-size:16px;font-weight:700;color:var(--text-1);line-height:1}
.twh-donut-sub{font-size:9px;color:var(--text-3);margin-top:2px}
.twh-bar-chart{display:flex;flex-direction:column;gap:8px;flex:1;justify-content:center}
.twh-bar-row{display:flex;align-items:center;gap:8px}
.twh-bar-lbl{font-size:11px;color:var(--text-2);width:120px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.twh-bar-track{flex:1;height:8px;background:var(--surface-3);border-radius:4px;position:relative;overflow:visible}
.twh-bar-fill{position:absolute;top:-1px;left:0;height:10px;border-radius:4px;transition:width 400ms cubic-bezier(.34,1.2,.64,1)}
.twh-bar-done{position:absolute;top:0;left:0;height:8px;border-radius:4px;transition:width 400ms cubic-bezier(.34,1.2,.64,1) 60ms}
.twh-bar-num{font-size:11px;color:var(--text-3);width:24px;text-align:right;flex-shrink:0}
.twh-stat-list{display:flex;flex-direction:column;gap:8px;flex:1;justify-content:center}
.twh-stat-row{display:flex;align-items:center;gap:8px}
.twh-stat-row.total{border-top:1px solid var(--border-subtle);padding-top:8px;margin-top:2px}
.twh-stat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.twh-stat-lbl{font-size:12px;color:var(--text-2);flex:1}
.twh-stat-val{font-size:13px;font-weight:600;color:var(--text-1)}
.twh-stat-val.accent-danger{color:oklch(.72 .14 20)}
.twh-global-metrics{display:none}
.twh-gm-stat{display:flex;flex-direction:column;align-items:center;padding:8px 14px;border-radius:10px;background:var(--surface-2);border:1px solid var(--border);min-width:58px;gap:2px}
.twh-gm-n{font-size:18px;font-weight:700;color:var(--text-1);line-height:1}
.twh-gm-l{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.6px}
.twh-gm-stat.accent .twh-gm-n{color:oklch(.7 .14 290)}
.twh-gm-stat.done .twh-gm-n{color:oklch(.72 .14 150)}
.twh-gm-stat.danger .twh-gm-n{color:oklch(.72 .14 20)}
.twh-new-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;width:180px;height:180px;background:oklch(.55 .18 290);border:none;border-radius:16px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all 140ms;flex-shrink:0;text-align:center;line-height:1.3}
.twh-new-btn:hover{background:oklch(.6 .18 290);transform:translateY(-2px);box-shadow:0 8px 24px oklch(.55 .18 290 / .4)}
.twh-new-btn svg{width:56px;height:56px;stroke:currentColor;stroke-width:1.5;fill:none;flex-shrink:0}
/* workspace cards grid */

/* list section */
.twh-recent-section{padding:0 32px 32px;flex-shrink:0}
.twh-section-label{font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.7px;margin-bottom:10px}
.twh-ws-list{display:flex;flex-direction:column;gap:6px}
.twh-list-row{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;background:var(--surface-2);border:1px solid var(--border);cursor:pointer;transition:all 120ms;position:relative;overflow:hidden}
.twh-list-row:hover{background:var(--surface-3);border-color:oklch(.3 .06 290)}
.twh-lr-accent{width:3px;height:32px;border-radius:2px;flex-shrink:0}
.twh-lr-icon{font-size:16px;flex-shrink:0}
.twh-lr-name{font-size:13px;font-weight:600;color:var(--text-1);min-width:120px}
.twh-lr-count{font-size:11px;color:var(--text-3);flex-shrink:0;min-width:60px}
.twh-lr-pills{display:flex;gap:5px;flex-wrap:wrap;margin-left:auto}
.twh-sp-pill{font-size:9px;font-weight:600;padding:2px 7px;border-radius:100px;white-space:nowrap}
.twh-sp-pill.active{background:oklch(.55 .18 290 / .15);color:oklch(.7 .14 290)}
.twh-sp-pill.overdue{background:oklch(.72 .14 20 / .15);color:oklch(.72 .14 20)}
.twh-sp-pill.done{background:oklch(.72 .14 150 / .15);color:oklch(.72 .14 150)}
.twh-sp-pill.empty{background:var(--surface-3);color:var(--text-3)}

.twh-lr-opts{width:26px;height:26px;border-radius:6px;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-3);flex-shrink:0;transition:background 100ms,color 100ms}
.twh-lr-opts:hover{background:var(--surface-3);color:var(--text-1)}

/* ctx menu */
.twh-ctx{position:fixed;background:var(--surface-3);border:1px solid var(--border);border-radius:8px;padding:4px;min-width:130px;z-index:900;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.twh-ctx-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:5px;font-size:12px;color:var(--text-2);cursor:pointer;border:none;background:transparent;width:100%;text-align:left;font-family:inherit}
.twh-ctx-item:hover{background:var(--surface-4);color:var(--text-1)}
.twh-ctx-item.danger:hover{background:oklch(.35 .12 20 / .3);color:oklch(.72 .14 20)}
/* back bar inside workspace */
.pta-ws-title-bar{display:flex;align-items:center;gap:10px;flex-shrink:0}
.pta-ws-title-icon{font-size:22px;line-height:1}
.pta-ws-title-name{font-size:20px;font-weight:700;color:var(--text-1);letter-spacing:-.3px}
/* metrics row */
.pta-metrics{display:flex;align-items:center;gap:6px;margin-left:auto}
.pta-mstat{display:flex;flex-direction:column;align-items:center;padding:5px 10px;border-radius:8px;background:var(--surface-2);border:1px solid var(--border);min-width:46px;gap:1px}
.pta-mstat-n{font-size:14px;font-weight:700;color:var(--text-1);line-height:1}
.pta-mstat-l{font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}
.pta-mstat.accent .pta-mstat-n{color:oklch(.7 .14 290)}
.pta-mstat.warn .pta-mstat-n{color:oklch(.75 .14 150)}
.pta-mstat.danger .pta-mstat-n{color:oklch(.72 .14 20)}
/* modal */
.twh-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:800;backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity 180ms}
.twh-modal-bg.open{opacity:1;pointer-events:all}
.twh-modal{background:var(--surface-2);border:1px solid var(--border);border-radius:14px;padding:24px;width:360px;box-shadow:0 24px 60px rgba(0,0,0,.5);transform:translateY(8px) scale(.98);transition:transform 180ms}
.twh-modal-bg.open .twh-modal{transform:none}
.twh-modal h3{font-size:15px;font-weight:600;color:var(--text-1);margin-bottom:16px}
.twh-field{margin-bottom:12px}
.twh-field label{display:block;font-size:10px;font-weight:600;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.twh-input{width:100%;background:var(--surface-3);border:1px solid var(--border);border-radius:7px;padding:8px 10px;font-size:13px;color:var(--text-1);font-family:inherit;outline:none;transition:border-color 120ms}
.twh-input:focus{border-color:oklch(.55 .18 290)}
.twh-colors{display:flex;gap:8px;flex-wrap:wrap}
.twh-color{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform 100ms,border-color 100ms;flex-shrink:0}
.twh-color.sel{border-color:#fff;transform:scale(1.15)}
.twh-icons{display:flex;gap:6px;flex-wrap:wrap}
.twh-ico-btn{width:34px;height:34px;border-radius:7px;background:var(--surface-3);border:1px solid var(--border);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 100ms}
.twh-ico-btn.sel{border-color:oklch(.55 .18 290);background:oklch(.55 .18 290 / .15)}
.twh-modal-ft{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}
.twh-btn{padding:7px 16px;border-radius:7px;font-size:12px;font-weight:500;cursor:pointer;border:1px solid var(--border);font-family:inherit;transition:all 100ms}
.twh-btn-ghost{background:transparent;color:var(--text-2)}
.twh-btn-ghost:hover{background:var(--surface-3);color:var(--text-1)}
.twh-btn-pri{background:oklch(.55 .18 290);border-color:oklch(.55 .18 290);color:#fff}
.twh-btn-pri:hover{background:oklch(.6 .18 290)}

</style>
</head>
<body id="body">

<aside class="sidebar">
  <div class="profile">
    <div class="icon" style="background:oklch(0.28 0.08 290);color:oklch(0.82 0.12 290);">H</div>
    <div class="label">
      <span class="label__name">Harmonic</span>
      <span class="label__sub"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="dab2bba8b7b5b4b3b99aaaafb6a9bba8f4b3b5">[email&#160;protected]</a></span>
    </div>
  </div>

  <div class="search" role="search">
    <span class="search__icon">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    </span>
    <input class="search__input" type="text" placeholder="Search" aria-label="Search">
  </div>

  <!-- Switcher -->
  <div class="switcher" id="switcher">
    <div class="carousel" id="carousel">
      <div class="carousel__item" data-pillar="extensions">
        <div class="icon" data-pillar-home="extensions" style="background:oklch(0.28 0.10 20);color:oklch(0.72 0.14 20);">E</div>
        <div class="label carousel__label-click" data-pillar-toggle="extensions"><span class="label__name">Extensions</span></div>
      </div>
      <div class="carousel__item" data-pillar="collaboration">
        <div class="icon" data-pillar-home="collaboration" style="background:oklch(0.28 0.12 330);color:oklch(0.72 0.14 330);">C</div>
        <div class="label carousel__label-click" data-pillar-toggle="collaboration"><span class="label__name">Collaboration</span></div>
      </div>
      <div class="carousel__item" data-pillar="customization">
        <div class="icon" data-pillar-home="customization" style="background:oklch(0.28 0.14 290);color:oklch(0.72 0.16 290);">C</div>
        <div class="label carousel__label-click" data-pillar-toggle="customization"><span class="label__name">Customization</span></div>
      </div>
      <div class="carousel__item" data-pillar="insights">
        <div class="icon" data-pillar-home="insights" style="background:oklch(0.28 0.12 200);color:oklch(0.72 0.14 200);">I</div>
        <div class="label carousel__label-click" data-pillar-toggle="insights"><span class="label__name">Insights</span></div>
      </div>
      <div class="carousel__item" data-pillar="productivity">
        <div class="icon" data-pillar-home="productivity" style="background:oklch(0.28 0.10 60);color:oklch(0.72 0.16 60);">P</div>
        <div class="label carousel__label-click" data-pillar-toggle="productivity"><span class="label__name">Productivity</span></div>
      </div>
      <div class="carousel__item" data-pillar="knowledge">
        <div class="icon" data-pillar-home="knowledge" style="background:oklch(0.28 0.12 150);color:oklch(0.72 0.14 150);">K</div>
        <div class="label carousel__label-click" data-pillar-toggle="knowledge"><span class="label__name">Knowledge</span></div>
      </div>
      <div class="carousel__item" data-pillar="corespace">
        <div class="icon" data-pillar-home="corespace" style="background:oklch(0.28 0.12 260);color:oklch(0.75 0.15 260);">C</div>
        <div class="label carousel__label-click" data-pillar-toggle="corespace"><span class="label__name">Corespace</span></div>
      </div>

      <div class="carousel__controls">
        <button class="carousel__btn" id="prevBtn" aria-label="Previous">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="18 15 12 9 6 15"/></svg>
        </button>
        <button class="carousel__btn" id="nextBtn" aria-label="Next">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
      </div>
    </div>

    <div class="pillar-dropdown" id="pillarDropdown">
      <div class="dropdown__content" id="dropdownContent"></div>
    </div>
  </div>

  <div class="nav-item">
    <div class="icon" style="background:var(--surface-3);color:var(--text-2);">M</div>
    <div class="label"><span class="label__name">Marketplace</span></div>
  </div>
  <div class="spacer"></div>
  <div class="nav-item">
    <div class="icon" style="background:var(--surface-3);color:var(--text-2);">N</div>
    <div class="label"><span class="label__name">Notifications</span></div>
  </div>
  <div class="nav-item">
    <div class="icon" style="background:var(--surface-3);color:var(--text-2);">F</div>
    <div class="label"><span class="label__name">Feedback</span></div>
  </div>
  <div class="nav-item">
    <div class="icon" style="background:var(--surface-3);color:var(--text-2);">S</div>
    <div class="label"><span class="label__name">Settings</span></div>
  </div>
</aside>

<header class="topbar">
  <nav class="breadcrumb" id="breadcrumbNav"></nav>
</header>

<main class="main" id="mainArea">
  <div id="contentArea">
    <div class="empty-state">
      <div class="empty-state__icon">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
      </div>
      <p class="empty-state__text">Select a task view from the sidebar</p>
    </div>
  </div>
  <button class="toggle" id="toggle">◀</button>
</main>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const IC = {
  grid:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>`,
  bell:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
  folder:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
  link:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`,
  cal:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
  note:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`,
  graph:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><circle cx="12" cy="12" r="2"/><circle cx="4" cy="6" r="2"/><circle cx="20" cy="6" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/><line x1="6" y1="7" x2="10" y2="11"/><line x1="14" y1="11" x2="18" y2="7"/><line x1="6" y1="17" x2="10" y2="13"/><line x1="14" y1="13" x2="18" y2="17"/></svg>`,
  stack:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>`,
  card:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>`,
  book:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
  search:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>`,
  check:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>`,
  clip:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>`,
  timer:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>`,
  timeline:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/><circle cx="8" cy="6" r="2" fill="currentColor" stroke="none"/><circle cx="16" cy="12" r="2" fill="currentColor" stroke="none"/><circle cx="11" cy="18" r="2" fill="currentColor" stroke="none"/></svg>`,
  target:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
  repeat:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>`,
  bar:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
  heat:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="3" width="4" height="4" rx="0.5"/><rect x="10" y="3" width="4" height="4" rx="0.5"/><rect x="17" y="3" width="4" height="4" rx="0.5"/><rect x="3" y="10" width="4" height="4" rx="0.5"/><rect x="10" y="10" width="4" height="4" rx="0.5"/><rect x="17" y="10" width="4" height="4" rx="0.5"/><rect x="3" y="17" width="4" height="4" rx="0.5"/><rect x="10" y="17" width="4" height="4" rx="0.5"/><rect x="17" y="17" width="4" height="4" rx="0.5"/></svg>`,
  trend:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>`,
  report:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><polyline points="14 2 14 8 20 8"/></svg>`,
  magic:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="m12 2 2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6z"/></svg>`,
  sliders:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/><circle cx="9" cy="6" r="2" fill="var(--surface-2)"/><circle cx="15" cy="12" r="2" fill="var(--surface-2)"/><circle cx="10" cy="18" r="2" fill="var(--surface-2)"/></svg>`,
  palette:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 1.657-2.686 3-6 3h-1c-1.105 0-2 .895-2 2s.895 2 2 2"/><circle cx="8" cy="10" r="1" fill="currentColor"/><circle cx="12" cy="7" r="1" fill="currentColor"/><circle cx="16" cy="10" r="1" fill="currentColor"/></svg>`,
  layout:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>`,
  zap:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
  robot:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><line x1="9" y1="15" x2="9" y2="17"/><line x1="15" y1="15" x2="15" y2="17"/></svg>`,
  kbd:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="10" x2="6" y2="10"/><line x1="10" y1="10" x2="10" y2="10"/><line x1="14" y1="10" x2="14" y2="10"/><line x1="18" y1="10" x2="18" y2="10"/><line x1="8" y1="14" x2="16" y2="14"/></svg>`,
  users:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  chat:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
  mention:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"/></svg>`,
  share:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>`,
  lock:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
  mail:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
  plug:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>`,
  store:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M3 9l1-5h16l1 5"/><path d="M3 9a2 2 0 0 0 4 0 2 2 0 0 0 4 0 2 2 0 0 0 4 0 2 2 0 0 0 4 0"/><rect x="5" y="14" width="14" height="7" rx="1"/></svg>`,
  beaker:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M9 3h6M9 3v8l-5 10h16l-5-10V3"/></svg>`,
  code:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
  plus:`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
  pin:`<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><path d="M12 2l2.5 6.5H21l-5.5 4 2 6.5L12 15l-5.5 4 2-6.5L3 8.5h6.5z"/></svg>`,
};

const PILLARS = {
  corespace:{label:'Corespace',accent:'oklch(0.75 0.15 260)',
    sections:[
      {title:'Your Space',items:[
        {i:'grid',n:'Dashboard',b:null,page:'dashboard'},
        {i:'pin',n:'Pinned',b:'4',page:'pinned'},
        {i:'bell',n:'Notifications',b:'12',page:'notifications'},
        {i:'zap',n:'Quick Capture',b:null,page:'quickcapture'},
      ]},
      {title:'Recent',items:[
        {i:'timer',n:'Focus Launcher',b:null,page:'focuslauncher'},
        {i:'trend',n:'Momentum',b:null,page:'momentum'},
        {i:'note',n:'Inbox',b:'6',page:'inbox'},
      ]}
    ]},
  knowledge:{label:'Knowledge',accent:'oklch(0.72 0.14 150)',
    sections:[
      {title:'Create',items:[
        {i:'note',n:'Notes',b:null,page:'notes'},
        {i:'book',n:'Topic Library',b:null,page:'topiclibrary'},
        {i:'card',n:'Study Sheets',b:null,page:'studysheets'},
        {i:'stack',n:'Reference Vault',b:null,page:'refvault'},
      ]},
      {title:'Explore',items:[
        {i:'graph',n:'Concept Map',b:null,page:'conceptmap'},
        {i:'zap',n:'Accelerators',b:null,page:'accelerators'},
        {i:'bar',n:'Insight Dashboard',b:null,page:'knowledgeinsights'},
      ]}
    ]},
  productivity:{label:'Productivity',accent:'oklch(0.72 0.16 60)',
    sections:[
      {title:'Do',items:[
        {i:'check',n:'Tasks',b:'7',page:'tasks'},
        {i:'cal',n:'Calendar',b:null,page:'calendar'},
        {i:'clip',n:'Project Boards',b:'3',page:'projects'},
        {i:'timer',n:'Focus Sessions',b:null,page:'focus'},
      ]},
      {title:'Track',items:[
        {i:'repeat',n:'Habits',b:null,page:'habits'},
        {i:'target',n:'Goals',b:'2',page:'goals'},
        {i:'note',n:'Journal',b:null,page:'journal'},
      ]}
    ]},
  insights:{label:'Insights',accent:'oklch(0.72 0.14 200)',
    sections:[
      {title:'Metrics',items:[
        {i:'bar',n:'Productivity Score',b:null,page:'prodscore'},
        {i:'heat',n:'Focus Heatmap',b:null,page:'heatmap'},
        {i:'graph',n:'Knowledge Growth',b:null,page:'knowledgegrowth'},
        {i:'trend',n:'Habit & Goal Trends',b:null,page:'habittrends'},
      ]},
      {title:'Reports',items:[
        {i:'sliders',n:'Custom Graph Builder',b:null,page:'graphbuilder'},
        {i:'timer',n:'Session Log',b:null,page:'sessionlog'},
        {i:'report',n:'Weekly Snapshot',b:'New',page:'weeklysnapshot'},
      ]}
    ]},
  customization:{label:'Customization',accent:'oklch(0.72 0.16 290)',
    sections:[
      {title:'Build',items:[
        {i:'layout',n:'Layout Studio',b:null,page:'layoutstudio'},
        {i:'palette',n:'Theme Builder',b:null,page:'themebuilder'},
        {i:'note',n:'Note Type Editor',b:null,page:'notetypeeditor'},
        {i:'stack',n:'Module Library',b:null,page:'modulelibrary'},
      ]},
      {title:'Configure',items:[
        {i:'graph',n:'Tag Explorer',b:null,page:'tagexplorer'},
        {i:'kbd',n:'Shortcut Editor',b:null,page:'shortcuts'},
        {i:'layout',n:'View Templates',b:null,page:'viewtemplates'},
      ]}
    ]},
  collaboration:{label:'Collaboration',accent:'oklch(0.72 0.14 330)',
    sections:[
      {title:'Together',items:[
        {i:'users',n:'Team Spaces',b:'2',page:'teamspaces'},
        {i:'clip',n:'Multiplayer Boards',b:null,page:'multiboards'},
        {i:'target',n:'Shared Goals',b:null,page:'sharedgoals'},
        {i:'stack',n:'Shared Knowledge',b:null,page:'sharedknowledge'},
      ]},
      {title:'Communicate',items:[
        {i:'chat',n:'Comments & Threads',b:'5',page:'comments'},
        {i:'trend',n:'Activity Feed',b:null,page:'activityfeed'},
        {i:'lock',n:'Permission Layers',b:null,page:'permissions'},
      ]}
    ]},
  extensions:{label:'Extensions',accent:'oklch(0.72 0.14 20)',
    sections:[
      {title:'Connect',items:[
        {i:'plug',n:'Installed Apps',b:null,page:'installedapps'},
        {i:'folder',n:'Import / Export',b:null,page:'importexport'},
        {i:'zap',n:'Automations',b:null,page:'automations'},
        {i:'code',n:'Developer API',b:null,page:'devapi'},
      ]},
      {title:'Explore',items:[
        {i:'beaker',n:'Labs',b:'3',page:'labs'},
        {i:'stack',n:'Session Backup',b:null,page:'sessionbackup'},
      ]}
    ]},
}
function ci(ic,c){return `<div class="card-icon" style="background:oklch(0.22 0.08 ${c})">${icSVG(ic,c)}</div>`;}
function icSVG(ic,c){const s=IC[ic]||IC.grid;return s.replace('stroke="currentColor"',`stroke="oklch(0.75 0.14 ${c})"`);}
function prog(pct,c){return `<div class="prog"><div class="prog-fill" style="width:${pct}%;background:oklch(0.6 0.14 ${c})"></div></div>`;}

const PAGES = {

  dashboard:{title:'Dashboard',pillar:'corespace',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Dashboard</div><div class="pg-sub">Your personal command center</div></div></div>
    <div class="pg-section"><div class="pg-section-label">Overview</div>
      <div class="cg cg-3">
        ${[{n:'Tasks Done',v:'24',t:'↑ 12% this week',c:'60'},{n:'Focus Time',v:'6.2h',t:'↑ 3% this week',c:'200'},{n:'Notes Created',v:'8',t:'↑ 5% this week',c:'150'}].map(s=>`
        <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c})">${ci('trend',s.c)}<div class="card-title">${s.n}</div><div class="card-value">${s.v}</div><div class="card-trend">${s.t}</div></div>`).join('')}
      </div>
    </div>
    <div class="pg-section"><div class="pg-section-label">Pinned Modules</div>
      <div class="cg cg-1">
        ${['Tasks','Focus Sessions','Daily Journal','Knowledge Map'].map((n,i)=>`
        <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${[60,200,150,290][i]})">${ci(['check','timer','note','graph'][i],[60,200,150,290][i])}<div class="card-body"><div class="card-title">${n}</div><div class="card-sub">Pinned from ${['Productivity','Productivity','Productivity','Knowledge'][i]}</div></div></div>`).join('')}
      </div>
    </div>`},

  pinned:{title:'Pinned',pillar:'corespace',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Pinned</div><div class="pg-sub">Your bookmarked items</div></div><span class="pg-badge">4 items</span></div>
    <div class="cg cg-2">
      ${[{n:'Q3 Strategy',t:'Document',c:'260'},{n:'Design System v2',t:'File',c:'290'},{n:'Sprint Planning',t:'Project Board',c:'150'},{n:'Weekly Review',t:'Note',c:'60'}].map(p=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${p.c})">${ci('note',p.c)}<div class="card-title">${p.n}</div><div class="card-sub">${p.t} · 2h ago</div></div>`).join('')}
    </div>`},

  notifications:{title:'Notifications',pillar:'corespace',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Notifications</div><div class="pg-sub">Recent alerts</div></div><span class="pg-badge">12 new</span></div>
    <div class="cg cg-1">
      ${[{t:'@alex mentioned you in Sprint Planning',s:'2m ago',c:'260'},{t:'Task "Design Review" is due today',s:'1h ago',c:'60'},{t:'New comment on Q3 Strategy',s:'3h ago',c:'150'},{t:'Goal "Launch v2" hit 80%',s:'5h ago',c:'200'}].map(n=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${n.c})">${ci('bell',n.c)}<div class="card-body"><div class="card-title">${n.t}</div><div class="card-sub">${n.s}</div></div></div>`).join('')}
    </div>`},

  quickcapture:{title:'Quick Capture',pillar:'corespace',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Quick Capture</div><div class="pg-sub">Dump it here, sort it later</div></div></div>
    <div class="card" style="padding:16px;margin-bottom:16px">
      <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">What's on your mind?</div>
      <div style="background:var(--surface-3);border-radius:8px;padding:12px;min-height:80px;font-size:13px;color:var(--text-2)">Start typing…</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        ${['Note','Task','Idea','Reference'].map((t,i)=>`<span class="tag" style="cursor:pointer;background:oklch(0.22 0.06 ${[150,60,290,200][i]});color:oklch(0.72 0.12 ${[150,60,290,200][i]})">${t}</span>`).join('')}
      </div>
    </div>
    <div class="pg-section"><div class="pg-section-label">Recent Captures</div>
      <div class="cg cg-1">
        ${[{t:'Look into OKLCH for the new color system',type:'Idea',c:'290'},{t:'Read "Shape Up" chapter 4',type:'Task',c:'60'},{t:'Cross-reference Pulsar architecture with Linear',type:'Note',c:'150'}].map(i=>`
        <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${i.c})"><div class="card-body"><div class="card-title">${i.t}</div></div><span class="tag">${i.type}</span></div>`).join('')}
      </div>
    </div>`},

  focuslauncher:{title:'Focus Launcher',pillar:'corespace',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Focus Launcher</div><div class="pg-sub">Start deep work in one click</div></div></div>
    <div class="card" style="padding:24px;text-align:center;margin-bottom:16px">
      <div style="font-size:40px;font-weight:700;color:var(--text-1);letter-spacing:-1px;margin-bottom:4px">25:00</div>
      <div style="font-size:12px;color:var(--text-3);margin-bottom:16px">Focus Session</div>
      <button style="background:oklch(0.28 0.10 60);border:none;border-radius:8px;padding:10px 28px;color:oklch(0.82 0.14 60);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Start Session</button>
    </div>
    <div class="pg-section"><div class="pg-section-label">Recent Sessions</div>
      <div class="cg cg-1">
        ${[{n:'Pulsar UI work',d:'1h 20m',c:'60'},{n:'BiteRight planning',d:'45m',c:'150'},{n:'Research session',d:'2h',c:'200'}].map(s=>`
        <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${s.c})">${ci('timer',s.c)}<div class="card-body"><div class="card-title">${s.n}</div></div><span class="tag">${s.d}</span></div>`).join('')}
      </div>
    </div>`},

  momentum:{title:'Momentum',pillar:'corespace',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Momentum</div><div class="pg-sub">Your streak and progress at a glance</div></div></div>
    <div class="cg cg-3" style="margin-bottom:20px">
      ${[{n:'Day Streak',v:'14',t:'Keep it going',c:'60'},{n:'Tasks this week',v:'24',t:'Personal best',c:'200'},{n:'Focus hours',v:'12.4h',t:'↑ 8% vs last week',c:'150'}].map(s=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c})">${ci('trend',s.c)}<div class="card-title">${s.n}</div><div class="card-value">${s.v}</div><div class="card-trend">${s.t}</div></div>`).join('')}
    </div>
    <div class="pg-section"><div class="pg-section-label">Active Goals</div>
      <div class="cg cg-1">
        ${[{n:'Launch Pulsar v2',p:65,c:'60'},{n:'Win GT InVenture',p:20,c:'200'}].map(g=>`
        <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${g.c})"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><div class="card-title">${g.n}</div><span class="tag">${g.p}%</span></div>${prog(g.p,g.c)}</div>`).join('')}
      </div>
    </div>`},

  inbox:{title:'Inbox',pillar:'corespace',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Inbox</div><div class="pg-sub">Everything uncategorized — process it</div></div><span class="pg-badge">6 items</span></div>
    <div class="cg cg-1">
      ${[{t:'Notes from design review meeting',type:'Note',c:'150'},{t:'Follow up with Koray about PR',type:'Task',c:'60'},{t:'Interesting article on spaced repetition',type:'Reference',c:'200'},{t:'Idea: habit streaks tied to goals',type:'Idea',c:'290'},{t:'Screenshot of Linear shortcut UI',type:'Reference',c:'260'},{t:'Retro action items from last sprint',type:'Task',c:'60'}].map(i=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${i.c})"><div class="card-body"><div class="card-title">${i.t}</div></div><span class="tag">${i.type}</span></div>`).join('')}
    </div>`},

  notes:{title:'Notes',pillar:'knowledge',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Notes</div><div class="pg-sub">Full note type system</div></div><span class="pg-badge">38 notes</span></div>
    <div class="pg-section"><div class="pg-section-label">Note Types</div>
      <div class="cg cg-3">
        ${[{n:'Freeform',s:'Plain rich text',c:'150'},{n:'Structured',s:'Sections & headers',c:'260'},{n:'Concept',s:'Define one idea clearly',c:'60'},{n:'Literature',s:'Book or paper notes',c:'200'},{n:'Evergreen',s:'Refined over time',c:'290'},{n:'Argument Map',s:'Claim + evidence',c:'330'}].map(t=>`
        <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${t.c})">${ci('note',t.c)}<div class="card-title">${t.n}</div><div class="card-sub">${t.s}</div></div>`).join('')}
      </div>
    </div>
    <div class="pg-section"><div class="pg-section-label">Recent Notes</div>
      <div class="cg cg-1">
        ${[{n:'OKLCH Color System',t:'Concept · 2h ago',c:'150'},{n:'Pulsar Architecture v3',t:'Structured · 1d ago',c:'260'},{n:'Shape Up — Chapter 4',t:'Literature · 2d ago',c:'200'}].map(n=>`
        <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${n.c})">${ci('note',n.c)}<div class="card-body"><div class="card-title">${n.n}</div><div class="card-sub">${n.t}</div></div></div>`).join('')}
      </div>
    </div>`},

  topiclibrary:{title:'Topic Library',pillar:'knowledge',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Topic Library</div><div class="pg-sub">Your personal domain tree</div></div></div>
    <div class="cg cg-2">
      ${[{n:'Design Systems',count:14,sub:'Color, Typography, Components',c:'150'},{n:'Engineering',count:9,sub:'Architecture, Patterns, APIs',c:'260'},{n:'Cognitive Science',count:7,sub:'Memory, Attention, Learning',c:'60'},{n:'Product Strategy',count:5,sub:'Frameworks, Case Studies',c:'200'},{n:'Finance',count:4,sub:'Markets, Valuation, Risk',c:'290'},{n:'Biology',count:3,sub:'Cells, Systems, Evolution',c:'330'}].map(t=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${t.c})">${ci('book',t.c)}<div class="card-title">${t.n}</div><div class="card-sub">${t.sub}</div><div style="font-size:10px;color:var(--text-3);margin-top:6px">${t.count} notes</div></div>`).join('')}
    </div>`},

  studysheets:{title:'Study Sheets',pillar:'knowledge',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Study Sheets</div><div class="pg-sub">Compressed review formats</div></div></div>
    <div class="cg cg-1">
      ${[{n:'OKLCH & Color Theory',f:'Outline · 3 sources',c:'150',p:80},{n:'Fitts\u2019s Law & UX Principles',f:'Flashcard · 5 sources',c:'260',p:45},{n:'Spaced Repetition Methods',f:'Narrative · 2 sources',c:'60',p:100}].map(s=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c})">${ci('card',s.c)}<div class="card-title">${s.n}</div><div class="card-sub">${s.f}</div>${prog(s.p,s.c)}<div style="font-size:10px;color:var(--text-3);margin-top:4px">${s.p}% reviewed</div></div>`).join('')}
    </div>`},

  refvault:{title:'Reference Vault',pillar:'knowledge',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Reference Vault</div><div class="pg-sub">Sources, papers, annotated links</div></div></div>
    <div class="cg cg-1">
      ${[{n:'Thinking Fast and Slow',t:'Book',c:'150',p:45},{n:'The Design of Everyday Things',t:'Book',c:'260',p:80},{n:'Attention and Effort — Kahneman',t:'Paper',c:'60',p:20},{n:'Shape Up — Basecamp',t:'Article',c:'200',p:60}].map(r=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${r.c})">${ci('book',r.c)}<div class="card-title">${r.n}</div><div class="card-sub">${r.t}</div>${prog(r.p,r.c)}<div style="font-size:10px;color:var(--text-3);margin-top:4px">${r.p}% read</div></div>`).join('')}
    </div>`},

  conceptmap:{title:'Concept Map',pillar:'knowledge',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Concept Map</div><div class="pg-sub">Spatial canvas of connected ideas</div></div></div>
    <div class="cg cg-3">
      ${[{n:'Design Systems',links:12,c:'150'},{n:'Engineering',links:9,c:'260'},{n:'Product Strategy',links:7,c:'60'},{n:'Research',links:5,c:'200'},{n:'Personal',links:4,c:'290'},{n:'Archive',links:3,c:'330'}].map(g=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${g.c})">${ci('graph',g.c)}<div class="card-title">${g.n}</div><div class="card-sub">${g.links} connected notes</div>${prog(g.links*7,g.c)}</div>`).join('')}
    </div>`},

  accelerators:{title:'Accelerators',pillar:'knowledge',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Accelerators</div><div class="pg-sub">Structured learning tracks</div></div></div>
    <div class="cg cg-1">
      ${[{n:'UI Design Fundamentals',steps:8,done:5,c:'150'},{n:'System Design Basics',steps:10,done:2,c:'260'},{n:'Behavioral Psychology',steps:6,done:6,c:'60'}].map(a=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${a.c})">${ci('zap',a.c)}<div class="card-title">${a.n}</div><div class="card-sub">${a.done}/${a.steps} steps complete</div>${prog(Math.round(a.done/a.steps*100),a.c)}</div>`).join('')}
    </div>`},

  knowledgeinsights:{title:'Insight Dashboard',pillar:'knowledge',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Insight Dashboard</div><div class="pg-sub">Your knowledge at a glance</div></div></div>
    <div class="cg cg-3" style="margin-bottom:20px">
      ${[{n:'Notes Created',v:'38',c:'150'},{n:'Topics Covered',v:'6',c:'260'},{n:'References Saved',v:'12',c:'60'}].map(s=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c})">${ci('bar',s.c)}<div class="card-title">${s.n}</div><div class="card-value">${s.v}</div></div>`).join('')}
    </div>`},

  tasks:{title:'Tasks',pillar:'productivity',render:()=>`<div id="tasksRoot" style="height:100%;display:flex;flex-direction:column;min-height:0"></div>`},

  calendar:{title:'Calendar',pillar:'productivity',render:()=>{
    
    if(!document.getElementById('cv18-font')){
      const lk=document.createElement('link');lk.id='cv18-font';lk.rel='stylesheet';lk.href='https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap';
      document.head.appendChild(lk);
    }
    return `<div class="calv18-wrap"><div class="cv18" id="cv18Root"><div class="cv18-hdr"><div class="cv18-nav"><button class="cv18-nav-btn" id="cv18Prev"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg></button><button class="cv18-nav-btn" id="cv18Next"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg></button></div><h2 class="cv18-title" id="cv18Title"></h2><div class="cv18-clock"><div class="cv18-clock-display" id="cv18ClockDisplay"></div><div class="cv18-clock-toggle" id="cv18ClockToggle"></div><span class="cv18-clock-label" id="cv18ClockLabel">24h</span></div><div class="cv18-tabs" id="cv18Tabs"><div class="cv18-tab-bg" id="cv18TabBg"></div><button class="cv18-tab" data-v="year">Year</button><button class="cv18-tab" data-v="month">Month</button><button class="cv18-tab" data-v="week">Week</button><button class="cv18-tab" data-v="day">Day</button></div><div class="cv18-actions"><button class="cv18-btn cv18-btn-ghost" id="cv18TodayBtn">Today</button><button class="cv18-btn cv18-btn-pri" id="cv18AddBtn"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>New</button></div></div><main class="cv18-main" id="cv18Main"></main></div><div class="cv18-modal-bg" id="cv18ModalBg"><div class="cv18-modal"><div class="cv18-modal-hdr"><h3 id="cv18ModalTitle">New Event</h3><button class="cv18-modal-x" id="cv18ModalX">×</button></div><div class="cv18-modal-body"><form id="cv18Form"><div class="cv18-fg"><label>Title</label><input type="text" id="cv18FTitle" placeholder="What's happening?" required></div><div class="cv18-fg-row"><div class="cv18-fg"><label>Date</label><input type="date" id="cv18FDate" required></div><div class="cv18-fg"><label>Repeat</label><select id="cv18FRecur"><option value="">None</option><option value="daily">Daily</option><option value="weekly">Weekly</option></select></div></div><div class="cv18-fg-row"><div class="cv18-fg"><label>Start</label><input type="time" id="cv18FStart"></div><div class="cv18-fg"><label>End</label><input type="time" id="cv18FEnd"></div></div><div class="cv18-fg"><label>Category</label><div class="cv18-fg-colors" id="cv18FColors"><span class="cv18-fg-color cv18-c-skill" data-t="skill"></span><span class="cv18-fg-color cv18-c-pulsar" data-t="pulsar"></span><span class="cv18-fg-color cv18-c-health" data-t="health"></span><span class="cv18-fg-color cv18-c-work" data-t="work"></span><span class="cv18-fg-color cv18-c-school" data-t="school"></span><span class="cv18-fg-color cv18-c-fun" data-t="fun"></span><span class="cv18-fg-color cv18-c-worship" data-t="worship"></span><span class="cv18-fg-color cv18-c-personal" data-t="personal"></span><span class="cv18-fg-color cv18-c-routine" data-t="routine"></span><span class="cv18-fg-color cv18-c-urgent" data-t="urgent"></span><span class="cv18-fg-color cv18-c-meeting" data-t="meeting"></span></div></div><input type="hidden" id="cv18FTag" value="default"><input type="hidden" id="cv18FId" value=""></form></div><div class="cv18-modal-ft"><button type="button" class="cv18-btn cv18-btn-del" id="cv18DelBtn" style="display:none">Delete</button><button type="submit" form="cv18Form" class="cv18-btn cv18-btn-pri">Save</button></div></div></div><div class="cv18-tooltip" id="cv18Tooltip"></div><div class="cv18-toast" id="cv18Toast"></div></div>`;
  }},

  projects:{title:'Project Boards',pillar:'productivity',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Project Boards</div><div class="pg-sub">Kanban, list, and timeline views</div></div><span class="pg-badge">3 active</span></div>
    <div class="cg cg-2">
      ${[{n:'Pulsar v2',tasks:12,done:8,c:'60'},{n:'BiteRight App',tasks:9,done:4,c:'150'},{n:'GT InVenture',tasks:6,done:6,c:'200'}].map(p=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${p.c})">${ci('clip',p.c)}<div class="card-title">${p.n}</div><div class="card-sub">${p.done}/${p.tasks} tasks</div>${prog(Math.round(p.done/p.tasks*100),p.c)}</div>`).join('')}
    </div>`},

  focus:{title:'Focus Sessions',pillar:'productivity',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Focus Sessions</div><div class="pg-sub">Deep work this week</div></div></div>
    <div class="card" style="padding:24px;text-align:center;margin-bottom:16px">
      <div style="font-size:40px;font-weight:700;color:var(--text-1);letter-spacing:-1px;margin-bottom:4px">25:00</div>
      <div style="font-size:12px;color:var(--text-3);margin-bottom:16px">Ready to focus</div>
      <button style="background:oklch(0.28 0.10 60);border:none;border-radius:8px;padding:10px 28px;color:oklch(0.82 0.14 60);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Start Session</button>
    </div>
    <div class="cg cg-3">
      ${[['Mon',90],['Tue',120],['Wed',0],['Thu',75],['Fri',45]].map(([d,m])=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 60)"><div class="card-title" style="color:var(--text-2)">${d}</div><div class="card-value" style="font-size:18px">${m?Math.floor(m/60)+'h '+(m%60)+'m':'—'}</div>${prog(Math.min(100,m/120*100),60)}</div>`).join('')}
    </div>`},

  habits:{title:'Habits',pillar:'productivity',render:()=>`<div id="habitsRoot" style="min-height:600px"></div>`},

  goals:{title:'Goals',pillar:'productivity',render:()=>`<div id="goalsRoot" style="min-height:600px"></div>`},

  journal:{title:'Journal',pillar:'productivity',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Journal</div><div class="pg-sub">Daily reflection</div></div></div>
    <div class="card" style="padding:16px;margin-bottom:16px">
      <div style="font-size:11px;color:var(--text-3);margin-bottom:8px">Today · Feb 19</div>
      <div style="font-size:13px;color:var(--text-2);font-style:italic;margin-bottom:12px">What did you make progress on today?</div>
      <div style="background:var(--surface-3);border-radius:8px;padding:12px;min-height:80px;font-size:13px;color:var(--text-2)">Start writing…</div>
      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <span style="font-size:11px;color:var(--text-3)">Mood:</span>
        ${['😌','😤','😴','🔥','😊'].map(e=>`<span style="cursor:pointer;font-size:16px">${e}</span>`).join('')}
      </div>
    </div>
    <div class="pg-section"><div class="pg-section-label">Past Entries</div>
      <div class="cg cg-1">
        ${[{d:'Feb 18',t:'Worked on the dashboard carousel, fixed the JS bug finally',c:'150'},{d:'Feb 17',t:'BiteRight planning session with the team',c:'60'},{d:'Feb 16',t:'Deep dive into behavioral psychology principles',c:'200'}].map(e=>`
        <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${e.c})"><div style="font-size:10px;color:var(--text-3);margin-bottom:4px">${e.d}</div><div class="card-title">${e.t}</div></div>`).join('')}
      </div>
    </div>`},

  prodscore:{title:'Productivity Score',pillar:'insights',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Productivity Score</div><div class="pg-sub">Your composite performance metric</div></div></div>
    <div class="cg cg-3" style="margin-bottom:20px">
      ${[{n:'Tasks',v:82,c:'60'},{n:'Focus',v:74,c:'200'},{n:'Habits',v:91,c:'150'}].map(s=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c})"><div class="card-title">${s.n}</div><div class="card-value">${s.v}</div>${prog(s.v,s.c)}</div>`).join('')}
    </div>`},

  heatmap:{title:'Focus Heatmap',pillar:'insights',render:()=>{
    const hours=['9am','10am','11am','12pm','1pm','2pm','3pm','4pm','5pm'];
    const days=['M','T','W','T','F'];
    const data=[[3,5,8,4,2],[7,9,6,3,5],[8,7,9,8,6],[2,1,3,5,4],[6,8,7,9,8],[4,3,2,4,6],[5,7,8,6,7],[3,4,5,3,4],[2,1,3,2,1]];
    return `<div class="pg-header"><div><div class="pg-title">Focus Heatmap</div><div class="pg-sub">When you work best</div></div></div>
    <div class="card"><div style="display:grid;grid-template-columns:36px repeat(5,1fr);gap:4px">
      <div></div>${days.map(d=>`<div style="text-align:center;font-size:10px;color:var(--text-3);padding-bottom:4px">${d}</div>`).join('')}
      ${hours.map((h,hi)=>`<div style="font-size:10px;color:var(--text-3);display:flex;align-items:center">${h}</div>${days.map((_,di)=>{const v=data[hi][di];return`<div style="height:26px;border-radius:4px;background:oklch(${0.18+v*0.03} ${v*0.016} 200)"></div>`;}).join('')}`).join('')}
    </div></div>`;
  }},

  knowledgegrowth:{title:'Knowledge Growth',pillar:'insights',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Knowledge Growth</div><div class="pg-sub">How your domains expand over time</div></div></div>
    <div class="cg cg-2">
      ${[{n:'Notes Created',vals:[4,6,5,8,8],c:'150'},{n:'Topics Added',vals:[1,2,1,3,2],c:'260'},{n:'References Saved',vals:[2,3,4,3,5],c:'60'},{n:'Study Sheets',vals:[0,1,2,2,3],c:'200'}].map(t=>{
        const mx=Math.max(...t.vals);
        return`<div class="card card-accent" style="--ca:oklch(0.6 0.14 ${t.c})"><div class="card-title">${t.n}</div><div style="display:flex;align-items:flex-end;gap:5px;height:44px;margin-top:12px">${t.vals.map(v=>`<div style="flex:1;border-radius:3px 3px 0 0;background:oklch(0.6 0.14 ${t.c});height:${Math.round(v/mx*100)}%;opacity:0.8"></div>`).join('')}</div></div>`;}).join('')}
    </div>`},

  habittrends:{title:'Habit & Goal Trends',pillar:'insights',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Habit & Goal Trends</div><div class="pg-sub">Consistency patterns over time</div></div></div>
    <div class="cg cg-1">
      ${[{n:'Morning pages',streak:14,best:21,c:'60'},{n:'30 min deep work',streak:7,best:14,c:'150'},{n:'Read 20 min',streak:3,best:10,c:'200'},{n:'Evening review',streak:21,best:21,c:'290'}].map(h=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${h.c})">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px"><div class="card-title">${h.n}</div><span class="tag">🔥 ${h.streak}d</span></div>
        ${prog(Math.round(h.streak/h.best*100),h.c)}
        <div style="font-size:10px;color:var(--text-3);margin-top:4px">Best: ${h.best} days</div>
      </div>`).join('')}
    </div>`},

  graphbuilder:{title:'Custom Graph Builder',pillar:'insights',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Custom Graph Builder</div><div class="pg-sub">Drag any data, pick any chart</div></div></div>
    <div class="card" style="padding:20px;margin-bottom:16px;min-height:140px;display:flex;align-items:center;justify-content:center;border:1.5px dashed var(--border)">
      <div style="text-align:center;color:var(--text-3)">
        <div style="font-size:24px;margin-bottom:8px">+</div>
        <div style="font-size:12px">Drag a data source here or pick one below</div>
      </div>
    </div>
    <div class="pg-section"><div class="pg-section-label">Data Sources</div>
      <div class="cg cg-3">
        ${[{n:'Tasks',c:'60'},{n:'Focus Sessions',c:'200'},{n:'Habits',c:'150'},{n:'Goals',c:'290'},{n:'Notes',c:'260'},{n:'Journal',c:'330'}].map(s=>`
        <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${s.c})">${ci('bar',s.c)}<div class="card-body"><div class="card-title">${s.n}</div></div></div>`).join('')}
      </div>
    </div>`},

  sessionlog:{title:'Session Log',pillar:'insights',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Session Log</div><div class="pg-sub">Full history of focus sessions</div></div></div>
    <div class="cg cg-1">
      ${[{n:'Pulsar UI — dropdown fix',d:'1h 20m',date:'Today',c:'60'},{n:'BiteRight planning',d:'45m',date:'Today',c:'150'},{n:'Research — behavioral psych',d:'2h',date:'Yesterday',c:'200'},{n:'GT InVenture prep',d:'30m',date:'Feb 17',c:'290'}].map(s=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${s.c})">${ci('timer',s.c)}<div class="card-body"><div class="card-title">${s.n}</div><div class="card-sub">${s.date}</div></div><span class="tag">${s.d}</span></div>`).join('')}
    </div>`},

  weeklysnapshot:{title:'Weekly Snapshot',pillar:'insights',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Weekly Snapshot</div><div class="pg-sub">Feb 10 – Feb 16</div></div><span class="pg-badge tag-new" style="display:inline-flex">New</span></div>
    <div class="cg cg-2">
      ${[{n:'Tasks Completed',v:'24',t:'↑ 12% vs last week',c:'60'},{n:'Focus Sessions',v:'8',t:'5h 40m total',c:'200'},{n:'Notes Added',v:'8',t:'↑ 5% vs last week',c:'150'},{n:'Habit Score',v:'91%',t:'Best week ever',c:'290'}].map(s=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c})"><div class="card-title">${s.n}</div><div class="card-value">${s.v}</div><div class="card-trend">${s.t}</div></div>`).join('')}
    </div>`},

  layoutstudio:{title:'Layout Studio',pillar:'customization',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Layout Studio</div><div class="pg-sub">Grid and type view builder</div></div></div>
    <div class="card" style="padding:20px;margin-bottom:16px;min-height:160px;display:flex;align-items:center;justify-content:center;border:1.5px dashed var(--border)">
      <div style="text-align:center;color:var(--text-3)">
        <div style="font-size:24px;margin-bottom:8px">⊞</div>
        <div style="font-size:12px">Drag modules to build your layout</div>
      </div>
    </div>
    <div class="pg-section"><div class="pg-section-label">Saved Layouts</div>
      <div class="cg cg-2">
        ${[{n:'Default',active:true,c:'290'},{n:'Focus Mode',active:false,c:'260'},{n:'Research Setup',active:false,c:'150'},{n:'Sprint View',active:false,c:'60'}].map(l=>`
        <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${l.c})">${ci('layout',l.c)}<div style="display:flex;justify-content:space-between;align-items:center"><div class="card-title">${l.n}</div>${l.active?`<span class="tag tag-on">Active</span>`:''}</div></div>`).join('')}
      </div>
    </div>`},

  themebuilder:{title:'Theme Builder',pillar:'customization',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Theme Builder</div><div class="pg-sub">Color, typography, density</div></div></div>
    <div class="cg cg-3">
      ${[{n:'Pulsar Dark',active:true,bg:'oklch(0.12 0.02 290)',c:'260'},{n:'Midnight',active:false,bg:'oklch(0.10 0 0)',c:'290'},{n:'Forest',active:false,bg:'oklch(0.12 0.04 150)',c:'150'},{n:'Ocean',active:false,bg:'oklch(0.12 0.04 220)',c:'220'},{n:'Ember',active:false,bg:'oklch(0.12 0.04 30)',c:'30'},{n:'Custom',active:false,bg:'oklch(0.14 0.02 290)',c:'290'}].map(t=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${t.c})">
        <div style="height:44px;border-radius:6px;background:${t.bg};margin-bottom:10px;border:1px solid var(--border-subtle)"></div>
        <div style="display:flex;justify-content:space-between;align-items:center"><div class="card-title">${t.n}</div>${t.active?`<span class="tag tag-on">Active</span>`:''}</div>
      </div>`).join('')}
    </div>`},

  notetypeeditor:{title:'Note Type Editor',pillar:'customization',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Note Type Editor</div><div class="pg-sub">Customize and create note types</div></div></div>
    <div class="cg cg-2">
      ${[{n:'Freeform',fields:2,c:'150'},{n:'Structured',fields:4,c:'260'},{n:'Concept',fields:5,c:'60'},{n:'Literature',fields:6,c:'200'},{n:'Project Board',fields:7,c:'290'},{n:'+ New Type',fields:0,c:'330'}].map(t=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${t.c})">${ci('note',t.c)}<div class="card-title">${t.n}</div><div class="card-sub">${t.fields?t.fields+' fields':'Start from scratch'}</div></div>`).join('')}
    </div>`},

  modulelibrary:{title:'Module Library',pillar:'customization',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Module Library</div><div class="pg-sub">Browse, install, and build modules</div></div></div>
    <div class="cg cg-2">
      ${[{n:'Habit Tracker',s:'Productivity',installed:true,c:'60'},{n:'Concept Map',s:'Knowledge',installed:true,c:'150'},{n:'Focus Timer',s:'Productivity',installed:false,c:'200'},{n:'Reading List',s:'Knowledge',installed:false,c:'260'},{n:'Goal Board',s:'Productivity',installed:false,c:'290'},{n:'Tag Graph',s:'Customization',installed:false,c:'330'}].map(m=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${m.c})">${ci('stack',m.c)}<div class="card-body"><div class="card-title">${m.n}</div><div class="card-sub">${m.s}</div></div><span class="tag ${m.installed?'tag-on':''}">${m.installed?'Installed':'Get'}</span></div>`).join('')}
    </div>`},

  tagexplorer:{title:'Tag Explorer',pillar:'customization',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Tag Explorer</div><div class="pg-sub">Visual tag graph with relationships</div></div></div>
    <div class="cg cg-3">
      ${[{n:'#design',count:14,c:'150'},{n:'#engineering',count:9,c:'260'},{n:'#pulsar',count:22,c:'290'},{n:'#research',count:7,c:'200'},{n:'#biteright',count:11,c:'60'},{n:'#learning',count:5,c:'330'}].map(t=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${t.c})"><div class="card-title" style="font-family:monospace">${t.n}</div><div class="card-sub">${t.count} notes</div></div>`).join('')}
    </div>`},

  shortcuts:{title:'Shortcut Editor',pillar:'customization',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Shortcut Editor</div><div class="pg-sub">Remap any action</div></div></div>
    <div class="cg cg-1">
      ${[{n:'Open Search',k:'⌘K',c:'290'},{n:'New Note',k:'⌘N',c:'150'},{n:'Toggle Sidebar',k:'⌘ |',c:'260'},{n:'Focus Mode',k:'⌘⇧F',c:'60'},{n:'Quick Capture',k:'⌘⇧C',c:'200'},{n:'Go to Today',k:'⌘T',c:'330'}].map(s=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${s.c})"><div class="card-body"><div class="card-title">${s.n}</div></div><code style="font-size:11px;background:var(--surface-3);padding:3px 8px;border-radius:5px;color:var(--text-2);font-family:monospace">${s.k}</code></div>`).join('')}
    </div>`},

  viewtemplates:{title:'View Templates',pillar:'customization',render:()=>`
    <div class="pg-header"><div><div class="pg-title">View Templates</div><div class="pg-sub">Save and share layouts</div></div></div>
    <div class="cg cg-2">
      ${[{n:'Semester Setup',s:'Student · 4 modules',c:'150'},{n:'Sprint View',s:'Team · 6 modules',c:'60'},{n:'Research Dashboard',s:'Deep Learner · 5 modules',c:'200'},{n:'Founder OS',s:'Professional · 7 modules',c:'290'}].map(t=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${t.c})">${ci('layout',t.c)}<div class="card-title">${t.n}</div><div class="card-sub">${t.s}</div></div>`).join('')}
    </div>`},

  teamspaces:{title:'Team Spaces',pillar:'collaboration',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Team Spaces</div><div class="pg-sub">Shared workspaces</div></div><span class="pg-badge">2 spaces</span></div>
    <div class="cg cg-2">
      ${[{n:'Pulsar Core Team',members:4,c:'330'},{n:'BiteRight',members:4,c:'150'}].map(s=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c});min-height:120px">${ci('users',s.c)}<div class="card-title">${s.n}</div><div class="card-sub">${s.members} members</div></div>`).join('')}
    </div>`},

  multiboards:{title:'Multiplayer Boards',pillar:'collaboration',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Multiplayer Boards</div><div class="pg-sub">Real-time collaborative editing</div></div></div>
    <div class="cg cg-1">
      ${[{n:'Pulsar v2 Sprint',active:2,c:'330'},{n:'BiteRight Roadmap',active:1,c:'150'},{n:'GT InVenture Plan',active:3,c:'60'}].map(b=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${b.c})">${ci('clip',b.c)}<div class="card-body"><div class="card-title">${b.n}</div><div class="card-sub">${b.active} people active now</div></div><span class="tag tag-on">Live</span></div>`).join('')}
    </div>`},

  sharedgoals:{title:'Shared Goals',pillar:'collaboration',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Shared Goals</div><div class="pg-sub">Team-level objectives</div></div></div>
    <div class="cg cg-1">
      ${[{n:'Ship Pulsar v2',p:65,team:'Pulsar Core',c:'330'},{n:'Win GT InVenture',p:20,team:'BiteRight',c:'150'}].map(g=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${g.c})">${ci('target',g.c)}<div style="display:flex;justify-content:space-between;margin-bottom:6px"><div class="card-title">${g.n}</div><span class="tag">${g.p}%</span></div><div class="card-sub">${g.team}</div>${prog(g.p,g.c)}</div>`).join('')}
    </div>`},

  sharedknowledge:{title:'Shared Knowledge',pillar:'collaboration',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Shared Knowledge</div><div class="pg-sub">Build knowledge together</div></div></div>
    <div class="cg cg-2">
      ${[{n:'Pulsar Design System',notes:14,c:'330'},{n:'BiteRight Research',notes:7,c:'150'},{n:'GT InVenture Docs',notes:9,c:'60'},{n:'Engineering Reference',notes:11,c:'260'}].map(k=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${k.c})">${ci('stack',k.c)}<div class="card-title">${k.n}</div><div class="card-sub">${k.notes} shared notes</div></div>`).join('')}
    </div>`},

  comments:{title:'Comments & Threads',pillar:'collaboration',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Comments & Threads</div><div class="pg-sub">Inline on any note or task</div></div><span class="pg-badge">5 unread</span></div>
    <div class="cg cg-1">
      ${[{user:'@alex',text:'Looks great, ship it!',doc:'Design System v2',t:'2m ago',c:'330'},{user:'@koray',text:'Can we add dark mode here?',doc:'Pulsar Architecture',t:'1h ago',c:'260'},{user:'@ghibran',text:'Fixed the carousel bug ✓',doc:'Dropdown Component',t:'3h ago',c:'150'},{user:'@princeton',text:'Added grocery store logic',doc:'BiteRight App',t:'5h ago',c:'60'}].map(c=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${c.c})"><div style="display:flex;justify-content:space-between;margin-bottom:5px"><div class="card-title">${c.user}</div><div style="font-size:10px;color:var(--text-3)">${c.t}</div></div><div class="card-sub">${c.text}</div><div style="font-size:10px;color:var(--text-3);margin-top:4px">on ${c.doc}</div></div>`).join('')}
    </div>`},

  activityfeed:{title:'Activity Feed',pillar:'collaboration',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Activity Feed</div><div class="pg-sub">Everything happening across shared spaces</div></div></div>
    <div class="cg cg-1">
      ${[{user:'@alex',action:'completed task "Review PR #42"',t:'2m ago',c:'330'},{user:'@koray',action:'added a note to Pulsar Architecture',t:'15m ago',c:'260'},{user:'@ghibran',action:'checked in Habit: Morning pages',t:'1h ago',c:'150'},{user:'@princeton',action:'moved "Grocery logic" to Done',t:'2h ago',c:'60'}].map(a=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${a.c})">
        <div style="width:26px;height:26px;border-radius:50%;background:oklch(0.22 0.08 ${a.c});display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:oklch(0.72 0.14 ${a.c});flex-shrink:0">${a.user[1].toUpperCase()}</div>
        <div class="card-body"><div class="card-title"><span style="color:oklch(0.75 0.12 ${a.c})">${a.user}</span> ${a.action}</div><div class="card-sub">${a.t}</div></div>
      </div>`).join('')}
    </div>`},

  permissions:{title:'Permission Layers',pillar:'collaboration',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Permission Layers</div><div class="pg-sub">Access control per space and note</div></div></div>
    <div class="cg cg-1">
      ${[{n:'@alex',role:'Admin',c:'330'},{n:'@koray',role:'Editor',c:'260'},{n:'@ghibran',role:'Editor',c:'150'},{n:'@princeton',role:'Viewer',c:'60'}].map(p=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${p.c})">
        <div style="width:28px;height:28px;border-radius:50%;background:oklch(0.22 0.08 ${p.c});display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:oklch(0.72 0.14 ${p.c});flex-shrink:0">${p.n[1].toUpperCase()}</div>
        <div class="card-body"><div class="card-title">${p.n}</div></div><span class="tag">${p.role}</span>
      </div>`).join('')}
    </div>`},

  installedapps:{title:'Installed Apps',pillar:'extensions',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Installed Apps</div><div class="pg-sub">Active integrations</div></div></div>
    <div class="cg cg-1">
      ${[{n:'Notion',s:'Syncing 38 pages',on:true,c:'260'},{n:'Google Calendar',s:'12 events this week',on:true,c:'200'},{n:'GitHub',s:'Last push 2h ago',on:true,c:'290'},{n:'Readwise',s:'Not connected',on:false,c:'60'},{n:'Zotero',s:'Not connected',on:false,c:'150'},{n:'Linear',s:'Not connected',on:false,c:'330'}].map(p=>`
      <div class="card card-row">
        ${ci('plug',p.c)}<div class="card-body"><div class="card-title">${p.n}</div><div class="card-sub">${p.s}</div></div>
        <span class="tag ${p.on?'tag-on':''}">${p.on?'On':'Off'}</span>
      </div>`).join('')}
    </div>`},

  importexport:{title:'Import / Export',pillar:'extensions',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Import / Export</div><div class="pg-sub">Migrate in or out of Pulsar</div></div></div>
    <div class="pg-section"><div class="pg-section-label">Import From</div>
      <div class="cg cg-3">
        ${['Notion','Obsidian','Roam','Markdown','CSV','Bear'].map((n,i)=>`
        <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${[260,290,150,200,60,330][i]})">${ci('folder',[260,290,150,200,60,330][i])}<div class="card-title">${n}</div></div>`).join('')}
      </div>
    </div>
    <div class="pg-section"><div class="pg-section-label">Export As</div>
      <div class="cg cg-3">
        ${['Markdown','JSON','CSV'].map((n,i)=>`
        <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${[150,260,60][i]})">${ci('note',[150,260,60][i])}<div class="card-body"><div class="card-title">${n}</div></div></div>`).join('')}
      </div>
    </div>`},

  automations:{title:'Automations',pillar:'extensions',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Automations</div><div class="pg-sub">Connect events and actions across pillars</div></div></div>
    <div class="pg-section"><div class="pg-section-label">Active Automations</div>
      <div class="cg cg-1">
        ${[{n:'Focus ends → log to Journal',active:true,c:'20'},{n:'Task complete → update Goal progress',active:true,c:'60'},{n:'New note → tag by topic',active:false,c:'150'}].map(a=>`
        <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${a.c})">${ci('zap',a.c)}<div class="card-body"><div class="card-title">${a.n}</div></div><span class="tag ${a.active?'tag-on':''}">${a.active?'On':'Off'}</span></div>`).join('')}
      </div>
    </div>
    <div class="pg-section"><div class="pg-section-label">Recipes</div>
      <div class="cg cg-2">
        ${[{n:'Daily Review',s:'Journal + Tasks + Habits',c:'200'},{n:'Sprint Kickoff',s:'Goals + Board + Calendar',c:'290'},{n:'Study Session',s:'Focus + Notes + Flashcards',c:'150'},{n:'Weekly Reset',s:'Snapshot + Inbox clear',c:'60'}].map(r=>`
        <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${r.c})">${ci('zap',r.c)}<div class="card-title">${r.n}</div><div class="card-sub">${r.s}</div></div>`).join('')}
      </div>
    </div>`},

  devapi:{title:'Developer API',pillar:'extensions',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Developer API</div><div class="pg-sub">Build on Pulsar</div></div></div>
    <div class="cg cg-2" style="margin-bottom:16px">
      ${[{n:'API Calls today',v:'1.2k',c:'20'},{n:'Active tokens',v:'2',c:'260'}].map(s=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c})"><div class="card-title">${s.n}</div><div class="card-value" style="font-size:20px">${s.v}</div></div>`).join('')}
    </div>
    <div class="pg-section"><div class="pg-section-label">Endpoints</div>
      <div class="cg cg-1">
        ${['/v1/notes','/v1/tasks','/v1/analytics','/v1/automations'].map(e=>`
        <div class="card card-row"><code style="font-size:11px;flex:1;color:oklch(0.72 0.14 20);font-family:monospace">${e}</code><span class="tag">REST</span></div>`).join('')}
      </div>
    </div>`},

  labs:{title:'Labs',pillar:'extensions',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Labs</div><div class="pg-sub">Experimental features — opt in</div></div><span class="pg-badge">3 active</span></div>
    <div class="cg cg-1">
      ${[{n:'AI Co-pilot',s:'Inline writing suggestions',on:true,c:'20'},{n:'Voice Notes',s:'Transcribe audio to notes',on:true,c:'260'},{n:'Smart Folders',s:'Auto-organize by topic',on:true,c:'150'},{n:'Neural Search',s:'Semantic search v2',on:false,c:'200'}].map(l=>`
      <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${l.c})">${ci('beaker',l.c)}<div class="card-body"><div class="card-title">${l.n}</div><div class="card-sub">${l.s}</div></div><span class="tag ${l.on?'tag-on':''}">${l.on?'On':'Off'}</span></div>`).join('')}
    </div>`},

  sessionbackup:{title:'Session Backup',pillar:'extensions',render:()=>`
    <div class="pg-header"><div><div class="pg-title">Session Backup & Export</div><div class="pg-sub">Your data, always yours</div></div></div>
    <div class="cg cg-2" style="margin-bottom:16px">
      ${[{n:'Last Backup',v:'2h ago',c:'20'},{n:'Total Size',v:'48 MB',c:'260'}].map(s=>`
      <div class="card card-accent" style="--ca:oklch(0.6 0.14 ${s.c})"><div class="card-title">${s.n}</div><div class="card-value" style="font-size:20px">${s.v}</div></div>`).join('')}
    </div>
    <div class="pg-section"><div class="pg-section-label">Export Everything</div>
      <div class="cg cg-3">
        ${['Markdown','JSON','CSV'].map((n,i)=>`
        <div class="card card-row card-accent" style="--ca:oklch(0.6 0.14 ${[150,260,60][i]})">${ci('note',[150,260,60][i])}<div class="card-body"><div class="card-title">${n}</div></div></div>`).join('')}
      </div>
    </div>`},

}

const bodyEl      = document.getElementById('body');
const toggleBtn   = document.getElementById('toggle');
const switcher    = document.getElementById('switcher');
const carousel    = document.getElementById('carousel');
const dropdown    = document.getElementById('pillarDropdown');
const dcontent    = document.getElementById('dropdownContent');
const breadcrumbNav = document.getElementById('breadcrumbNav');
const contentArea = document.getElementById('contentArea');
const items       = Array.from(carousel.querySelectorAll('.carousel__item'));

let current = 6, busy = false, isOpen = false;
const DUR = 180, EASE = 'cubic-bezier(0.25,0.46,0.45,0.94)';

function initCarousel() {
  items.forEach((el, i) => {
    el.style.transition = 'none';
    el.style.opacity   = i === current ? '1' : '0';
    el.style.transform = i === current ? 'none' : 'translateY(12px)';
  });
}

function rotate(dir) {
  if (busy) return; busy = true;
  const from = items[current];
  current = (current + dir + items.length) % items.length;
  const to = items[current];

  from.style.transition = `opacity ${DUR}ms ${EASE}, transform ${DUR}ms ${EASE}`;
  from.style.opacity = '0';
  from.style.transform = `translateY(${dir * 12}px)`;

  to.style.transition = 'none';
  to.style.opacity = '0';
  to.style.transform = `translateY(${-dir * 12}px)`;
  void to.offsetHeight;
  to.style.transition = `opacity ${DUR}ms ${EASE}, transform ${DUR}ms ${EASE}`;
  to.style.opacity = '1';
  to.style.transform = 'none';

  if (isOpen) {
    dcontent.style.transition = 'opacity 120ms ease';
    dcontent.style.opacity = '0';
    setTimeout(() => {
      buildDropdown();
      dcontent.style.transition = 'opacity 160ms ease';
      dcontent.style.opacity = '1';
    }, 120);
  }

  setTimeout(() => { busy = false; }, DUR);
}

// Scroll anywhere on carousel to rotate
carousel.addEventListener('wheel', e => { e.preventDefault(); rotate(e.deltaY > 0 ? -1 : 1); }, { passive: false });
document.getElementById('prevBtn').addEventListener('click', e => { e.stopPropagation(); rotate(-1); });
document.getElementById('nextBtn').addEventListener('click', e => { e.stopPropagation(); rotate(1); });

// Click anywhere on carousel row → icon clicks go to pillar home, label/rest toggles dropdown
carousel.addEventListener('click', e => {
  if (e.target.closest('.carousel__controls')) return;

  const iconEl = e.target.closest('.icon[data-pillar-home]');
  const labelEl = e.target.closest('.carousel__label-click');

  if (iconEl) {
    const currentPillar = items[current].dataset.pillar;
    loadPillarHome(currentPillar);
    markActiveIcon();
  } else if (labelEl || (!iconEl && !e.target.closest('.carousel__controls'))) {
    isOpen ? closeDropdown() : openDropdown();
  }
});

function markActiveIcon() {
  items.forEach(el => {
    const ic = el.querySelector('.icon');
    ic.classList.remove('icon--active');
    ic.style.boxShadow = '';
    el.classList.remove('is-current');
  });
  const curItem = items[current];
  const curIcon = curItem.querySelector('.icon');
  curIcon.classList.add('icon--active');
  const colorMatch = curIcon.style.color || 'oklch(0.72 0.14 260)';
  curIcon.style.boxShadow = '0 0 0 2px ' + colorMatch;
  curItem.classList.add('is-current');
}

function buildDropdown() {
  const key = items[current].dataset.pillar;
  const d   = PILLARS[key]; if (!d) return;

  dcontent.innerHTML = d.sections.map(sec => `
    <div class="dropdown__section">
      <div class="dropdown__section-label">${sec.title}</div>
      ${sec.items.map(it => `
        <div class="dropdown__item" data-page="${it.page}">
          <div class="dropdown__item-icon" style="color:${d.accent}">${IC[it.i]||IC.grid}</div>
          <span class="dropdown__item-name">${it.n}</span>
          ${it.b ? `<span class="dropdown__item-badge">${it.b}</span>` : ''}
        </div>`).join('')}
    </div>`).join('') +
    `
    `;

  dcontent.querySelectorAll('.dropdown__item[data-page]').forEach(el => {
    el.addEventListener('click', () => loadPage(el.dataset.page));
  });
}

// segments: [{label, onclick}] — last one is current (no link)
function renderBreadcrumb(segments) {
  breadcrumbNav.innerHTML = segments.map((s, i) => {
    const isLast = i === segments.length - 1;
    const sep = i > 0 ? '<span class="breadcrumb__sep">›</span>' : '';
    if (isLast) return sep + '<span class="breadcrumb__current">' + s.label + '</span>';
    return sep + '<span class="breadcrumb__link" data-bc="' + i + '">' + s.label + '</span>';
  }).join('');
  // bind clicks
  breadcrumbNav.querySelectorAll('[data-bc]').forEach(el => {
    const idx = +el.dataset.bc;
    el.onclick = segments[idx].onclick;
  });
}

function setBreadcrumb(pillarKey, pageTitle) {
  const pillar = PILLARS[pillarKey];
  if (!pillar) { renderBreadcrumb([{label:'Overview'}]); return; }
  // if pageTitle is same as pillar label or null — pillar home, single crumb
  if (!pageTitle || pageTitle === pillar.label) {
    renderBreadcrumb([{label: pillar.label}]);
  } else {
    renderBreadcrumb([
      {label: pillar.label, onclick: () => loadPillarHome(pillarKey)},
      {label: pageTitle}
    ]);
  }
}

// extend breadcrumb with extra segments (e.g. task view name)
function pushBreadcrumb(segments) {
  // re-render by appending to current
  const existing = [...breadcrumbNav.querySelectorAll('.breadcrumb__current, .breadcrumb__link')].map((el, i) => ({
    label: el.textContent,
    onclick: el.onclick || null
  }));
  // make the last existing item a link again
  const allSegs = existing.map((s, i) => {
    if (i === existing.length - 1 && segments.length > 0) return {...s}; // will get onclick from caller
    return s;
  });
  renderBreadcrumb([...allSegs, ...segments]);
}

let _activePage = null;
function loadPage(pageKey) {
  const pg = PAGES[pageKey]; if (!pg) return;
  _activePage = pageKey;
  setBreadcrumb(pg.pillar, pg.title);
  contentArea.innerHTML = `<div class="content-area">${pg.render()}</div>`;
  if(pageKey==='calendar'&&typeof initCalendarV18==='function')setTimeout(initCalendarV18,0);
  if(pageKey==='goals'&&typeof initGoalsApp==='function')setTimeout(initGoalsApp,0);
  if(pageKey==='habits'&&typeof initHabitsApp==='function')setTimeout(initHabitsApp,0);
  if(pageKey==='tasks'&&typeof initTasksApp==='function')setTimeout(initTasksApp,0);
}

function loadPillarHome(pillarKey) {
  const d = PILLARS[pillarKey]; if (!d) return;
  setBreadcrumb(pillarKey, null);
  const hue = d.accent.split(' ').pop().replace(')','');
  const html = d.sections.map(sec => {
    const cards = sec.items.map(it => {
      const svg = (IC[it.i]||IC.grid).replace('stroke="currentColor"', 'stroke="' + d.accent + '"');
      const badge = it.b ? '<div class="card-badge">' + it.b + '</div>' : '';
      return '<div class="card card-accent" style="--ca:' + d.accent + '" data-page="' + it.page + '">'
        + '<div class="card-icon" style="background:oklch(0.22 0.06 ' + hue + ')">' + svg + '</div>'
        + '<div class="card-title">' + it.n + '</div>'
        + badge
        + '</div>';
    }).join('');
    return '<div class="pg-section"><div class="pg-section-label">' + sec.title + '</div>'
      + '<div class="cg cg-3">' + cards + '</div></div>';
  }).join('');

  contentArea.innerHTML = '<div class="content-area">'
    + '<div class="pg-header"><div>'
    + '<div class="pg-title">' + d.label + '</div>'
    + '<div class="pg-sub">Choose a space to open</div>'
    + '</div></div>'
    + html + '</div>';

  contentArea.querySelectorAll('[data-page]').forEach(el => {
    el.addEventListener('click', () => loadPage(el.dataset.page));
  });
}

function openDropdown() {
  buildDropdown();
  dropdown.style.transition = 'none';
  dropdown.style.height = 'auto';
  dropdown.style.opacity = '1';
  const h = dropdown.scrollHeight;
  dropdown.style.height = '0';
  dropdown.style.opacity = '0';
  void dropdown.offsetHeight;

  dcontent.style.opacity = '0';
  switcher.classList.add('is-open');
  isOpen = true;

  requestAnimationFrame(() => {
    dropdown.style.transition = 'height 360ms cubic-bezier(0.16,1,0.3,1), opacity 200ms ease';
    dropdown.style.height = h + 'px';
    dropdown.style.opacity = '1';
    setTimeout(() => {
      dcontent.style.transition = 'opacity 240ms ease';
      dcontent.style.opacity = '1';
    }, 80);
  });
}

function closeDropdown() {
  isOpen = false; // set immediately so next click registers right away
  dcontent.style.transition = 'opacity 160ms ease';
  dcontent.style.opacity = '0';
  setTimeout(() => {
    dropdown.style.transition = 'height 320ms cubic-bezier(0.4,0,0.2,1), opacity 240ms ease';
    dropdown.style.height = '0';
    dropdown.style.opacity = '0';
    switcher.classList.remove('is-open');
  }, 60);
}

// carousel click handled above via delegation
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && isOpen) { closeDropdown(); return; }

  const cal = window._cv18;
  if (_activePage === 'tasks') {
    const tag2 = document.activeElement?.tagName;
    if (tag2 !== 'INPUT' && tag2 !== 'TEXTAREA' && tag2 !== 'SELECT') {
      const vmap = {'1':'list','2':'kanban','3':'timeline'};
      if (vmap[e.key]) {
        e.preventDefault();
        const tab = document.querySelector(`.pta-tab[data-v="${vmap[e.key]}"]`);
        if (tab) tab.click();
        return;
      }
    }
  }

  if (_activePage === 'calendar' && cal) {
    const tag = document.activeElement && document.activeElement.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
    if (cal.isModalOpen && cal.isModalOpen()) return;

    const view = cal.getView();

    if (e.key === '1') { e.preventDefault(); cal.setView('year'); return; }
    if (e.key === '2') { e.preventDefault(); cal.setView('month'); return; }
    if (e.key === '3') { e.preventDefault(); cal.setView('week'); return; }
    if (e.key === '4') { e.preventDefault(); cal.setView('day'); return; }

    if (e.key === 't' || e.key === 'T') { e.preventDefault(); cal.today(); return; }

    if (e.key === 'n' || e.key === 'N') { e.preventDefault(); cal.newEvent(); return; }

    if (e.shiftKey && e.key === 'ArrowRight') { e.preventDefault(); cal.nav(1); return; }
    if (e.shiftKey && e.key === 'ArrowLeft')  { e.preventDefault(); cal.nav(-1); return; }
    if (e.shiftKey && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
      e.preventDefault();
      const scrollable = document.querySelector('.cv18-day-scroll, .cv18-mo-grid, .cv18-yr-grid');
      if (scrollable) scrollable.scrollBy({ top: e.key === 'ArrowDown' ? 100 : -100, behavior: 'smooth' });
      return;
    }

  }
});

toggleBtn.addEventListener('click', () => {
  bodyEl.classList.toggle('collapsed');
  toggleBtn.textContent = bodyEl.classList.contains('collapsed') ? '▶' : '◀';
  if (isOpen) closeDropdown();
});

initCarousel();
markActiveIcon();
loadPage('dashboard');

function initCalendarV18(){
  const root=document.getElementById('cv18Root');
  if(!root)return;
  if(root._cv18Init)return;
  root._cv18Init=true;
  if(window._cv18Interval){clearInterval(window._cv18Interval);window._cv18Interval=null;}
  const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],DAYSFULL=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],MO18=['January','February','March','April','May','June','July','August','September','October','November','December'],MOS18=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],HOUR_H=52,START_HOUR=4,END_HOUR=24;
  const VL={YR:'year',MO:'month',WK:'week',DY:'day'};
  const g=id=>document.getElementById(id),qa=s=>document.querySelectorAll(s);
  let tooltipTimeout=null;
  const WORK_TAGS=['skill','pulsar','work','school','urgent','meeting','routine'];
  function classifyEv(ev){const tag=ev.tag||'default';if(WORK_TAGS.includes(tag))return'work';const t=(ev.title||'').toLowerCase();if(['study','learn','practice','build','code','write','design','meeting','call','review','plan','prep'].some(k=>t.includes(k)))return'work';return'leisure'}
  function calcBalance(evs){let wm=0,lm=0;evs.forEach(ev=>{if(!ev.start)return;const t=classifyEv(ev),s=tMin(ev.start),e=ev.end?tMin(ev.end):s+30,d=e-s;if(t==='work')wm+=d;else lm+=d});return{workHrs:Math.round(wm/60*10)/10,leisureHrs:Math.round(lm/60*10)/10,workMins:wm,leisureMins:lm,ratio:wm>0?(lm/wm):0}}
  function weekday18(o){const d=new Date();d.setDate(d.getDate()-d.getDay()+o+7);return fmt18(d)}
  function genMock(){const ev=[];let id=1;[1,2,3,4].forEach(day=>{const d=weekday18(day);ev.push({id:'e'+(id++),title:'Workout',date:d,start:'04:30',end:'05:00',tag:'health',done:day<=2,auto:false});ev.push({id:'e'+(id++),title:'Math Study',date:d,start:'05:10',end:'05:40',tag:'skill',done:day<=1,auto:false});ev.push({id:'e'+(id++),title:'Piano',date:d,start:'05:50',end:'06:20',tag:'skill',done:day<=1,auto:false});ev.push({id:'e'+(id++),title:'School',date:d,start:'07:30',end:'16:00',tag:'school',done:day<=2,auto:false});ev.push({id:'e'+(id++),title:'Skill Growth',date:d,start:'19:00',end:'20:30',tag:'skill',done:false,auto:false});ev.push({id:'e'+(id++),title:'Pulsar',date:d,start:'20:30',end:'23:00',tag:'pulsar',done:false,auto:false})});const fri=weekday18(5);ev.push({id:'e'+(id++),title:'Workout',date:fri,start:'04:30',end:'05:00',tag:'health',auto:false},{id:'e'+(id++),title:'School',date:fri,start:'07:30',end:'13:00',tag:'school',auto:false},{id:'e'+(id++),title:'Jumuah',date:fri,start:'13:00',end:'15:00',tag:'worship',auto:false},{id:'e'+(id++),title:'Work',date:fri,start:'17:00',end:'21:00',tag:'work',auto:false},{id:'e'+(id++),title:'Valorant',date:fri,start:'23:00',end:'23:59',tag:'fun',auto:false});const sat=weekday18(6);ev.push({id:'e'+(id++),title:'Workout',date:sat,start:'04:30',end:'05:00',tag:'health',auto:false},{id:'e'+(id++),title:'Piano',date:sat,start:'05:10',end:'06:00',tag:'skill',auto:false},{id:'e'+(id++),title:'Work',date:sat,start:'11:00',end:'15:00',tag:'work',auto:false},{id:'e'+(id++),title:'Pulsar',date:sat,start:'15:00',end:'17:30',tag:'pulsar',auto:false},{id:'e'+(id++),title:'Valorant',date:sat,start:'21:00',end:'22:30',tag:'fun',auto:false});const sun=weekday18(0);ev.push({id:'e'+(id++),title:'Pulsar',date:sun,start:'06:00',end:'08:00',tag:'pulsar',done:true,auto:false},{id:'e'+(id++),title:'Piano',date:sun,start:'08:30',end:'10:30',tag:'skill',done:true,auto:false},{id:'e'+(id++),title:'Pulsar',date:sun,start:'15:00',end:'17:00',tag:'pulsar',auto:false});ev.push({id:'e'+(id++),title:'BiteRight Sync',date:weekday18(3),start:'18:00',end:'18:30',tag:'meeting',auto:false});return ev}
  let CS={v:VL.WK,y:new Date().getFullYear(),m:new Date().getMonth(),d:new Date().getDate(),ev:[],anim:null,use24h:true};
  const fmt18=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const parse18=s=>{const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d)};
  const isToday18=d=>{const t=new Date();return d.getFullYear()===t.getFullYear()&&d.getMonth()===t.getMonth()&&d.getDate()===t.getDate()};
  const weekStart18=d=>{const w=d.getDay();return new Date(d.getFullYear(),d.getMonth(),d.getDate()-w)};
  const daysIn18=(y,m)=>new Date(y,m+1,0).getDate();
  const firstDay18=(y,m)=>new Date(y,m,1).getDay();
  const tMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m};
  const minToPos=m=>((m/60)-START_HOUR)*HOUR_H;
  function fmtTime(t){if(!t)return'';const[h,m]=t.split(':');const hr=+h;if(CS.use24h)return`${hr}:${m}`;return`${hr%12||12}:${m}${hr<12?'a':'p'}`}
  function fmtHour(hr){if(CS.use24h)return hr+':00';if(hr===0)return'12a';if(hr<12)return hr+'a';if(hr===12)return'12p';return(hr-12)+'p'}
  function loadState(){try{const s=localStorage.getItem('pulsar_v18');CS.ev=s?JSON.parse(s):genMock();if(!s)saveState();const p=localStorage.getItem('pulsar_prefs18');if(p)CS.use24h=JSON.parse(p).use24h!==false}catch{CS.ev=genMock();saveState()}}
  function saveState(){localStorage.setItem('pulsar_v18',JSON.stringify(CS.ev))}
  function eventsFor18(date){const ds=fmt18(date);return CS.ev.filter(e=>{if(e.date===ds)return true;if(e.recur){const ed=parse18(e.date);if(ed>date)return false;const diff=Math.floor((date-ed)/864e5);if(e.recur==='daily')return true;if(e.recur==='weekly')return diff%7===0}return false}).sort((a,b)=>(a.start||'99').localeCompare(b.start||'99'))}
  function cv18Toast(msg){const t=g('cv18Toast');if(!t)return;t.textContent=msg;t.classList.add('on');setTimeout(()=>t.classList.remove('on'),2500)}
  function updateTabBg18(){const tabs=root.querySelectorAll('.cv18-tab'),bg=g('cv18TabBg');if(!bg)return;tabs.forEach(t=>{if(t.dataset.v===CS.v){bg.style.width=t.offsetWidth+'px';bg.style.height=t.offsetHeight+'px';bg.style.left=t.offsetLeft+'px';bg.style.top=t.offsetTop+'px'}t.classList.toggle('on',t.dataset.v===CS.v)})}
  function renderTitle18(){let t='';if(CS.v==='year')t=CS.y;else if(CS.v==='month')t=`${MO18[CS.m]}<span>${CS.y}</span>`;else if(CS.v==='week'){const ws=weekStart18(new Date(CS.y,CS.m,CS.d));t=`${MOS18[ws.getMonth()]} ${ws.getDate()}<span>${ws.getFullYear()}</span>`}else t=`${MO18[CS.m]} ${CS.d}<span>${CS.y}</span>`;const el=g('cv18Title');if(el)el.innerHTML=t}
  function renderYear18(){let h='<div class="cv18-yr-grid">';for(let m=0;m<12;m++){h+=`<div class="cv18-yr-mo" data-m="${m}"><div class="cv18-yr-mo-name">${MOS18[m]}</div><div class="cv18-yr-days">`;const fd=firstDay18(CS.y,m),days=daysIn18(CS.y,m);for(let i=0;i<fd;i++)h+='<div class="cv18-yr-d"></div>';for(let d=1;d<=days;d++){const date=new Date(CS.y,m,d),hev=eventsFor18(date).length>0,td=isToday18(date);h+=`<div class="cv18-yr-d${hev?' ev':''}${td?' td':''}">${d}</div>`}h+='</div></div>'}return h+'</div>'}
  function renderMonth18(){let h='<div class="cv18-mo-wrap"><div class="cv18-mo-hdr">';DAYS.forEach(d=>h+=`<span>${d}</span>`);h+='</div><div class="cv18-mo-grid">';const fd=firstDay18(CS.y,CS.m),days=daysIn18(CS.y,CS.m),prev=daysIn18(CS.y,CS.m-1);for(let i=fd-1;i>=0;i--)h+=moDay18(new Date(CS.y,CS.m-1,prev-i),true);for(let d=1;d<=days;d++)h+=moDay18(new Date(CS.y,CS.m,d),false);const tot=fd+days,rem=(7-tot%7)%7;for(let d=1;d<=rem;d++)h+=moDay18(new Date(CS.y,CS.m+1,d),true);return h+'</div></div>'}
  function moDay18(date,ot){const evts=eventsFor18(date),td=isToday18(date),dateStr=fmt18(date);let h=`<div class="cv18-mo-day${ot?' ot':''}${td?' td':''}" data-dt="${dateStr}"><div class="cv18-mo-day-num">${date.getDate()}</div>`;if(evts.length){const show=evts.slice(0,5),more=evts.length-5;h+=`<div class="cv18-dot-pill" data-date="${dateStr}">`;show.forEach(e=>h+=`<span class="cv18-dot cv18-c-${e.tag||'default'}${e.done?' done':''}" data-id="${e.id}"></span>`);if(more>0)h+=`<span class="cv18-dot-more">+${more}</span>`;h+='</div>'}return h+'</div>'}
  function showTooltip18(el,dateStr){clearTimeout(tooltipTimeout);const evts=eventsFor18(parse18(dateStr));if(!evts.length)return;tooltipTimeout=setTimeout(()=>{const tip=g('cv18Tooltip');if(!tip)return;let h='';evts.forEach(e=>h+=`<div class="cv18-tip-item${e.done?' done':''}" data-id="${e.id}"><span class="cv18-dot cv18-c-${e.tag||'default'}"></span><span class="name">${e.title}</span>${e.start?`<span class="time">${fmtTime(e.start)}</span>`:''}</div>`);tip.innerHTML=h;const rect=el.getBoundingClientRect();let left=rect.left+rect.width/2-90;let top=rect.bottom+6;if(left<8)left=8;if(left+210>window.innerWidth)left=window.innerWidth-218;if(top+200>window.innerHeight)top=rect.top-206;tip.style.left=left+'px';tip.style.top=top+'px';tip.classList.add('show');tip.onclick=e=>{const item=e.target.closest('.cv18-tip-item');if(item)editEv18(item.dataset.id)}},500)}
  function hideTooltip18(){clearTimeout(tooltipTimeout);const t=g('cv18Tooltip');if(t)t.classList.remove('show')}
  function renderWeek18(){const ws=weekStart18(new Date(CS.y,CS.m,CS.d));let h='<div class="cv18-wk-wrap"><div class="cv18-wk-grid">';for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const evts=eventsFor18(d),td=isToday18(d);h+=`<div class="cv18-wk-col${td?' td':''}" data-dt="${fmt18(d)}"><div class="cv18-wk-hdr"><div class="nm">${DAYS[d.getDay()]}</div><div class="dt">${d.getDate()}</div></div><div class="cv18-wk-body">`;if(evts.length){evts.forEach(e=>h+=`<div class="cv18-wk-ev cv18-c-${e.tag||'default'}${e.done?(e.auto?' auto':' done'):''}" data-id="${e.id}"><span class="cv18-chk${e.done?(e.auto?' auto':' done'):''}" data-id="${e.id}"></span><div class="info"><div class="title">${e.title}</div>${e.start?`<div class="time">${fmtTime(e.start)}</div>`:''}</div></div>`)}else{h+='<div class="cv18-wk-empty">—</div>'}h+='</div></div>'}return h+'</div></div>'}
  function renderDay18(){const date=new Date(CS.y,CS.m,CS.d),evts=eventsFor18(date),allDay=evts.filter(e=>!e.start),timed=evts.filter(e=>e.start),done=evts.filter(e=>e.done).length,total=evts.length,pct=total?Math.round(done/total*100):0,remaining=total-done,now=new Date(),isCurrentDay=isToday18(date),nowMin=now.getHours()*60+now.getMinutes(),circ=2*Math.PI*20,offset=circ-(pct/100)*circ;
    const bal=calcBalance(evts);let balText='',balIcon='';if(bal.workHrs===0&&bal.leisureHrs===0){balText='Free day';balIcon='🌤️'}else if(bal.ratio<0.15){balText='Heavy work day';balIcon='💪'}else if(bal.ratio<0.4){balText='Productive flow';balIcon='🎯'}else if(bal.ratio<0.8){balText='Balanced day';balIcon='⚖️'}else{balText='Chill vibes';balIcon='😌'}
    let h=`<div class="cv18-day-wrap"><div class="cv18-day-hdr"><div class="cv18-day-big"><div class="num">${date.getDate()}</div><div class="wd">${DAYS[date.getDay()]}</div></div><div class="cv18-day-meta"><div class="full">${DAYSFULL[date.getDay()]}, ${MO18[date.getMonth()]} ${date.getFullYear()}</div><div class="sub" id="cv18DaySub">${total} event${total!==1?'s':''}${done?' · '+done+' done':''}</div></div><div class="cv18-day-prog"><div class="cv18-prog-ring"><svg><circle class="bg" cx="21" cy="21" r="17"/><circle class="fill" cx="21" cy="21" r="17" stroke-dasharray="${2*Math.PI*17}" stroke-dashoffset="${2*Math.PI*17-(pct/100)*2*Math.PI*17}" id="cv18ProgRing"/></svg><div class="pct" id="cv18ProgPct">${pct}%</div></div><div class="cv18-prog-info"><div class="label">Progress</div><div class="detail" id="cv18ProgDetail">${remaining} left</div></div></div></div><div class="cv18-day-body"><div class="cv18-day-main">`;
    if(allDay.length){h+='<div class="cv18-day-allday"><div class="cv18-day-allday-title">All Day</div><div class="cv18-day-allday-list">';allDay.forEach(e=>h+=`<div class="cv18-day-allday-ev cv18-c-${e.tag||'default'}${e.done?(e.auto?' auto':' done'):''}" data-id="${e.id}"><span class="cv18-chk${e.done?(e.auto?' auto':' done'):''}" data-id="${e.id}"></span><span>${e.title}</span></div>`);h+='</div></div>'}
    h+='<div class="cv18-day-scroll" id="cv18DayScroll"><div class="cv18-day-grid"><div class="cv18-day-times">';
    for(let hr=START_HOUR;hr<END_HOUR;hr++)h+=`<div class="cv18-day-time">${fmtHour(hr)}</div>`;
    h+='</div><div class="cv18-day-hours">';for(let hr=START_HOUR;hr<END_HOUR;hr++)h+=`<div class="cv18-day-hour" data-hr="${hr}"></div>`;
    if(isCurrentDay&&nowMin>=START_HOUR*60&&nowMin<END_HOUR*60)h+=`<div class="cv18-now-line" style="top:${minToPos(nowMin)}px"><div class="cv18-now-dot"></div></div>`;
    const positioned=timed.map(e=>{const sm=tMin(e.start),em=e.end?tMin(e.end):sm+30;return{...e,startMin:sm,endMin:em}});
    positioned.forEach((e,i)=>{let col=0;const ov=positioned.slice(0,i).filter(o=>o.startMin<e.endMin&&o.endMin>e.startMin);if(ov.length){const used=ov.map(o=>o.column||0);while(used.includes(col))col++}e.column=col});
    positioned.forEach(e=>{const top=minToPos(e.startMin),height=Math.max((e.endMin-e.startMin)/60*HOUR_H,30),small=height<44,lo=e.column*33;h+=`<div class="cv18-day-ev cv18-c-${e.tag||'default'}${e.done?(e.auto?' auto':' done'):''}${small?' small':''}" data-id="${e.id}" style="top:${top}px;height:${height}px;left:${6+lo}px"><div class="top"><span class="cv18-chk${e.done?(e.auto?' auto':' done'):''}" data-id="${e.id}"></span><div class="info"><div class="title">${e.title}</div><div class="time">${fmtTime(e.start)}${e.end?' – '+fmtTime(e.end):''}</div></div></div></div>`});
    h+='</div></div></div></div>';
    const focusMins=timed.filter(e=>classifyEv(e)==='work').reduce((acc,e)=>{const s=tMin(e.start),en=e.end?tMin(e.end):s+30;return acc+(en-s)},0);
    h+=`<div class="cv18-day-side"><div class="cv18-insights"><div class="cv18-insights-title">⚡ Insights</div><div class="cv18-insight-item"><div class="cv18-insight-icon">🎯</div><div class="cv18-insight-text"><strong>${Math.round(focusMins/60*10)/10}h</strong> deep work</div></div><div class="cv18-insight-item"><div class="cv18-insight-icon">${balIcon}</div><div class="cv18-insight-text">${balText}</div></div><div class="cv18-insight-item"><div class="cv18-insight-icon">📊</div><div class="cv18-insight-text"><strong>${bal.workHrs}h</strong> work · <strong>${bal.leisureHrs}h</strong> chill</div></div></div><div class="cv18-day-notes"><div class="cv18-day-notes-title">Notes</div><textarea id="cv18Notes" placeholder="Capture thoughts...">${getNotes18(fmt18(date))}</textarea></div></div></div></div>`;
    return h}
  function getNotes18(d){try{return JSON.parse(localStorage.getItem('pulsar_notes18')||'{}')[d]||''}catch{return''}}
  function saveNotes18(d,t){const n=JSON.parse(localStorage.getItem('pulsar_notes18')||'{}');n[d]=t;localStorage.setItem('pulsar_notes18',JSON.stringify(n))}
  function autoCheck18(){const now=new Date(),today=fmt18(now),nowMin=now.getHours()*60+now.getMinutes();let changed=false;CS.ev.forEach(ev=>{if(ev.done||!ev.end||!ev.start)return;if(ev.date<today||(ev.date===today&&tMin(ev.end)<=nowMin)){ev.done=true;ev.auto=true;changed=true}});if(changed)saveState()}
  function render18(preserveScroll=false){const anim=CS.anim||'';CS.anim=null;let scrollTop=0;const ds=document.querySelector('.cv18-day-scroll');if(preserveScroll&&ds)scrollTop=ds.scrollTop;let h='';if(CS.v==='year')h=renderYear18();else if(CS.v==='month')h=renderMonth18();else if(CS.v==='week')h=renderWeek18();else h=renderDay18();const mainEl=g('cv18Main');if(!mainEl)return;mainEl.innerHTML=`<div class="cv18-view ${anim?'anim-'+anim:''}">${h}</div>`;renderTitle18();updateTabBg18();bind18();if(CS.v==='day'){const ns=document.querySelector('.cv18-day-scroll');if(ns){if(preserveScroll&&scrollTop)ns.scrollTop=scrollTop;else{const now=new Date(),th=Math.max(START_HOUR,now.getHours()-2);ns.scrollTop=(th-START_HOUR)*HOUR_H}}}}
  function bind18(){root.querySelectorAll('.cv18-yr-mo').forEach(el=>el.onclick=()=>{CS.m=+el.dataset.m;CS.anim='zi';CS.v='month';render18()});root.querySelectorAll('.cv18-mo-day').forEach(el=>{el.onclick=e=>{if(e.target.closest('.cv18-dot-pill'))return;const d=parse18(el.dataset.dt);CS.y=d.getFullYear();CS.m=d.getMonth();CS.d=d.getDate();CS.anim='zi';CS.v='week';render18()};el.ondblclick=()=>openModal18(el.dataset.dt)});root.querySelectorAll('.cv18-dot-pill').forEach(el=>{el.onmouseenter=()=>showTooltip18(el,el.dataset.date);el.onmouseleave=hideTooltip18});root.querySelectorAll('.cv18-wk-col').forEach(el=>{el.onclick=e=>{if(e.target.closest('.cv18-chk')||e.target.closest('.cv18-wk-ev'))return;const d=parse18(el.dataset.dt);CS.y=d.getFullYear();CS.m=d.getMonth();CS.d=d.getDate();CS.anim='zi';CS.v='day';render18()};el.ondblclick=e=>{if(!e.target.closest('.cv18-wk-ev'))openModal18(el.dataset.dt)}});root.querySelectorAll('.cv18-wk-ev').forEach(el=>el.onclick=e=>{if(!e.target.closest('.cv18-chk'))editEv18(el.dataset.id)});root.querySelectorAll('.cv18-day-hour').forEach(el=>{el.ondblclick=()=>{const hr=String(el.dataset.hr).padStart(2,'0');openModal18(fmt18(new Date(CS.y,CS.m,CS.d)),hr+':00')}});root.querySelectorAll('.cv18-day-ev,.cv18-day-allday-ev').forEach(el=>el.onclick=e=>{if(!e.target.closest('.cv18-chk'))editEv18(el.dataset.id)});root.querySelectorAll('.cv18-chk').forEach(el=>el.onclick=e=>{e.stopPropagation();toggle18(el.dataset.id,el)});root.querySelectorAll('.cv18-tab').forEach(t=>t.onclick=()=>{const oi=['year','month','week','day'].indexOf(CS.v),ni=['year','month','week','day'].indexOf(t.dataset.v);CS.anim=ni>oi?'zi':'zo';CS.v=t.dataset.v;render18()});const notes=g('cv18Notes');if(notes)notes.oninput=()=>saveNotes18(fmt18(new Date(CS.y,CS.m,CS.d)),notes.value)}
  function toggle18(id,chkEl){const ev=CS.ev.find(e=>e.id===id);if(!ev)return;if(ev.done&&ev.auto){ev.auto=false;saveState();if(chkEl){chkEl.classList.remove('auto');chkEl.classList.add('done','pop');setTimeout(()=>chkEl.classList.remove('pop'),400)}root.querySelectorAll('.cv18-chk[data-id="'+id+'"]').forEach(c=>{c.classList.remove('auto');c.classList.add('done')});root.querySelectorAll('.cv18-wk-ev[data-id="'+id+'"],.cv18-day-ev[data-id="'+id+'"],.cv18-day-allday-ev[data-id="'+id+'"]').forEach(p=>{p.classList.remove('auto');p.classList.add('done')});cv18Toast('✓ Confirmed!');return}ev.done=!ev.done;ev.auto=false;saveState();if(chkEl){chkEl.classList.add('pop');setTimeout(()=>chkEl.classList.remove('pop'),400)}root.querySelectorAll('.cv18-chk[data-id="'+id+'"]').forEach(c=>c.classList.toggle('done',ev.done));root.querySelectorAll('.cv18-wk-ev[data-id="'+id+'"],.cv18-day-ev[data-id="'+id+'"],.cv18-day-allday-ev[data-id="'+id+'"]').forEach(p=>p.classList.toggle('done',ev.done));cv18Toast(ev.done?'✓ Done!':'Undone')}
  function openModal18(date,time){const bg=g('cv18ModalBg');if(!bg)return;bg.classList.add('on');g('cv18Form').reset();g('cv18FDate').value=date||fmt18(new Date());g('cv18FStart').value=time||'';g('cv18FId').value='';g('cv18ModalTitle').textContent='New Event';g('cv18DelBtn').style.display='none';root.querySelectorAll('.cv18-fg-color').forEach(t=>t.classList.remove('on'));g('cv18FTag').value='default';setTimeout(()=>g('cv18FTitle').focus(),100)}
  function editEv18(id){const ev=CS.ev.find(e=>e.id===id);if(!ev)return;hideTooltip18();const bg=g('cv18ModalBg');if(!bg)return;bg.classList.add('on');g('cv18FTitle').value=ev.title;g('cv18FDate').value=ev.date;g('cv18FStart').value=ev.start||'';g('cv18FEnd').value=ev.end||'';g('cv18FRecur').value=ev.recur||'';g('cv18FTag').value=ev.tag||'default';g('cv18FId').value=ev.id;g('cv18ModalTitle').textContent='Edit Event';g('cv18DelBtn').style.display='block';root.querySelectorAll('.cv18-fg-color').forEach(t=>t.classList.toggle('on',t.dataset.t===ev.tag))}
  function closeModal18(){const bg=g('cv18ModalBg');if(bg)bg.classList.remove('on')}
  function nav18(dir){CS.anim=dir>0?'sl':'sr';if(CS.v==='year')CS.y+=dir;else if(CS.v==='month'){CS.m+=dir;if(CS.m>11){CS.m=0;CS.y++}else if(CS.m<0){CS.m=11;CS.y--}}else if(CS.v==='week'){const ws=weekStart18(new Date(CS.y,CS.m,CS.d));ws.setDate(ws.getDate()+dir*7);CS.y=ws.getFullYear();CS.m=ws.getMonth();CS.d=ws.getDate()}else{const d=new Date(CS.y,CS.m,CS.d);d.setDate(d.getDate()+dir);CS.y=d.getFullYear();CS.m=d.getMonth();CS.d=d.getDate()}render18()}
  function goToday18(){const t=new Date();CS.y=t.getFullYear();CS.m=t.getMonth();CS.d=t.getDate();CS.anim='zi';CS.v='day';render18()}
  function updateClock18(){const now=new Date();let h=now.getHours(),m=now.getMinutes(),s=now.getSeconds();if(!CS.use24h)h=h%12||12;const el=g('cv18ClockDisplay');if(el)el.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;const nl=document.querySelector('.cv18-now-line');if(nl){const nm=now.getHours()*60+now.getMinutes();if(nm>=START_HOUR*60&&nm<END_HOUR*60)nl.style.top=minToPos(nm)+'px'}}
  const prevBtn=g('cv18Prev'),nextBtn=g('cv18Next'),todayBtn=g('cv18TodayBtn'),addBtn=g('cv18AddBtn'),modalX=g('cv18ModalX'),modalBg=g('cv18ModalBg'),delBtn=g('cv18DelBtn'),form=g('cv18Form'),clockToggle=g('cv18ClockToggle');
  if(prevBtn)prevBtn.onclick=()=>nav18(-1);
  if(nextBtn)nextBtn.onclick=()=>nav18(1);
  if(todayBtn)todayBtn.onclick=goToday18;
  if(addBtn)addBtn.onclick=()=>openModal18();
  if(modalX)modalX.onclick=closeModal18;
  if(modalBg)modalBg.onclick=e=>{if(e.target===modalBg)closeModal18()};
  if(delBtn)delBtn.onclick=()=>{const id=g('cv18FId').value;CS.ev=CS.ev.filter(e=>e.id!==id);saveState();closeModal18();CS.anim='zo';render18();cv18Toast('Deleted')};
  if(form)form.onsubmit=e=>{e.preventDefault();const id=g('cv18FId').value||'e'+Date.now(),ev={id,title:g('cv18FTitle').value,date:g('cv18FDate').value,start:g('cv18FStart').value||null,end:g('cv18FEnd').value||null,tag:g('cv18FTag').value,recur:g('cv18FRecur').value||null,done:false,auto:false};if(g('cv18FId').value){const i=CS.ev.findIndex(x=>x.id===id);if(i>-1){ev.done=CS.ev[i].done;ev.auto=CS.ev[i].auto||false;CS.ev[i]=ev}}else CS.ev.push(ev);saveState();closeModal18();CS.anim='zi';render18();cv18Toast(g('cv18FId').value?'Updated':'Created')};
  root.querySelectorAll('.cv18-fg-color').forEach(t=>t.onclick=()=>{root.querySelectorAll('.cv18-fg-color').forEach(x=>x.classList.remove('on'));t.classList.add('on');g('cv18FTag').value=t.dataset.t});
  if(clockToggle)clockToggle.onclick=()=>{CS.use24h=!CS.use24h;localStorage.setItem('pulsar_prefs18',JSON.stringify({use24h:CS.use24h}));g('cv18ClockLabel').textContent=CS.use24h?'24h':'12h';clockToggle.classList.toggle('on',!CS.use24h);updateClock18()};
  loadState();autoCheck18();render18();updateClock18();
  if(window._cv18Interval)clearInterval(window._cv18Interval);
  window._cv18Interval=setInterval(updateClock18,1000);

  window._cv18={
    nav:nav18,
    today:goToday18,
    setView:v=>{const views=['year','month','week','day'];const oi=views.indexOf(CS.v),ni=views.indexOf(v);if(ni<0)return;CS.anim=ni>oi?'zi':'zo';CS.v=v;render18()},
    drillDown:()=>{
      if(CS.v==='year'){CS.anim='zi';CS.m=CS.cur.m;CS.y=CS.cur.y;CS.v='month';render18();}
      else if(CS.v==='month'){CS.anim='zi';CS.d=CS.cur.d;CS.m=CS.cur.m;CS.y=CS.cur.y;CS.v='week';render18();}
      else if(CS.v==='week'){CS.anim='zi';CS.v='day';render18();}
    },
    drillUp:()=>{const views=['year','month','week','day'];const i=views.indexOf(CS.v);if(i>0){CS.anim='zo';CS.v=views[i-1];render18()}},
    getView:()=>CS.v,
    newEvent:()=>openModal18(),
    isModalOpen:()=>{const bg=g('cv18ModalBg');return bg&&bg.classList.contains('on');}
  };
}

function initGoalsApp(){
  const root=document.getElementById('goalsRoot');
  if(!root||root._goalsInit)return;
  root._goalsInit=true;

  

  root.innerHTML=`<div class="ga">
    <div class="ga-wrap">
      <div class="ga-list" id="gaList">

        <div id="gaCards"></div>
      </div>
      <div class="ga-side" id="gaSide"></div>
    </div>
    <!-- Modal -->
    <div class="ga-mo" id="gaMo">
      <div class="ga-mbox">
        <h3 id="gaMoTitle">New goal</h3>
        <label>Title</label><input id="gaFTitle" placeholder="e.g. Ship Pulsar v1" maxlength="60">
        <label>Description</label><textarea id="gaFDesc" placeholder="What does success look like?"></textarea>
        <div class="row">
          <div><label>Category</label>
            <select id="gaFCat">
              <option value="work">Work</option><option value="personal">Personal</option>
              <option value="health">Health</option><option value="learning">Learning</option>
              <option value="finance">Finance</option><option value="creative">Creative</option>
            </select>
          </div>
          <div><label>Priority</label>
            <select id="gaFPri">
              <option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div><label>Start</label><input type="date" id="gaFStart"></div>
          <div><label>End</label><input type="date" id="gaFEnd"></div>
        </div>

        <div class="ga-prog-wrap" id="gaProgWrap">
          <div class="ga-prog-header"><span>Progress</span><em id="gaProgVal">0%</em></div>
          <div class="ga-prog-track">
            <div class="ga-prog-fill-track" id="gaProgFill" style="width:0%"></div>
            <input type="range" class="ga-prog-range" id="gaFProg" min="0" max="100" value="0">
          </div>
          <div class="ga-prog-note" id="gaProgNote"></div>
        </div>
        <div class="ga-macts">
          <button class="cancel" id="gaMoCancel">Cancel</button>
          <button class="save" id="gaMoSave">Save</button>
        </div>
      </div>
    </div>
    <!-- Confirm delete -->
    <div class="ga-confirm-mo" id="gaConfirm">
      <div class="ga-confirm-box">
        <div class="ga-confirm-icon">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </div>
        <div class="ga-confirm-title">Delete this goal?</div>
        <div class="ga-confirm-desc">Delete <strong id="gaConfirmName"></strong>? This can be undone.</div>
        <div class="ga-confirm-acts">
          <button class="ga-cc" id="gaConfirmCancel">Cancel</button>
          <button class="ga-cd" id="gaConfirmDel">Delete</button>
        </div>
      </div>
    </div>
    <!-- Undo -->
    <div class="ga-undo" id="gaUndo">
      <span id="gaUndoMsg"></span>
      <button id="gaUndoBtn">Undo</button>
    </div>
  </div>`;

  const SK='pulsar_goals_v3';
  let GS={goals:[]},editId=null,filter='all',undoStack=[],pendingDel=null;

  const g=id=>root.querySelector('#'+id);
  const svgCheck=(s=10)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;
  const svgEdit=(s=12)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>`;
  const svgTrash=(s=12)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>`;
  const svgChev=(s=11)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>`;
  const svgPlus=(s=11)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`;
  const svgCal=(s=9)=>`<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`;
  const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};
  const gid=()=>'g_'+Math.random().toString(36).slice(2,9);
  const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const parseD=s=>{if(!s)return null;const p=s.split('-');return new Date(+p[0],+p[1]-1,+p[2])};
  const daysLeft=end=>{if(!end)return null;const e=parseD(end),n=new Date();n.setHours(0,0,0,0);return Math.ceil((e-n)/(86400000))};
  const fmtShort=s=>{if(!s)return'';const d=parseD(s);return d.toLocaleDateString('en',{month:'short',day:'numeric'})};

  function save(){localStorage.setItem(SK,JSON.stringify(GS))}
  function load(){
    const r=localStorage.getItem(SK);
    if(r){try{GS=JSON.parse(r)}catch{seed()}}else seed();
  }
  function seed(){
    const now=new Date(),y=now.getFullYear(),m=now.getMonth();
    GS={goals:[
      {id:gid(),title:'Ship Pulsar v1',desc:'Complete core modules and deploy to production.',cat:'work',pri:'high',progress:65,start:fmt(new Date(y,m,1)),end:fmt(new Date(y,m+1,15)),subs:[{id:gid(),name:'Habit tracker',done:true},{id:gid(),name:'Goal tracker',done:false},{id:gid(),name:'Task management',done:false},{id:gid(),name:'Deploy & QA',done:false}],collapsed:false,completed:false},
      {id:gid(),title:'Read 12 books this year',desc:'One book per month across different genres.',cat:'learning',pri:'medium',progress:33,start:fmt(new Date(y,0,1)),end:fmt(new Date(y,11,31)),subs:[{id:gid(),name:'Q1: 3 books',done:true},{id:gid(),name:'Q2: 3 books',done:true},{id:gid(),name:'Q3: 3 books',done:false},{id:gid(),name:'Q4: 3 books',done:false}],collapsed:true,completed:false},
      {id:gid(),title:'Run a half marathon',desc:'Train consistently and complete a half marathon.',cat:'health',pri:'high',progress:40,start:fmt(new Date(y,m-2,1)),end:fmt(new Date(y,7,31)),subs:[{id:gid(),name:'Build base mileage',done:true},{id:gid(),name:'Complete 10K race',done:true},{id:gid(),name:'Peak training block',done:false},{id:gid(),name:'Race day',done:false}],collapsed:true,completed:false},
      {id:gid(),title:'Emergency fund: 6 months',desc:'Save 6 months of expenses in liquid savings.',cat:'finance',pri:'medium',progress:80,start:fmt(new Date(y,0,1)),end:fmt(new Date(y,11,31)),subs:[],collapsed:true,completed:false},
      {id:gid(),title:'Learn Rust basics',desc:'Complete the Rust Book and build a CLI tool.',cat:'learning',pri:'low',progress:15,start:fmt(new Date(y,m,1)),end:fmt(new Date(y,m+3,1)),subs:[{id:gid(),name:'Chapters 1-8',done:true},{id:gid(),name:'Chapters 9-15',done:false},{id:gid(),name:'Build CLI project',done:false}],collapsed:true,completed:false}
    ]};
    save();
  }

  function syncGoal(goal){
    if(goal.subs&&goal.subs.length>0){
      const d=goal.subs.filter(s=>s.done).length;
      goal.progress=Math.round(d/goal.subs.length*100);
      goal.completed=(d===goal.subs.length);
    }
  }

  function filtered(){
    return GS.goals.filter(goal=>{
      if(filter==='active')return!goal.completed;
      if(filter==='done')return goal.completed;
      if(filter==='high')return goal.pri==='high'&&!goal.completed;
      return true;
    });
  }

  let _soft=false;
  function render(){renderCards();renderSide()}

  function renderCards(){
    const list=g('gaCards');
    if(_soft)list.classList.add('no-ga-anim');else list.classList.remove('no-ga-anim');
    const goals=filtered();
    if(!GS.goals.length){
      list.innerHTML=`<div class="ga-empty"><svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="color:var(--text-3)"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 8v4l3 3"/></svg><h3>Set your first goal</h3><p>Define what you want to achieve and track progress over time.</p></div>`;
      return;
    }
    if(!goals.length){
      list.innerHTML=`<div class="ga-empty"><svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="color:var(--text-3)"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><h3>No goals match</h3><p>Try a different filter.</p></div>`;
      return;
    }
    const active=goals.filter(x=>!x.completed),done=goals.filter(x=>x.completed);
    let h='';
    [...active,...done].forEach((goal,gi)=>{
      const dl=daysLeft(goal.end),ov=dl!==null&&dl<0,soon=dl!==null&&dl>=0&&dl<=7;
      const subsDone=(goal.subs||[]).filter(s=>s.done).length,subsTotal=(goal.subs||[]).length;
      const pct=goal.completed?100:goal.progress;
      h+=`<div class="ga-card${goal.completed?' done':''}" data-id="${goal.id}">
        <div class="ga-actions">
          <button data-edit="${goal.id}" title="Edit">${svgEdit()}</button>
          <button class="ga-delbtn" data-del="${goal.id}" title="Delete">${svgTrash()}</button>
        </div>
        <div class="ga-card-top">
          <span class="ga-chk${goal.completed?' on':''}" data-chk="${goal.id}">${svgCheck()}</span>
          <div class="ga-card-body">
            <div class="ga-title">${esc(goal.title)}</div>
            ${goal.desc?`<div class="ga-desc">${esc(goal.desc)}</div>`:''}
            <div class="ga-meta">
              <span class="ga-tag ${goal.cat}">${goal.cat}</span>
              <span class="ga-pri ${goal.pri}">${goal.pri}</span>
              ${goal.end?`<span class="ga-date${ov?' overdue':soon?' soon':''}">${svgCal()} ${fmtShort(goal.end)}${ov?' · overdue':soon?' · '+dl+'d':''}  </span>`:''}
            </div>
          </div>
        </div>
        <div class="ga-prog">
          <div class="ga-prog-row"><span class="ga-prog-lbl">Progress</span><span class="ga-prog-pct">${pct}%</span></div>
          <div class="ga-bar"><div class="ga-fill${pct>=100?' full':''}" style="width:${pct}%"></div></div>
        </div>`;
      if(subsTotal>0){
        h+=`<div class="ga-subs">
          <button class="ga-sub-toggle" data-toggle="${goal.id}">
            <span class="arr${goal.collapsed?'':' open'}">${svgChev()}</span>
            ${subsDone}/${subsTotal} milestones
          </button>
          <div class="ga-sub-list${goal.collapsed?' collapsed':''}">`;
        (goal.subs||[]).forEach(s=>{
          h+=`<div class="ga-sub" data-subrow="${goal.id}|${s.id}">
            <span class="ga-subck${s.done?' on':''}">${svgCheck(8)}</span>
            <span class="ga-subname${s.done?' done':''}">${esc(s.name)}</span>
          </div>`;
        });
        h+=`</div>
          <div class="ga-add-sub">
            <input placeholder="Add milestone…" data-addsub="${goal.id}">
            <button data-addsubbtn="${goal.id}">${svgPlus()}</button>
          </div></div>`;
      } else {
        h+=`<div class="ga-subs" style="border-top:none;padding-top:6px">
          <div class="ga-add-sub" style="padding-left:0">
            <input placeholder="Add milestone…" data-addsub="${goal.id}">
            <button data-addsubbtn="${goal.id}">${svgPlus()}</button>
          </div></div>`;
      }
      h+=`</div>`;
    });
    list.innerHTML=h;
    bindCards();
  }

  function bindCards(){
    const list=g('gaCards');
    list.querySelectorAll('[data-chk]').forEach(el=>el.onclick=()=>toggleComplete(el.dataset.chk));
    list.querySelectorAll('[data-edit]').forEach(el=>el.onclick=()=>openEdit(el.dataset.edit));
    list.querySelectorAll('[data-del]').forEach(el=>el.onclick=()=>askDelete(el.dataset.del));
    list.querySelectorAll('[data-toggle]').forEach(el=>el.onclick=()=>toggleCollapse(el.dataset.toggle));
    list.querySelectorAll('.ga-sub[data-subrow]').forEach(row=>row.onclick=()=>{
      const[gid,sid]=row.dataset.subrow.split('|');toggleSub(gid,sid);
    });
    list.querySelectorAll('[data-addsub]').forEach(input=>input.addEventListener('keydown',e=>{if(e.key==='Enter')doAddSub(input.dataset.addsub,input)}));
    list.querySelectorAll('[data-addsubbtn]').forEach(btn=>btn.onclick=()=>{
      const input=list.querySelector(`[data-addsub="${btn.dataset.addsubbtn}"]`);
      if(input)doAddSub(btn.dataset.addsubbtn,input);
    });
  }

  function renderSide(){
    const sb=g('gaSide');
    const total=GS.goals.length,done=GS.goals.filter(x=>x.completed).length,active=total-done;
    const avg=total?Math.round(GS.goals.reduce((a,x)=>a+(x.completed?100:x.progress),0)/total):0;
    const high=GS.goals.filter(x=>x.pri==='high'&&!x.completed).length;
    const upcoming=GS.goals.filter(x=>!x.completed&&x.end).sort((a,b)=>parseD(a.end)-parseD(b.end)).slice(0,5);
    const cats=['work','health','learning','personal','finance','creative'];
    const catColors={'work':'oklch(.72 .14 260)','health':'oklch(.72 .14 150)','learning':'oklch(.8 .14 290)','personal':'oklch(.82 .14 60)','finance':'oklch(.72 .14 150)','creative':'oklch(.78 .14 320)'};
    const cc={};cats.forEach(c=>cc[c]=GS.goals.filter(x=>x.cat===c&&!x.completed).length);
    const maxC=Math.max(1,...Object.values(cc));
    const activeCats=cats.filter(c=>cc[c]>0);
    const priColors={'high':'oklch(.72 .14 20)','medium':'oklch(.82 .14 60)','low':'oklch(.72 .14 150)'};
    const priCounts={'high':GS.goals.filter(x=>x.pri==='high'&&!x.completed).length,'medium':GS.goals.filter(x=>x.pri==='medium'&&!x.completed).length,'low':GS.goals.filter(x=>x.pri==='low'&&!x.completed).length};

    let h=`<div class="ga-sb-section">
      <button class="ga-btn-add" id="gaAddBtn" style="width:100%;justify-content:center;margin-bottom:16px">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        New goal
      </button>
      <!-- Avg progress card -->
      <div class="ga-avg">
        <div class="ga-avg-top">
          <div><div class="ga-avg-lbl">Avg progress</div><div class="ga-avg-num">${avg}<span>%</span></div></div>
          <div style="text-align:right"><div class="ga-avg-lbl">Completed</div><div style="font-size:20px;font-weight:700;letter-spacing:-1px;color:oklch(.72 .14 150);line-height:1.1">${done}<span style="font-size:12px;color:var(--text-3);font-weight:400"> / ${total}</span></div></div>
        </div>
        <div class="ga-avg-bar"><div class="ga-avg-fill" style="width:${avg}%"></div></div>
      </div>
    </div>`;

    if(activeCats.length){
      h+=`<div class="ga-sb-section"><div class="ga-sb-title">By category</div>`;
      activeCats.forEach(c=>{
        const pct=Math.round(cc[c]/maxC*100);
        h+=`<div class="ga-cat-row">
          <span class="ga-cat-lbl">${c}</span>
          <span class="ga-cat-bar"><span class="ga-cat-fill" style="width:${pct}%;background:${catColors[c]}"></span></span>
          <span class="ga-cat-chip" style="background:${catColors[c]}20;color:${catColors[c]}">${cc[c]}</span>
        </div>`;
      });
      h+=`</div>`;
    }

    if(upcoming.length){
      h+=`<div class="ga-sb-section"><div class="ga-sb-title">Deadlines</div>`;
      upcoming.forEach(goal=>{
        const dl=daysLeft(goal.end),ov=dl!==null&&dl<0,sn=dl!==null&&dl>=0&&dl<=7;
        const accent=ov?'oklch(.72 .14 20)':sn?'oklch(.82 .14 60)':'var(--text-4,oklch(.35 .03 280))';
        const dlabel=ov?'overdue':dl===0?'today':dl===1?'tomorrow':`${dl}d`;
        h+=`<div class="ga-dl-item">
          <div class="ga-dl-body">
            <div class="ga-dl-name">${esc(goal.title)}</div>
            <div class="ga-dl-meta">
              <span class="ga-dl-date">${fmtShort(goal.end)}</span>
              <span class="ga-dl-badge" style="background:${accent}18;color:${accent}">${dlabel}</span>
            </div>
          </div>
        </div>`;
      });
      h+=`</div>`;
    }
    sb.innerHTML=h;
    const addBtn=sb.querySelector('#gaAddBtn');
    if(addBtn)addBtn.onclick=openNew;
  }

  function toggleComplete(id){
    const goal=GS.goals.find(x=>x.id===id);if(!goal)return;
    if(!goal.completed){goal.completed=true;goal.progress=100;if(goal.subs&&goal.subs.length)goal.subs.forEach(s=>s.done=true);}
    else{goal.completed=false;if(goal.subs&&goal.subs.length){goal.subs.forEach(s=>s.done=false);goal.progress=0;}else goal.progress=0;}
    save();flipRender(id);
  }

  function flipRender(movedId){
    const list=g('gaCards');
    const before={};
    [...list.querySelectorAll('.ga-card[data-id]')].forEach(card=>{before[card.dataset.id]=card.getBoundingClientRect().top});
    _soft=true;renderCards();renderSide();_soft=false;
    [...list.querySelectorAll('.ga-card[data-id]')].forEach(card=>{
      const cid=card.dataset.id,newTop=card.getBoundingClientRect().top,oldTop=before[cid];
      if(oldTop===undefined){card.classList.add('settling');return}
      const delta=oldTop-newTop;if(Math.abs(delta)<2)return;
      card.style.transition='none';card.style.transform=`translateY(${delta}px)`;card.style.opacity=cid===movedId?'0.5':'1';
      card.offsetHeight;
      const dur=cid===movedId?420:320,ease=cid===movedId?'cubic-bezier(.4,0,.2,1)':'cubic-bezier(.25,1,.5,1)';
      card.style.transition=`transform ${dur}ms ${ease}, opacity 200ms ease`;
      card.style.transform='translateY(0)';card.style.opacity='1';
      card.addEventListener('transitionend',()=>{card.style.transition='';card.style.transform='';card.style.opacity='';if(cid===movedId){card.style.outline='1px solid oklch(.3 .08 290)';setTimeout(()=>card.style.outline='',600)}},{once:true});
    });
  }

  function toggleCollapse(id){
    const goal=GS.goals.find(x=>x.id===id);if(!goal)return;
    const card=root.querySelector(`.ga-card[data-id="${id}"]`);
    const list=card&&card.querySelector('.ga-sub-list'),arrow=card&&card.querySelector('.ga-sub-toggle .arr');
    if(!list)return;
    list.style.transition='none';list.style.height=list.scrollHeight+'px';list.style.overflow='hidden';list.style.opacity=goal.collapsed?'0':'1';list.classList.remove('collapsed');
    if(goal.collapsed){
      goal.collapsed=false;save();if(arrow)arrow.classList.add('open');
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        list.style.transition='height .26s cubic-bezier(.4,0,.2,1), opacity .2s ease';list.style.height=list.scrollHeight+'px';list.style.opacity='1';
        list.addEventListener('transitionend',()=>{list.style.cssText='';},{once:true});
      }));
    }else{
      goal.collapsed=true;save();if(arrow)arrow.classList.remove('open');
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        list.style.transition='height .22s cubic-bezier(.4,0,.2,1), opacity .16s ease';list.style.height='0px';list.style.opacity='0';
        list.addEventListener('transitionend',()=>{list.style.cssText='';list.classList.add('collapsed');},{once:true});
      }));
    }
  }

  function toggleSub(gid,sid){
    const goal=GS.goals.find(x=>x.id===gid);if(!goal)return;
    const s=goal.subs.find(x=>x.id===sid);if(!s)return;
    s.done=!s.done;
    const was=goal.completed;syncGoal(goal);save();
    if(goal.completed!==was){flipRender(gid);}
    else{
      const card=root.querySelector(`.ga-card[data-id="${gid}"]`);
      if(card){
        const row=card.querySelector(`[data-subrow="${gid}|${sid}"]`);
        if(row){
          const ck=row.querySelector('.ga-subck'),nm=row.querySelector('.ga-subname');
          ck&&ck.classList.toggle('on',s.done);nm&&nm.classList.toggle('done',s.done);
        }
        const toggle=card.querySelector('.ga-sub-toggle');
        if(toggle){const subsDone=(goal.subs||[]).filter(x=>x.done).length,subsTotal=(goal.subs||[]).length;toggle.innerHTML=toggle.innerHTML.replace(/\d+\//,subsDone+'/');}
        const fill=card.querySelector('.ga-fill'),pct=card.querySelector('.ga-prog-pct');
        if(fill){fill.style.width=goal.progress+'%';fill.classList.toggle('full',goal.progress>=100);}
        if(pct)pct.textContent=goal.progress+'%';
      }
      renderSide();
    }
  }

  function doAddSub(gid,input){
    const name=input.value.trim();if(!name)return;
    const goal=GS.goals.find(x=>x.id===gid);if(!goal)return;
    if(!goal.subs)goal.subs=[];
    goal.subs.push({id:gid+Math.random().toString(36).slice(2,6),name,done:false});
    goal.collapsed=false;syncGoal(goal);input.value='';save();_soft=true;render();_soft=false;
  }

  function askDelete(id){
    const goal=GS.goals.find(x=>x.id===id);if(!goal)return;
    pendingDel=id;
    g('gaConfirmName').textContent='"'+goal.title+'"';
    g('gaConfirm').classList.add('open');
  }
  function closeConfirm(){g('gaConfirm').classList.remove('open');pendingDel=null}
  function confirmDel(){
    const id=pendingDel;if(!id)return;closeConfirm();
    const card=root.querySelector(`.ga-card[data-id="${id}"]`);
    const prev=JSON.parse(JSON.stringify(GS.goals));
    const nm=GS.goals.find(x=>x.id===id)?.title||'';
    if(card){card.classList.add('exiting');setTimeout(()=>{GS.goals=GS.goals.filter(x=>x.id!==id);save();render();pushUndo(`Deleted "${nm}"`,()=>{GS.goals=prev})},240);}
    else{GS.goals=GS.goals.filter(x=>x.id!==id);save();render();pushUndo(`Deleted "${nm}"`,()=>{GS.goals=prev})}
  }

  function pushUndo(msg,fn){
    undoStack.push({msg,fn});
    const t=g('gaUndo');g('gaUndoMsg').textContent=msg;t.classList.add('show');
    clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),3500);
  }
  function doUndo(){if(!undoStack.length)return;undoStack.pop().fn();save();render();g('gaUndo').classList.remove('show')}

  function updateProgBar(val){
    val=Math.min(100,Math.max(0,+val));
    g('gaProgVal').textContent=val+'%';g('gaProgFill').style.width=val+'%';g('gaFProg').value=val;
  }
  function openNew(){
    editId=null;g('gaMoTitle').textContent='New goal';
    g('gaFTitle').value='';g('gaFDesc').value='';g('gaFCat').value='work';g('gaFPri').value='medium';
    g('gaFStart').value=fmt(new Date());g('gaFEnd').value='';
    g('gaProgNote').textContent='';g('gaProgWrap').style.opacity='1';g('gaProgWrap').style.pointerEvents='';
    updateProgBar(0);g('gaMo').classList.add('open');setTimeout(()=>g('gaFTitle').focus(),80);
  }
  function openEdit(id){
    const goal=GS.goals.find(x=>x.id===id);if(!goal)return;
    editId=id;g('gaMoTitle').textContent='Edit goal';
    g('gaFTitle').value=goal.title;g('gaFDesc').value=goal.desc||'';
    g('gaFCat').value=goal.cat;g('gaFPri').value=goal.pri;
    g('gaFStart').value=goal.start||'';g('gaFEnd').value=goal.end||'';
    const hasSubs=goal.subs&&goal.subs.length>0;
    g('gaProgNote').textContent=hasSubs?'Controlled by milestones':'';
    g('gaProgWrap').style.opacity=hasSubs?'.5':'1';g('gaProgWrap').style.pointerEvents=hasSubs?'none':'';
    updateProgBar(goal.progress);g('gaMo').classList.add('open');
  }
  function closeMo(){g('gaMo').classList.remove('open')}
  function saveMo(){
    const title=g('gaFTitle').value.trim();if(!title)return;
    const data={title,desc:g('gaFDesc').value.trim(),cat:g('gaFCat').value,pri:g('gaFPri').value,start:g('gaFStart').value,end:g('gaFEnd').value,progress:+g('gaFProg').value};
    if(editId){
      const goal=GS.goals.find(x=>x.id===editId);
      if(goal){Object.assign(goal,data);if(goal.subs&&goal.subs.length)syncGoal(goal);else goal.completed=(goal.progress>=100);}
    }else{
      GS.goals.unshift({id:gid(),...data,subs:[],collapsed:false,completed:data.progress>=100});
    }
    save();closeMo();render();
  }

  g('gaMoCancel').onclick=closeMo;
  g('gaMoSave').onclick=saveMo;
  g('gaMo').addEventListener('click',e=>{if(e.target===g('gaMo'))closeMo()});
  g('gaFProg').oninput=()=>updateProgBar(g('gaFProg').value);
  g('gaConfirmCancel').onclick=closeConfirm;
  g('gaConfirmDel').onclick=confirmDel;
  g('gaConfirm').addEventListener('click',e=>{if(e.target===g('gaConfirm'))closeConfirm()});
  g('gaUndoBtn').onclick=doUndo;

  root._gaKeydown=e=>{
    if(e.key==='Escape'){closeMo();closeConfirm();}
    if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();doUndo()}
  };
  document.addEventListener('keydown',root._gaKeydown);

  function renderWithSlide(dir){
    const main=q('haMain');
    if(!main)return render();
    const grid=main.querySelector('.ha-gw');
    if(!grid)return render();
    const out=dir==='right'?'translateX(-20px)':'translateX(20px)';
    grid.style.transition='opacity .16s ease,transform .16s ease';
    grid.style.opacity='0';grid.style.transform=out;
    setTimeout(()=>{
      render(); // full re-render, summary redraws chart
      const newGrid=main.querySelector('.ha-gw');
      if(!newGrid)return;
      const inFrom=dir==='right'?'translateX(20px)':'translateX(-20px)';
      newGrid.style.transition='none';
      newGrid.style.opacity='0';newGrid.style.transform=inFrom;
      requestAnimationFrame(()=>{
        newGrid.style.transition='opacity .22s ease,transform .22s cubic-bezier(.25,1,.5,1)';
        newGrid.style.opacity='1';newGrid.style.transform='translateX(0)';
      });
    },160);
  }

  load();render();
}

function initHabitsApp(){
  const root=document.getElementById('habitsRoot');
  if(!root||root._habitsInit)return;
  root._habitsInit=true;

  

  root.innerHTML=`<div class="ha">
    <div class="ha-hdr">
      <div class="ha-nav">
        <button id="haPrev">‹</button>
        <span class="ha-lbl" id="haLbl"></span>
        <button id="haNext">›</button>
      </div>
      <div class="ha-hdr-r">
        <button class="ha-btn-today hidden" id="haBtnToday">Today</button>
        <button class="ha-btn-add" id="haAddBtn">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          Add habit
        </button>
      </div>
    </div>
    <div id="haMain"></div>
    <!-- Context menu -->
    <div class="ha-ctx" id="haCtx">
      <button id="haCtxEdit">✏️&ensp;Edit</button>
      <div class="ha-sep"></div>
      <button class="dng" id="haCtxDel">🗑&ensp;Delete</button>
      <div class="ha-dcf" id="haDcf">
        <p>Delete habit and all history?</p>
        <button class="dy" id="haDcfYes">Delete</button>
        <button class="dn2" id="haDcfNo">Cancel</button>
      </div>
    </div>
    <!-- Modal -->
    <div class="ha-mo" id="haMo">
      <div class="ha-mbox">
        <h3 id="haMoTitle">Add habit</h3>
        <label>Icon</label><div class="ha-ep" id="haEpick"></div>
        <label>Name</label><input id="haFName" placeholder="e.g. Morning run" maxlength="40">
        <label>Category</label>
        <select id="haFCat">
          <option value="health">Health</option><option value="mind">Mind</option>
          <option value="work">Work</option><option value="creative">Creative</option>
          <option value="social">Social</option><option value="self-care">Self-care</option>
        </select>
        <div class="ha-macts">
          <button class="cancel" id="haMoCancel">Cancel</button>
          <button class="save" id="haMoSave">Save</button>
        </div>
      </div>
    </div>
    <!-- Undo -->
    <div class="ha-undo" id="haUndo">
      <span id="haUndoMsg"></span>
      <button id="haUndoBtn">Undo</button>
    </div>
  </div>`;

  const SK='pulsar_hv5';
  const DOW=['S','M','T','W','T','F','S'];
  const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const EMOJIS=['🏃','📖','💻','🧘','✍️','😴','💧','🎯','🎨','🏋️','🧠','🌱','📝','🎵','🍎','⏰','🚫','💪','📚','☕'];

  let HS={habits:[],comp:{},mOff:0},haEditId=null,haCtxId=null,haSelEmoji='🎯',haReorderSrc=null,haUndoStack=[];

  const q=id=>root.querySelector('#'+id);
  const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};
  const gid=()=>'h_'+Math.random().toString(36).slice(2,9);
  const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const ck=(h,d)=>h+'::'+d;
  const isToday=d=>{const t=new Date();return d.getFullYear()===t.getFullYear()&&d.getMonth()===t.getMonth()&&d.getDate()===t.getDate()};
  const isFuture=d=>{const t=new Date();t.setHours(0,0,0,0);const dc=new Date(d);dc.setHours(0,0,0,0);return dc>t};

  function mDates(){
    const n=new Date(),y=n.getFullYear(),m=n.getMonth()+HS.mOff;
    const d1=new Date(y,m,1),cnt=new Date(d1.getFullYear(),d1.getMonth()+1,0).getDate();
    return Array.from({length:cnt},(_,i)=>{const x=new Date(d1.getFullYear(),d1.getMonth(),i+1);x.setHours(12,0,0,0);return x});
  }

  function save(){localStorage.setItem(SK,JSON.stringify(HS))}
  function load(){
    const r=localStorage.getItem(SK);
    if(r){try{HS=JSON.parse(r)}catch{seed()}}else seed();
  }

  function seed(){
    const defs=[
      {id:gid(),name:'Morning exercise',tag:'health',emoji:'🏃'},
      {id:gid(),name:'Read 30 min',tag:'mind',emoji:'📖'},
      {id:gid(),name:'Deep work',tag:'work',emoji:'💻'},
      {id:gid(),name:'Meditate',tag:'mind',emoji:'🧘'},
      {id:gid(),name:'Journal',tag:'creative',emoji:'✍️'},
      {id:gid(),name:'No screens 9pm',tag:'self-care',emoji:'🚫'},
    ];
    HS={habits:defs,comp:{},mOff:0};
    const dates=mDates();
    const pats=[[1,1,0,1,1,1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1,1,1,0,1,1,0,1],[1,0,1,1,1,0,1,1,0,1,1,0,1,0,1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,0,1],[1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,1,1,1,0,0,1,1,1],[1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,1,1,1],[0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0,1,0,1,0,0,1,0],[1,0,1,0,1,1,0,1,0,1,0,1,1,0,1,0,1,0,1,1,0,1,0,1,0,1,1,0,1,0,1]];
    defs.forEach((h,hi)=>{dates.forEach((d,di)=>{
      if(!isFuture(d)&&!isToday(d)&&pats[hi]&&pats[hi][di])HS.comp[ck(h.id,fmt(d))]=true;
    })});
    save();
  }

  function pushUndo(msg,fn){
    haUndoStack.push({msg,fn});
    const t=q('haUndo');q('haUndoMsg').textContent=msg;t.classList.add('show');
    clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),3500);
  }
  function doUndo(){if(!haUndoStack.length)return;haUndoStack.pop().fn();save();render();}

  function render(){
    const dates=mDates(),d0=dates[0];
    const now=new Date(),isCur=d0.getMonth()===now.getMonth()&&d0.getFullYear()===now.getFullYear();
    q('haLbl').textContent=`${MONTHS[d0.getMonth()]} ${d0.getFullYear()}`;
    q('haBtnToday').classList.toggle('hidden',isCur);

    const main=q('haMain');
    if(!HS.habits.length){
      main.innerHTML=`<div class="ha-empty"><div class="ha-empty-i">✦</div><h3>Start tracking</h3><p>Add your first habit and mark it day by day.</p><button id="haEmptyAdd">+ Add first habit</button></div>`;
      main.querySelector('#haEmptyAdd').onclick=openMo;
      return;
    }

    let h='<div class="ha-gw"><table class="ha-table"><thead><tr><th class="ha-hth">Habit</th>';
    dates.forEach((d,di)=>{
      const td=isToday(d),first=di===0;
      h+=`<th class="ha-dth${td?' ha-tdy':''}">${DOW[d.getDay()]}<span class="ha-dn">${d.getDate()}</span></th>`;
    });
    h+='</tr></thead><tbody>';

    HS.habits.forEach((hab,hi)=>{
      h+=`<tr draggable="true" data-hi="${hi}">`;
      h+=`<td class="ha-hc"><div class="ha-hi" data-ctx="${hab.id}"><span class="ha-he">${hab.emoji||'🎯'}</span><span class="ha-hn">${esc(hab.name)}</span></div></td>`;
      dates.forEach((d,di)=>{
        const key=ck(hab.id,fmt(d)),done=!!HS.comp[key],td=isToday(d),fut=isFuture(d),locked=!td,first=di===0;
        const cls=['ha-c'];
        if(done)cls.push('ha-done');
        if(td)cls.push('ha-active');
        if(locked)cls.push('ha-locked');
        h+=`<td class="ha-dtd${td?' ha-tdy-td':''}${first?' ha-first-day':''}"><div class="${cls.join(' ')}"${td?` data-h="${hab.id}" data-d="${fmt(d)}"`:''}>
          <span class="ha-ck"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3.5 8.5 6.5 11.5 12.5 4.5"/></svg></span>
        </div></td>`;
      });
      h+='</tr>';
    });

    h+='</tbody></table></div>';
    h+=renderSum(dates);
    main.innerHTML=h;

    main.querySelectorAll('.ha-c.ha-active').forEach(el=>{
      el.addEventListener('mousedown',e=>{e.preventDefault();toggleCell(el)});
      el.addEventListener('touchstart',e=>{e.preventDefault();toggleCell(el)},{passive:false});
    });

    main.querySelectorAll('[data-ctx]').forEach(el=>{
      el.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();showCtx(e,el.dataset.ctx)});
    });

    main.querySelectorAll('tr[data-hi]').forEach(tr=>{
      const i=+tr.dataset.hi;
      tr.addEventListener('dragstart',e=>{haReorderSrc=i;e.dataTransfer.effectAllowed='move';tr.style.opacity='.3'});
      tr.addEventListener('dragover',e=>{e.preventDefault();if(i!==haReorderSrc)tr.style.boxShadow=`inset 0 ${i<haReorderSrc?'2':'-2'}px 0 oklch(.6 .18 290)`});
      tr.addEventListener('dragleave',()=>tr.style.boxShadow='');
      tr.addEventListener('drop',e=>{
        e.preventDefault();tr.style.boxShadow='';
        if(haReorderSrc===null||haReorderSrc===i)return;
        const hb=HS.habits.splice(haReorderSrc,1)[0];HS.habits.splice(i,0,hb);save();render();
      });
      tr.addEventListener('dragend',()=>{tr.style.opacity='';haReorderSrc=null;main.querySelectorAll('tr').forEach(r=>r.style.boxShadow='')});
    });

    requestAnimationFrame(()=>{drawChart(dates);setupHover()});
  }

  function toggleCell(el){
    const key=ck(el.dataset.h,el.dataset.d);
    if(HS.comp[key])delete HS.comp[key];else HS.comp[key]=true;
    save();
    el.classList.toggle('ha-done',!!HS.comp[key]);
    el.classList.add('ha-pop');setTimeout(()=>el.classList.remove('ha-pop'),320);
    animateChartUpdate();
  }

  function animateChartUpdate(){
    const canvas=q('haCanvas');if(!canvas)return;
    const dates=mDates();
    const newRates=calcR(dates);
    const dpr=window.devicePixelRatio||1,rect=canvas.parentElement.getBoundingClientRect();
    const W=rect.width,H=rect.height,pad={t:8,r:8,b:22,l:30},cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
    const vi=newRates.map((r,i)=>r!==null?i:-1).filter(i=>i>=0),nv=vi.length;
    if(!nv)return;
    const newPts=[];vi.forEach((di,j)=>{const r=newRates[di],x=pad.l+(cw/Math.max(nv-1,1))*j,y=pad.t+ch-ch*r.pct/100;newPts.push({x,y,pct:r.pct,done:r.done,total:r.total,date:dates[di]})});
    const oldPts=haChPts.length===newPts.length?haChPts.map(p=>({...p})):newPts.map(p=>({...p,y:p.y+20,pct:p.pct}));
    const start=performance.now(),dur=500;
    cancelAnimationFrame(haBounceAnim);
    function frame(t){
      const raw=(t-start)/dur,prog=raw>=1?1:1-Math.pow(1-raw,3); // ease-out cubic
      const tweened=newPts.map((np,i)=>{
        const op=oldPts[i]||np;
        return {...np,y:op.y+(np.y-op.y)*prog,x:op.x+(np.x-op.x)*prog};
      });
      drawChartPts(canvas,dates,tweened,-1);
      if(raw<1)haBounceAnim=requestAnimationFrame(frame);
      else{haChPts=newPts;drawChart(dates,-1);}
    }
    haBounceAnim=requestAnimationFrame(frame);
  }

  function drawChartPts(canvas,dates,pts,hovIdx){
    const dpr=window.devicePixelRatio||1,rect=canvas.parentElement.getBoundingClientRect();
    const W=rect.width,H=rect.height;
    const needsResize=canvas.width!==Math.round(W*dpr)||canvas.height!==Math.round(H*dpr);
    if(needsResize){canvas.width=Math.round(W*dpr);canvas.height=Math.round(H*dpr);canvas.style.width=W+'px';canvas.style.height=H+'px';}
    const ctx=canvas.getContext('2d');
    if(needsResize)ctx.scale(dpr,dpr);
    const pad={t:8,r:8,b:22,l:30},cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
    ctx.clearRect(0,0,W,H);
    for(let i=0;i<=4;i++){const y=pad.t+ch-ch*i/4;ctx.strokeStyle='oklch(.18 .02 280)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();ctx.fillStyle='oklch(.35 .03 280)';ctx.font='8px system-ui,sans-serif';ctx.textAlign='right';ctx.fillText(i*25+'%',pad.l-4,y+3)}
    const step=Math.max(1,Math.floor(pts.length/8));
    ctx.textAlign='center';ctx.font='8px system-ui,sans-serif';
    pts.forEach((p,i)=>{if(i%step===0||i===pts.length-1){ctx.fillStyle=isToday(p.date)?'oklch(.7 .14 290)':'oklch(.35 .03 280)';ctx.fillText(p.date.getDate(),p.x,H-4)}});
    if(pts.length>=2){
      const grad=ctx.createLinearGradient(0,pad.t,0,pad.t+ch);
      grad.addColorStop(0,'oklch(.7 .14 290 / .07)');grad.addColorStop(1,'oklch(.7 .14 290 / 0)');
      ctx.beginPath();ctx.moveTo(pts[0].x,pad.t+ch);pts.forEach(p=>ctx.lineTo(p.x,p.y));
      ctx.lineTo(pts[pts.length-1].x,pad.t+ch);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
      ctx.beginPath();pts.forEach((p,i)=>{if(!i)ctx.moveTo(p.x,p.y);else ctx.lineTo(p.x,p.y)});
      ctx.strokeStyle='oklch(.7 .14 290)';ctx.lineWidth=1.5;ctx.stroke();
    }
    pts.forEach((p,i)=>{
      const isHov=hovIdx===i,r=isHov?5:2.5;
      ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fillStyle='oklch(.7 .14 290)';ctx.fill();
      if(!isHov){ctx.beginPath();ctx.arc(p.x,p.y,1,0,Math.PI*2);ctx.fillStyle='oklch(.12 .02 280)';ctx.fill()}
    });
  }

  function calcR(dates){
    const hc=HS.habits.length;if(!hc)return[];
    return dates.map(d=>{if(isFuture(d))return null;let dn=0;HS.habits.forEach(h=>{if(HS.comp[ck(h.id,fmt(d))])dn++});return{pct:Math.round(dn/hc*100),done:dn,total:hc}});
  }

  function renderSum(dates){
    if(!HS.habits.length)return'';
    const rates=calcR(dates),hc=HS.habits.length,vr=rates.filter(r=>r!==null),tp=vr.length*hc;
    let td=0;vr.forEach(r=>td+=r.done);
    const con=tp?Math.round(td/tp*100):0;
    let bestH='—',bestP=0;
    HS.habits.forEach(h=>{let d=0,t=0;dates.forEach(dt=>{if(!isFuture(dt)){t++;if(HS.comp[ck(h.id,fmt(dt))])d++}});const p=t?Math.round(d/t*100):0;if(p>bestP){bestP=p;bestH=h.emoji+' '+h.name}});
    return `<div class="ha-sum">
      <div class="ha-chbox"><h4>Completion rate</h4>
        <div class="ha-ccw"><canvas id="haCanvas"></canvas>
          <div class="ha-chtip" id="haChTip">
            <div class="ha-ct-date"></div><div class="ha-ct-pct"></div>
            <div class="ha-ct-bar"><div class="ha-ct-fill"></div></div>
            <div class="ha-ct-detail">
              <span><span style="width:5px;height:5px;border-radius:50%;background:oklch(.72 .14 150);flex-shrink:0;display:inline-block"></span>&nbsp;<b class="ha-ct-dn">0</b> done</span>
              <span><span style="width:5px;height:5px;border-radius:50%;background:oklch(.72 .14 20);flex-shrink:0;display:inline-block"></span>&nbsp;<b class="ha-ct-mn">0</b> missed</span>
            </div>
          </div>
        </div>
      </div>
      <div class="ha-stats">
        <div class="ha-sc ${con>=70?'grn':'amb'}"><div class="ha-sl">Consistency</div><div class="ha-sv">${con}%</div><div class="ha-ss">${td} / ${tp} completed</div></div>
        <div class="ha-sc" style="display:flex;flex-direction:column;justify-content:space-between">
          <div class="ha-sl">Top habit</div>
          <div style="flex:1;display:flex;flex-direction:column;justify-content:center;gap:10px;padding:8px 0">
            <div style="font-size:32px;line-height:1">${bestH.split(' ')[0]||'—'}</div>
            <div style="font-size:14px;font-weight:600;color:var(--text-1);letter-spacing:-.2px;line-height:1.3">${esc(bestH.split(' ').slice(1).join(' '))}</div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px">
              <span style="font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.5px">This month</span>
              <span style="font-size:13px;font-weight:700;color:oklch(.72 .14 150);letter-spacing:-.3px">${bestP}%</span>
            </div>
            <div style="height:3px;background:var(--border);border-radius:2px;overflow:hidden">
              <div style="height:100%;width:${bestP}%;background:linear-gradient(90deg,oklch(.55 .14 150),oklch(.72 .14 150));border-radius:2px;transition:width .5s cubic-bezier(.4,0,.2,1)"></div>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  }

  let haChPts=[],haChIdx=-1,haChTimer=null,haBounceAnim=null;

  function drawChart(dates,hovIdx){
    const canvas=q('haCanvas');if(!canvas||!HS.habits.length)return;
    const rates=calcR(dates),dpr=window.devicePixelRatio||1,rect=canvas.parentElement.getBoundingClientRect();
    canvas.width=rect.width*dpr;canvas.height=rect.height*dpr;
    canvas.style.width=rect.width+'px';canvas.style.height=rect.height+'px';
    const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
    const W=rect.width,H=rect.height,pad={t:8,r:8,b:22,l:30},cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
    ctx.clearRect(0,0,W,H);

    for(let i=0;i<=4;i++){
      const y=pad.t+ch-ch*i/4;
      ctx.strokeStyle='var(--border, #1e1f23)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
      ctx.fillStyle='oklch(.35 .03 280)';ctx.font='8px system-ui,sans-serif';ctx.textAlign='right';ctx.fillText(i*25+'%',pad.l-4,y+3);
    }

    const pts=[],vi=rates.map((r,i)=>r!==null?i:-1).filter(i=>i>=0),nv=vi.length;
    if(!nv)return;
    vi.forEach((di,j)=>{const r=rates[di],x=pad.l+(cw/Math.max(nv-1,1))*j,y=pad.t+ch-ch*r.pct/100;pts.push({x,y,pct:r.pct,done:r.done,total:r.total,date:dates[di]})});
    haChPts=pts;

    const step=Math.max(1,Math.floor(nv/8));
    ctx.textAlign='center';ctx.font='8px system-ui,sans-serif';
    pts.forEach((p,i)=>{if(i%step===0||i===pts.length-1){ctx.fillStyle=isToday(p.date)?'oklch(.7 .14 290)':'oklch(.35 .03 280)';ctx.fillText(p.date.getDate(),p.x,H-4)}});

    if(pts.length<2){ctx.beginPath();ctx.arc(pts[0].x,pts[0].y,3,0,Math.PI*2);ctx.fillStyle='oklch(.7 .14 290)';ctx.fill();return}

    const grad=ctx.createLinearGradient(0,pad.t,0,pad.t+ch);
    grad.addColorStop(0,'oklch(.7 .14 290 / .07)');grad.addColorStop(1,'oklch(.7 .14 290 / 0)');
    ctx.beginPath();ctx.moveTo(pts[0].x,pad.t+ch);pts.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.lineTo(pts[pts.length-1].x,pad.t+ch);ctx.closePath();ctx.fillStyle=grad;ctx.fill();

    ctx.beginPath();pts.forEach((p,i)=>{if(!i)ctx.moveTo(p.x,p.y);else ctx.lineTo(p.x,p.y)});
    ctx.strokeStyle='oklch(.7 .14 290)';ctx.lineWidth=1.5;ctx.stroke();

    pts.forEach((p,i)=>{
      const isHov=hovIdx===i,r=isHov?5:2.5;
      ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fillStyle='oklch(.7 .14 290)';ctx.fill();
      if(!isHov){ctx.beginPath();ctx.arc(p.x,p.y,1,0,Math.PI*2);ctx.fillStyle='var(--surface-2,#13131e)';ctx.fill()}
    });
  }

  function setupHover(){
    const canvas=q('haCanvas');if(!canvas)return;
    canvas.onmousemove=e=>{
      const rect=canvas.getBoundingClientRect(),mx=e.clientX-rect.left,my=e.clientY-rect.top;
      let cl=-1,md=Infinity;
      haChPts.forEach((p,i)=>{const d=Math.hypot(p.x-mx,p.y-my);if(d<md&&d<22){md=d;cl=i}});
      if(cl===haChIdx)return;
      clearTimeout(haChTimer);cancelAnimationFrame(haBounceAnim);
      const tip=q('haChTip');
      if(cl<0){tip.classList.remove('show');haChIdx=-1;drawChart(mDates(),-1);return}
      haChIdx=cl;
      const start=performance.now(),dur=240;
      function frame(t){
        const p=(t-start)/dur;if(p>=1){drawChart(mDates(),cl);return}
        const s=p<.4?1+1.5*(p/.4):1+1.5*(1-(p-.4)/.6);
        const canvas2=q('haCanvas');if(!canvas2)return;
        const rates=calcR(mDates()),dpr=window.devicePixelRatio||1,rect2=canvas2.parentElement.getBoundingClientRect();
        canvas2.width=rect2.width*dpr;canvas2.height=rect2.height*dpr;canvas2.style.width=rect2.width+'px';canvas2.style.height=rect2.height+'px';
        const ctx2=canvas2.getContext('2d');ctx2.scale(dpr,dpr);
        const W=rect2.width,H=rect2.height,pad={t:8,r:8,b:22,l:30},cw=W-pad.l-pad.r,ch=H-pad.t-pad.b;
        ctx2.clearRect(0,0,W,H);
        for(let i=0;i<=4;i++){const y=pad.t+ch-ch*i/4;ctx2.strokeStyle='oklch(.18 .02 280)';ctx2.lineWidth=1;ctx2.beginPath();ctx2.moveTo(pad.l,y);ctx2.lineTo(W-pad.r,y);ctx2.stroke();ctx2.fillStyle='oklch(.35 .03 280)';ctx2.font='8px system-ui,sans-serif';ctx2.textAlign='right';ctx2.fillText(i*25+'%',pad.l-4,y+3)}
        const vi=rates.map((r,i)=>r!==null?i:-1).filter(i=>i>=0),nv=vi.length;if(!nv)return;
        const pts=[];vi.forEach((di,j)=>{const r=rates[di],x=pad.l+(cw/Math.max(nv-1,1))*j,y=pad.t+ch-ch*r.pct/100;pts.push({x,y,pct:r.pct,date:mDates()[di]})});
        const step2=Math.max(1,Math.floor(nv/8));ctx2.textAlign='center';ctx2.font='8px system-ui,sans-serif';
        pts.forEach((pt,i)=>{if(i%step2===0||i===pts.length-1){ctx2.fillStyle=isToday(pt.date)?'oklch(.7 .14 290)':'oklch(.35 .03 280)';ctx2.fillText(pt.date.getDate(),pt.x,H-4)}});
        if(pts.length>=2){
          const g=ctx2.createLinearGradient(0,pad.t,0,pad.t+ch);g.addColorStop(0,'oklch(.7 .14 290 / .07)');g.addColorStop(1,'oklch(.7 .14 290 / 0)');
          ctx2.beginPath();ctx2.moveTo(pts[0].x,pad.t+ch);pts.forEach(pt=>ctx2.lineTo(pt.x,pt.y));ctx2.lineTo(pts[pts.length-1].x,pad.t+ch);ctx2.closePath();ctx2.fillStyle=g;ctx2.fill();
          ctx2.beginPath();pts.forEach((pt,i)=>{if(!i)ctx2.moveTo(pt.x,pt.y);else ctx2.lineTo(pt.x,pt.y)});ctx2.strokeStyle='oklch(.7 .14 290)';ctx2.lineWidth=1.5;ctx2.stroke();
        }
        pts.forEach((pt,i)=>{const r2=i===cl?2.5*s:2.5;ctx2.beginPath();ctx2.arc(pt.x,pt.y,r2,0,Math.PI*2);ctx2.fillStyle='oklch(.7 .14 290)';ctx2.fill();if(i!==cl){ctx2.beginPath();ctx2.arc(pt.x,pt.y,1,0,Math.PI*2);ctx2.fillStyle='oklch(.12 .02 280)';ctx2.fill()}});
        haBounceAnim=requestAnimationFrame(frame);
      }
      haBounceAnim=requestAnimationFrame(frame);
      haChTimer=setTimeout(()=>{
        if(haChIdx!==cl)return;
        const p=haChPts[cl];if(!p)return;
        tip.querySelector('.ha-ct-date').textContent=p.date.toLocaleDateString('en',{weekday:'short',month:'short',day:'numeric'});
        tip.querySelector('.ha-ct-pct').textContent=p.pct+'%';
        tip.querySelector('.ha-ct-fill').style.width=p.pct+'%';
        tip.querySelector('.ha-ct-dn').textContent=p.done;
        tip.querySelector('.ha-ct-mn').textContent=p.total-p.done;
        const cr=canvas.getBoundingClientRect();
        let tx=p.x-69;tx=Math.max(4,Math.min(tx,cr.width-145));
        tip.style.left=tx+'px';tip.style.top=(p.y-108)+'px';
        tip.classList.add('show');
      },500);
    };
    canvas.onmouseleave=()=>{
      clearTimeout(haChTimer);haChIdx=-1;
      const tip=q('haChTip');if(tip)tip.classList.remove('show');
      drawChart(mDates(),-1);
    };
  }

  function showCtx(e,hid){
    haCtxId=hid;
    const m=q('haCtx');
    q('haDcf').classList.remove('show');
    m.style.left=Math.min(e.clientX,innerWidth-165)+'px';
    m.style.top=Math.min(e.clientY,innerHeight-130)+'px';
    m.classList.add('open');
  }

  function buildEP(){
    q('haEpick').innerHTML=EMOJIS.map(e=>`<button type="button" class="${e===haSelEmoji?'sel':''}" data-em="${e}">${e}</button>`).join('');
    q('haEpick').querySelectorAll('button').forEach(btn=>{btn.onclick=()=>{haSelEmoji=btn.dataset.em;q('haEpick').querySelectorAll('button').forEach(b=>b.classList.toggle('sel',b===btn))}});
  }
  function openMo(){
    haEditId=null;haSelEmoji='🎯';
    q('haMoTitle').textContent='Add habit';q('haFName').value='';q('haFCat').value='health';
    buildEP();q('haMo').classList.add('open');setTimeout(()=>q('haFName').focus(),80);
  }
  function closeMo(){q('haMo').classList.remove('open')}
  function saveH(){
    const name=q('haFName').value.trim();if(!name)return;
    const tag=q('haFCat').value;
    if(haEditId){const h=HS.habits.find(x=>x.id===haEditId);if(h){h.name=name;h.tag=tag;h.emoji=haSelEmoji}}
    else HS.habits.push({id:gid(),name,tag,emoji:haSelEmoji});
    save();closeMo();render();
  }

  q('haPrev').onclick=()=>{HS.mOff--;save();renderWithSlide('left')};
  q('haNext').onclick=()=>{HS.mOff++;save();renderWithSlide('right')};
  q('haBtnToday').onclick=()=>{const dir=HS.mOff>0?'left':'right';HS.mOff=0;save();renderWithSlide(dir)};
  q('haAddBtn').onclick=openMo;
  q('haMoCancel').onclick=closeMo;
  q('haMoSave').onclick=saveH;
  q('haMo').addEventListener('click',e=>{if(e.target===q('haMo'))closeMo()});
  q('haFName').addEventListener('keydown',e=>{if(e.key==='Enter')saveH()});
  q('haCtxEdit').onclick=()=>{
    if(!haCtxId)return;const h=HS.habits.find(x=>x.id===haCtxId);if(!h)return;
    haEditId=h.id;q('haMoTitle').textContent='Edit';q('haFName').value=h.name;q('haFCat').value=h.tag||'health';
    haSelEmoji=h.emoji||'🎯';buildEP();q('haMo').classList.add('open');q('haCtx').classList.remove('open');
    setTimeout(()=>q('haFName').focus(),80);
  };
  q('haCtxDel').onclick=()=>q('haDcf').classList.add('show');
  q('haDcfNo').onclick=()=>q('haDcf').classList.remove('show');
  q('haDcfYes').onclick=()=>{
    if(!haCtxId)return;
    const prev={h:HS.habits.map(x=>({...x})),c:{...HS.comp}},nm=HS.habits.find(h=>h.id===haCtxId)?.name||'';
    HS.habits=HS.habits.filter(h=>h.id!==haCtxId);Object.keys(HS.comp).forEach(k=>{if(k.startsWith(haCtxId+'::'))delete HS.comp[k]});
    save();render();q('haCtx').classList.remove('open');
    pushUndo(`Deleted "${nm}"`,()=>{HS.habits=prev.h;HS.comp=prev.c});
  };
  q('haUndoBtn').onclick=()=>{doUndo();q('haUndo').classList.remove('show')};

  root._haClickout=e=>{if(!e.target.closest('.ha-ctx'))q('haCtx').classList.remove('open')};
  document.addEventListener('click',root._haClickout);

  root._haKeydown=e=>{
    if(e.key==='Escape'){closeMo();q('haCtx').classList.remove('open')}
    if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();doUndo();q('haUndo').classList.remove('show')}
  };
  document.addEventListener('keydown',root._haKeydown);

  root._haResize=()=>{const c=q('haCanvas');if(c)drawChart(mDates(),-1)};
  window.addEventListener('resize',root._haResize);

  function renderWithSlide(dir){
    const main=q('haMain');
    if(!main)return render();
    const grid=main.querySelector('.ha-gw');
    if(!grid)return render();
    const out=dir==='right'?'translateX(-20px)':'translateX(20px)';
    grid.style.transition='opacity .16s ease,transform .16s ease';
    grid.style.opacity='0';grid.style.transform=out;
    setTimeout(()=>{
      render(); // full re-render, summary redraws chart
      const newGrid=main.querySelector('.ha-gw');
      if(!newGrid)return;
      const inFrom=dir==='right'?'translateX(20px)':'translateX(-20px)';
      newGrid.style.transition='none';
      newGrid.style.opacity='0';newGrid.style.transform=inFrom;
      requestAnimationFrame(()=>{
        newGrid.style.transition='opacity .22s ease,transform .22s cubic-bezier(.25,1,.5,1)';
        newGrid.style.opacity='1';newGrid.style.transform='translateX(0)';
      });
    },160);
  }

  load();render();
}

function initTasksApp(){
  const host=document.getElementById('tasksRoot');
  if(!host||host._init)return;
  host._init=true;

  

  let _id=200;const uid=()=>_id++;
  let _today=(()=>{const d=new Date();d.setHours(0,0,0,0);return d;})();
  setInterval(()=>{_today=new Date();_today.setHours(0,0,0,0);},60000);
  function mkTask(p={}){const n=new Date().toISOString();return{id:p.id??uid(),title:p.title||'',icon:p.icon||'📋',color:p.color||'#8b5cf6',project:p.project||'',category:p.category||'',tags:p.tags||'',startDate:p.startDate||'',dueDate:p.dueDate||'',dueTime:p.dueTime||'',recurrence:p.recurrence||'',estimate:p.estimate||0,projectLink:p.projectLink||'',importance:p.importance||'',impactScore:p.impactScore||0,energyMode:p.energyMode||'',focusEligible:p.focusEligible!==false,notes:p.notes||'',dependencies:p.dependencies||'',blockReason:p.blockReason||'',completed:p.completed||false,subtasks:p.subtasks?p.subtasks.map(s=>mkSub(s)):null,system:{createdAt:p.system?.createdAt||n,lastModified:n,completedAt:p.system?.completedAt||null,version:1,autoPriorityWeight:0}};}
  function mkSub(p={}){return{title:p.title||'',startDate:p.startDate||'',dueDate:p.dueDate||'',importance:p.importance||'',impactScore:p.impactScore||0,completed:p.completed||false};}
  function derived(t){
    const today=_today;
    const due=t.dueDate?new Date(t.dueDate+'T00:00:00'):null;
    const start=t.startDate?new Date(t.startDate+'T00:00:00'):null;
    if(!due)return{label:'later',urgencyScore:0,isUrgent:false,daysUntilDue:null};
    const dDue=Math.floor((due-today)/864e5);
    const dStart=start?Math.floor((start-today)/864e5):dDue;
    let ug=dDue<=0?10:dDue<=1?9:dDue<=3?7:dDue<=7?5:dDue<=14?3:1;
    const im={low:2,medium:5,high:8,critical:10};
    t.system.autoPriorityWeight=(im[t.importance]||0)*.4+(t.impactScore||0)*.3+ug*.3;
    let label='later',isUrgent=false;
    if(t.completed)label='done';
    else if(dDue<0)label='overdue';
    else if(dStart<=0&&dDue>=0){label='inprogress';isUrgent=dDue<=1;}
    else if(dDue<=3)label='soon';
    return{label,urgencyScore:ug,isUrgent,daysUntilDue:dDue};
  }
  function subDerived(s){
    if(s.completed)return{label:'done',isUrgent:false,urgencyScore:0};
    if(!s.dueDate)return{label:'later',isUrgent:false,urgencyScore:0};
    const today=_today;
    const due=new Date(s.dueDate+'T00:00:00');
    const start=s.startDate?new Date(s.startDate+'T00:00:00'):null;
    const d=Math.floor((due-today)/864e5);
    const ds=start?Math.floor((start-today)/864e5):d;
    const ug=d<=0?10:d<=1?9:d<=3?7:d<=7?5:3;
    if(d<0)return{label:'overdue',isUrgent:false,urgencyScore:ug};
    if(ds<=0&&d>=0)return{label:'inprogress',isUrgent:d<=1,urgencyScore:ug};
    if(d<=3)return{label:'soon',isUrgent:false,urgencyScore:ug};
    return{label:'later',isUrgent:false,urgencyScore:ug};
  }
  function sCls(label,urg){if(label==='inprogress'&&urg)return'pta-s-urgent';return{overdue:'pta-s-overdue',done:'pta-s-done',inprogress:'pta-s-active',soon:'pta-s-soon',later:'pta-s-later'}[label]||'pta-s-later';}
  function sTxt(label,urg){if(label==='inprogress'&&urg)return'urgent';return{overdue:'overdue',done:'done',inprogress:'active',soon:'soon',later:'later'}[label]||'later';}
  function impCls(i){return{critical:'pta-i-critical',high:'pta-i-high',medium:'pta-i-medium',low:'pta-i-low'}[i]||'';}
  const ugClr=s=>s>=9?'oklch(.72 .14 20)':s>=7?'oklch(.82 .14 40)':s>=5?'oklch(.82 .14 60)':s>=3?'oklch(.72 .14 290)':'var(--text-3)';
  const fmtDate=d=>d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'—';

  let _tasks=[];let _listeners=[];
  function notify(){_listeners.forEach(fn=>fn());}
  const P={
    getTasks:()=>_tasks,
    addTask(p){const t=mkTask(p);_tasks.push(t);derived(t);notify();return t;},
    updateTask(id,p){const t=_tasks.find(t=>t.id===id);if(!t)return;Object.assign(t,p);t.system.lastModified=new Date().toISOString();t.system.version++;if(t.completed&&!t.system.completedAt)t.system.completedAt=new Date().toISOString();if(!t.completed)t.system.completedAt=null;derived(t);notify();},
    deleteTask(id){_tasks=_tasks.filter(t=>t.id!==id);notify();},
    duplicateTask(id){const t=_tasks.find(t=>t.id===id);if(!t)return;const d=mkTask(JSON.parse(JSON.stringify(t)));d.title+=' (Copy)';d.completed=false;d.system.completedAt=null;if(d.subtasks)d.subtasks.forEach(s=>s.completed=false);_tasks.push(d);derived(d);notify();},
    toggleTask(id){const t=_tasks.find(t=>t.id===id);if(!t)return;t.completed=!t.completed;t.system.lastModified=new Date().toISOString();t.system.completedAt=t.completed?new Date().toISOString():null;if(t.completed&&t.subtasks)t.subtasks.forEach(s=>s.completed=true);derived(t);notify();},
    toggleSub(tid,si){const t=_tasks.find(t=>t.id===tid);if(!t||!t.subtasks||!t.subtasks[si])return;t.subtasks[si].completed=!t.subtasks[si].completed;t.completed=t.subtasks.every(s=>s.completed);t.system.lastModified=new Date().toISOString();t.system.completedAt=t.completed?new Date().toISOString():null;derived(t);notify();},
    subscribe(fn){_listeners.push(fn);},
    mkTask,mkSub,derived,subDerived,sCls,sTxt,
    filtered(filter,q){
      q=(q||'').toLowerCase();
      return _tasks.filter(t=>{
        if(filter&&filter!=='all'){const d=derived(t);if(filter==='inprogress'&&(d.label==='inprogress'||d.label==='soon')){}else if(d.label!==filter)return false;}
        if(q)return[t.title,t.project,t.tags,t.category].some(v=>(v||'').toLowerCase().includes(q));
        return true;
      });
    },
    moveTask(fromId,toId){
      const fi=_tasks.findIndex(t=>t.id===fromId),ti=_tasks.findIndex(t=>t.id===toId);
      if(fi<0||ti<0||fi===ti)return;
      const [t]=_tasks.splice(fi,1);_tasks.splice(ti,0,t);notify();
    },
    seed(data){_tasks=data.map(p=>mkTask(p));_tasks.forEach(derived);_id=Math.max(_id,..._tasks.map(t=>t.id+1));}
  };

  P.seed([
    {id:1,title:'Q1 Product Strategy',icon:'🎯',color:'#8b5cf6',project:'Strategy',category:'Planning',tags:'quarterly,leadership',startDate:'2026-02-18',dueDate:'2026-03-05',dueTime:'17:00',importance:'critical',impactScore:9,estimate:8,projectLink:'https://notion.so/strategy',notes:'Define roadmap priorities for Q1.',subtasks:[{title:'Market Analysis Report',startDate:'2026-02-18',dueDate:'2026-02-22',importance:'high',impactScore:7},{title:'Competitive Landscape Review',startDate:'2026-02-22',dueDate:'2026-02-26',importance:'high',impactScore:8},{title:'Draft Strategy Slides',startDate:'2026-02-26',dueDate:'2026-03-01',importance:'medium',impactScore:6},{title:'Leadership Review Meeting',startDate:'2026-03-01',dueDate:'2026-03-05',importance:'medium',impactScore:5}]},
    {id:2,title:'User Research Synthesis',icon:'📊',color:'#a78bfa',project:'Research',category:'UX',tags:'research,users',startDate:'2026-02-10',dueDate:'2026-02-23',importance:'high',impactScore:7,estimate:6,subtasks:[{title:'Compile Interview Transcripts',startDate:'2026-02-10',dueDate:'2026-02-14',completed:true,importance:'medium',impactScore:5},{title:'Identify Key Pain Points',startDate:'2026-02-14',dueDate:'2026-02-18',importance:'high',impactScore:8},{title:'Create Persona Documents',startDate:'2026-02-18',dueDate:'2026-02-20',importance:'medium',impactScore:6},{title:'Write Research Report',startDate:'2026-02-20',dueDate:'2026-02-23',importance:'high',impactScore:7}]},
    {id:3,title:'Design System Update',icon:'🎨',color:'#34d399',project:'Design',category:'Engineering',tags:'design,components',startDate:'2026-03-01',dueDate:'2026-03-14',importance:'medium',impactScore:6,estimate:12,subtasks:[{title:'Audit Color Tokens',startDate:'2026-03-01',dueDate:'2026-03-04',importance:'low',impactScore:4},{title:'Define Typography Scale',startDate:'2026-03-04',dueDate:'2026-03-08',importance:'medium',impactScore:6},{title:'Update Component Docs',startDate:'2026-03-08',dueDate:'2026-03-12',importance:'medium',impactScore:5},{title:'Migration Guide',startDate:'2026-03-12',dueDate:'2026-03-14',importance:'high',impactScore:7}]},
    {id:4,title:'API Documentation',icon:'📝',color:'#fbbf24',project:'Engineering',category:'Docs',tags:'api,docs',startDate:'2026-02-05',dueDate:'2026-02-16',importance:'high',impactScore:5,estimate:4,blockReason:'Waiting on API v2 from backend',subtasks:[{title:'Auth Endpoints',startDate:'2026-02-05',dueDate:'2026-02-08',completed:true,importance:'high',impactScore:6},{title:'CRUD Examples',startDate:'2026-02-08',dueDate:'2026-02-12',importance:'medium',impactScore:5},{title:'Error Code Reference',startDate:'2026-02-12',dueDate:'2026-02-16',importance:'medium',impactScore:4}]},
    {id:5,title:'Performance Optimization',icon:'⚡',color:'#f87171',project:'Engineering',category:'Perf',tags:'speed,core',startDate:'2026-02-20',dueDate:'2026-03-07',importance:'high',impactScore:8,estimate:16,dependencies:'3',subtasks:[{title:'Profiling Analysis',startDate:'2026-02-20',dueDate:'2026-02-23',importance:'high',impactScore:7},{title:'Bundle Size Optimization',startDate:'2026-02-23',dueDate:'2026-02-27',importance:'high',impactScore:8},{title:'Component Render Perf',startDate:'2026-02-27',dueDate:'2026-03-03',importance:'medium',impactScore:6},{title:'Load Testing',startDate:'2026-03-03',dueDate:'2026-03-07',importance:'medium',impactScore:7}]},
    {id:6,title:'Client Presentation Prep',icon:'🎤',color:'#f472b6',project:'Sales',category:'Client',tags:'client,demo',startDate:'2026-02-24',dueDate:'2026-02-27',dueTime:'10:00',importance:'critical',impactScore:9,estimate:5,subtasks:[{title:'Demo Environment Setup',startDate:'2026-02-24',dueDate:'2026-02-25',importance:'critical',impactScore:8},{title:'Slide Deck',startDate:'2026-02-25',dueDate:'2026-02-26',importance:'high',impactScore:9},{title:'Rehearse Flow',startDate:'2026-02-26',dueDate:'2026-02-27',importance:'medium',impactScore:6}]},
    {id:7,title:'Team Retrospective',icon:'🔄',color:'#22d3ee',project:'Operations',category:'Team',tags:'team,process',startDate:'2026-02-22',dueDate:'2026-02-22',dueTime:'14:00',importance:'medium',impactScore:4,estimate:2,recurrence:'biweekly'},
    {id:8,title:'Security Audit Prep',icon:'🔒',color:'#dc2626',project:'Engineering',category:'Security',tags:'security,compliance',startDate:'2026-03-10',dueDate:'2026-03-28',importance:'critical',impactScore:10,estimate:20},
    {id:9,title:'Weekly Standup Notes',icon:'📋',color:'#64748b',project:'Operations',category:'Admin',tags:'meeting,weekly',startDate:'2026-02-17',dueDate:'2026-02-17',importance:'low',impactScore:2,estimate:0.5,completed:true},
    {id:10,title:'Onboarding New Hires',icon:'👋',color:'#818cf8',project:'HR',category:'Team',tags:'onboarding,training',startDate:'2026-03-03',dueDate:'2026-03-10',importance:'medium',impactScore:5,estimate:8},
  ]);


  /* ══ WORKSPACE STORE ══ */
  const WS_KEY='pta_workspaces_v2';
  const WS_TASK_KEY=id=>'pta_ws_tasks_v2_'+id;
  const DEFAULT_WS=[
    {id:'ws1',name:'School',icon:'🎓',color:'#34d399',createdAt:Date.now()},
    {id:'ws2',name:'Pulsar',icon:'⚡',color:'#8b5cf6',createdAt:Date.now()},
    {id:'ws3',name:'InVenture',icon:'🚀',color:'#f472b6',createdAt:Date.now()},
    {id:'ws4',name:'Solo Learning',icon:'📚',color:'#fbbf24',createdAt:Date.now()},
  ];
  let _workspaces=[];
  let _activeWs=null;

  function loadWorkspaces(){
    try{const r=localStorage.getItem(WS_KEY);_workspaces=r?JSON.parse(r):DEFAULT_WS;}
    catch{_workspaces=[...DEFAULT_WS];}
    if(!_workspaces.length)_workspaces=[...DEFAULT_WS];
  }
  function saveWorkspaces(){localStorage.setItem(WS_KEY,JSON.stringify(_workspaces));}
  function saveWsTasks(wsId){localStorage.setItem(WS_TASK_KEY(wsId),JSON.stringify(P.getTasks()));}
  const WS_SEEDS={
    ws1:[
      {id:1,title:'Calculus Problem Sets',icon:'📐',color:'#34d399',project:'Math',category:'Homework',tags:'calculus,weekly',startDate:'2026-02-24',dueDate:'2026-03-01',importance:'high',impactScore:8,estimate:3,subtasks:[{title:'Chapter 5 derivatives',dueDate:'2026-02-26',importance:'medium'},{title:'Chapter 6 integrals',dueDate:'2026-03-01',importance:'high'}]},
      {id:2,title:'History Essay — Cold War',icon:'✍️',color:'#34d399',project:'History',category:'Essay',startDate:'2026-02-20',dueDate:'2026-03-07',importance:'critical',impactScore:9,estimate:8,subtasks:[{title:'Research & sources',dueDate:'2026-02-25',importance:'high',completed:true},{title:'Outline draft',dueDate:'2026-02-28',importance:'high'},{title:'Write essay',dueDate:'2026-03-05',importance:'critical'},{title:'Proofread',dueDate:'2026-03-07',importance:'medium'}]},
      {id:3,title:'Biology Lab Report',icon:'🔬',color:'#34d399',project:'Biology',category:'Lab',startDate:'2026-02-22',dueDate:'2026-02-28',importance:'high',impactScore:7,estimate:4},
      {id:4,title:'CS Project — Sorting Algorithms',icon:'💻',color:'#34d399',project:'CS',category:'Project',startDate:'2026-03-01',dueDate:'2026-03-14',importance:'medium',impactScore:6,estimate:10,subtasks:[{title:'Implement quicksort',dueDate:'2026-03-05',importance:'high'},{title:'Benchmark tests',dueDate:'2026-03-10',importance:'medium'},{title:'Write report',dueDate:'2026-03-14',importance:'medium'}]},
      {id:5,title:'Study for Chem Midterm',icon:'⚗️',color:'#34d399',project:'Chemistry',category:'Exam Prep',startDate:'2026-03-03',dueDate:'2026-03-10',importance:'critical',impactScore:10,estimate:12},
      {id:6,title:'Spanish Oral Presentation',icon:'🗣️',color:'#34d399',project:'Spanish',category:'Speaking',startDate:'2026-02-24',dueDate:'2026-02-26',importance:'high',impactScore:8,estimate:2,completed:true},
    ],
    ws2:[
      {id:1,title:'Dashboard v3 — Tasks Module',icon:'⚡',color:'#8b5cf6',project:'Frontend',category:'Engineering',tags:'ui,react',startDate:'2026-02-20',dueDate:'2026-03-07',importance:'critical',impactScore:10,estimate:20,subtasks:[{title:'List view drag-to-reorder',dueDate:'2026-02-25',importance:'high',completed:true},{title:'Kanban swimlanes',dueDate:'2026-03-01',importance:'high'},{title:'Timeline scroll sync',dueDate:'2026-03-05',importance:'medium'},{title:'Performance pass',dueDate:'2026-03-07',importance:'high'}]},
      {id:2,title:'AI Behavior System Design',icon:'🤖',color:'#8b5cf6',project:'AI Layer',category:'Architecture',startDate:'2026-02-24',dueDate:'2026-03-10',importance:'critical',impactScore:9,estimate:16},
      {id:3,title:'Skills Framework — 10 Skills',icon:'🧠',color:'#8b5cf6',project:'Skills',category:'System',startDate:'2026-02-15',dueDate:'2026-02-28',importance:'high',impactScore:8,estimate:12,subtasks:[{title:'Behavioral psychology skill',dueDate:'2026-02-20',completed:true,importance:'high'},{title:'UX designer skill',dueDate:'2026-02-22',completed:true,importance:'high'},{title:'QA edge case skill',dueDate:'2026-02-26',importance:'medium'},{title:'Performance optimizer skill',dueDate:'2026-02-28',importance:'medium'}]},
      {id:4,title:'Calendar v18 Bug Fixes',icon:'📅',color:'#8b5cf6',project:'Frontend',category:'Bugs',startDate:'2026-02-18',dueDate:'2026-02-24',importance:'high',impactScore:7,estimate:4,completed:true},
      {id:5,title:'Knowledge Graph Architecture',icon:'🕸️',color:'#8b5cf6',project:'Core',category:'Architecture',startDate:'2026-03-05',dueDate:'2026-03-20',importance:'high',impactScore:9,estimate:24},
      {id:6,title:'Onboarding Flow Design',icon:'🎯',color:'#8b5cf6',project:'UX',category:'Design',startDate:'2026-03-10',dueDate:'2026-03-25',importance:'medium',impactScore:7,estimate:10},
    ],
    ws3:[
      {id:1,title:'GT InVenture Pitch Deck',icon:'🚀',color:'#f472b6',project:'Pitch',category:'Presentation',tags:'competition,deadline',startDate:'2026-02-20',dueDate:'2026-03-01',importance:'critical',impactScore:10,estimate:10,subtasks:[{title:'Problem slide',dueDate:'2026-02-23',importance:'high',completed:true},{title:'Solution demo',dueDate:'2026-02-25',importance:'critical'},{title:'Market size slide',dueDate:'2026-02-27',importance:'high'},{title:'Financials',dueDate:'2026-03-01',importance:'critical'}]},
      {id:2,title:'BiteRight — Grocery Store Map',icon:'🗺️',color:'#f472b6',project:'BiteRight',category:'Feature',startDate:'2026-02-18',dueDate:'2026-02-26',importance:'high',impactScore:9,estimate:8,completed:true},
      {id:3,title:'User Testing Round 1',icon:'👥',color:'#f472b6',project:'Research',category:'Testing',startDate:'2026-02-24',dueDate:'2026-03-03',importance:'high',impactScore:8,estimate:5,subtasks:[{title:'Recruit 5 testers',dueDate:'2026-02-26',importance:'medium'},{title:'Conduct sessions',dueDate:'2026-03-01',importance:'high'},{title:'Synthesize feedback',dueDate:'2026-03-03',importance:'high'}]},
      {id:4,title:'Financial Projections Model',icon:'📊',color:'#f472b6',project:'Business',category:'Finance',startDate:'2026-02-28',dueDate:'2026-03-10',importance:'critical',impactScore:9,estimate:6},
      {id:5,title:'Competition Registration',icon:'📋',color:'#f472b6',project:'Admin',category:'Admin',startDate:'2026-02-15',dueDate:'2026-02-20',importance:'medium',impactScore:5,estimate:1,completed:true},
      {id:6,title:'Landing Page MVP',icon:'🌐',color:'#f472b6',project:'BiteRight',category:'Engineering',startDate:'2026-03-03',dueDate:'2026-03-15',importance:'high',impactScore:8,estimate:12},
    ],
    ws4:[
      {id:1,title:'Linear Algebra — 3Blue1Brown Series',icon:'📐',color:'#fbbf24',project:'Math',category:'Course',tags:'youtube,self-paced',startDate:'2026-02-20',dueDate:'2026-03-20',importance:'medium',impactScore:8,estimate:15,subtasks:[{title:'Vectors & Spaces (eps 1-4)',dueDate:'2026-02-28',importance:'medium',completed:true},{title:'Matrix Transformations (eps 5-7)',dueDate:'2026-03-07',importance:'medium'},{title:'Eigenvalues (eps 8-11)',dueDate:'2026-03-14',importance:'high'},{title:'Final review & notes',dueDate:'2026-03-20',importance:'medium'}]},
      {id:2,title:'Deep Learning Specialization',icon:'🧠',color:'#fbbf24',project:'ML',category:'Course',startDate:'2026-02-15',dueDate:'2026-04-01',importance:'high',impactScore:9,estimate:40,subtasks:[{title:'Neural Networks Basics',dueDate:'2026-02-28',importance:'high',completed:true},{title:'Improving Deep NNs',dueDate:'2026-03-14',importance:'high'},{title:'Structuring ML Projects',dueDate:'2026-03-21',importance:'medium'},{title:'CNNs',dueDate:'2026-03-28',importance:'high'}]},
      {id:3,title:'Read: Atomic Habits',icon:'📖',color:'#fbbf24',project:'Books',category:'Reading',startDate:'2026-02-10',dueDate:'2026-02-28',importance:'medium',impactScore:7,estimate:5,completed:true},
      {id:4,title:'Piano — Moonlight Sonata Mvt 1',icon:'🎹',color:'#fbbf24',project:'Music',category:'Practice',startDate:'2026-02-01',dueDate:'2026-03-31',importance:'low',impactScore:6,estimate:30,subtasks:[{title:'Learn right hand',dueDate:'2026-02-20',importance:'medium',completed:true},{title:'Learn left hand',dueDate:'2026-03-01',importance:'medium'},{title:'Hands together slow',dueDate:'2026-03-15',importance:'high'},{title:'Up to tempo',dueDate:'2026-03-31',importance:'medium'}]},
      {id:5,title:'Spanish — Duolingo 30-day streak',icon:'🗣️',color:'#fbbf24',project:'Languages',category:'Daily',startDate:'2026-02-01',dueDate:'2026-03-02',importance:'low',impactScore:5,estimate:5},
      {id:6,title:'Read: The Pragmatic Programmer',icon:'💻',color:'#fbbf24',project:'Books',category:'Reading',startDate:'2026-03-01',dueDate:'2026-03-30',importance:'medium',impactScore:8,estimate:8},
    ],
  };
  function loadWsTasks(wsId){
    try{const r=localStorage.getItem(WS_TASK_KEY(wsId));if(r){P.seed(JSON.parse(r));return;}}catch{}
    // first visit — seed with view-specific tasks, save so they persist
    const seeds=WS_SEEDS[wsId]||WS_SEEDS.ws1;
    P.seed(JSON.parse(JSON.stringify(seeds)));
    saveWsTasks(wsId);
  }
  function wsMetrics(wsId){
    const key=WS_TASK_KEY(wsId);
    let tasks=[];
    try{const r=localStorage.getItem(key);if(r)tasks=JSON.parse(r);}catch{}
    if(wsId===_activeWs)tasks=P.getTasks();
    const total=tasks.length;
    const done=tasks.filter(t=>t.completed).length;
    const overdue=tasks.filter(t=>{if(t.completed||!t.dueDate)return false;return new Date(t.dueDate+'T00:00:00')<_today;}).length;
    return{total,done,overdue,active:total-done};
  }

  function wsGenId(){return'ws'+Date.now().toString(36);}

  /* ══ HUB RENDER ══ */
  const HUB_COLORS=['#8b5cf6','#34d399','#f472b6','#fbbf24','#f87171','#22d3ee','#818cf8','#a78bfa'];
  const HUB_ICONS=['📋','🎓','🚀','⚡','🎯','📊','🎨','🔒','💡','🏗️','📝','🌟'];

  function renderHub(){
    loadWorkspaces();
    // breadcrumb: Productivity > Tasks
    if(typeof renderBreadcrumb==='function'){
      renderBreadcrumb([
        {label:'Productivity', onclick:()=>loadPillarHome('productivity')},
        {label:'Tasks'}
      ]);
    }

    // compute global metrics
    const wsTaskMap=_workspaces.map(ws=>{
      let tasks=[];
      if(ws.id===_activeWs)tasks=P.getTasks();
      else{try{const r=localStorage.getItem(WS_TASK_KEY(ws.id));tasks=r?JSON.parse(r):[];}catch{}}
      return{ws,tasks};
    });
    const allTasks=wsTaskMap.flatMap(x=>x.tasks);
    const gTotal=allTasks.length;
    const gDone=allTasks.filter(t=>t.completed).length;
    const gActive=gTotal-gDone;
    const gOverdue=allTasks.filter(t=>{if(t.completed||!t.dueDate)return false;return new Date(t.dueDate+'T00:00:00')<_today;}).length;
    const gRate=gTotal>0?Math.round(gDone/gTotal*100):0;
    // per-workspace bar chart data
    const wsChartData=wsTaskMap.map(({ws,tasks})=>({
      name:ws.name,icon:ws.icon,color:ws.color,
      total:tasks.length,
      done:tasks.filter(t=>t.completed).length,
      overdue:tasks.filter(t=>{if(t.completed||!t.dueDate)return false;return new Date(t.dueDate+'T00:00:00')<_today;}).length
    }));
    const maxTotal=Math.max(1,...wsChartData.map(d=>d.total));

    host.innerHTML=`
    <div class="twh">
      <div class="twh-header">
        <button class="twh-new-btn" id="twhNewBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="4" x2="12" y2="20"/><line x1="4" y1="12" x2="20" y2="12"/></svg>
        </button>
        <div class="twh-charts-area">
          <div class="twh-chart-card">
            <div class="twh-chart-title">Completion Rate</div>
            <div class="twh-donut-wrap">
              <canvas id="twhDonut" width="120" height="120"></canvas>
              <div class="twh-donut-label">
                <span class="twh-donut-pct">${gRate}%</span>
                <span class="twh-donut-sub">${gDone}/${gTotal}</span>
              </div>
            </div>
          </div>
          <div class="twh-chart-card twh-chart-stacked">
            <div class="twh-chart-title">Status Overview</div>
            <div class="twh-status-rows">
              <div class="twh-sr"><div class="twh-sr-bar-wrap"><div class="twh-sr-bar" style="width:${gTotal>0?Math.round(gActive/gTotal*100):0}%;background:#a78bfa"></div></div><span class="twh-sr-lbl">Active</span><span class="twh-sr-val" style="color:#a78bfa">${gActive}</span></div>
              <div class="twh-sr"><div class="twh-sr-bar-wrap"><div class="twh-sr-bar" style="width:${gTotal>0?Math.round(gDone/gTotal*100):0}%;background:#4ade80"></div></div><span class="twh-sr-lbl">Done</span><span class="twh-sr-val" style="color:#4ade80">${gDone}</span></div>
              <div class="twh-sr"><div class="twh-sr-bar-wrap"><div class="twh-sr-bar" style="width:${gTotal>0?Math.round(gOverdue/gTotal*100):0}%;background:#f87171"></div></div><span class="twh-sr-lbl">Overdue</span><span class="twh-sr-val" style="color:#f87171">${gOverdue}</span></div>
              <div class="twh-sr twh-sr-total"><span class="twh-sr-lbl">Total tasks</span><span class="twh-sr-val">${gTotal}</span></div>
            </div>
          </div>

        </div>
      </div>
      <div class="twh-recent-section">
        <div class="twh-section-label">All Task Views</div>
        <div class="twh-ws-list" id="twList"></div>
      </div>
    </div>
    <div class="twh-modal-bg" id="twhModalBg">
      <div class="twh-modal">
        <h3 id="twhModalTitle">New Task View</h3>
        <div class="twh-field"><label>Name</label><input class="twh-input" id="twhName" placeholder="e.g. School, Pulsar, Work" maxlength="32"></div>
        <div class="twh-field"><label>Icon</label><div class="twh-icons" id="twhIcons"></div></div>
        <div class="twh-field"><label>Color</label><div class="twh-colors" id="twhColors"></div></div>
        <div class="twh-modal-ft">
          <button class="twh-btn twh-btn-ghost" id="twhCancel">Cancel</button>
          <button class="twh-btn twh-btn-pri" id="twhSave">Create</button>
        </div>
      </div>
    </div>`;

    let editingWsId=null;
    let selColor=HUB_COLORS[0];
    let selIcon=HUB_ICONS[0];

    function buildGrid(){
      const list=document.getElementById('twList');
      list.innerHTML='';
      _workspaces.forEach(ws=>{
        const m=wsMetrics(ws.id);
        const row=document.createElement('div');
        row.className='twh-list-row';
        row.innerHTML=`
          <div class="twh-lr-accent" style="background:${ws.color}"></div>
          <span class="twh-lr-icon">${ws.icon}</span>
          <span class="twh-lr-name">${ws.name}</span>
          <span class="twh-lr-count">${m.total} task${m.total!==1?'s':''}</span>
          <div class="twh-lr-pills">
            ${m.active>0?`<span class="twh-sp-pill active">${m.active} active</span>`:'<span class="twh-sp-pill empty">No active tasks</span>'}
            ${m.overdue>0?`<span class="twh-sp-pill overdue">${m.overdue} overdue</span>`:''}
            ${m.done>0?`<span class="twh-sp-pill done">${m.done} done</span>`:''}
          </div>
          <button class="twh-lr-opts" data-wsid="${ws.id}"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1" fill="currentColor" stroke="none"/><circle cx="12" cy="12" r="1" fill="currentColor" stroke="none"/><circle cx="12" cy="19" r="1" fill="currentColor" stroke="none"/></svg></button>`;
        row.onclick=e=>{if(e.target.closest('.twh-lr-opts'))return;enterWorkspace(ws.id);};
        row.querySelector('.twh-lr-opts').onclick=e=>{e.stopPropagation();showCtxMenu(e,ws.id);};
        list.appendChild(row);
      });
    }
    let activeCtx=null;
    function showCtxMenu(e,wsId){
      closeCtx();
      const menu=document.createElement('div');
      menu.className='twh-ctx';
      menu.innerHTML=`
        <button class="twh-ctx-item" data-act="edit"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Rename</button>
        <button class="twh-ctx-item danger" data-act="del"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>Delete</button>`;
      menu.style.left=e.clientX+'px';menu.style.top=e.clientY+'px';
      document.body.appendChild(menu);activeCtx=menu;
      menu.querySelector('[data-act="edit"]').onclick=()=>{closeCtx();openEditModal(wsId);};
      menu.querySelector('[data-act="del"]').onclick=()=>{closeCtx();deleteWs(wsId);};
      setTimeout(()=>document.addEventListener('click',closeCtx,{once:true}),0);
    }
    function closeCtx(){if(activeCtx){activeCtx.remove();activeCtx=null;}}

    function buildModalPickers(){
      const iconsEl=document.getElementById('twhIcons');
      const colorsEl=document.getElementById('twhColors');
      if(!iconsEl||!colorsEl)return;
      iconsEl.innerHTML=HUB_ICONS.map(i=>`<button class="twh-ico-btn${i===selIcon?' sel':''}" data-ico="${i}">${i}</button>`).join('');
      colorsEl.innerHTML=HUB_COLORS.map(c=>`<div class="twh-color${c===selColor?' sel':''}" data-col="${c}" style="background:${c}"></div>`).join('');
      iconsEl.querySelectorAll('.twh-ico-btn').forEach(b=>b.onclick=()=>{selIcon=b.dataset.ico;buildModalPickers();});
      colorsEl.querySelectorAll('.twh-color').forEach(b=>b.onclick=()=>{selColor=b.dataset.col;buildModalPickers();});
    }

    function openCreateModal(){
      editingWsId=null;
      selColor=HUB_COLORS[_workspaces.length%HUB_COLORS.length];
      selIcon=HUB_ICONS[_workspaces.length%HUB_ICONS.length];
      document.getElementById('twhModalTitle').textContent='New Task View';
      document.getElementById('twhName').value='';
      document.getElementById('twhSave').textContent='Create';
      buildModalPickers();
      document.getElementById('twhModalBg').classList.add('open');
      setTimeout(()=>document.getElementById('twhName').focus(),180);
    }
    function openEditModal(wsId){
      const ws=_workspaces.find(w=>w.id===wsId);if(!ws)return;
      editingWsId=wsId;selColor=ws.color;selIcon=ws.icon;
      document.getElementById('twhModalTitle').textContent='Edit Task View';
      document.getElementById('twhName').value=ws.name;
      document.getElementById('twhSave').textContent='Save';
      buildModalPickers();
      document.getElementById('twhModalBg').classList.add('open');
    }
    function closeModal(){const el=document.getElementById('twhModalBg');if(el)el.classList.remove('open');}
    function deleteWs(wsId){
      if(!confirm('Delete this task view and all its tasks?'))return;
      _workspaces=_workspaces.filter(w=>w.id!==wsId);
      localStorage.removeItem(WS_TASK_KEY(wsId));
      saveWorkspaces();buildGrid();
    }

    document.getElementById('twhNewBtn').onclick=()=>openCreateModal();
    document.getElementById('twhCancel').onclick=closeModal;
    document.getElementById('twhModalBg').onclick=e=>{if(e.target===document.getElementById('twhModalBg'))closeModal();};
    document.getElementById('twhSave').onclick=()=>{
      const name=document.getElementById('twhName').value.trim();
      if(!name)return;
      if(editingWsId){
        const ws=_workspaces.find(w=>w.id===editingWsId);
        if(ws){ws.name=name;ws.color=selColor;ws.icon=selIcon;}
      } else {
        _workspaces.push({id:wsGenId(),name,icon:selIcon,color:selColor,createdAt:Date.now()});
      }
      saveWorkspaces();closeModal();buildGrid();
    };
    document.getElementById('twhName').onkeydown=e=>{if(e.key==='Enter')document.getElementById('twhSave').click();};

    buildGrid();
    drawCharts();

    function drawCharts(){
      const dpr=window.devicePixelRatio||1;

      // ── 1. DONUT — completion rate ───────────────────────────────
      const dc=document.getElementById('twhDonut');
      if(dc){
        const S=120*dpr; dc.width=S; dc.height=S;
        dc.style.width='120px'; dc.style.height='120px';
        const ctx=dc.getContext('2d');
        ctx.scale(dpr,dpr);
        const cx=60,cy=60,r=44,lw=11;
        // track
        ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
        ctx.strokeStyle='rgba(255,255,255,0.07)';ctx.lineWidth=lw;ctx.stroke();
        if(gTotal>0){
          const segs=[
            {val:gDone,   color:'#4ade80'},
            {val:gActive, color:'#a78bfa'},
            {val:gOverdue,color:'#f87171'},
          ];
          let angle=-Math.PI/2;
          segs.forEach(s=>{
            if(s.val<=0)return;
            const sweep=(s.val/gTotal)*Math.PI*2;
            ctx.beginPath();ctx.arc(cx,cy,r,angle,angle+sweep);
            ctx.strokeStyle=s.color;ctx.lineWidth=lw;
            ctx.lineCap='butt';ctx.stroke();
            angle+=sweep;
          });
          // gap dots between segments
          ctx.lineCap='round';
        }
        // thin inner ring
        ctx.beginPath();ctx.arc(cx,cy,r-8,0,Math.PI*2);
        ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;ctx.stroke();
      }


    }
  }

  function enterWorkspace(wsId){
    _activeWs=wsId;
    _listeners=[];
    loadWsTasks(wsId);
    const ws=_workspaces.find(w=>w.id===wsId)||{name:'Task View'};
    if(typeof renderBreadcrumb==='function'){
      renderBreadcrumb([
        {label:'Productivity', onclick:()=>loadPillarHome('productivity')},
        {label:'Tasks', onclick:()=>{
          if(host._ptaBack)host._ptaBack();
          else{if(_activeWs)saveWsTasks(_activeWs);if(host._ptaKey)document.removeEventListener('keydown',host._ptaKey);_activeWs=null;_tasks=[];_listeners=[];renderHub();}
        }},
        {label: ws.icon + ' ' + ws.name}
      ]);
    }
    initApp();
    P.subscribe(()=>saveWsTasks(wsId));
  }

  loadWorkspaces();
  renderHub();

  function initApp(){
    const ws=_workspaces.find(w=>w.id===_activeWs)||{name:'Tasks',icon:'📋',color:'#8b5cf6'};

    host.innerHTML=`<div class="pta">
  <div class="pta-hdr">
    <div class="pta-ws-title-bar">
      <span class="pta-ws-title-icon">${ws.icon}</span>
      <span class="pta-ws-title-name">${ws.name}</span>
    </div>
    <nav class="pta-tabs" id="ptaTabs" style="margin-left:20px">
      <div class="pta-tab-pill" id="ptaTabPill"></div>
      <button class="pta-tab active" data-v="list"><svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3" cy="6" r=".5" fill="currentColor"/><circle cx="3" cy="12" r=".5" fill="currentColor"/><circle cx="3" cy="18" r=".5" fill="currentColor"/></svg>List</button>
      <button class="pta-tab" data-v="kanban"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="11" rx="1"/><rect x="17" y="3" width="5" height="15" rx="1"/></svg>Kanban</button>
      <button class="pta-tab" data-v="timeline"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Timeline</button>
    </nav>
    <div class="pta-sp"></div>
    <div class="pta-search"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input class="pta-sinput" id="ptaSearch" placeholder="Search tasks…"></div>
    <div class="pta-metrics" id="ptaMetrics"></div>
    <button class="pta-addbtn" id="ptaAdd"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Task</button>
  </div>
  <div class="pta-panels">
    <!-- LIST -->
    <div class="pta-panel active" id="pta-v-list">
      <div class="pta-chips" id="ptaChips">
        <div class="pta-chip active" data-f="all">All</div>
        <div class="pta-chip" data-f="overdue">Overdue</div>
        <div class="pta-chip" data-f="inprogress">Active</div>
        <div class="pta-chip" data-f="soon">Soon</div>
        <div class="pta-chip" data-f="done">Done</div>
        <div class="pta-chip" data-f="later">Later</div>
      </div>
      <div class="pta-listwrap">
        <div class="pta-lhead">
          <div class="pta-lhead-fixed">
            <div></div><div></div><div></div>
            <div class="pta-colh" style="min-width:280px">Tasks</div>
          </div>
          <div class="pta-lhead-swrap" id="ptaShwrap">
            <div class="pta-shead">
              <div class="pta-colh pcw140" data-ls="project">Project</div>
              <div class="pta-colh pcw110" data-ls="dueDate">Due</div>
              <div class="pta-colh pcw110" data-ls="startDate">Start</div>
              <div class="pta-colh pcw100" data-ls="estimate">Est</div>
              <div class="pta-colh pcw130" data-ls="importance">Priority</div>
              <div class="pta-colh pcw160" data-ls="urgency">Urgency</div>
              <div class="pta-colh pcw130" data-ls="impact">Impact</div>
              <div class="pta-colh pcw110" data-ls="state">State</div>
              <div class="pta-colh pcw130" data-ls="blockReason">Blocked</div>
              <div class="pta-colh pcw140">Link</div>
            </div>
          </div>
        </div>
        <div class="pta-lbody" id="ptaListbody"></div>
      </div>
    </div>
    <!-- KANBAN -->
    <div class="pta-panel" id="pta-v-kanban">
      <div class="pta-ktool">
        <div class="pta-kmtog">
          <button class="pta-kmbtn active" data-km="state">By State</button>
          <button class="pta-kmbtn" data-km="category">By Category</button>
        </div>
      </div>
      <div class="pta-board" id="ptaBoard"></div>
    </div>
    <!-- TIMELINE -->
    <div class="pta-panel" id="pta-v-timeline">
      <div class="pta-tltool">
        <button class="pta-tlbtn" id="ptaGoToday"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Today</button>
      </div>
      <div class="pta-tlwrap">
        <div class="pta-tl-head">
          <div class="pta-tl-lblhead"><span>Tasks</span></div>
          <div class="pta-days-wrap" id="ptaDaysWrap"><div class="pta-days-head" id="ptaDaysHead"></div></div>
        </div>
        <div class="pta-tlbody" id="ptaTlbody"></div>
      </div>
    </div>
  </div>
</div>
<!-- Task modal -->
<div class="pta-mo" id="ptaMo">
  <div class="pta-mbox">
    <div class="pta-mhd">
      <div class="pta-mhd-dot" id="ptaMDot"></div>
      <h3 id="ptaMTitle">New Task</h3>
      <button class="pta-mclosebtn" id="ptaMClose"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="pta-mtitle-row">
      <span class="pta-mtitle-icon" id="ptaMIconD">📋</span>
      <input class="pta-mtitle-input" id="ptaMFTitle" placeholder="Task name…">
      <input class="pta-mcolor" type="color" id="ptaMColor" value="#8b5cf6">
    </div>
    <div class="pta-mtabs">
      <div class="pta-mtab active" data-tab="details">Details</div>
      <div class="pta-mtab" data-tab="schedule">Schedule</div>
      <div class="pta-mtab" data-tab="priority">Priority</div>
      <div class="pta-mtab" data-tab="subtasks">Subtasks</div>
      <div class="pta-mtab" data-tab="notes">Notes</div>
    </div>
    <div class="pta-mbody">
      <div class="pta-mtpanel active" id="ptaTab-details">
        <div class="pta-mrow pta-mrow-2"><div class="pta-mfield"><label>Project</label><input id="ptaMProject"></div><div class="pta-mfield"><label>Category</label><input id="ptaMCat"></div></div>
        <div class="pta-mrow pta-mrow-2"><div class="pta-mfield"><label>Icon</label><input id="ptaMIcon" maxlength="2" style="font-size:16px;text-align:center"></div><div class="pta-mfield"><label>Tags</label><input id="ptaMTags" placeholder="tag1, tag2…"></div></div>
        <div class="pta-mrow"><div class="pta-mfield"><label>Project Link</label><input type="url" id="ptaMLink" placeholder="https://…"></div></div>
        <div class="pta-insight" id="ptaInsight" style="display:none"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg><div class="pta-insight-txt" id="ptaInsightTxt"></div></div>
      </div>
      <div class="pta-mtpanel" id="ptaTab-schedule">
        <div class="pta-mrow pta-mrow-2"><div class="pta-mfield"><label>Start Date</label><input type="date" id="ptaMStart"></div><div class="pta-mfield"><label>Due Date</label><input type="date" id="ptaMDue"></div></div>
        <div class="pta-mrow pta-mrow-2"><div class="pta-mfield"><label>Due Time</label><input type="time" id="ptaMDueTime"></div><div class="pta-mfield"><label>Est. Hours</label><input type="number" id="ptaMEst" min="0" step="0.5" placeholder="0"></div></div>
        <div class="pta-mrow"><div class="pta-mfield"><label>Recurrence</label><select id="ptaMRec"><option value="">None</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="biweekly">Bi-weekly</option><option value="monthly">Monthly</option></select></div></div>
      </div>
      <div class="pta-mtpanel" id="ptaTab-priority">
        <div class="pta-mrow pta-mrow-2"><div class="pta-mfield"><label>Importance</label><select id="ptaMImp"><option value="">—</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div><div class="pta-mfield"><label>Impact (1–10)</label><input type="number" id="ptaMImpact" min="1" max="10"></div></div>
        <div class="pta-mrow pta-mrow-2"><div class="pta-mfield"><label>Energy</label><select id="ptaMEnergy"><option value="">—</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select></div><div class="pta-mfield" style="justify-content:flex-end"><label>&nbsp;</label><label class="pta-mchk"><input type="checkbox" id="ptaMFocus"><span>Focus Eligible</span></label></div></div>
        <div class="pta-mrow"><div class="pta-mfield"><label>Block Reason</label><input id="ptaMBlock" placeholder="Why is this blocked?"></div></div>
        <div class="pta-mrow"><div class="pta-mfield"><label>Dependencies</label><input id="ptaMDeps" placeholder="Task IDs: 1, 2…"></div></div>
      </div>
      <div class="pta-mtpanel" id="ptaTab-subtasks">
        <div class="pta-sub-add">
          <div class="pta-mfield"><label>Title</label><input id="ptaSubT" placeholder="Subtask name…"></div>
          <div class="pta-mfield"><label>Start</label><input type="date" id="ptaSubS"></div>
          <div class="pta-mfield"><label>Due</label><input type="date" id="ptaSubD"></div>
          <button class="pta-mbtn pta-mbtn-sec pta-mbtn-sm" id="ptaAddSub" disabled>+ Add</button>
        </div>
        <div class="pta-sub-list" id="ptaSubList"></div>
      </div>
      <div class="pta-mtpanel" id="ptaTab-notes">
        <div class="pta-mfield"><label>Notes</label><textarea id="ptaMNotes" placeholder="Context, decisions, details…" style="min-height:150px"></textarea></div>
      </div>
    </div>
    <div class="pta-mfoot">
      <div class="pta-mfoot-l"><button class="pta-mbtn pta-mbtn-danger" id="ptaMDel">Delete</button><button class="pta-mbtn pta-mbtn-ghost" id="ptaMDup">Duplicate</button></div>
      <button class="pta-mbtn pta-mbtn-sec" id="ptaMCancel">Cancel</button>
      <button class="pta-mbtn pta-mbtn-primary" id="ptaMSave">Save Task</button>
    </div>
  </div>
</div>
<!-- Subtask modal -->
<div class="pta-mo" id="ptaSMo">
  <div class="pta-sbox">
    <div class="pta-mhd" style="padding-bottom:12px;border-bottom:1px solid oklch(.22 .04 290)">
      <div class="pta-mhd-dot" id="ptaSMDot"></div>
      <h3>Subtask</h3>
      <button class="pta-mclosebtn" id="ptaSClose"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div style="padding:14px 18px;display:flex;flex-direction:column;gap:11px">
      <div class="pta-mfield"><label>Title</label><input id="ptaSFTitle" placeholder="Subtask name…" style="font-size:13px"></div>
      <div class="pta-mrow pta-mrow-2"><div class="pta-mfield"><label>Start</label><input type="date" id="ptaSStart"></div><div class="pta-mfield"><label>Due</label><input type="date" id="ptaSDue"></div></div>
      <div class="pta-mrow pta-mrow-2"><div class="pta-mfield"><label>Importance</label><select id="ptaSImp"><option value="">—</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div><div class="pta-mfield"><label>Impact</label><input type="number" id="ptaSImpact" min="1" max="10"></div></div>
      <label class="pta-mchk"><input type="checkbox" id="ptaSComp"><span>Completed</span></label>
    </div>
    <div class="pta-mfoot">
      <div class="pta-mfoot-l"><button class="pta-mbtn pta-mbtn-danger pta-mbtn-sm" id="ptaSDelete">Remove</button></div>
      <button class="pta-mbtn pta-mbtn-sec" id="ptaSCancel">Cancel</button>
      <button class="pta-mbtn pta-mbtn-primary" id="ptaSSave">Save</button>
    </div>
  </div>
</div>`;

  const q=id=>host.querySelector('#'+id);
  const activeView=()=>host.querySelector('.pta-tab.active')?.dataset.v||'list';

  function movePill(tab){
    const pill=q('ptaTabPill');
    if(!pill||!tab)return;
    pill.style.left=tab.offsetLeft+'px';
    pill.style.top=tab.offsetTop+'px';
    pill.style.width=tab.offsetWidth+'px';
    pill.style.height=tab.offsetHeight+'px';
  }
  host.querySelectorAll('.pta-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      host.querySelectorAll('.pta-tab').forEach(t=>t.classList.remove('active'));
      host.querySelectorAll('.pta-panel').forEach(p=>p.classList.remove('active'));
      tab.classList.add('active');
      host.querySelector('#pta-v-'+tab.dataset.v)?.classList.add('active');
      movePill(tab);
      if(tab.dataset.v==='timeline')tlScrollToday();
    });
  });
  (()=>{
    const pill=q('ptaTabPill');const active=host.querySelector('.pta-tab.active');
    if(!pill||!active)return;
    pill.style.transition='none';
    movePill(active);
    requestAnimationFrame(()=>pill.style.transition='');
  })();

  q('ptaSearch').oninput=()=>{renderList();renderKanban();renderTL();};
  q('ptaAdd').onclick=()=>openModal(null);
  // back nav now via breadcrumb; keep handler on a hidden anchor
  const _ptaBackFn=()=>{
    if(_activeWs)saveWsTasks(_activeWs);
    if(host._ptaKey)document.removeEventListener('keydown',host._ptaKey);
    _activeWs=null;_tasks=[];_listeners=[];
    renderHub();
  };
  // expose so breadcrumb Tasks link can call it
  host._ptaBack=_ptaBackFn;
  function updateMetrics(){
    const el=document.getElementById('ptaMetrics');if(!el)return;
    const tasks=P.getTasks();
    const total=tasks.length;
    const done=tasks.filter(t=>t.completed).length;
    const overdue=tasks.filter(t=>{if(t.completed||!t.dueDate)return false;return new Date(t.dueDate+'T00:00:00')<_today;}).length;
    const active=total-done;
    el.innerHTML=`
      <div class="pta-mstat accent"><span class="pta-mstat-n">${total}</span><span class="pta-mstat-l">Total</span></div>
      <div class="pta-mstat"><span class="pta-mstat-n">${active}</span><span class="pta-mstat-l">Active</span></div>
      <div class="pta-mstat warn"><span class="pta-mstat-n">${done}</span><span class="pta-mstat-l">Done</span></div>
      ${overdue>0?`<div class="pta-mstat danger"><span class="pta-mstat-n">${overdue}</span><span class="pta-mstat-l">Overdue</span></div>`:''}`;
  }

  let lSort='dueDate',lDir=1,lFilter='all',lExp=new Set(),ldSrc=null;

  function lSortV(t,k){
    const d=P.derived(t);
    switch(k){
      case'title':return t.title.toLowerCase();
      case'project':return(t.project||'').toLowerCase();
      case'dueDate':return t.dueDate||'9999';
      case'startDate':return t.startDate||'9999';
      case'estimate':return t.estimate||0;
      case'importance':return{critical:4,high:3,medium:2,low:1}[t.importance]||0;
      case'urgency':return d.urgencyScore;
      case'impact':return t.impactScore||0;
      case'state':return{overdue:5,inprogress:4,soon:3,later:2,done:1}[d.label]||0;
      case'blockReason':return t.blockReason?0:1;
      default:return 0;
    }
  }

  function renderList(){
    const body=q('ptaListbody');
    const _base=P.filtered(lFilter,q('ptaSearch').value);
    const tasks=lSort?[..._base].sort((a,b)=>{const av=lSortV(a,lSort),bv=lSortV(b,lSort);return av<bv?-lDir:av>bv?lDir:0;}):_base;
    if(!tasks.length){body.innerHTML=`<div class="pta-empty"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg><p>No tasks found</p></div>`;return;}
    let h='';
    tasks.forEach(t=>{
      const d=P.derived(t);const hasSubs=t.subtasks&&t.subtasks.length;const isExp=lExp.has(t.id);
      h+=`<div class="pta-group">`;
      h+=lTaskHTML(t,d,hasSubs,isExp);
      if(hasSubs){
        h+=`<div class="pta-subwrap" data-subs="${t.id}" style="height:${isExp?'auto':'0px'}">`;
        t.subtasks.forEach((s,i)=>h+=lSubHTML(t,s,i,P.subDerived(s)));
        h+=`</div>`;
      }
      h+=`</div>`;
    });
    body.innerHTML=h;
    lBind();
  }

  function lTaskHTML(t,d,hasSubs,isExp){
    const ug=d.urgencyScore;
    let imp=hasSubs?`<span style="font-size:10px;color:var(--text-3)">${t.subtasks.filter(s=>s.completed).length}/${t.subtasks.length}</span>`:'';
    let impBadge=t.importance?`<span class="pta-ib ${impCls(t.importance)}">${t.importance}</span>`:'<span class="pta-ct">—</span>';
    let dots='<span class="pta-ct">—</span>';
    if(t.impactScore){let dd='';for(let i=1;i<=10;i++)dd+=`<div class="pta-idot${i<=t.impactScore?' on':''}"></div>`;dots=`<div class="pta-imd"><div class="pta-idots">${dd}</div><span class="pta-isc">${t.impactScore}</span></div>`;}
    let link='<span class="pta-ct">—</span>';
    if(t.projectLink){try{const h=new URL(t.projectLink).hostname.replace('www.','');link=`<a class="pta-link" href="${t.projectLink}" target="_blank" onclick="event.stopPropagation()"><svg viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/></svg>${h}</a>`;}catch(e){}}
    let blocked='<span class="pta-ct">—</span>';
    if(t.blockReason)blocked=`<div class="pta-btag"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/></svg>Blocked</div>`;
    return `<div class="pta-taskrow${t.completed?' done':''}" data-id="${t.id}">
      <div class="pta-row-fixed">
        <div class="pta-cell pta-cbar"><div class="pta-cbarfill" style="background:${t.color}"></div></div>
        <div class="pta-drag" onmousedown="event.preventDefault();event.stopPropagation();if(window._ptaDragStart)window._ptaDragStart(this,${t.id})"><svg viewBox="0 0 24 24" width="12" height="12"><use href="#drag-dots"/></svg></div>
        <div class="pta-cell pta-ccb"><input type="checkbox" class="pta-cb pta-tchk" data-id="${t.id}" ${t.completed?'checked':''}></div>
        <div class="pta-cell pta-ctitle">
          <button class="pta-expbtn${isExp?' open':''}" data-id="${t.id}" style="${hasSubs?'':'visibility:hidden'}"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></button>
          <span style="font-size:13px;flex-shrink:0">${t.icon}</span>
          <span class="pta-tnm${t.completed?' done':''}" data-open="${t.id}"><span class=\"pta-tnm-inner\">${t.title}</span></span>${imp}
        </div>
      </div>
      <div class="pta-row-scroll pta-rs" data-id="${t.id}">
        <div class="pta-cell pcw140"><span class="pta-ct">${t.project||'—'}</span></div>
        <div class="pta-cell pcw110"><span class="pta-cd">${fmtDate(t.dueDate)}</span></div>
        <div class="pta-cell pcw110"><span class="pta-cd">${fmtDate(t.startDate)}</span></div>
        <div class="pta-cell pcw100"><span class="pta-ct">${t.estimate?t.estimate+'h':'—'}</span></div>
        <div class="pta-cell pcw130">${impBadge}</div>
        <div class="pta-cell pcw160"><div class="pta-ugw"><div class="pta-ugbar"><div class="pta-ugfill" style="width:${ug*10}%;background:${ugClr(ug)}"></div></div><span class="pta-uglbl">${ug}</span></div></div>
        <div class="pta-cell pcw130">${dots}</div>
        <div class="pta-cell pcw110"><span class="pta-sp ${P.sCls(d.label,d.isUrgent)}">${P.sTxt(d.label,d.isUrgent)}</span></div>
        <div class="pta-cell pcw130">${blocked}</div>
        <div class="pta-cell pcw140">${link}</div>
      </div>
    </div>`;
  }

  function lSubHTML(parent,sub,idx,sd){
    const ug=sd.urgencyScore;
    let impBadge=sub.importance?`<span class="pta-ib ${impCls(sub.importance)}">${sub.importance}</span>`:'<span class="pta-ct">—</span>';
    let dots='<span class="pta-ct">—</span>';
    if(sub.impactScore){let dd='';for(let i=1;i<=10;i++)dd+=`<div class="pta-idot${i<=sub.impactScore?' on':''}"></div>`;dots=`<div class="pta-imd"><div class="pta-idots">${dd}</div><span class="pta-isc">${sub.impactScore}</span></div>`;}
    return `<div class="pta-subrow" data-parent="${parent.id}" data-idx="${idx}">
      <div class="pta-row-fixed">
        <div class="pta-cell pta-cbar"><div class="pta-cbarfill" style="background:${parent.color};opacity:.4"></div></div>
        <div class="pta-drag" style="visibility:hidden"><svg viewBox="0 0 24 24" width="12" height="12"><use href="#drag-dots"/></svg></div>
        <div class="pta-cell pta-ccb"><input type="checkbox" class="pta-cb pta-schk" data-parent="${parent.id}" data-idx="${idx}" ${sub.completed?'checked':''}></div>
        <div class="pta-cell pta-ctitle"><div class="pta-sindent"></div><span class="pta-tnm${sub.completed?' done':''}" style="font-weight:400;font-size:11px"><span class=\"pta-tnm-inner\">${sub.title}</span></span></div>
      </div>
      <div class="pta-row-scroll pta-rs">
        <div class="pta-cell pcw140"><span class="pta-ct">—</span></div>
        <div class="pta-cell pcw110"><span class="pta-cd">${fmtDate(sub.dueDate)}</span></div>
        <div class="pta-cell pcw110"><span class="pta-cd">${fmtDate(sub.startDate)}</span></div>
        <div class="pta-cell pcw100"><span class="pta-ct">—</span></div>
        <div class="pta-cell pcw130">${impBadge}</div>
        <div class="pta-cell pcw160"><div class="pta-ugw"><div class="pta-ugbar"><div class="pta-ugfill" style="width:${ug*10}%;background:${ugClr(ug)}"></div></div><span class="pta-uglbl">${ug}</span></div></div>
        <div class="pta-cell pcw130">${dots}</div>
        <div class="pta-cell pcw110"><span class="pta-sp ${P.sCls(sd.label,sd.isUrgent)}">${P.sTxt(sd.label,sd.isUrgent)}</span></div>
        <div class="pta-cell pcw130"><span class="pta-ct">—</span></div>
        <div class="pta-cell pcw140"><span class="pta-ct">—</span></div>
      </div>
    </div>`;
  }

  function lBind(){
    host.querySelectorAll('.pta-tchk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();P.toggleTask(+cb.dataset.id);});
    host.querySelectorAll('.pta-schk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();P.toggleSub(+cb.dataset.parent,+cb.dataset.idx);});
    host.querySelectorAll('.pta-expbtn').forEach(btn=>btn.onclick=e=>{
      e.stopPropagation();
      const id=+btn.dataset.id;const wrap=host.querySelector(`.pta-subwrap[data-subs="${id}"]`);if(!wrap)return;
      if(lExp.has(id)){wrap.style.height=wrap.offsetHeight+'px';wrap.offsetHeight;wrap.style.height='0px';lExp.delete(id);btn.classList.remove('open');}
      else{wrap.style.height='0px';wrap.offsetHeight;wrap.style.height=wrap.scrollHeight+'px';wrap.addEventListener('transitionend',()=>{if(lExp.has(id))wrap.style.height='auto';},{once:true});lExp.add(id);btn.classList.add('open');}
    });
    host.querySelectorAll('[data-open]').forEach(el=>el.onclick=e=>{e.stopPropagation();const t=P.getTasks().find(t=>t.id===+el.dataset.open);if(t)openModal(t);});
    host.querySelectorAll('.pta-taskrow').forEach(row=>row.onclick=e=>{if(e.target.classList.contains('pta-cb')||e.target.closest('.pta-expbtn')||e.target.closest('.pta-link')||e.target.dataset.open)return;const t=P.getTasks().find(t=>t.id===+row.dataset.id);if(t)openModal(t);});
    host.querySelectorAll('.pta-subrow').forEach(row=>row.onclick=e=>{
      if(e.target.classList.contains('pta-cb'))return;
      const t=P.getTasks().find(t=>t.id===+row.dataset.parent);if(!t)return;
      openModal(t);requestAnimationFrame(()=>{switchMTab('subtasks');openSubModal(+row.dataset.idx);});
    });
  }



  host.querySelectorAll('.pta-chip').forEach(c=>c.onclick=()=>{host.querySelectorAll('.pta-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');lFilter=c.dataset.f;renderList();});

  window._ptaDragStart=function(handleEl,taskId){
    const body=q('ptaListbody');
    if(!body)return;
    let srcId=taskId,srcGrp=null,lastOverKey=null;
    let el=handleEl;
    while(el&&!el.classList.contains('pta-group'))el=el.parentElement;
    srcGrp=el;
    if(!srcGrp)return;
    srcGrp.querySelector('.pta-taskrow')?.classList.add('dragging');
    document.body.style.userSelect='none';
    document.body.style.cursor='grabbing';

    function restripe(){
      [...body.querySelectorAll('.pta-group')].forEach((g,i)=>{
        const even=i%2===1;
        g.querySelectorAll('.pta-taskrow,.pta-subrow,.pta-row-fixed').forEach(el=>{
          el.style.background=even?'oklch(.145 .015 290)':'';
        });
      });
    }

    function swapInStore(fromId,toId,after){
      const arr=P.getTasks();
      const fi=arr.findIndex(t=>t.id===fromId);
      const ti=arr.findIndex(t=>t.id===toId);
      if(fi<0||ti<0||fi===ti)return;
      const [item]=arr.splice(fi,1);
      const ni=arr.findIndex(t=>t.id===toId);
      arr.splice(after?ni+1:ni,0,item);
      lSort=null;
      host.querySelectorAll('[data-ls]').forEach(c=>c.classList.remove('sorted'));
    }

    function animatedSwap(targetGrp,after){
      const groups=[...body.querySelectorAll('.pta-group')];
      const before=new Map();
      groups.forEach(g=>before.set(g,g.getBoundingClientRect().top));
      if(after)targetGrp.after(srcGrp);else targetGrp.before(srcGrp);
      groups.forEach(g=>{
        const dy=before.get(g)-g.getBoundingClientRect().top;
        if(Math.abs(dy)<1)return;
        g.style.transition='none';
        g.style.transform=`translateY(${dy}px)`;
        requestAnimationFrame(()=>{
          g.style.transition='transform 180ms cubic-bezier(.25,.8,.25,1)';
          g.style.transform='translateY(0)';
        });
      });
      restripe();
    }

    function onMove(ev){
      if(!srcGrp)return;
      srcGrp.style.pointerEvents='none';
      const target=document.elementFromPoint(ev.clientX,ev.clientY);
      srcGrp.style.pointerEvents='';
      if(!target)return;
      const overRow=target.closest('.pta-taskrow');
      if(!overRow||!body.contains(overRow))return;
      const overId=+overRow.dataset.id;
      if(!overId||overId===srcId)return;
      let overGrp=overRow;
      while(overGrp&&!overGrp.classList.contains('pta-group'))overGrp=overGrp.parentElement;
      if(!overGrp||overGrp===srcGrp)return;
      const r=overRow.getBoundingClientRect();
      const after=ev.clientY>r.top+r.height*0.5;
      const key=overId+'_'+(after?'a':'b');
      if(key===lastOverKey)return;
      lastOverKey=key;
      swapInStore(srcId,overId,after);
      animatedSwap(overGrp,after);
    }

    function onUp(){
      document.removeEventListener('mousemove',onMove);
      document.removeEventListener('mouseup',onUp);
      document.body.style.userSelect='';
      document.body.style.cursor='';
      srcGrp?.querySelector('.pta-taskrow')?.classList.remove('dragging');
      srcId=null;srcGrp=null;lastOverKey=null;
    }

    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  };

  (()=>{
    const wrap=q('ptaShwrap');let drag=false,sx=0,sl=0;
    wrap.addEventListener('mousedown',e=>{drag=true;wrap.classList.add('drag');sx=e.pageX;sl=wrap.scrollLeft;});
    document.addEventListener('mouseup',()=>{drag=false;wrap.classList.remove('drag');});
    document.addEventListener('mousemove',e=>{if(!drag)return;wrap.scrollLeft=sl-(e.pageX-sx);syncLS();});
    wrap.addEventListener('scroll',syncLS);
    function syncLS(){host.querySelectorAll('.pta-rs').forEach(r=>r.scrollLeft=wrap.scrollLeft);}
  })();

  let kMode='state',kExp=new Set();
  const STATE_COLS=[{id:'overdue',label:'Overdue',dot:'oklch(.72 .14 20)'},{id:'inprogress',label:'Active',dot:'oklch(.65 .12 260)'},{id:'soon',label:'Soon',dot:'oklch(.82 .14 60)'},{id:'later',label:'Later',dot:'var(--text-3)'},{id:'done',label:'Done',dot:'oklch(.72 .14 150)'}];

  host.querySelectorAll('[data-km]').forEach(btn=>{btn.onclick=()=>{host.querySelectorAll('[data-km]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');kMode=btn.dataset.km;renderKanban();};});

  function renderKanban(){
    const board=q('ptaBoard');const sq=q('ptaSearch').value.toLowerCase();
    const tasks=P.getTasks().filter(t=>!sq||[t.title,t.project,t.tags,t.category].some(v=>(v||'').toLowerCase().includes(sq)));
    let cols;
    if(kMode==='state'){cols=STATE_COLS;}
    else{const cats=new Set();tasks.forEach(t=>t.category?cats.add(t.category):null);cols=[...[...cats].map(c=>({id:c,label:c,dot:'oklch(.72 .14 290)'})),{id:'_none',label:'Uncategorized',dot:'var(--text-3)'}];}
    board.innerHTML='';
    cols.forEach(col=>{
      const colTasks=tasks.filter(t=>(kMode==='state'?P.derived(t).label:t.category||'_none')===col.id);
      const el=document.createElement('div');el.className='pta-kcol';
      let h=`<div class="pta-kcolhead"><div class="pta-kdot" style="background:${col.dot}"></div><div class="pta-kcoltitle">${col.label}</div><div class="pta-kcolct">${colTasks.length}</div></div><div class="pta-kcolbody">`;
      if(!colTasks.length)h+=`<div class="pta-kempty"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6"/></svg><p>No tasks</p></div>`;
      else colTasks.forEach(t=>h+=kCardHTML(t));
      h+=`</div>`;el.innerHTML=h;board.appendChild(el);
    });
    kBind();
  }

  function kCardHTML(t){
    const d=P.derived(t);const hasSubs=t.subtasks&&t.subtasks.length;const isExp=kExp.has(t.id);
    const done=hasSubs?t.subtasks.filter(s=>s.completed).length:0;
    const pct=hasSubs?Math.round(done/t.subtasks.length*100):0;
    let meta=`<span class="pta-sp ${P.sCls(d.label,d.isUrgent)}">${P.sTxt(d.label,d.isUrgent)}</span>`;
    if(t.importance)meta+=`<span class="pta-ib ${impCls(t.importance)}">${t.importance}</span>`;
    if(t.project)meta+=`<span class="pta-mtag">${t.project}</span>`;
    const ds=t.dueDate?new Date(t.dueDate+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):null;
    return `<div class="pta-kcard" data-id="${t.id}" style="border-left-color:${t.color}">
      <div class="pta-kcard-top">
        <input type="checkbox" class="pta-cb pta-ktchk" data-id="${t.id}" ${t.completed?'checked':''} style="margin-top:2px">
        <div class="pta-kcard-body">
          <div class="pta-ktrow">
            ${hasSubs?`<button class="pta-kexpbtn${isExp?' open':''}" data-id="${t.id}"><svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></button>`:'<span style="width:14px"></span>'}
            <span class="pta-kti">${t.icon}</span>
            <span class="pta-ktn${t.completed?' done':''}"><span class=\"pta-ktn-inner\">${t.title}</span></span>
          </div>
          <div class="pta-kmeta">${meta}</div>
          ${ds?`<div class="pta-kdate"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${ds}</div>`:''}
        </div>
      </div>
      ${hasSubs?`<div class="pta-kfoot"><div class="pta-progbar"><div class="pta-progfill" style="width:${pct}%"></div></div><span class="pta-proglbl">${done}/${t.subtasks.length}</span></div>`:''}
    </div>`;
  }

  function kBind(){
    host.querySelectorAll('.pta-ktchk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();P.toggleTask(+cb.dataset.id);});
    host.querySelectorAll('.pta-kschk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();P.toggleSub(+cb.dataset.parent,+cb.dataset.idx);});
    host.querySelectorAll('.pta-kexpbtn').forEach(btn=>btn.onclick=e=>{
      e.stopPropagation();
      const id=+btn.dataset.id;
      const card=btn.closest('.pta-kcard');if(!card)return;
      let subs=card.querySelector('.pta-ksubs');
      if(kExp.has(id)){
        subs.style.height=subs.scrollHeight+'px';subs.offsetHeight;
        subs.style.height='0px';
        subs.addEventListener('transitionend',()=>{subs.style.display='none';subs.style.height='';},{once:true});
        kExp.delete(id);btn.classList.remove('open');
      } else {
        if(!subs){
          const t=P.getTasks().find(t=>t.id===id);if(!t||!t.subtasks)return;
          subs=document.createElement('div');subs.className='pta-ksubs';
          let sh='';t.subtasks.forEach((s,i)=>{const sd=P.subDerived(s);sh+=`<div class="pta-ksubrow"><input type="checkbox" class="pta-cb pta-kschk" data-parent="${t.id}" data-idx="${i}" ${s.completed?'checked':''}><span class="pta-ksubnm${s.completed?' done':''}">${s.title}</span><span class="pta-sp ${P.sCls(sd.label,sd.isUrgent)}">${P.sTxt(sd.label,sd.isUrgent)}</span></div>`;});
          subs.innerHTML=sh;card.appendChild(subs);
          subs.querySelectorAll('.pta-kschk').forEach(cb=>cb.onclick=ev=>{ev.stopPropagation();P.toggleSub(+cb.dataset.parent,+cb.dataset.idx);});
        } else {
          subs.style.display='block';
        }
        subs.style.height='0px';subs.offsetHeight;
        subs.style.height=subs.scrollHeight+'px';
        subs.addEventListener('transitionend',()=>{subs.style.height='auto';},{once:true});
        kExp.add(id);btn.classList.add('open');
      }
    });
    host.querySelectorAll('.pta-kcard').forEach(card=>card.onclick=e=>{if(e.target.classList.contains('pta-cb')||e.target.closest('.pta-kexpbtn'))return;const t=P.getTasks().find(t=>t.id===+card.dataset.id);if(t)openModal(t);});
  }

  const TL_START=new Date('2026-01-01');TL_START.setHours(0,0,0,0);
  const TOTAL_DAYS=120;const DAY_W=96;
  const tlToday=new Date();tlToday.setHours(0,0,0,0);
  const todayOff=Math.floor((tlToday-TL_START)/864e5);
  let tlTX=0,tlDragging=false,tlDragX=0;

  function dateOff(ds){if(!ds)return null;return Math.floor((new Date(ds+'T00:00:00')-TL_START)/864e5);}

  function darken(hex,p){const n=parseInt(hex.replace('#',''),16);const r=Math.max(0,Math.floor((n>>16)*(1-p)));const g=Math.max(0,Math.floor(((n>>8)&0xff)*(1-p)));const b=Math.max(0,Math.floor((n&0xff)*(1-p)));return'#'+((r<<16)|(g<<8)|b).toString(16).padStart(6,'0');}

  function renderDaysHead(){
    const head=q('ptaDaysHead');head.innerHTML='';
    head.style.cssText='position:absolute;top:0;left:0;height:100%;user-select:none;';
    head.style.width=(TOTAL_DAYS*DAY_W)+'px';
    for(let i=0;i<TOTAL_DAYS;i++){
      const d=new Date(TL_START);d.setDate(d.getDate()+i);
      const isT=i===todayOff;
      const col=document.createElement('div');
      col.style.cssText=`position:absolute;left:${i*DAY_W}px;top:0;width:${DAY_W}px;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;border-right:1px solid var(--border-subtle);box-sizing:border-box;background:${isT?'oklch(.22 .06 290 / .4)':'var(--surface-2)'}`;
      const yr=document.createElement('div');yr.style.cssText='font-size:10px;color:var(--text-3)';yr.textContent=d.getFullYear();
      const dt=document.createElement('div');dt.style.cssText=`font-size:11px;font-weight:500;color:${isT?'oklch(.82 .14 290)':'var(--text-2)'}`;
      dt.textContent=d.toLocaleDateString('en-US',{month:'short',day:'2-digit'});
      col.appendChild(yr);col.appendChild(dt);head.appendChild(col);
    }
  }

  function renderTasks(){
    const body=q('ptaTlbody');body.innerHTML='';
    const sq=q('ptaSearch').value.toLowerCase();
    const tasks=P.getTasks().filter(t=>!sq||[t.title,t.project].some(v=>(v||'').toLowerCase().includes(sq)));
    const ROW_H=52,SUB_H=42;
    tasks.forEach(task=>{
      const d=P.derived(task);const hasSubs=task.subtasks&&task.subtasks.length;const numSubs=hasSubs?task.subtasks.length:0;
      const startOff=dateOff(task.startDate),dueOff=dateOff(task.dueDate);
      const row=document.createElement('div');row.className='pta-tl-row';
      const totalH=ROW_H+numSubs*SUB_H;row.style.height=totalH+'px';

      const label=document.createElement('div');label.className='pta-tl-lbl';
      const tRow=document.createElement('div');tRow.className='pta-tl-taskrow';tRow.style.borderLeftColor=task.color;tRow.dataset.drag=task.id;
      tRow.innerHTML=`<span class="pta-drag"><svg viewBox="0 0 24 24" width="12" height="12"><use href="#drag-dots"/></svg></span><input type="checkbox" class="pta-cb pta-tltchk" data-id="${task.id}" ${task.completed?'checked':''}><span style="font-size:13px;flex-shrink:0">${task.icon}</span><span class="pta-tlnm${task.completed?' done':''}"><span class=\"pta-tlnm-inner\">${task.title}</span></span><span class="pta-sp ${P.sCls(d.label,d.isUrgent)}">${P.sTxt(d.label,d.isUrgent)}</span>${task.importance?`<span class="pta-ib ${impCls(task.importance)}">${task.importance}</span>`:''} ${task.project?`<span class="pta-mtag">${task.project}</span>`:''}`;
      tRow.querySelector('.pta-tltchk').onclick=e=>{e.stopPropagation();P.toggleTask(task.id);};
      tRow.onclick=e=>{if(e.target.classList.contains('pta-cb')||e.target.closest('.pta-drag'))return;openModal(task);};
      tRow.querySelector('.pta-drag').onmousedown=e=>{
        if(e.button!==0)return;
        e.preventDefault();e.stopPropagation();
        const tlBody=q('ptaTlbody');
        let srcRow=row,srcId=task.id;
        srcRow.classList.add('dragging');
        document.body.style.userSelect='none';
        document.body.style.cursor='grabbing';
        function swapStore(fromId,toId,after){
          const arr=P.getTasks();
          const fi=arr.findIndex(t=>t.id===fromId),ti=arr.findIndex(t=>t.id===toId);
          if(fi<0||ti<0||fi===ti)return;
          const [item]=arr.splice(fi,1);
          const ni=arr.findIndex(t=>t.id===toId);
          arr.splice(after?ni+1:ni,0,item);
          lSort=null;
        }
        let lastOverId=null;
        function animatedSwap(targetRow,after){
          const rows=[...tlBody.querySelectorAll('.pta-tl-row')];
          const before=new Map();
          rows.forEach(r=>before.set(r,r.getBoundingClientRect().top));
          if(after)targetRow.after(srcRow);else targetRow.before(srcRow);
          rows.forEach(r=>{
            const dy=before.get(r)-r.getBoundingClientRect().top;
            if(Math.abs(dy)<1)return;
            r.style.transition='none';
            r.style.transform=`translateY(${dy}px)`;
            requestAnimationFrame(()=>{
              r.style.transition='transform 180ms cubic-bezier(.25,.8,.25,1)';
              r.style.transform='translateY(0)';
            });
          });
          syncTL();
        }
        function onMove(ev){
          const rows=[...tlBody.querySelectorAll('.pta-tl-row')];
          let overRow=null;
          for(const r of rows){
            if(r===srcRow)continue;
            const rect=r.getBoundingClientRect();
            if(ev.clientY>=rect.top&&ev.clientY<rect.bottom){overRow=r;break;}
          }
          if(!overRow)return;
          const rect=overRow.getBoundingClientRect();
          const after=ev.clientY>rect.top+rect.height*0.5;
          const overId=+overRow.querySelector('.pta-tl-taskrow')?.dataset.drag||0;
          if(!overId||overId===srcId)return;
          const key=overId+'_'+(after?'a':'b');
          if(key===lastOverId)return;
          lastOverId=key;
          swapStore(srcId,overId,after);
          animatedSwap(overRow,after);
        }
        function onUp(){
          document.removeEventListener('mousemove',onMove);
          document.removeEventListener('mouseup',onUp);
          document.body.style.userSelect='';
          document.body.style.cursor='';
          srcRow.classList.remove('dragging');
        }
        document.addEventListener('mousemove',onMove);
        document.addEventListener('mouseup',onUp);
      };
      label.appendChild(tRow);
      if(hasSubs)task.subtasks.forEach((sub,idx)=>{
        const sd=P.subDerived(sub);const sRow=document.createElement('div');sRow.className='pta-tl-subrow';sRow.style.borderLeftColor=task.color;
        sRow.innerHTML=`<input type="checkbox" class="pta-cb pta-tlschk" data-parent="${task.id}" data-idx="${idx}" ${sub.completed?'checked':''}><span class="pta-tlsubnm${sub.completed?' done':''}">${sub.title}</span><span class="pta-sp ${P.sCls(sd.label,sd.isUrgent)}">${P.sTxt(sd.label,sd.isUrgent)}</span>`;
        sRow.querySelector('.pta-tlschk').onclick=e=>{e.stopPropagation();P.toggleSub(task.id,idx);};
        sRow.onclick=e=>{if(e.target.classList.contains('pta-cb'))return;openModal(task);requestAnimationFrame(()=>{switchMTab('subtasks');openSubModal(idx);});};
        label.appendChild(sRow);
      });

      const grid=document.createElement('div');grid.className='pta-tl-grid';grid.style.minHeight=totalH+'px';
      const inner=document.createElement('div');inner.className='pta-tl-inner';inner.style.cssText=`width:${TOTAL_DAYS*DAY_W}px;height:${totalH}px;`;

      const bg=document.createElement('div');bg.className='pta-grid-bg';bg.style.cssText=`width:${TOTAL_DAYS*DAY_W}px;height:${totalH}px`;
      for(let i=0;i<TOTAL_DAYS;i++){const dc=document.createElement('div');dc.className='pta-grid-day'+(i===todayOff?' today':'');dc.style.width=DAY_W+'px';bg.appendChild(dc);}
      inner.appendChild(bg);

      if(startOff!==null&&dueOff!==null&&startOff<TOTAL_DAYS&&dueOff>=0){
        const s=Math.max(0,startOff),e=Math.min(TOTAL_DAYS-1,dueOff);
        const bw=(e-s+1)*DAY_W-8;
        if(bw>0){const bar=document.createElement('div');bar.className='pta-tl-bar'+(task.completed?' done':'');bar.style.cssText=`left:${s*DAY_W+4}px;width:${bw}px;top:4px;height:${ROW_H-8}px;background:${task.color}`;bar.onclick=()=>openModal(task);inner.appendChild(bar);}
      }

      if(hasSubs&&startOff!==null&&dueOff!==null){
        const ps=Math.max(0,startOff),pe=Math.min(TOTAL_DAYS-1,dueOff);
        const pw=(pe-ps+1)*DAY_W-8;
        if(pw>0){const panel=document.createElement('div');panel.style.cssText=`position:absolute;left:${ps*DAY_W+4}px;width:${pw}px;top:4px;height:${ROW_H-8+numSubs*SUB_H}px;background:${darken(task.color,0.72)};border-radius:4px;pointer-events:none;z-index:1`;inner.appendChild(panel);}
        task.subtasks.forEach((sub,idx)=>{
          const sOff=dateOff(sub.startDate)??startOff,dOff=dateOff(sub.dueDate);if(dOff===null)return;
          const s=Math.max(0,sOff),e=Math.min(TOTAL_DAYS-1,dOff);const bw=(e-s+1)*DAY_W-16;if(bw<=0)return;
          const bar=document.createElement('div');bar.className='pta-tl-sbar'+(sub.completed?' done':'');
          bar.style.cssText=`left:${s*DAY_W+8}px;width:${bw}px;top:${ROW_H+idx*SUB_H+7}px;height:26px;background:${task.color};z-index:2`;
          bar.onclick=()=>openModal(task);inner.appendChild(bar);
        });
      }

      if(todayOff>=0&&todayOff<TOTAL_DAYS){const ov=document.createElement('div');ov.style.cssText=`position:absolute;top:0;left:${todayOff*DAY_W}px;width:${DAY_W}px;height:100%;background:oklch(.55 .18 290 / .08);pointer-events:none;z-index:3`;inner.appendChild(ov);}

      grid.appendChild(inner);row.appendChild(label);row.appendChild(grid);body.appendChild(row);

      body.querySelectorAll('.pta-tltchk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();P.toggleTask(+cb.dataset.id);});
      body.querySelectorAll('.pta-tlschk').forEach(cb=>cb.onclick=e=>{e.stopPropagation();P.toggleSub(+cb.dataset.parent,+cb.dataset.idx);});
    });
    syncTL();
  }

  function syncTL(){
    const ww=q('ptaDaysWrap')?.offsetWidth||800;
    const totalW=TOTAL_DAYS*DAY_W;
    tlTX=Math.max(-(totalW-ww),Math.min(0,tlTX));
    q('ptaDaysHead').style.transform=`translateX(${tlTX}px)`;
    host.querySelectorAll('.pta-tl-inner').forEach(inner=>inner.style.transform=`translateX(${tlTX}px)`);
  }

  function renderTL(){renderDaysHead();renderTasks();}

  function tlScrollToday(){const ww=q('ptaDaysWrap')?.offsetWidth||800;tlTX=-(todayOff*DAY_W-ww/2+DAY_W/2);syncTL();}

  const dh=q('ptaDaysHead');const tb=q('ptaTlbody');
  function tlStart(e){tlDragging=true;tlDragX=e.pageX;document.body.style.userSelect='none';}
  function tlEnd(){tlDragging=false;document.body.style.userSelect='';}
  dh.addEventListener('mousedown',tlStart);
  tb.addEventListener('mousedown',e=>{if(e.target.closest('.pta-tl-lbl'))return;tlStart(e);});
  document.addEventListener('mouseup',tlEnd);
  document.addEventListener('mousemove',e=>{if(!tlDragging)return;tlTX+=e.pageX-tlDragX;tlDragX=e.pageX;syncTL();});
  q('ptaGoToday').onclick=tlScrollToday;

  let _cur=null,_isNew=false,_subIdx=null;

  function switchMTab(tab){
    host.querySelectorAll('.pta-mtab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
    host.querySelectorAll('.pta-mtpanel').forEach(p=>p.classList.toggle('active',p.id==='ptaTab-'+tab));
  }

  host.querySelectorAll('.pta-mtab').forEach(tab=>tab.onclick=()=>switchMTab(tab.dataset.tab));

  q('ptaMColor').oninput=()=>q('ptaMDot').style.background=q('ptaMColor').value;
  q('ptaMIcon').oninput=()=>q('ptaMIconD').textContent=q('ptaMIcon').value||'📋';

  function closeMo(){q('ptaMo').classList.remove('open');_cur=null;}
  q('ptaMClose').onclick=closeMo;q('ptaMCancel').onclick=closeMo;
  q('ptaMo').onclick=e=>{if(e.target===q('ptaMo'))closeMo();};

  function genInsight(t){
    const d=P.derived(t);let msg='';
    if(d.label==='overdue')msg=`<strong>⚠ Overdue:</strong> ${Math.abs(d.daysUntilDue)} day${Math.abs(d.daysUntilDue)>1?'s':''} past due.`;
    else if(t.blockReason)msg=`<strong>🚫 Blocked:</strong> "${t.blockReason}"`;
    else if(t.dependencies)msg=`<strong>🔗 Depends on:</strong> [${t.dependencies}]`;
    else if(d.isUrgent&&t.importance==='critical')msg=`<strong>⚡ Critical & urgent</strong> — due ${d.daysUntilDue===0?'today':'tomorrow'}.`;
    else if(t.subtasks?.length){const dn=t.subtasks.filter(s=>s.completed).length;msg=`<strong>📊 Progress:</strong> ${dn}/${t.subtasks.length} subtasks (${Math.round(dn/t.subtasks.length*100)}%)`;}
    const el=q('ptaInsight');if(msg){q('ptaInsightTxt').innerHTML=msg;el.style.display='flex';}else el.style.display='none';
  }

  function renderSubList(){
    const list=q('ptaSubList');
    if(!_cur?.subtasks?.length){list.innerHTML='<p style="font-size:11px;color:var(--text-3)">No subtasks yet</p>';return;}
    list.innerHTML='';
    _cur.subtasks.forEach((s,i)=>{
      const row=document.createElement('div');row.className='pta-sub-item';
      row.innerHTML=`<input type="checkbox" style="accent-color:oklch(.55 .18 290);flex-shrink:0" ${s.completed?'checked':''}><span class="pta-sub-title${s.completed?' done':''}">${s.title||'Untitled'}</span><span class="pta-sub-date">${s.dueDate?fmtDate(s.dueDate):''}</span><button class="pta-sub-del"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
      row.querySelector('input').onchange=e=>{e.stopPropagation();s.completed=!s.completed;renderSubList();};
      row.querySelector('.pta-sub-del').onclick=e=>{e.stopPropagation();_cur.subtasks.splice(i,1);if(!_cur.subtasks.length)_cur.subtasks=null;renderSubList();};
      row.onclick=e=>{if(e.target.tagName==='INPUT'||e.target.closest('.pta-sub-del'))return;openSubModal(i);};
      list.appendChild(row);
    });
  }

  ['ptaSubT','ptaSubS','ptaSubD'].forEach(id=>q(id).oninput=()=>q('ptaAddSub').disabled=!q('ptaSubT').value.trim());
  q('ptaAddSub').onclick=()=>{
    const title=q('ptaSubT').value.trim();if(!title)return;
    if(!_cur.subtasks)_cur.subtasks=[];
    _cur.subtasks.push(P.mkSub({title,startDate:q('ptaSubS').value,dueDate:q('ptaSubD').value}));
    q('ptaSubT').value='';q('ptaSubS').value='';q('ptaSubD').value='';q('ptaAddSub').disabled=true;
    renderSubList();
  };

  function openModal(taskOrNull){
    _isNew=!taskOrNull||!P.getTasks().find(t=>t.id===taskOrNull?.id);
    if(_isNew){const t0=new Date().toISOString().split('T')[0],t1=new Date(Date.now()+864e5).toISOString().split('T')[0];_cur=P.mkTask(taskOrNull||{startDate:t0,dueDate:t1});}
    else _cur=taskOrNull;
    switchMTab('details');
    q('ptaMTitle').textContent=_isNew?'New Task':'Edit Task';
    q('ptaMFTitle').value=_cur.title;
    q('ptaMIcon').value=_cur.icon||'📋';q('ptaMIconD').textContent=_cur.icon||'📋';
    q('ptaMColor').value=_cur.color||'#8b5cf6';q('ptaMDot').style.background=_cur.color||'#8b5cf6';
    q('ptaMProject').value=_cur.project||'';q('ptaMCat').value=_cur.category||'';q('ptaMTags').value=_cur.tags||'';
    q('ptaMLink').value=_cur.projectLink||'';
    q('ptaMStart').value=_cur.startDate||'';q('ptaMDue').value=_cur.dueDate||'';q('ptaMDueTime').value=_cur.dueTime||'';
    q('ptaMEst').value=_cur.estimate||'';q('ptaMRec').value=_cur.recurrence||'';
    q('ptaMImp').value=_cur.importance||'';q('ptaMImpact').value=_cur.impactScore||'';
    q('ptaMEnergy').value=_cur.energyMode||'';q('ptaMFocus').checked=_cur.focusEligible;
    q('ptaMNotes').value=_cur.notes||'';q('ptaMDeps').value=_cur.dependencies||'';q('ptaMBlock').value=_cur.blockReason||'';
    q('ptaSubT').value='';q('ptaSubS').value='';q('ptaSubD').value='';q('ptaAddSub').disabled=true;
    renderSubList();genInsight(_cur);q('ptaMo').classList.add('open');
  }

  q('ptaMSave').onclick=()=>{
    if(!_cur)return;
    const u={title:q('ptaMFTitle').value.trim()||'Untitled',project:q('ptaMProject').value,icon:q('ptaMIcon').value||'📋',color:q('ptaMColor').value,category:q('ptaMCat').value,tags:q('ptaMTags').value,startDate:q('ptaMStart').value,dueDate:q('ptaMDue').value,dueTime:q('ptaMDueTime').value,estimate:parseFloat(q('ptaMEst').value)||0,recurrence:q('ptaMRec').value,projectLink:q('ptaMLink').value,importance:q('ptaMImp').value,impactScore:parseInt(q('ptaMImpact').value)||0,energyMode:q('ptaMEnergy').value,focusEligible:q('ptaMFocus').checked,notes:q('ptaMNotes').value,dependencies:q('ptaMDeps').value,blockReason:q('ptaMBlock').value,subtasks:_cur.subtasks};
    if(_isNew){Object.assign(_cur,u);P.addTask(_cur);}else P.updateTask(_cur.id,u);
    closeMo();
  };
  q('ptaMDel').onclick=()=>{if(!_cur||_isNew)return;if(!confirm('Delete this task?'))return;P.deleteTask(_cur.id);closeMo();};
  q('ptaMDup').onclick=()=>{if(!_cur)return;if(!_isNew)P.duplicateTask(_cur.id);closeMo();};

  function closeSubMo(){q('ptaSMo').classList.remove('open');_subIdx=null;}
  q('ptaSClose').onclick=closeSubMo;q('ptaSCancel').onclick=closeSubMo;
  q('ptaSMo').onclick=e=>{if(e.target===q('ptaSMo'))closeSubMo();};

  function openSubModal(idx){
    if(!_cur?.subtasks?.[idx])return;
    _subIdx=idx;const s=_cur.subtasks[idx];
    q('ptaSMDot').style.background=_cur.color||'#8b5cf6';
    q('ptaSFTitle').value=s.title||'';q('ptaSStart').value=s.startDate||'';q('ptaSDue').value=s.dueDate||'';
    q('ptaSImp').value=s.importance||'';q('ptaSImpact').value=s.impactScore||'';q('ptaSComp').checked=s.completed||false;
    q('ptaSMo').classList.add('open');
  }
  q('ptaSSave').onclick=()=>{
    if(_subIdx===null||!_cur?.subtasks)return;
    const s=_cur.subtasks[_subIdx];
    s.title=q('ptaSFTitle').value.trim()||'Untitled';s.startDate=q('ptaSStart').value;s.dueDate=q('ptaSDue').value;
    s.importance=q('ptaSImp').value;s.impactScore=parseInt(q('ptaSImpact').value)||0;s.completed=q('ptaSComp').checked;
    closeSubMo();renderSubList();
  };
  q('ptaSDelete').onclick=()=>{if(_subIdx===null||!_cur?.subtasks)return;_cur.subtasks.splice(_subIdx,1);if(!_cur.subtasks.length)_cur.subtasks=null;closeSubMo();renderSubList();};

  if(host._ptaKey)document.removeEventListener('keydown',host._ptaKey);
  host._ptaKey=e=>{if(e.key==='Escape'){closeMo();closeSubMo();}};
  document.addEventListener('keydown',host._ptaKey);

  P.subscribe((()=>{
    let raf=null;
    return ()=>{if(raf)return;raf=requestAnimationFrame(()=>{raf=null;renderList();renderKanban();renderTL();updateMetrics();});};
  })());
  renderList();renderKanban();renderTL();
  updateMetrics();
  setTimeout(()=>tlScrollToday(),80);
  } // end initApp
}

</script>
</body>
</html>