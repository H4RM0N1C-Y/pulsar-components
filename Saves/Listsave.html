<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulsar Task Tracker</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d0d0f; color: #e8e8ec; overflow: hidden; }
#app { display: flex; flex-direction: column; height: 100vh; padding: 20px; }
.title-section { margin-bottom: 20px; }
.title-section h1 { font-size: 28px; font-weight: 600; color: #e8e8ec; cursor: text; padding: 8px; border-radius: 6px; transition: background 0.2s; }
.title-section h1:hover { background: #1a1a20; }
.title-section h1[contenteditable="true"] { outline: 2px solid #4a9eff; background: #1a1a20; }
.controls { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
.btn { padding: 8px 16px; background: #1a1a20; border: 1px solid #2a2a30; border-radius: 6px; color: #e8e8ec; cursor: pointer; font-size: 13px; transition: all 0.2s; }
.btn:hover { background: #252530; border-color: #4a9eff; }
.btn:active { transform: scale(0.98); }
.btn.primary { background: #4a9eff; color: #fff; border-color: #4a9eff; }
.btn.primary:hover { background: #3a8eef; }
.btn.danger { background: #ff4a4a; color: #fff; border-color: #ff4a4a; }
.btn.danger:hover { background: #ef3a3a; }

.task-container { flex: 1; overflow: hidden; display: flex; flex-direction: column; background: #141418; border-radius: 8px; }
.grid-header { display: grid; grid-template-columns: 40px 280px 120px 80px 80px 80px 90px 100px 80px 100px 120px 150px; gap: 0; background: #1a1a20; border-bottom: 2px solid #2a2a30; padding: 12px 0; font-size: 12px; font-weight: 600; color: #9090a0; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
.grid-header > div { padding: 0 12px; border-right: 1px solid #2a2a30; display: flex; align-items: center; }
.grid-header > div:last-child { border-right: none; }

.task-list { flex: 1; overflow-y: auto; overflow-x: auto; }
.task-list::-webkit-scrollbar { width: 8px; height: 8px; }
.task-list::-webkit-scrollbar-track { background: #1a1a20; }
.task-list::-webkit-scrollbar-thumb { background: #2a2a30; border-radius: 4px; }
.task-list::-webkit-scrollbar-thumb:hover { background: #3a3a40; }

.task-row { display: grid; grid-template-columns: 40px 280px 120px 80px 80px 80px 90px 100px 80px 100px 120px 150px; gap: 0; background: #1a1a20; border-bottom: 1px solid #2a2a30; padding: 0; min-height: 48px; cursor: pointer; transition: background 0.15s; position: relative; }
.task-row:hover { background: #252530; }
.task-row.selected { background: #1e2a3a; outline: 2px solid #4a9eff; }
.task-row.expanded { background: #252530; }
.task-row.dragging { opacity: 0.5; }
.task-row.drag-over { border-top: 3px solid #4a9eff; }

.task-cell { padding: 12px; border-right: 1px solid #2a2a30; display: flex; align-items: center; font-size: 13px; color: #e8e8ec; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.task-cell:last-child { border-right: none; }
.task-cell.chevron-cell { justify-content: center; cursor: pointer; }

.task-chevron { width: 16px; height: 16px; transition: transform 0.2s; color: #9090a0; }
.task-chevron.expanded { transform: rotate(90deg); }

.task-title-cell { cursor: text; font-weight: 500; }
.task-title-cell:hover { background: rgba(74, 158, 255, 0.1); }
.task-title-cell[contenteditable="true"] { outline: 2px solid #4a9eff; background: #1a1a20; }

.task-cell.editable { cursor: text; }
.task-cell.editable:hover { background: rgba(74, 158, 255, 0.05); }
.task-cell.editable[contenteditable="true"] { outline: 1px solid #4a9eff; background: #1a1a20; }

.task-cell.state-cell { cursor: pointer; font-weight: 500; justify-content: center; }
.task-cell.state-cell.todo { color: #9090a0; }
.task-cell.state-cell.in-progress { color: #4a9eff; }
.task-cell.state-cell.done { color: #4ade80; }
.task-cell.state-cell.blocked { color: #ff4a4a; }

.task-cell.importance-high { color: #ff4a4a; font-weight: 600; }
.task-cell.importance-medium { color: #ffa500; font-weight: 600; }
.task-cell.importance-low { color: #4a9eff; font-weight: 600; }

.task-cell.urgency-high { animation: pulse 2s infinite; color: #ff4a4a; font-weight: 600; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

.badge { display: inline-block; padding: 2px 6px; background: #2a2a30; border-radius: 10px; font-size: 10px; margin-left: 4px; white-space: nowrap; }
.badge.focus { background: #4a9eff; color: #fff; }
.badge.impact-high { background: #ff4a4a; color: #fff; }
.badge.impact-medium { background: #ffa500; color: #fff; }

.expanded-content { grid-column: 1 / -1; background: #1a1a20; border-top: 1px solid #2a2a30; padding: 20px; display: none; }
.task-row.expanded .expanded-content { display: block; }

.expanded-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
.expanded-section { margin-bottom: 16px; }
.expanded-section h4 { font-size: 13px; color: #9090a0; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.notes-area { width: 100%; min-height: 120px; padding: 12px; background: #141418; border: 1px solid #2a2a30; border-radius: 6px; color: #e8e8ec; font-size: 13px; resize: vertical; font-family: inherit; line-height: 1.5; }
.notes-area:focus { outline: 2px solid #4a9eff; border-color: #4a9eff; }

.metadata-grid { display: grid; grid-template-columns: 120px 1fr; gap: 8px; font-size: 12px; }
.metadata-label { color: #9090a0; }
.metadata-value { color: #e8e8ec; }
.tag { display: inline-block; padding: 4px 10px; background: #2a2a30; border-radius: 12px; font-size: 11px; margin-right: 6px; margin-bottom: 4px; color: #e8e8ec; }

.attachment-list { list-style: none; }
.attachment-item { padding: 8px 12px; background: #141418; border-radius: 4px; margin-bottom: 6px; font-size: 12px; color: #4a9eff; cursor: pointer; transition: background 0.2s; }
.attachment-item:hover { background: #1a1a20; }

.subtasks-section { grid-column: 1 / -1; }
.subtask-item { background: #141418; padding: 10px 14px; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
.subtask-item:hover { background: #1a1a20; }
.subtask-item.done { opacity: 0.6; }
.subtask-checkbox { width: 18px; height: 18px; border: 2px solid #4a9eff; border-radius: 4px; cursor: pointer; position: relative; flex-shrink: 0; }
.subtask-checkbox.checked::after { content: '‚úì'; position: absolute; top: -3px; left: 2px; color: #4a9eff; font-size: 14px; font-weight: bold; }
.subtask-title { flex: 1; font-size: 13px; color: #e8e8ec; }
.subtask-item.done .subtask-title { text-decoration: line-through; }

.ai-insights { margin-top: 16px; padding: 14px; background: #141418; border-left: 4px solid #4a9eff; border-radius: 6px; font-size: 12px; color: #9090a0; line-height: 1.6; }
.ai-insights strong { color: #4a9eff; }

.actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; border-top: 1px solid #2a2a30; padding-top: 16px; }

.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
.modal.active { display: flex; }
.modal-content { background: #1a1a20; border-radius: 10px; max-width: 600px; width: 90%; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
.modal-header { padding: 24px 24px 16px; border-bottom: 1px solid #2a2a30; display: flex; justify-content: space-between; align-items: center; }
.modal-header h3 { color: #e8e8ec; font-size: 20px; font-weight: 600; }
.modal-close { width: 32px; height: 32px; border: none; background: transparent; color: #9090a0; font-size: 24px; cursor: pointer; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.modal-close:hover { background: #252530; color: #e8e8ec; }
.modal-body { padding: 24px; overflow-y: auto; flex: 1; }
.modal-body::-webkit-scrollbar { width: 8px; }
.modal-body::-webkit-scrollbar-track { background: #141418; border-radius: 4px; }
.modal-body::-webkit-scrollbar-thumb { background: #2a2a30; border-radius: 4px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; color: #9090a0; font-size: 13px; font-weight: 500; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; background: #141418; border: 1px solid #2a2a30; border-radius: 6px; color: #e8e8ec; font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #4a9eff; }
.modal-footer { padding: 16px 24px; border-top: 1px solid #2a2a30; display: flex; gap: 12px; justify-content: flex-end; }
</style>
</head>
<body>
<div id="app">
  <div class="title-section">
    <h1 contenteditable="true" id="listTitle">My Task List</h1>
  </div>
  <div class="controls">
    <button class="btn primary" onclick="app.openNewTaskModal()">+ New Task</button>
    <button class="btn" onclick="app.sortTasks('dueDate')">Sort by Due Date</button>
    <button class="btn" onclick="app.sortTasks('importance')">Sort by Importance</button>
    <button class="btn" onclick="app.sortTasks('urgency')">Sort by Urgency</button>
    <button class="btn" onclick="app.filterFocusEligible()">Show Focus Tasks</button>
    <button class="btn" onclick="app.resetFilter()">Show All</button>
  </div>
  <div class="task-container">
    <div class="grid-header">
      <div></div>
      <div>Title</div>
      <div>Project</div>
      <div>Due Date</div>
      <div>Due Time</div>
      <div>Start Date</div>
      <div>Time Est.</div>
      <div>Importance</div>
      <div>Urgency</div>
      <div>Impact</div>
      <div>State</div>
      <div>Completed</div>
      <div>Block Reason</div>
    </div>
    <div class="task-list" id="taskList"></div>
  </div>
</div>

<div class="modal" id="taskModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">New Task</h3>
      <button class="modal-close" onclick="app.closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Title *</label>
        <input type="text" id="modalTaskTitle" placeholder="Task title">
      </div>
      <div class="form-group">
        <label>Project</label>
        <input type="text" id="modalProject" placeholder="Project name">
      </div>
      <div class="form-group">
        <label>Due Date</label>
        <input type="date" id="modalDueDate">
      </div>
      <div class="form-group">
        <label>Due Time</label>
        <input type="time" id="modalDueTime">
      </div>
      <div class="form-group">
        <label>Start Date</label>
        <input type="date" id="modalStartDate">
      </div>
      <div class="form-group">
        <label>Time Estimate (hours)</label>
        <input type="number" id="modalTimeEstimate" min="0" step="0.5" placeholder="0">
      </div>
      <div class="form-group">
        <label>Importance</label>
        <select id="modalImportance">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>
      <div class="form-group">
        <label>Tags (comma-separated)</label>
        <input type="text" id="modalTags" placeholder="work, urgent, review">
      </div>
      <div class="form-group">
        <label>Category</label>
        <input type="text" id="modalCategory" placeholder="Development, Design, etc.">
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="modalNotes" rows="4" placeholder="Additional notes..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="app.closeModal()">Cancel</button>
      <button class="btn primary" onclick="app.saveTask()">Save Task</button>
    </div>
  </div>
</div>

<script>
const app = {
  tasks: [],
  allTasks: [],
  selectedTaskId: null,
  draggedTaskId: null,
  
  init() {
    this.loadSampleData();
    this.allTasks = [...this.tasks];
    this.render();
    this.setupKeyboard();
    this.setupModalKeyboard();
  },
  
  loadSampleData() {
    this.tasks = [
      {
        id: '1', title: 'Implement authentication system', project: 'Pulsar Core', dueDate: '2026-01-20', dueTime: '17:00',
        startDate: '2026-01-15', timeEstimate: 8, importance: 'high', state: 'in-progress', tags: ['backend', 'security'],
        category: 'Development', notes: 'Need to integrate OAuth2 and JWT tokens. Consider multi-factor authentication.',
        attachments: ['auth-spec.pdf', 'security-checklist.md'], linkedDocs: ['API Design Doc'],
        createdAt: '2026-01-10T10:00:00Z', lastModified: '2026-01-15T14:30:00Z', parentTask: null,
        blockReason: '', completedAt: null, recurrence: null, subtasks: [
          { id: 's1', title: 'Set up OAuth2 provider', done: true },
          { id: 's2', title: 'Implement JWT middleware', done: false },
          { id: 's3', title: 'Add password hashing', done: true }
        ]
      },
      {
        id: '2', title: 'Design dashboard layout', project: 'Pulsar UI', dueDate: '2026-01-18', dueTime: '12:00',
        startDate: '2026-01-14', timeEstimate: 4, importance: 'high', state: 'todo', tags: ['design', 'ui'],
        category: 'Design', notes: 'Focus on data visualization and user-friendly navigation. Dark mode priority.',
        attachments: ['mockup-v1.fig'], linkedDocs: [], createdAt: '2026-01-12T09:00:00Z',
        lastModified: '2026-01-14T16:00:00Z', parentTask: null, blockReason: '', completedAt: null,
        recurrence: null, subtasks: []
      },
      {
        id: '3', title: 'Write API documentation', project: 'Pulsar Core', dueDate: '2026-01-22', dueTime: '15:00',
        startDate: '2026-01-16', timeEstimate: 6, importance: 'medium', state: 'todo', tags: ['docs', 'api'],
        category: 'Documentation', notes: 'Include examples for all endpoints. Use OpenAPI spec.',
        attachments: [], linkedDocs: ['API Reference'], createdAt: '2026-01-11T11:00:00Z',
        lastModified: '2026-01-14T10:00:00Z', parentTask: null, blockReason: '', completedAt: null,
        recurrence: null, subtasks: []
      },
      {
        id: '4', title: 'Fix mobile responsive issues', project: 'Pulsar UI', dueDate: '2026-01-17', dueTime: '18:00',
        startDate: '2026-01-15', timeEstimate: 3, importance: 'high', state: 'blocked', tags: ['bug', 'mobile'],
        category: 'Development', notes: 'Multiple layout breaks on iOS Safari. Needs design review first.',
        attachments: [], linkedDocs: [], createdAt: '2026-01-13T08:00:00Z', lastModified: '2026-01-15T12:00:00Z',
        parentTask: null, blockReason: 'Waiting for design approval', completedAt: null, recurrence: null,
        subtasks: []
      },
      {
        id: '5', title: 'Optimize database queries', project: 'Pulsar Core', dueDate: '2026-01-25', dueTime: '16:00',
        startDate: '2026-01-18', timeEstimate: 5, importance: 'medium', state: 'todo', tags: ['performance', 'backend'],
        category: 'Development', notes: 'Focus on task list and analytics queries. Add indexes where needed.',
        attachments: ['query-analysis.xlsx'], linkedDocs: [], createdAt: '2026-01-12T13:00:00Z',
        lastModified: '2026-01-14T09:00:00Z', parentTask: null, blockReason: '', completedAt: null,
        recurrence: null, subtasks: []
      },
      {
        id: '6', title: 'Conduct user testing', project: 'Pulsar UI', dueDate: '2026-01-30', dueTime: '14:00',
        startDate: '2026-01-20', timeEstimate: 8, importance: 'low', state: 'todo', tags: ['research', 'ux'],
        category: 'Research', notes: 'Schedule 5 user interviews. Prepare testing script and metrics.',
        attachments: [], linkedDocs: ['UX Research Plan'], createdAt: '2026-01-10T15:00:00Z',
        lastModified: '2026-01-13T11:00:00Z', parentTask: null, blockReason: '', completedAt: null,
        recurrence: null, subtasks: []
      },
      {
        id: '7', title: 'Review pull requests', project: 'Pulsar Core', dueDate: '2026-01-16', dueTime: '10:00',
        startDate: '2026-01-15', timeEstimate: 2, importance: 'medium', state: 'in-progress', tags: ['review', 'code'],
        category: 'Development', notes: 'Focus on authentication and API modules first.',
        attachments: [], linkedDocs: [], createdAt: '2026-01-15T08:00:00Z', lastModified: '2026-01-15T13:00:00Z',
        parentTask: null, blockReason: '', completedAt: null, recurrence: null, subtasks: []
      },
      {
        id: '8', title: 'Update deployment pipeline', project: 'DevOps', dueDate: '2026-01-28', dueTime: '17:00',
        startDate: '2026-01-22', timeEstimate: 6, importance: 'low', state: 'todo', tags: ['devops', 'ci-cd'],
        category: 'Infrastructure', notes: 'Add staging environment and automated testing steps.',
        attachments: ['pipeline-diagram.png'], linkedDocs: [], createdAt: '2026-01-14T12:00:00Z',
        lastModified: '2026-01-14T18:00:00Z', parentTask: null, blockReason: '', completedAt: null,
        recurrence: null, subtasks: []
      },
      {
        id: '9', title: 'Team standup meeting', project: 'Team', dueDate: '2026-01-16', dueTime: '09:00',
        startDate: '2026-01-16', timeEstimate: 0.5, importance: 'medium', state: 'done', tags: ['meeting'],
        category: 'Team', notes: 'Daily standup - discuss blockers and progress.',
        attachments: [], linkedDocs: [], createdAt: '2026-01-15T18:00:00Z', lastModified: '2026-01-16T09:30:00Z',
        parentTask: null, blockReason: '', completedAt: '2026-01-16T09:30:00Z', recurrence: 'daily',
        subtasks: []
      },
      {
        id: '10', title: 'Refactor task manager module', project: 'Pulsar Core', dueDate: '2026-02-05', dueTime: '16:00',
        startDate: '2026-01-25', timeEstimate: 12, importance: 'medium', state: 'todo', tags: ['refactor', 'code-quality'],
        category: 'Development', notes: 'Split into smaller modules, improve testability, reduce coupling.',
        attachments: [], linkedDocs: ['Architecture Doc'], createdAt: '2026-01-13T14:00:00Z',
        lastModified: '2026-01-15T10:00:00Z', parentTask: null, blockReason: '', completedAt: null,
        recurrence: null, subtasks: []
      }
    ];
  },
  
  calculateDerivedFields(task) {
    const now = new Date();
    const dueDate = task.dueDate ? new Date(task.dueDate) : null;
    
    let urgency = 0;
    if (dueDate) {
      const daysUntilDue = (dueDate - now) / (1000 * 60 * 60 * 24);
      if (daysUntilDue < 1) urgency = 100;
      else if (daysUntilDue < 3) urgency = 80;
      else if (daysUntilDue < 7) urgency = 60;
      else if (daysUntilDue < 14) urgency = 40;
      else urgency = 20;
    }
    
    const importanceWeight = { high: 3, medium: 2, low: 1 }[task.importance] || 1;
    const impact = importanceWeight * (task.timeEstimate || 1);
    const autoPriorityWeight = urgency * 0.6 + impact * 0.4;
    const focusEligible = task.state !== 'done' && task.state !== 'blocked' && urgency > 50 && impact > 3;
    
    return { urgency, impact, autoPriorityWeight, focusEligible };
  },
  
  render() {
    const container = document.getElementById('taskList');
    container.innerHTML = '';
    
    this.tasks.forEach(task => {
      const derived = this.calculateDerivedFields(task);
      const row = document.createElement('div');
      row.className = 'task-row';
      row.draggable = true;
      row.dataset.taskId = task.id;
      
      if (this.selectedTaskId === task.id) row.classList.add('selected');
      if (task.expanded) row.classList.add('expanded');
      
      const urgencyClass = derived.urgency > 70 ? 'urgency-high' : '';
      const impactBadge = derived.impact > 6 ? 'impact-high' : derived.impact > 3 ? 'impact-medium' : '';
      
      row.innerHTML = `
        <div class="task-cell chevron-cell">
          <svg class="task-chevron ${task.expanded ? 'expanded' : ''}" viewBox="0 0 16 16" fill="currentColor">
            <path d="M6 4l4 4-4 4V4z"/>
          </svg>
        </div>
        <div class="task-cell task-title-cell" contenteditable="false">${task.title}</div>
        <div class="task-cell editable" contenteditable="false" data-field="project">${task.project || '-'}</div>
        <div class="task-cell editable" contenteditable="false" data-field="dueDate">${task.dueDate || '-'}</div>
        <div class="task-cell editable" contenteditable="false" data-field="dueTime">${task.dueTime || '-'}</div>
        <div class="task-cell editable" contenteditable="false" data-field="startDate">${task.startDate || '-'}</div>
        <div class="task-cell">${task.timeEstimate ? task.timeEstimate + 'h' : '-'}</div>
        <div class="task-cell importance-${task.importance}">${task.importance.toUpperCase()}</div>
        <div class="task-cell ${urgencyClass}">${derived.urgency.toFixed(0)}%</div>
        <div class="task-cell">${derived.impact.toFixed(1)}${derived.focusEligible ? '<span class="badge focus">F</span>' : ''}</div>
        <div class="task-cell state-cell ${task.state}">${task.state.toUpperCase()}</div>
        <div class="task-cell">${task.completedAt ? new Date(task.completedAt).toLocaleDateString() : '-'}</div>
        <div class="task-cell editable" contenteditable="false" data-field="blockReason">${task.blockReason || '-'}</div>
        
        <div class="expanded-content">
          <div class="expanded-grid">
            <div>
              <div class="expanded-section">
                <h4>Notes</h4>
                <textarea class="notes-area" data-field="notes">${task.notes || ''}</textarea>
              </div>
              
              <div class="expanded-section">
                <h4>Metadata</h4>
                <div class="metadata-grid">
                  <div class="metadata-label">Category:</div>
                  <div class="metadata-value">${task.category || '-'}</div>
                  <div class="metadata-label">Tags:</div>
                  <div class="metadata-value">${task.tags.map(t => `<span class="tag">${t}</span>`).join('') || '-'}</div>
                  <div class="metadata-label">Created:</div>
                  <div class="metadata-value">${new Date(task.createdAt).toLocaleString()}</div>
                  <div class="metadata-label">Modified:</div>
                  <div class="metadata-value">${new Date(task.lastModified).toLocaleString()}</div>
                  ${task.parentTask ? `<div class="metadata-label">Parent Task:</div><div class="metadata-value">${task.parentTask}</div>` : ''}
                  ${task.recurrence ? `<div class="metadata-label">Recurrence:</div><div class="metadata-value">${task.recurrence}</div>` : ''}
                </div>
              </div>
            </div>
            
            <div>
              ${task.attachments.length ? `
                <div class="expanded-section">
                  <h4>Attachments</h4>
                  <ul class="attachment-list">
                    ${task.attachments.map(a => `<li class="attachment-item">üìé ${a}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
              
              ${task.linkedDocs.length ? `
                <div class="expanded-section">
                  <h4>Linked Documents</h4>
                  <ul class="attachment-list">
                    ${task.linkedDocs.map(d => `<li class="attachment-item">üîó ${d}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
              
              <div class="expanded-section">
                <h4>AI Insights</h4>
                <div class="ai-insights">
                  <strong>Priority Analysis:</strong> Urgency ${derived.urgency.toFixed(0)}% | Impact Score ${derived.impact.toFixed(1)} | Auto-Priority ${derived.autoPriorityWeight.toFixed(1)}<br>
                  <strong>Recommendation:</strong> ${derived.focusEligible ? '‚≠ê High priority - Recommended for focus session' : 'Standard priority - Schedule when convenient'}<br>
                  <strong>Focus Eligible:</strong> ${derived.focusEligible ? 'Yes' : 'No'}
                </div>
              </div>
            </div>
            
            <div class="subtasks-section">
              <h4>Subtasks (${task.subtasks.filter(s => s.done).length}/${task.subtasks.length} completed)</h4>
              ${task.subtasks.map(st => `
                <div class="subtask-item ${st.done ? 'done' : ''}" data-subtask-id="${st.id}">
                  <div class="subtask-checkbox ${st.done ? 'checked' : ''}"></div>
                  <div class="subtask-title">${st.title}</div>
                </div>
              `).join('')}
              <button class="btn" style="margin-top: 12px;" onclick="app.addSubtask('${task.id}')">+ Add Subtask</button>
            </div>
          </div>
          
          <div class="actions">
            <button class="btn primary" onclick="app.saveTaskChanges('${task.id}')">Save Changes</button>
            <button class="btn" onclick="app.toggleExpand('${task.id}')">Collapse</button>
            <button class="btn danger" onclick="app.deleteTask('${task.id}')">Delete Task</button>
            <button class="btn" onclick="app.duplicateTask('${task.id}')">Duplicate</button>
            <button class="btn" onclick="app.convertToSubtask('${task.id}')">Convert to Subtask</button>
          </div>
        </div>
      `;
      
      container.appendChild(row);
      
      // Event listeners
      row.querySelector('.chevron-cell').addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleExpand(task.id);
      });
      
      const titleCell = row.querySelector('.task-title-cell');
      titleCell.addEventListener('click', (e) => {
        e.stopPropagation();
        this.startEdit(task.id, 'title', e.target);
      });
      
      row.querySelectorAll('.task-cell.editable').forEach(cell => {
        cell.addEventListener('click', (e) => {
          e.stopPropagation();
          const field = cell.dataset.field;
          this.startEdit(task.id, field, cell);
        });
      });
      
      const stateCell = row.querySelector('.state-cell');
      stateCell.addEventListener('click', (e) => {
        e.stopPropagation();
        this.cycleState(task.id);
      });
      
      const notesArea = row.querySelector('.notes-area');
      if (notesArea) {
        notesArea.addEventListener('blur', (e) => {
          task.notes = e.target.value;
          task.lastModified = new Date().toISOString();
        });
      }
      
      row.querySelectorAll('.subtask-checkbox').forEach(cb => {
        cb.addEventListener('click', (e) => {
          e.stopPropagation();
          const subtaskId = cb.parentElement.dataset.subtaskId;
          this.toggleSubtask(task.id, subtaskId);
        });
      });
      
      row.addEventListener('dragstart', (e) => {
        this.draggedTaskId = task.id;
        row.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      
      row.addEventListener('dragend', () => {
        row.classList.remove('dragging');
        this.draggedTaskId = null;
      });
      
      row.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (!row.classList.contains('expanded-content')) {
          e.dataTransfer.dropEffect = 'move';
          row.classList.add('drag-over');
        }
      });
      
      row.addEventListener('dragleave', () => {
        row.classList.remove('drag-over');
      });
      
      row.addEventListener('drop', (e) => {
        e.preventDefault();
        row.classList.remove('drag-over');
        if (this.draggedTaskId && this.draggedTaskId !== task.id) {
          this.reorderTasks(this.draggedTaskId, task.id);
        }
      });
      
      row.addEventListener('click', () => {
        this.selectTask(task.id);
      });
    });
  },
  
  toggleExpand(taskId) {
    const task = this.tasks.find(t => t.id === taskId);
    if (task) {
      task.expanded = !task.expanded;
      this.render();
    }
  },
  
  selectTask(taskId) {
    this.selectedTaskId = taskId;
    this.render();
  },
  
  startEdit(taskId, field, element) {
    const originalValue = element.textContent;
    element.contentEditable = 'true';
    element.focus();
    
    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(element);
    sel.removeAllRanges();
    sel.addRange(range);
    
    const saveEdit = () => {
      const task = this.tasks.find(t => t.id === taskId);
      if (task) {
        const newValue = element.textContent.trim();
        if (newValue !== '-' && newValue !== '') {
          task[field] = newValue;
        } else {
          task[field] = '';
        }
        task.lastModified = new Date().toISOString();
      }
      element.contentEditable = 'false';
      this.render();
    };
    
    const cancelEdit = () => {
      element.textContent = originalValue;
      element.contentEditable = 'false';
    };
    
    element.addEventListener('blur', saveEdit, { once: true });
    
    element.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        element.blur();
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        element.removeEventListener('blur', saveEdit);
        cancelEdit();
      }
    });
  },
  
  cycleState(taskId) {
    const task = this.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    const states = ['todo', 'in-progress', 'done', 'blocked'];
    const currentIndex = states.indexOf(task.state);
    task.state = states[(currentIndex + 1) % states.length];
    
    if (task.state === 'done') {
      task.completedAt = new Date().toISOString();
    } else {
      task.completedAt = null;
    }
    
    task.lastModified = new Date().toISOString();
    this.render();
  },
  
  toggleSubtask(taskId, subtaskId) {
    const task = this.tasks.find(t => t.id === taskId);
    if (!task) return;
    
    const subtask = task.subtasks.find(s => s.id === subtaskId);
    if (subtask) {
      subtask.done = !subtask.done;
      task.lastModified = new Date().toISOString();
      this.render();
    }
  },
  
  addSubtask(taskId) {
    const title = prompt('Subtask title:');
    if (!title) return;
    
    const task = this.tasks.find(t => t.id === taskId);
    if (task) {
      task.subtasks.push({
        id: 's' + Date.now(),
        title,
        done: false
      });
      task.lastModified = new Date().toISOString();
      this.render();
    }
  },
  
  reorderTasks(draggedId, targetId) {
    const draggedIndex = this.tasks.findIndex(t => t.id === draggedId);
    const targetIndex = this.tasks.findIndex(t => t.id === targetId);
    
    if (draggedIndex !== -1 && targetIndex !== -1) {
      const [draggedTask] = this.tasks.splice(draggedIndex, 1);
      this.tasks.splice(targetIndex, 0, draggedTask);
      this.render();
    }
  },
  
  sortTasks(by) {
    if (by === 'dueDate') {
      this.tasks.sort((a, b) => {
        if (!a.dueDate) return 1;
        if (!b.dueDate) return -1;
        return new Date(a.dueDate) - new Date(b.dueDate);
      });
    } else if (by === 'importance') {
      const order = { high: 0, medium: 1, low: 2 };
      this.tasks.sort((a, b) => order[a.importance] - order[b.importance]);
    } else if (by === 'urgency') {
      this.tasks.sort((a, b) => {
        const urgA = this.calculateDerivedFields(a).urgency;
        const urgB = this.calculateDerivedFields(b).urgency;
        return urgB - urgA;
      });
    }
    this.render();
  },
  
  filterFocusEligible() {
    const focusTasks = this.allTasks.filter(t => this.calculateDerivedFields(t).focusEligible);
    if (focusTasks.length === 0) {
      alert('No focus-eligible tasks found!');
      return;
    }
    this.tasks = focusTasks;
    this.render();
  },
  
  resetFilter() {
    this.tasks = [...this.allTasks];
    this.render();
  },
  
  saveTaskChanges(taskId) {
    const task = this.tasks.find(t => t.id === taskId);
    if (task) {
      task.lastModified = new Date().toISOString();
      alert('Task saved successfully!');
    }
  },
  
  deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
      this.tasks = this.tasks.filter(t => t.id !== taskId);
      this.allTasks = this.allTasks.filter(t => t.id !== taskId);
      this.selectedTaskId = null;
      this.render();
    }
  },
  
  duplicateTask(taskId) {
    const task = this.tasks.find(t => t.id === taskId);
    if (task) {
      const newTask = JSON.parse(JSON.stringify(task));
      newTask.id = 't' + Date.now();
      newTask.title = task.title + ' (Copy)';
      newTask.createdAt = new Date().toISOString();
      newTask.lastModified = new Date().toISOString();
      newTask.expanded = false;
      this.tasks.push(newTask);
      this.allTasks.push(newTask);
      this.render();
    }
  },
  
  convertToSubtask(taskId) {
    const parentId = prompt('Enter parent task ID:');
    if (!parentId) return;
    
    const parentTask = this.allTasks.find(t => t.id === parentId);
    const task = this.tasks.find(t => t.id === taskId);
    
    if (parentTask && task) {
      parentTask.subtasks.push({
        id: 's' + Date.now(),
        title: task.title,
        done: task.state === 'done'
      });
      this.tasks = this.tasks.filter(t => t.id !== taskId);
      this.allTasks = this.allTasks.filter(t => t.id !== taskId);
      this.render();
    } else {
      alert('Parent task not found!');
    }
  },
  
  openNewTaskModal() {
    document.getElementById('taskModal').classList.add('active');
    document.getElementById('modalTitle').textContent = 'New Task';
    document.getElementById('modalTaskTitle').value = '';
    document.getElementById('modalProject').value = '';
    document.getElementById('modalDueDate').value = '';
    document.getElementById('modalDueTime').value = '';
    document.getElementById('modalStartDate').value = '';
    document.getElementById('modalTimeEstimate').value = '';
    document.getElementById('modalImportance').value = 'medium';
    document.getElementById('modalTags').value = '';
    document.getElementById('modalCategory').value = '';
    document.getElementById('modalNotes').value = '';
    setTimeout(() => document.getElementById('modalTaskTitle').focus(), 100);
  },
  
  closeModal() {
    document.getElementById('taskModal').classList.remove('active');
  },
  
  saveTask() {
    const title = document.getElementById('modalTaskTitle').value.trim();
    if (!title) {
      alert('Title is required');
      document.getElementById('modalTaskTitle').focus();
      return;
    }
    
    const newTask = {
      id: 't' + Date.now(),
      title,
      project: document.getElementById('modalProject').value.trim(),
      dueDate: document.getElementById('modalDueDate').value,
      dueTime: document.getElementById('modalDueTime').value,
      startDate: document.getElementById('modalStartDate').value,
      timeEstimate: parseFloat(document.getElementById('modalTimeEstimate').value) || 0,
      importance: document.getElementById('modalImportance').value,
      state: 'todo',
      tags: document.getElementById('modalTags').value.split(',').map(t => t.trim()).filter(Boolean),
      category: document.getElementById('modalCategory').value.trim(),
      notes: document.getElementById('modalNotes').value.trim(),
      attachments: [],
      linkedDocs: [],
      createdAt: new Date().toISOString(),
      lastModified: new Date().toISOString(),
      parentTask: null,
      blockReason: '',
      completedAt: null,
      recurrence: null,
      subtasks: []
    };
    
    this.tasks.push(newTask);
    this.allTasks.push(newTask);
    this.closeModal();
    this.render();
  },
  
  setupKeyboard() {
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.contentEditable === 'true') return;
      if (document.getElementById('taskModal').classList.contains('active')) return;
      if (!this.selectedTaskId) return;
      
      const currentIndex = this.tasks.findIndex(t => t.id === this.selectedTaskId);
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentIndex < this.tasks.length - 1) {
          this.selectTask(this.tasks[currentIndex + 1].id);
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentIndex > 0) {
          this.selectTask(this.tasks[currentIndex - 1].id);
        }
      } else if (e.key === 'Enter') {
        e.preventDefault();
        this.toggleExpand(this.selectedTaskId);
      } else if (e.key === ' ') {
        e.preventDefault();
        this.cycleState(this.selectedTaskId);
      } else if (e.key === 'Delete' || e.key === 'Backspace') {
        e.preventDefault();
        this.deleteTask(this.selectedTaskId);
      } else if (e.key === 'd' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        this.duplicateTask(this.selectedTaskId);
      }
    });
  },
  
  setupModalKeyboard() {
    document.addEventListener('keydown', (e) => {
      const modal = document.getElementById('taskModal');
      if (!modal.classList.contains('active')) return;
      
      if (e.key === 'Escape') {
        this.closeModal();
      } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        this.saveTask();
      }
    });
    
    // Close modal when clicking outside
    document.getElementById('taskModal').addEventListener('click', (e) => {
      if (e.target.id === 'taskModal') {
        this.closeModal();
      }
    });
  }
};

app.init();
</script>
</body>
</html>